=======================================
6.1 虚拟机crash事件捕获设备pvpanic
=======================================

--------------------------------
虚拟机内核crash
--------------------------------

虚拟机在运行过程中，由于各种原因都可能出现内核crash，也就是Linux的kernel panic。对于Windows 虚拟机，则是蓝屏异常。

云计算海量的服务器运行了海量的虚拟机，各种复杂的运行环境，虚拟机crash可能反映了软件或硬件的问题或隐患，所以，正确获取虚拟机异常是云计算运维的基础。

--------------------------------
模拟触发虚拟机crash
--------------------------------

> 模拟虚拟机crash的方法有很多种

但是这种异常是在虚拟机内部出现的，对于运行在物理服务器上的QEMU进程来说，QEMU进程是不知道虚拟机内部的异常。由于在物理服务器层无法感知到虚拟机内部的异常，使得云计算平台无法采取相应的措施来排查或恢复虚拟机正常运行，对云计算用户十分不利。 

此时在host主机上使用 ``virsh domstate --reason <name>`` 却只能显示 ``running (booted)``。

--------------------------------
qemu pvpanic设备
--------------------------------

``pvpanic`` 设备是一个模拟的ISA设备，通过这个设备 ``guest panic`` 事件被发送给qemu，并且生成一个QMP事件。这允许管理程序（例如， ``libvirt`` ）被通知并响应这个事件。

管理程序有一个选项来等待 ``GUEST_PANICKED`` 事件，并且/或 polling ``guest-panicked`` 运行状态，来获取何时出现 ``pvpanic`` 设备被 panic 事件触发。

``pvpanic`` 输出一个简单的I/O端口，默认是 ``0x505`` 。读取时，通过设置设备的位来识别。软件可以忽略这个设置位。写入时，这个设置位不能省略。软件只能自己和设备识别两者来设置位。当前，只有位0是使用的，设置这个设置位就标志着发生了 ``guest panic`` 。

--------------------------------
配置qemu pvpanic设备
--------------------------------

现在我们为虚拟机配置一个 ``pvpanic`` 设备，然后来模拟触发虚拟机crash