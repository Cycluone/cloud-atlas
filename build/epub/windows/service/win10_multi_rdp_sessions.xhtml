<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Windows 10远程桌面多会话</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="windows-10">
<span id="win10-multi-rdp-sessions"></span><h1>Windows 10远程桌面多会话</h1>
<p>Windows 10远程桌面(Remote Desktop, RDP)和Sever版本的Terminal Service不同的是：Windows 10不允许多个帐号同时并发使用远程桌面。这是微软的操作系统版本区分策略，实际上Windows 10也能够开启多个RDP会话，就好像服务器版本一样。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>我在这里探索Windows 10远程桌面多会话功能，实际上是因为在研究 <a class="reference internal" href="../../linux/desktop/rdp/seamless_rdp.xhtml#seamless-rdp"><span class="std std-ref">Seamless RDP使用Windows应用</span></a> 发现Windows 10不能实现类似Windows Server一样的seamless RDP。经过一些探索，我发现主要原因应该是Windows 10 Pro不支持Terminal Server的RemoteApp方式运行程序。Seamless RDP可能是Terminal Server的RemoteApp形式的包装，所以只能在Windows Server上实现。</p>
</div>
<section id="terminal-server">
<h2>Terminal Server</h2>
<p>seamlessrdp 需要服务器端使用Terminal Server，也就是能够在服务器端 <a class="reference external" href="https://social.technet.microsoft.com/wiki/contents/articles/10817.publishing-remoteapps-in-windows-server-2012.aspx">Publishing RemoteApps in Windows Server 2012</a><span class="link-target"> [https://social.technet.microsoft.com/wiki/contents/articles/10817.publishing-remoteapps-in-windows-server-2012.aspx]</span> 或者类似在 Windows Sever 2008上参考 <a class="reference external" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc730673(v=ws.10)?redirectedfrom=MSDN">TS RemoteApp Step-by-Step Guide</a><span class="link-target"> [https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc730673(v=ws.10)?redirectedfrom=MSDN]</span> ，而Windows 10 Pro恰恰没有提供Terminal Server功能。勤劳朴实的Haker提供了以下两种方案实现 <a class="reference external" href="https://www.mysysadmintips.com/windows/clients/545-multiple-rdp-remote-desktop-sessions-in-windows-10">Multiple RDP (Remote Desktop) sessions in Windows 10</a><span class="link-target"> [https://www.mysysadmintips.com/windows/clients/545-multiple-rdp-remote-desktop-sessions-in-windows-10]</span> ：</p>
<ul class="simple">
<li><p>修改 termsrv.dll</p></li>
<li><p>部署开源的RDP Wrapper中间层</p></li>
</ul>
<p>编辑 <code class="docutils literal notranslate"><span class="pre">termserv.dll</span></code> 可以使用免费的 <a class="reference external" href="http://texteditors.org/cgi-bin/wiki.pl?Tiny_Hexer">Tiny Hexer</a><span class="link-target"> [http://texteditors.org/cgi-bin/wiki.pl?Tiny_Hexer]</span> 编辑器。</p>
<p><strong>Windows 10 x64 v1903 - May 2019 Update</strong> 修订 <code class="docutils literal notranslate"><span class="pre">C:\Windows\System32\termsrv.dll</span></code></p>
<p>将:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">39</span> <span class="mi">81</span> <span class="mi">3</span><span class="n">C</span> <span class="mi">06</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">0</span><span class="n">F</span> <span class="mi">84</span> <span class="mi">5</span><span class="n">D</span> <span class="mi">61</span> <span class="mi">01</span> <span class="mi">00</span>
</pre></div>
</div>
<p>修改成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">B8</span> <span class="mi">00</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">89</span> <span class="mi">81</span> <span class="mi">38</span> <span class="mi">06</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">90</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">C:\Windows\System32\termsrv.dll</span></code> 是系统文件，无法直接编辑或者替换(例如我将文件复制出来修改以后想再复制回去覆盖原先的系统文件)。</p>
<ul>
<li><p>你需要首先把文件 <code class="docutils literal notranslate"><span class="pre">take</span> <span class="pre">own</span></code> 成自己(使用administrator权限运行command prompt)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">takeown</span> <span class="o">/</span><span class="n">f</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span>\<span class="n">termsrv</span><span class="o">.</span><span class="n">dll</span>
</pre></div>
</div>
</li>
<li><p>然后首选自己administrators完全访问和控制该文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">icacls</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span>\<span class="n">termsrv</span><span class="o">.</span><span class="n">dll</span> <span class="o">/</span><span class="n">grant</span> <span class="n">administrators</span><span class="p">:</span><span class="n">F</span>
</pre></div>
</div>
</li>
<li><p>停止远程桌面服务(通过 <code class="docutils literal notranslate"><span class="pre">Computer</span> <span class="pre">Managerment</span></code> 的Services管理 )</p></li>
<li><p>现在就可以复制文件进行系统文件替换:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">huatai</span>\<span class="n">Desktop</span>\<span class="n">termsrv</span><span class="o">.</span><span class="n">dll</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Windows</span>\<span class="n">system32</span>\<span class="n">termsrv</span><span class="o">.</span><span class="n">dll</span>
</pre></div>
</div>
</li>
<li><p>然后再次启动远程桌面服务</p></li>
</ul>
<p>现在Windows 10的多个用户帐号可以同时发起RDP远程桌面访问Windows 10系统，如果将Windows 10作为远程桌面服务器，运行多个办公环境，可以极大节约硬件资源。</p>
</section>
<section id="id1">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.thewindowsclub.com/how-to-fix-corrupted-system-files-in-windows-10">How to fix corrupted system files in Windows 10</a><span class="link-target"> [https://www.thewindowsclub.com/how-to-fix-corrupted-system-files-in-windows-10]</span></p></li>
<li><p><a class="reference external" href="https://www.mysysadmintips.com/windows/clients/545-multiple-rdp-remote-desktop-sessions-in-windows-10">Multiple RDP (Remote Desktop) sessions in Windows 10</a><span class="link-target"> [https://www.mysysadmintips.com/windows/clients/545-multiple-rdp-remote-desktop-sessions-in-windows-10]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>