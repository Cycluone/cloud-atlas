<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>部署DNSmasq</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="dnsmasq">
<span id="deploy-dnsmasq"></span><h1>部署DNSmasq</h1>
<section id="id1">
<h2>安装dnsmasq</h2>
<ul class="simple">
<li><p>各发行版都包含了dnsmasq，安装十分方便便捷：</p></li>
</ul>
<p><a class="reference internal" href="../../../linux/arch_linux/index.xhtml#arch-linux"><span class="std std-ref">Arch Linux</span></a> 安装dnsmasq:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pacman</span> <span class="o">-</span><span class="n">S</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../../linux/ubuntu_linux/index.xhtml#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 安装dnsmasq:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../../linux/redhat_linux/index.xhtml#redhat-linux"><span class="std std-ref">RedHat Linux</span></a> 安装dnsmasq (fedora或centos/rhel 8):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">install</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>配置dnsmasq</h2>
<ul>
<li><p>检查配置语法，这个基本步骤可以确保配置没有基础的语法错误:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnsmasq</span> <span class="o">--</span><span class="n">test</span>
</pre></div>
</div>
</li>
<li><p>在我的zcloud服务器上，有2个网络接口分别代表外网和内网。其中内网采用有线网络，网段是 <code class="docutils literal notranslate"><span class="pre">192.168.6.x</span></code> ，所以需要设置dnsmasq监听特定地址，只监听内部网络网段和回环地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">listen</span><span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.9</span><span class="p">,</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
</pre></div>
</div>
</li>
</ul>
<p>也可以通过设置监听接口来确保限制在指定网口上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span><span class="o">=</span><span class="n">enp0s25</span><span class="p">,</span><span class="n">anbox0</span>
</pre></div>
</div>
<p>或者仅指定不包括哪些接口 <code class="docutils literal notranslate"><span class="pre">except-interface=</span></code></p>
<ul>
<li><p>设置缓存大小：通常dnsmasq是作为本地局域网的DNS缓存服务器运行，并且默认只缓存150条DNS记录，可以将这个缓存扩大:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span><span class="o">-</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span>
</pre></div>
</div>
</li>
</ul>
<section id="dns">
<h3>DNS地址文件和转发</h3>
<p>在配置了dnsmasq之后，你需要添加一个localhost地址到 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> ，这样本机的DNS请求才会发送被本机运行的dnsmasq。</p>
<p>由于dnsmasq是一个stub解析器(resolver)但不是一个recusive解析器，所以你必须设置一个转发解析到外部DNS服务器。这个设置可以使用 <code class="docutils literal notranslate"><span class="pre">openresolv</span></code> 自动实现(也可以在dnsmasq的配置文件中手工设置，但我们通常都使用openresolv)。</p>
<section id="openresolv">
<h4>openresolv</h4>
<p>如果你的network manager支持 <code class="docutils literal notranslate"><span class="pre">resolvconf</span></code> ，就不需要直接修改 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> ，可以使用 <code class="docutils literal notranslate"><span class="pre">openresolv</span></code> 来为dnsmasq生成配置文件。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>注意， <code class="docutils literal notranslate"><span class="pre">resolvconf</span></code> 的基础配置 <code class="docutils literal notranslate"><span class="pre">DOMAINNAME</span></code> 是从 NetworkManager 获取的，会影响下面所有的 domain 配置。所以如果要修订域名搜索，需要修改Network Manager的配置。这块我还没有实践，待后续补充</p>
</div>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/etc/resolvconf.conf</span></code> 添加一个回环地址作为域名解析服务器，并配置 openresolv 来输出dnsmasq配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resolv_conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>
<span class="c1"># If you run a local name server, you should uncomment the below line and</span>
<span class="c1"># configure your subscribers configuration files below.</span>
<span class="n">name_servers</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>

<span class="c1"># Write out dnsmasq extended configuration and resolv files</span>
<span class="n">dnsmasq_conf</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">dnsmasq</span><span class="o">-</span><span class="n">conf</span><span class="o">.</span><span class="n">conf</span>
<span class="n">dnsmasq_resolv</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">dnsmasq</span><span class="o">-</span><span class="n">resolv</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
<li><p>执行 <code class="docutils literal notranslate"><span class="pre">resolvconf</span> <span class="pre">-u</span></code> 命令生成上述配置文件。注意，如果没有上述文件存在， <code class="docutils literal notranslate"><span class="pre">dnsmasq.service</span></code> 启动会失败。</p></li>
</ul>
<p>请注意，此时原先 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> 配置文件会修订成使用本机dns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">domain</span> <span class="n">test</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span>
<span class="n">nameserver</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
</pre></div>
</div>
<p>而 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq-resolv.conf</span></code> 配置则是之前 <code class="docutils literal notranslate"><span class="pre">resolv.conf</span></code> 内容，也就是说DNSmasq会使用这个 <code class="docutils literal notranslate"><span class="pre">dnsmasq-resolv.conf</span></code> 来请求外部DNS服务器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">nameserver</span> <span class="mf">202.96</span><span class="o">.</span><span class="mf">209.133</span>  <span class="c1"># 注意：之后这个外部DNS将修改成我部署的bind服务器IP</span>
</pre></div>
</div>
<p>而 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq-conf.conf</span></code> 配置是dnsmasq的配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">server</span><span class="o">=/</span><span class="n">test</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span><span class="o">/</span><span class="mf">202.96</span><span class="o">.</span><span class="mf">209.133</span>
</pre></div>
</div>
</section>
<section id="manual-forwarding">
<h4>Manual forwarding</h4>
<ul>
<li><p>首先需要确保 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> 配置中只设置 localhost 作为唯一的nameserver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generated by resolvconf</span>
<span class="n">domain</span> <span class="n">test</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span>
<span class="n">nameserver</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="c1"># 如果是IPv6还需要如下行</span>
<span class="c1"># nameserver ::1</span>
</pre></div>
</div>
</li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq.conf</span></code> 配置 <code class="docutils literal notranslate"><span class="pre">server=server_address</span></code> 指定上级DNS，并且添加 <code class="docutils literal notranslate"><span class="pre">no-resolv</span></code> 这样dnsmasq就不会读取 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> ，因为这个配置中实际只包含了它自己的localhost地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">no</span><span class="o">-</span><span class="n">resolv</span>
<span class="o">...</span>
<span class="c1"># Google&#39;s nameservers, for example</span>
<span class="n">server</span><span class="o">=</span><span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span>
<span class="n">server</span><span class="o">=</span><span class="mf">8.8</span><span class="o">.</span><span class="mf">4.4</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>一定要配置 <code class="docutils literal notranslate"><span class="pre">server=</span></code> ，将所有非本地域名的DNS解析都通过上一级DNS来提供</p>
</div>
</section>
</section>
</section>
<section id="id3">
<h2>添加定制域名</h2>
<p>可以为本地局域网添加一个domain，也就是我们内部域名:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span><span class="o">=/</span><span class="n">test</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span><span class="o">/</span>
<span class="n">domain</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span>
<span class="n">expand</span><span class="o">-</span><span class="n">hosts</span>
</pre></div>
</div>
<p>上述域名就是我们用于DHCP和内部域名，这样我们在 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 中配置主机名解析时候就只需要配置短域名主机名就可以了，会自动扩展成FQDN完整域名。例如， <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.9</span>  <span class="n">zcloud</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.10</span> <span class="n">jetson</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span> <span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.12</span> <span class="n">pi</span><span class="o">-</span><span class="n">master2</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.13</span> <span class="n">pi</span><span class="o">-</span><span class="n">master3</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.17</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker3</span>
</pre></div>
</div>
<p>则自动会被加上 <code class="docutils literal notranslate"><span class="pre">.test.huatai.me</span></code> 后缀域名，形成完成的域名 <code class="docutils literal notranslate"><span class="pre">192.168.6.9</span> <span class="pre">zcloud.test.huatai.me</span></code></p>
</section>
<section id="id4">
<h2>启动DNSmasq</h2>
<ul>
<li><p>启动dnsmasq:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
</li>
<li><p>查询测试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">host</span> <span class="n">zcloud</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到输出的域名解析被自动展开:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zcloud</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">huatai</span><span class="o">.</span><span class="n">me</span> <span class="n">has</span> <span class="n">address</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.9</span>
</pre></div>
</div>
</section>
<section id="dhcp">
<h2>DHCP服务器</h2>
<p>默认情况下，dnsmasq是关闭DHCP功能的，需要在配置中开启才可以使用dhcp。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果你的局域网内部已经使用了DHCP服务，例如宽带路由器对局域网就默认启用了DHCP。所以，一定要避免DHCP冲突，需要小心设置dnsmasq所使用对接口(参数 <code class="docutils literal notranslate"><span class="pre">interface=</span></code> )</p>
</div>
<p>在我的案例中，我启用了多个接口的DNS服务 ( <code class="docutils literal notranslate"><span class="pre">enp0s25,anbox0</span></code> ) 但是只在内网接口 <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 启用DHCP服务。</p>
<ul>
<li><p>重要配置案例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># If you want dnsmasq to listen for DHCP and DNS requests only on</span>
<span class="c1"># specified interfaces (and the loopback) give the name of the</span>
<span class="c1"># interface (eg eth0) here.</span>
<span class="c1"># Repeat the line for more than one interface.</span>
<span class="n">interface</span><span class="o">=</span><span class="n">enp0s25</span><span class="p">,</span><span class="n">anbox0</span>

<span class="c1"># If you want dnsmasq to provide only DNS service on an interface,</span>
<span class="c1"># configure it as shown above, and then use the following line to</span>
<span class="c1"># disable DHCP and TFTP on it.</span>
<span class="n">no</span><span class="o">-</span><span class="n">dhcp</span><span class="o">-</span><span class="n">interface</span><span class="o">=</span><span class="n">anbox0</span>

<span class="c1"># On systems which support it, dnsmasq binds the wildcard address,</span>
<span class="c1"># even when it is listening on only some interfaces. It then discards</span>
<span class="c1"># requests that it shouldn&#39;t reply to. This has the advantage of</span>
<span class="c1"># working even when interfaces come and go and change address. If you</span>
<span class="c1"># want dnsmasq to really bind only the interfaces it is listening on,</span>
<span class="c1"># uncomment this option. About the only time you may need this is when</span>
<span class="c1"># running another nameserver on the same machine.</span>
<span class="n">bind</span><span class="o">-</span><span class="n">interfaces</span>

<span class="c1"># Uncomment this to enable the integrated DHCP server, you need</span>
<span class="c1"># to supply the range of addresses available for lease and optionally</span>
<span class="c1"># a lease time. If you have more than one network, you will need to</span>
<span class="c1"># repeat this for each network on which you want to supply DHCP</span>
<span class="c1"># service.</span>
<span class="c1"># This is an example of a DHCP range where the netmask is given.</span>
<span class="n">dhcp</span><span class="o">-</span><span class="nb">range</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.201</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.254</span><span class="p">,</span><span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span><span class="p">,</span><span class="mi">12</span><span class="n">h</span>

<span class="c1"># 也支持根据以太网MAC地址来分配IP地址，适合需要固定IP地址分配场景</span>
<span class="c1"># 在企业内部网络，可以通过这种方式来。</span>
<span class="c1"># 以下为举例(设置主机名以及对应IP地址，并且45分钟释放):</span>
<span class="c1"># dhcp-host=11:22:33:44:55:66,fred,192.168.6.254,45m</span>

<span class="c1"># DHCP有很多重要选项，以下是一些常用案例：</span>

<span class="c1"># 设置默认网关，以下2种配置都可以，任选一种</span>
<span class="c1">#dhcp-option=3,192.168.6.9</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">:</span><span class="n">router</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.9</span>

<span class="c1"># 设置NTP服务器地址:</span>
<span class="c1">#dhcp-option=option:ntp-server,192.168.6.9</span>

<span class="c1"># 可以通过DHCP设置静态路由，注意要配置网络netmask</span>
<span class="c1">#dhcp-option=121,192.168.7.0/24,192.168.6.10,10.0.0.0/8,192.168.6.8</span>

<span class="c1"># 设置DNS服务器(待验证，配置文件只显示DHCPv6的dns-server)</span>
<span class="n">dhcp</span><span class="o">-</span><span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">:</span><span class="n">dns</span><span class="o">-</span><span class="n">server</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.9</span>
</pre></div>
</div>
</li>
</ul>
<p>完整的配置需要查看 <code class="docutils literal notranslate"><span class="pre">dnsmasq.conf</span></code> 配置注释，后面我会在部署 <a class="reference internal" href="../../../arm/raspberry_pi/pi_cluster/index.xhtml#pi-cluster"><span class="std std-ref">Raspberry Pi Cluster</span></a> 的diskless集群尝试实践。</p>
<ul>
<li><p>启动dnsmasq之后，要观察有哪些DHCP地址被分配出去，请检查 <code class="docutils literal notranslate"><span class="pre">/var/lib/misc/dnsmasq.leases</span></code></p></li>
<li><p>启动dnsmasq之后，请检查 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">dnsmasq</span></code> 输出，正常情况下显示类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/usr/lib/systemd/system/dnsmasq.service; enabled; vendor preset: disabled)
     Active: active (running) since Thu 2020-10-08 22:23:52 CST; 14min ago
       Docs: man:dnsmasq(8)
    Process: 36760 ExecStartPre=/usr/bin/dnsmasq --test (code=exited, status=0/SUCCESS)
   Main PID: 36761 (dnsmasq)
      Tasks: 1 (limit: 19050)
     Memory: 1.3M
     CGroup: /system.slice/dnsmasq.service
             └─36761 /usr/bin/dnsmasq -k --enable-dbus --user=dnsmasq --pid-file

Oct 08 22:23:52 zcloud dnsmasq[36760]: dnsmasq: syntax check OK.
Oct 08 22:23:52 zcloud systemd[1]: Started dnsmasq - A lightweight DHCP and caching DNS server.
Oct 08 22:23:52 zcloud dnsmasq[36761]: started, version 2.82 cachesize 1000
Oct 08 22:23:52 zcloud dnsmasq[36761]: compile time options: IPv6 GNU-getopt DBus no-UBus i18n IDN2 DHCP DHCPv6 no-Lua TFTP conntrack ipset auth DNSSEC loop-&gt;
Oct 08 22:23:52 zcloud dnsmasq[36761]: DBus support enabled: connected to system bus
Oct 08 22:23:52 zcloud dnsmasq-dhcp[36761]: DHCP, IP range 192.168.6.201 -- 192.168.6.254, lease time 12h
Oct 08 22:23:52 zcloud dnsmasq-dhcp[36761]: DHCP, sockets bound exclusively to interface enp0s25
Oct 08 22:23:52 zcloud dnsmasq[36761]: using only locally-known addresses for domain test.huatai.me
Oct 08 22:23:52 zcloud dnsmasq[36761]: using nameserver 202.96.209.133#53
Oct 08 22:23:52 zcloud dnsmasq[36761]: read /etc/hosts - 12 addresses
</pre></div>
</div>
</li>
</ul>
<p>请注意，这里输出的信息都反映了我们上述配置中的设置参数</p>
</section>
<section id="tftp">
<h2>TFTP服务器</h2>
<p>dnsmasq内建了TFTP服务器。也准备在 <a class="reference internal" href="../../../arm/raspberry_pi/pi_cluster/index.xhtml#pi-cluster"><span class="std std-ref">Raspberry Pi Cluster</span></a> 的diskless集群实践。</p>
</section>
<section id="id5">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Dnsmasq">archlinux doc - dnsmasq</a><span class="link-target"> [https://wiki.archlinux.org/index.php/Dnsmasq]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>