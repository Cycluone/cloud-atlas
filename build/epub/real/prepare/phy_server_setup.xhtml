<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>物理服务器设置</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="phy-server-setup">
<span id="id1"></span><h1>物理服务器设置</h1>
<section id="ipmi">
<h2>服务器IPMI</h2>
<p>对于服务器管理，远程带外管理是最基本的设置，为服务器设置 <a class="reference internal" href="../../linux/server/ipmi/ipmitool_tips.xhtml#ipmitool-tips"><span class="std std-ref">IPMI工具ipmitool</span></a> 运行环境，可以让我们能够在系统异常时远程诊断、重启系统，并且能够如果连接键盘显示器一样对物理服务器进行操作。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>可以在安装完Linux操作系统之后，通过操作系统的 <code class="docutils literal notranslate"><span class="pre">ipmitool</span></code> 命令来设置带外管理。</p>
</div>
<ul>
<li><p>如果带外系统已经设置了远程管理账号，则在每个IPMI命令之前加上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipmitool</span> <span class="o">-</span><span class="n">I</span> <span class="n">lanplus</span> <span class="o">-</span><span class="n">H</span> <span class="o">&lt;</span><span class="n">IPMI_IP</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">U</span> <span class="n">username</span> <span class="o">-</span><span class="n">P</span> <span class="n">password</span> <span class="o">&lt;</span><span class="n">ipmi</span> <span class="n">command</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以下配置命令是假设已经安装好操作系统，登陆到Linux系统中，使用root账号执行命令。如果远程执行，则添加上述远程命令选项。</p>
</div>
<ul>
<li><p>配置IPMI账号和访问IP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">待续</span>
</pre></div>
</div>
</li>
<li><p>冷重启BMC，避免一些潜在问题:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipmitool</span> <span class="n">mc</span> <span class="n">reset</span> <span class="n">cold</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id2">
<h2>操作系统</h2>
<ul>
<li><p>私有云物理服务器采用CentOS 7.x操作系统，采用最小化安装，并升级到最新版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">upgrade</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在CentOS 8正式推出以后，就 <a class="reference internal" href="../../linux/redhat_linux/centos/upgrade_centos_7_to_8.xhtml#upgrade-centos-7-to-8"><span class="std std-ref">升级CentOS 7到CentOS 8</span></a> ，以获得更好的软件性能及特性。</p>
</div>
<ul>
<li><p>安装必要软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">nmon</span> <span class="n">which</span> <span class="n">sudo</span> <span class="n">nmap</span><span class="o">-</span><span class="n">ncat</span> <span class="n">mlocate</span> <span class="n">net</span><span class="o">-</span><span class="n">tools</span> <span class="n">rsyslog</span> <span class="n">file</span> <span class="n">ntp</span> <span class="n">ntpdate</span> \
<span class="n">wget</span> <span class="n">tar</span> <span class="n">bzip2</span> <span class="n">screen</span> <span class="n">sysstat</span> <span class="n">unzip</span> <span class="n">nfs</span><span class="o">-</span><span class="n">utils</span> <span class="n">parted</span> <span class="n">lsof</span> <span class="n">man</span> <span class="n">bind</span><span class="o">-</span><span class="n">utils</span> \
<span class="n">gcc</span> <span class="n">gcc</span><span class="o">-</span><span class="n">c</span><span class="o">++</span> <span class="n">make</span> <span class="n">telnet</span> <span class="n">flex</span> <span class="n">autoconf</span> <span class="n">automake</span> <span class="n">ncurses</span><span class="o">-</span><span class="n">devel</span> <span class="n">crontabs</span> \
<span class="n">zlib</span><span class="o">-</span><span class="n">devel</span> <span class="n">git</span> <span class="n">vim</span>
</pre></div>
</div>
</li>
<li><p>关闭swap（Kubernetes运行要求节点关闭swap)</p></li>
<li><p>安装EPEL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">dl</span><span class="o">.</span><span class="n">fedoraproject</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pub</span><span class="o">/</span><span class="n">epel</span><span class="o">/</span><span class="n">epel</span><span class="o">-</span><span class="n">release</span><span class="o">-</span><span class="n">latest</span><span class="o">-</span><span class="mf">7.</span><span class="n">noarch</span><span class="o">.</span><span class="n">rpm</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id3">
<h2>磁盘分区</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>存储磁盘参考 <a class="reference internal" href="../../linux/storage/filesystem/lvm_xfs_in_studio.xhtml#lvm-xfs-in-studio"><span class="std std-ref">Studio环境的LVM+XFS存储</span></a> ，即磁盘块设备采用LVM卷管理，文件系统采用成熟的XFS系统。借鉴 <a class="reference external" href="https://stratis-storage.github.io/">Stratis项目</a><span class="link-target"> [https://stratis-storage.github.io/]</span> 存储架构。</p>
</div>
<ul>
<li><p>服务器磁盘 <code class="docutils literal notranslate"><span class="pre">/dev/sda4</span></code> 构建LVM卷，所以首先通过 <code class="docutils literal notranslate"><span class="pre">parted</span> <span class="pre">/dev/sda</span></code> 划分分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parted</span> <span class="o">-</span><span class="n">a</span> <span class="n">optimal</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span>

<span class="n">mkpart</span> <span class="n">primary</span> <span class="mf">54.8</span><span class="n">GB</span> <span class="mi">100</span><span class="o">%</span>
<span class="n">name</span> <span class="mi">4</span> <span class="n">store</span>
<span class="nb">set</span> <span class="mi">4</span> <span class="n">lvm</span> <span class="n">on</span>
</pre></div>
</div>
</li>
<li><p>构建LVM卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pvcreate</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda4</span>
<span class="n">vgcreate</span> <span class="n">store</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda4</span>

<span class="n">lvcreate</span> <span class="o">--</span><span class="n">size</span> <span class="mi">128</span><span class="n">G</span> <span class="o">-</span><span class="n">n</span> <span class="n">libvirt</span> <span class="n">store</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">xfs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">store</span><span class="o">/</span><span class="n">libvirt</span>

<span class="n">lvcreate</span> <span class="o">--</span><span class="n">size</span> <span class="mi">256</span><span class="n">G</span> <span class="o">-</span><span class="n">n</span> <span class="n">docker</span> <span class="n">store</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">xfs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">store</span><span class="o">/</span><span class="n">docker</span>
</pre></div>
</div>
</li>
<li><p>停止libvirt，将磁盘卷迁移到LVM卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">libvirtd</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">virtlogd</span>
</pre></div>
</div>
</li>
</ul>
<p>此时还会提示有sockect没有停止:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ne">Warning</span><span class="p">:</span> <span class="n">Stopping</span> <span class="n">virtlogd</span><span class="o">.</span><span class="n">service</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="n">can</span> <span class="n">still</span> <span class="n">be</span> <span class="n">activated</span> <span class="n">by</span><span class="p">:</span>
  <span class="n">virtlogd</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">socket</span>
  <span class="n">virtlogd</span><span class="o">.</span><span class="n">socket</span>
</pre></div>
</div>
<p>停止对应socket:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">virtlogd</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">socket</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">virtlogd</span><span class="o">.</span><span class="n">socket</span>
</pre></div>
</div>
<p>此外还需要停止virtlockd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">virtlockd</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">virtlockd</span><span class="o">.</span><span class="n">socket</span>
</pre></div>
</div>
<ul>
<li><p>此时确保 <code class="docutils literal notranslate"><span class="pre">lsof</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">libvirt</span></code> 没有输出之后，才可以迁移 <code class="docutils literal notranslate"><span class="pre">/var/lib/libvirt</span></code> 内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">.</span><span class="n">bak</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span>

<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">store</span><span class="o">/</span><span class="n">libvirt</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span>

<span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">.</span><span class="n">bak</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">cf</span> <span class="o">-</span> <span class="o">.</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">xf</span> <span class="o">-</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>同理迁移 docker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">bak</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span>

<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">store</span><span class="o">/</span><span class="n">docker</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span>

<span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">bak</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">cf</span> <span class="o">-</span> <span class="o">.</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">xf</span> <span class="o">-</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>添加 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;/dev/mapper/store-libvirt    /var/lib/libvirt    xfs    defaults    0 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
<span class="n">echo</span> <span class="s1">&#39;/dev/mapper/store-docker     /var/lib/docker     xfs    defaults    0 1&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
</pre></div>
</div>
</li>
<li><p>恢复libvirt 和 docker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">libvirtd</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">docker</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>