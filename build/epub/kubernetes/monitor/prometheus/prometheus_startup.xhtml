<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Prometheus快速起步</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="prometheus">
<span id="prometheus-startup"></span><h1>Prometheus快速起步</h1>
<section id="id1">
<h2>安装</h2>
<p>Prometheus官方网站提供下载 <a class="reference external" href="https://prometheus.io/download/">https://prometheus.io/download/</a> ，可以获得不同平台 （macOS, Linux, Windows）的版本:</p>
<ul class="simple">
<li><p>prometheus</p></li>
<li><p>alertmanager</p></li>
<li><p>不同的exporter</p></li>
</ul>
<p>提供给了二进制程序和 <a class="reference external" href="https://hub.docker.com/u/prom">Prometheus Docker镜像</a><span class="link-target"> [https://hub.docker.com/u/prom]</span></p>
</section>
<section id="arm">
<h2>ARM环境安装</h2>
<p>我的实践在 <a class="reference internal" href="../../arm/arm_k8s.xhtml#arm-k8s"><span class="std std-ref">ARM部署Kubernetes</span></a> 的 <a class="reference internal" href="../../../arm/raspberry_pi/index.xhtml#raspberry-pi"><span class="std std-ref">Raspberry Pi</span></a> 主机上完成，所以安装的是 <code class="docutils literal notranslate"><span class="pre">arm64</span></code> 版本。</p>
<ul>
<li><p>下载软件包并解压缩:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="mf">26.0</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="mf">2.26</span><span class="o">.</span><span class="mf">0.</span><span class="n">linux</span><span class="o">-</span><span class="n">arm64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">tar</span> <span class="n">xfz</span> <span class="n">prometheus</span><span class="o">-</span><span class="mf">2.26</span><span class="o">.</span><span class="mf">0.</span><span class="n">linux</span><span class="o">-</span><span class="n">arm64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="n">prometheus</span><span class="o">-</span><span class="mf">2.26</span><span class="o">.</span><span class="mf">0.</span><span class="n">linux</span><span class="o">-</span><span class="n">arm64</span><span class="o">/</span><span class="n">prometheus</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="n">prometheus</span><span class="o">-</span><span class="mf">2.26</span><span class="o">.</span><span class="mf">0.</span><span class="n">linux</span><span class="o">-</span><span class="n">arm64</span><span class="o">/</span><span class="n">promtool</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p>检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prometheus</span> <span class="o">--</span><span class="n">version</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Prometheus甚至可以通过 <a class="reference internal" href="../../../apple/studio/homebrew.xhtml#homebrew"><span class="std std-ref">Homebrew</span></a> 安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">brew</span> <span class="n">install</span> <span class="n">prometheus</span>
</pre></div>
</div>
</div>
</section>
<section id="id2">
<h2>配置</h2>
<p>在解压缩的Prometheus软件包目录下有一个默认配置文件 <code class="docutils literal notranslate"><span class="pre">prometheus.yml</span></code> ，这个初始配置复制到 <code class="docutils literal notranslate"><span class="pre">/etc/prometheus</span></code> 目录下然后简单配置就可以启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>配置</h2>
<p>在解压缩的Prometheus软件包目录下有一个默认配置文件 <code class="docutils literal notranslate"><span class="pre">prometheus.yml</span></code> ，这个初始配置复制到 <code class="docutils literal notranslate"><span class="pre">/etc/prometheus</span></code> 目录下然后简单配置就可以启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span>
</pre></div>
</div>
</section>
<section id="id4">
<h2>配置</h2>
<p>在解压缩的Prometheus软件包目录下有一个默认配置文件 <code class="docutils literal notranslate"><span class="pre">prometheus.yml</span></code> ，这个初始配置复制到 <code class="docutils literal notranslate"><span class="pre">/etc/prometheus</span></code> 目录下然后简单配置就可以启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span>
</pre></div>
</div>
<p>默认配置启动运行在 <code class="docutils literal notranslate"><span class="pre">localhost:9090</span></code> 并且只监听本机:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scrape_configs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="s1">&#39;prometheus&#39;</span>
    <span class="n">static_configs</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">targets</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;localhost:9090&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prometheus</span> <span class="o">--</span><span class="n">config</span><span class="o">.</span><span class="n">file</span> <span class="s2">&quot;/etc/prometheus/prometheus.yml&quot;</span>
</pre></div>
</div>
<p>如果发生异常，则可以使用 <code class="docutils literal notranslate"><span class="pre">prometool</span></code> 工具检查配置文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">promtool</span> <span class="n">check</span> <span class="n">config</span> <span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</section>
<section id="dockerprometheus">
<h2>Docker运行Prometheus</h2>
<p>官方提供了Prometheus Docker镜像，简单运行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">p</span> <span class="mi">9090</span><span class="p">:</span><span class="mi">9090</span> <span class="n">prom</span><span class="o">/</span><span class="n">prometheus</span>
</pre></div>
</div>
<p>不过，上述命令使用默认配置启动，所以需要提供自定义配置和数据存储，所以可以采用如下方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">p</span> <span class="mi">9090</span><span class="p">:</span><span class="mi">9090</span> <span class="o">-</span><span class="n">v</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">/</span><span class="n">prometheus</span><span class="o">.</span><span class="n">yml</span> <span class="n">prom</span><span class="o">/</span><span class="n">prometheus</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2>访问Prometheus</h2>
<p>请注意，上述简单的实践是将Prometheus启动监听在本地回环地址 <code class="docutils literal notranslate"><span class="pre">localhost:9090</span></code> ，所以一般外部就不能访问。这样带来一定的安全保护。</p>
<p>我们可以通过ssh端口转发方式实现远程访问，就是在客户端执行以下命令访问服务器 <code class="docutils literal notranslate"><span class="pre">192.168.6.11</span></code> 开启端口转发到服务器的回环地址 <code class="docutils literal notranslate"><span class="pre">9090</span></code> 端口:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">L</span> <span class="mi">9090</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9090</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span>
</pre></div>
</div>
<p>或者配置 <code class="docutils literal notranslate"><span class="pre">.ssh/config</span></code> 配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="n">prometheus</span>
    <span class="n">HostName</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span>
    <span class="n">User</span> <span class="n">admin</span>
    <span class="n">LocalForward</span> <span class="mi">9090</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">9090</span>
</pre></div>
</div>
<p>然后直接执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">prometheus</span>
</pre></div>
</div>
<p>通过ssh认证登陆后，在本地通过浏览器访问 <a class="reference external" href="http:://127.0.0.1:9090/graph">http:://127.0.0.1:9090/graph</a> 就可以看到管理配置界面(访问 <a class="reference external" href="http://127.0.0.1:9090">http://127.0.0.1:9090</a> 也会重定向到 <code class="docutils literal notranslate"><span class="pre">/graph</span></code> 路径)</p>
<p>如果要访问Prometheus服务器自己的metrics，则访问 <a class="reference external" href="http://127.0.0.1:9090/metrics">http://127.0.0.1:9090/metrics</a></p>
</section>
<section id="id6">
<h2>表达式浏览</h2>
<p>在表达式(也就是graph的查询栏输入需要查询的指标)，系统会自动匹配最接近的参数</p>
<p>例如，我们查询 <code class="docutils literal notranslate"><span class="pre">go_gc_duration_seconds</span></code> 指标，输入后点击 <code class="docutils literal notranslate"><span class="pre">Execute</span></code> 按钮执行，就看到:</p>
<figure class="align-default">
<img alt="../../../_images/prometheus_graph_1.png" src="../../../_images/prometheus_graph_1.png" style="width: 400.0px; height: 274.0px;" />
</figure>
<p>我们点击 <code class="docutils literal notranslate"><span class="pre">Graph</span></code> 面板，就可以看到上述 <code class="docutils literal notranslate"><span class="pre">Table</span></code> 表格数据在一段时间，例如1小时以内数据变化趋势:</p>
<figure class="align-default">
<img alt="../../../_images/prometheus_graph_2.png" src="../../../_images/prometheus_graph_2.png" style="width: 357.5px; height: 400.0px;" />
</figure>
<p>Prometheus的PromQL提供了非常灵活的表达式语言，允许查询和聚合指标。</p>
<p>一个简单查询所有带有 <code class="docutils literal notranslate"><span class="pre">quantile=&quot;0.5&quot;</span></code> 标签的追表，则输入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">quantile</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>我们可以看到有很多匹配的metrics:</p>
<figure class="align-default">
<img alt="../../../_images/prometheus_graph_3.png" src="../../../_images/prometheus_graph_3.png" style="width: 400.0px; height: 258.0px;" />
</figure>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>