<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Helm - Kubernetes包管理器</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="helm-kubernetes">
<span id="helm"></span><h1>Helm - Kubernetes包管理器</h1>
<p><a class="reference external" href="https://helm.sh/">Helm (英文原义是”舵”)</a><span class="link-target"> [https://helm.sh/]</span> 是用来管理Kubernetes应用程序的包管理器，Helm Charts 可以用于定义、安装以及更新复杂的Kubernetes应用程序。最新的Helm由 <a class="reference external" href="https://www.cncf.io/">CNCF</a><span class="link-target"> [https://www.cncf.io/]</span> 负责维护，由微软、Google，Bitnami以及Helm社区合作。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Helm是Kubernetes应用程序定义和安装、更新的管理器，而 Operator 是Kubernetes定义和部署工具。那么两者有什么区别和使用场景的不同呢？ 在Haker News上有一个 <a class="reference external" href="https://news.ycombinator.com/item?id=16969495">Can anyone talk about the positives/negatives of Operators v/s Helm Charts?</a><span class="link-target"> [https://news.ycombinator.com/item?id=16969495]</span> 的讨论</p>
<p><a class="reference external" href="https://medium.com/&#64;cloudark/why-to-write-kubernetes-operators-9b1e32a24814">Comparing Kubernetes Operator Pattern with alternatives</a><span class="link-target"> [https://medium.com/&#64;cloudark/why-to-write-kubernetes-operators-9b1e32a24814]</span> 对比了Operator和Helm在实践Postgres数据库的不同点，可以参考。</p>
</div>
<p>Helm分为客户端Helm (运行在你的客户端电脑，有多种版本) 和集群服务器端组件Tiller (运行在Kubernetes集群)</p>
<section id="id2">
<h2>安装Helm</h2>
<section id="id3">
<h3>二进制执行程序安装</h3>
<p><a class="reference external" href="https://github.com/helm/helm/releases">Helm的release</a><span class="link-target"> [https://github.com/helm/helm/releases]</span> 提供了不同操作系统的二进制执行程序，可以手工下载进行安装:</p>
<ul>
<li><p>在 macOS 安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">get</span><span class="o">.</span><span class="n">helm</span><span class="o">.</span><span class="n">sh</span><span class="o">/</span><span class="n">helm</span><span class="o">-</span><span class="n">v2</span><span class="o">.</span><span class="mf">14.1</span><span class="o">-</span><span class="n">darwin</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">zxvf</span> <span class="n">helm</span><span class="o">-</span><span class="n">v2</span><span class="o">.</span><span class="mf">14.1</span><span class="o">-</span><span class="n">darwin</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="n">darwin</span><span class="o">-</span><span class="n">amd64</span><span class="o">/</span><span class="n">helm</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">helm</span>
</pre></div>
</div>
</li>
<li><p>在 Linux 安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">get</span><span class="o">.</span><span class="n">helm</span><span class="o">.</span><span class="n">sh</span><span class="o">/</span><span class="n">helm</span><span class="o">-</span><span class="n">v2</span><span class="o">.</span><span class="mf">14.1</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">zxvf</span> <span class="n">helm</span><span class="o">-</span><span class="n">v2</span><span class="o">.</span><span class="mf">14.1</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="n">linux</span><span class="o">-</span><span class="n">amd64</span><span class="o">/</span><span class="n">helm</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">helm</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>其他操作系统二进制版本安装方法类似</p>
</div>
</section>
<section id="id4">
<h3>脚本安装</h3>
<p><a class="reference external" href="https://git.io/get_helm.sh">https://git.io/get_helm.sh</a> 提供了安装脚本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">get_helm</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span> <span class="mi">700</span> <span class="n">get_helm</span><span class="o">.</span><span class="n">sh</span>
<span class="o">./</span><span class="n">get_helm</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>当然，你也可以直接运行命令 <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-L</span> <span class="pre">https://git.io/get_helm.sh</span> <span class="pre">|</span> <span class="pre">bash</span></code> 。</p>
<p>需要注意的是，上述网站访问可能需要翻墙。</p>
</section>
</section>
<section id="tiller">
<h2>安装Tiller</h2>
<p>Tiller是 <code class="docutils literal notranslate"><span class="pre">helm</span></code> 命令的集群端组件，用于接收 <code class="docutils literal notranslate"><span class="pre">helm</span></code> 的命令并直接和Kubernetes API通讯以实际执行创建或删除资源的工作。大多数云平台激活了称为基于角色的访问控制(Role-Based Access Control, RBAC)功能。这种环境下，为了能够给予 Tiller 足够权限，可以使用 Kubernetes <code class="docutils literal notranslate"><span class="pre">serviceaccount</span></code> 资源。</p>
<p>最简单的在集群上安装 <code class="docutils literal notranslate"><span class="pre">tiller</span></code> 是使用 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">init</span></code> 命令，该命令会校验 <code class="docutils literal notranslate"><span class="pre">helm</span></code> 的本地环境以便正确设置。然后会连接到 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> 默认连接的集群( 通过 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">config</span> <span class="pre">view</span></code> 可以看到当前默认配置连接的集群 )，一旦正确连接到集群，就会在  <code class="docutils literal notranslate"><span class="pre">kube-system</span></code> 名字空间中安装 <code class="docutils literal notranslate"><span class="pre">tiller</span></code> 。</p>
<ul>
<li><p>检查本地 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> 连接的默认集群:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">config</span> <span class="n">view</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>请检查当前连接集群 <code class="docutils literal notranslate"><span class="pre">current-context</span></code> 是否正确，如果是多个集群，需要使用 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">config</span> <span class="pre">set</span> <span class="pre">current-context</span> <span class="pre">my-context</span></code> 切换。</p>
</div>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">kube-system</span></code> 名字空间创建 <code class="docutils literal notranslate"><span class="pre">tiller</span></code> 的 <code class="docutils literal notranslate"><span class="pre">serviceaccount</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">create</span> <span class="n">serviceaccount</span> <span class="n">tiller</span>
</pre></div>
</div>
</li>
<li><p>将 <code class="docutils literal notranslate"><span class="pre">tiller</span></code> 这个 <code class="docutils literal notranslate"><span class="pre">serviceaccount</span></code> 绑定到 <code class="docutils literal notranslate"><span class="pre">cluster-admin</span></code> 角色:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span> <span class="n">tiller</span> <span class="o">--</span><span class="n">clusterrole</span> <span class="n">cluster</span><span class="o">-</span><span class="n">admin</span> <span class="o">--</span><span class="n">serviceaccount</span><span class="o">=</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="p">:</span><span class="n">tiller</span>
</pre></div>
</div>
</li>
<li><p>执行 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">init</span></code> 则将 <code class="docutils literal notranslate"><span class="pre">tiller</span></code> 安装到集群中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">init</span> <span class="o">--</span><span class="n">service</span><span class="o">-</span><span class="n">account</span> <span class="n">tiller</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>注意默认Tiller部署采用的是非安全的 <code class="docutils literal notranslate"><span class="pre">allow</span> <span class="pre">unauthenticated</span> <span class="pre">users</span></code> 策略，为避免这个问题，请在运行 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">init</span></code> 命令时添加参数 <code class="docutils literal notranslate"><span class="pre">--tiller-tls-verify</span></code> 。这里我是测试环境验证，后续生产环境部署需要改进。</p>
</div>
<ul>
<li><p>安装完成后检查验证 tiller 运行，注意在kubernetes集群中的 <code class="docutils literal notranslate"><span class="pre">kube-system</span></code> namespace有新的pod名为 <code class="docutils literal notranslate"><span class="pre">tiller-deploy-xxxx</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                                   <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="o">...</span>
<span class="n">tiller</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="mi">9</span><span class="n">bf6fb76d</span><span class="o">-</span><span class="n">lj2dx</span>          <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">m1s</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>使用helm的实践待续…</p>
</div>
</section>
<section id="id5">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-software-on-kubernetes-clusters-with-the-helm-package-manager">How To Install Software on Kubernetes Clusters with the Helm Package Manager</a><span class="link-target"> [https://www.digitalocean.com/community/tutorials/how-to-install-software-on-kubernetes-clusters-with-the-helm-package-manager]</span></p></li>
<li><p><a class="reference external" href="https://helm.sh/docs/">Helm Documentation</a><span class="link-target"> [https://helm.sh/docs/]</span></p></li>
<li><p><a class="reference external" href="https://whmzsu.github.io/helm-doc-zh-cn/">Helm User Guide - Helm 用户指南</a><span class="link-target"> [https://whmzsu.github.io/helm-doc-zh-cn/]</span> - 官方 <a class="reference external" href="https://helm.sh/docs/">Helm Documentation</a><span class="link-target"> [https://helm.sh/docs/]</span> 的中文翻译，方便快速学习</p></li>
<li><p><a class="reference external" href="https://jimmysong.io/posts/manage-kubernetes-native-app-with-helm/">使用Helm管理kubernetes原生应用</a><span class="link-target"> [https://jimmysong.io/posts/manage-kubernetes-native-app-with-helm/]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>