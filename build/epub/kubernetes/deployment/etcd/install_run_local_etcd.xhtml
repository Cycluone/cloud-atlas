<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>安装运行本地etcd</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="etcd">
<span id="install-run-local-etcd"></span><h1>安装运行本地etcd</h1>
<p>一个集群中etcd服务的运行数量必须是奇数才能保证稳定。在开发测试环境，可以本地运行一个单一节点单服务 etcd或者一个单机节点etcd集群用于验证功能。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>本文实践是开发测试环境单机运行，服务监听 127.0.0.1 端口，所以没有任何安全加密认证，仅供测试。</p>
</div>
<section id="linuxetcd">
<span id="install-etcd-linux"></span><h2>Linux安装etcd</h2>
<ul>
<li><p>执行以下安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ETCD_VER=v3.4.7

# choose either URL
GOOGLE_URL=https://storage.googleapis.com/etcd
GITHUB_URL=https://github.com/etcd-io/etcd/releases/download
DOWNLOAD_URL=${GOOGLE_URL}

rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
rm -rf /tmp/etcd-download-test &amp;&amp; mkdir -p /tmp/etcd-download-test

curl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
tar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1
rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz

/tmp/etcd-download-test/etcd --version
/tmp/etcd-download-test/etcdctl version

sudo cp /tmp/etcd-download-test/etcd /usr/local/sbin/etcd
sudo cp /tmp/etcd-download-test/etcdctl /usr/local/bin/etcdctl
</pre></div>
</div>
</li>
</ul>
</section>
<section id="macoslocal-etcd">
<h2>macOS安装local etcd</h2>
<ul>
<li><p>执行以下安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ETCD_VER=v3.4.7

# choose either URL
GOOGLE_URL=https://storage.googleapis.com/etcd
GITHUB_URL=https://github.com/etcd-io/etcd/releases/download
DOWNLOAD_URL=${GOOGLE_URL}

rm -f /tmp/etcd-${ETCD_VER}-darwin-amd64.zip
rm -rf /tmp/etcd-download-test &amp;&amp; mkdir -p /tmp/etcd-download-test

curl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-darwin-amd64.zip -o /tmp/etcd-${ETCD_VER}-darwin-amd64.zip
unzip /tmp/etcd-${ETCD_VER}-darwin-amd64.zip -d /tmp &amp;&amp; rm -f /tmp/etcd-${ETCD_VER}-darwin-amd64.zip
mv /tmp/etcd-${ETCD_VER}-darwin-amd64/* /tmp/etcd-download-test &amp;&amp; rm -rf /tmp/etcd-${ETCD_VER}-darwin-amd64

/tmp/etcd-download-test/etcd --version
/tmp/etcd-download-test/etcdctl version

sudo cp /tmp/etcd-download-test/etcd /usr/local/sbin/etcd
sudo cp /tmp/etcd-download-test/etcdctl /usr/local/bin/etcdctl
</pre></div>
</div>
</li>
</ul>
</section>
<section id="local-single-etcd">
<h2>验证local single etcd</h2>
<ul>
<li><p>执行以下命令验证本地运行etcd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># start a local etcd server</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">etcd</span>

<span class="c1"># write,read to etcd</span>
<span class="n">etcdctl</span> <span class="o">--</span><span class="n">endpoints</span><span class="o">=</span><span class="n">localhost</span><span class="p">:</span><span class="mi">2379</span> <span class="n">put</span> <span class="n">foo</span> <span class="n">bar</span>
<span class="n">etcdctl</span> <span class="o">--</span><span class="n">endpoints</span><span class="o">=</span><span class="n">localhost</span><span class="p">:</span><span class="mi">2379</span> <span class="n">get</span> <span class="n">foo</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id1">
<h2>运行本地etcd集群</h2>
<ul>
<li><p>安装 <a class="reference external" href="https://github.com/mattn/goreman">goreman</a><span class="link-target"> [https://github.com/mattn/goreman]</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">go</span> <span class="n">get</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">mattn</span><span class="o">/</span><span class="n">goreman</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">go</span> <span class="pre">get</span></code> 是标准的下载和安装软件包和依赖的命令，安装执行程序位于 <code class="docutils literal notranslate"><span class="pre">~/go/bin</span></code> 目录。</p>
<p>参考 <a class="reference external" href="https://nanxiao.gitbooks.io/golang-101-hacks/content/posts/go-get-command.html">“go get” command</a><span class="link-target"> [https://nanxiao.gitbooks.io/golang-101-hacks/content/posts/go-get-command.html]</span></p>
</div>
<ul>
<li><p>下载etcd提供的学习案例 Procfile.learner</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">etcd</span><span class="o">-</span><span class="n">io</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">Procfile</span> <span class="o">-</span><span class="n">o</span> <span class="o">~/</span><span class="n">go</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">Procfile</span><span class="o">.</span><span class="n">learner</span>
</pre></div>
</div>
</li>
<li><p>修改一下 Procfile.learner ，将 <code class="docutils literal notranslate"><span class="pre">bin/etcd</span></code> 修改成 <code class="docutils literal notranslate"><span class="pre">/usr/local/sbin/etcd</span></code> ，并且启动一个proxy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use goreman to run `go get github.com/mattn/goreman`</span>
<span class="n">etcd1</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">etcd</span> <span class="o">--</span><span class="n">name</span> <span class="n">infra1</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">2379</span> <span class="o">--</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">2379</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">12380</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">advertise</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">12380</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">token</span> <span class="n">etcd</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span> <span class="s1">&#39;infra1=http://127.0.0.1:12380,infra2=http://127.0.0.1:22380,infra3=http://127.0.0.1:32380&#39;</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">state</span> <span class="n">new</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">pprof</span> <span class="o">--</span><span class="n">logger</span><span class="o">=</span><span class="n">zap</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">outputs</span><span class="o">=</span><span class="n">stderr</span>
<span class="n">etcd2</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">etcd</span> <span class="o">--</span><span class="n">name</span> <span class="n">infra2</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">22379</span> <span class="o">--</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">22379</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">22380</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">advertise</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">22380</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">token</span> <span class="n">etcd</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span> <span class="s1">&#39;infra1=http://127.0.0.1:12380,infra2=http://127.0.0.1:22380,infra3=http://127.0.0.1:32380&#39;</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">state</span> <span class="n">new</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">pprof</span> <span class="o">--</span><span class="n">logger</span><span class="o">=</span><span class="n">zap</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">outputs</span><span class="o">=</span><span class="n">stderr</span>
<span class="n">etcd3</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">etcd</span> <span class="o">--</span><span class="n">name</span> <span class="n">infra3</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">32379</span> <span class="o">--</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">32379</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">32380</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">advertise</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">32380</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">token</span> <span class="n">etcd</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span> <span class="s1">&#39;infra1=http://127.0.0.1:12380,infra2=http://127.0.0.1:22380,infra3=http://127.0.0.1:32380&#39;</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">state</span> <span class="n">new</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">pprof</span> <span class="o">--</span><span class="n">logger</span><span class="o">=</span><span class="n">zap</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">outputs</span><span class="o">=</span><span class="n">stderr</span>

<span class="n">proxy</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">etcd</span> <span class="n">grpc</span><span class="o">-</span><span class="n">proxy</span> <span class="n">start</span> <span class="o">--</span><span class="n">endpoints</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">2379</span><span class="p">,</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">22379</span><span class="p">,</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">32379</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">addr</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">23790</span> <span class="o">--</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">url</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">23790</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">pprof</span>

<span class="c1"># A learner node can be started using Procfile.learner</span>
</pre></div>
</div>
</li>
<li><p>启动本地etcd集群:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">goreman</span> <span class="o">-</span><span class="n">f</span> <span class="o">./</span><span class="n">Procfile</span><span class="o">.</span><span class="n">learner</span> <span class="n">start</span>
</pre></div>
</div>
</li>
<li><p>现在可以通过etcd-proxy入口来访问:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">etcdctl</span> <span class="o">--</span><span class="n">endpoints</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">23790</span> <span class="n">put</span> <span class="n">foor</span> <span class="n">bar</span>
<span class="n">etcdctl</span> <span class="o">--</span><span class="n">endpoints</span><span class="o">=</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">23790</span> <span class="n">get</span> <span class="n">foor</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id2">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/etcd-io/etcd/releases">etcd releases</a><span class="link-target"> [https://github.com/etcd-io/etcd/releases]</span></p></li>
<li><p><a class="reference external" href="https://github.com/etcd-io/etcd">github etcd</a><span class="link-target"> [https://github.com/etcd-io/etcd]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>