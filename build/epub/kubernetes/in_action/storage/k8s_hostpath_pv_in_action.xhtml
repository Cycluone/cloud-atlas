<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Kubernetes hostPath持久化卷实践</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="kubernetes-hostpath">
<span id="k8s-hostpath-pv-in-action"></span><h1>Kubernetes hostPath持久化卷实践</h1>
<section id="id1">
<h2>持久化卷部署步骤概述</h2>
<p>部署Kubernetes持久化卷步骤如下:</p>
<ul class="simple">
<li><p>系统管理员创建一个 持久化卷 (Persistent Volumes, PV)</p></li>
<li><p>开发人员创建一个 持久化卷申明 (Persistent Volumes Claim, PVC)</p></li>
<li><p>在POD中引用这个申明(claim)，则一旦这个claim被批准，POD就可以使用这个卷</p></li>
</ul>
<figure class="align-default">
<img alt="../../../_images/k8s_pod_with_pv_pvc.png" src="../../../_images/k8s_pod_with_pv_pvc.png" style="width: 614.4px; height: 286.8px;" />
</figure>
</section>
<section id="id2">
<h2>准备工作</h2>
<p>我的测试环境基于 <a class="reference internal" href="../../arm/arm_k8s_deploy.xhtml#arm-k8s-deploy"><span class="std std-ref">部署ARM架构Kubernetes</span></a> 的集群，当前已经部署了3个 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code> namespace中的pod。在本次实践中，将创建持久化卷挂载到容器中测试。</p>
<ul>
<li><p>检查节点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">nodes</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
</li>
</ul>
<p>输出信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>         <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>    <span class="n">VERSION</span>   <span class="n">INTERNAL</span><span class="o">-</span><span class="n">IP</span>    <span class="n">EXTERNAL</span><span class="o">-</span><span class="n">IP</span>   <span class="n">OS</span><span class="o">-</span><span class="n">IMAGE</span>             <span class="n">KERNEL</span><span class="o">-</span><span class="n">VERSION</span>     <span class="n">CONTAINER</span><span class="o">-</span><span class="n">RUNTIME</span>
<span class="n">jetson</span>       <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">40</span><span class="n">h</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>   <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.10</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="n">Ubuntu</span> <span class="mf">18.04</span><span class="o">.</span><span class="mi">5</span> <span class="n">LTS</span>   <span class="mf">4.9</span><span class="o">.</span><span class="mi">140</span><span class="o">-</span><span class="n">tegra</span>      <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="mf">19.3</span><span class="o">.</span><span class="mi">6</span>
<span class="n">pi</span><span class="o">-</span><span class="n">master1</span>   <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">8</span><span class="n">d</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>   <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="n">Ubuntu</span> <span class="mf">20.04</span><span class="o">.</span><span class="mi">1</span> <span class="n">LTS</span>   <span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">1022</span><span class="o">-</span><span class="n">raspi</span>   <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="mf">19.3</span><span class="o">.</span><span class="mi">8</span>
<span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">5</span><span class="n">d4h</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>   <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="n">Ubuntu</span> <span class="mf">20.04</span><span class="o">.</span><span class="mi">1</span> <span class="n">LTS</span>   <span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">1022</span><span class="o">-</span><span class="n">raspi</span>   <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="mf">19.3</span><span class="o">.</span><span class="mi">8</span>
<span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">5</span><span class="n">d4h</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>   <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="n">Ubuntu</span> <span class="mf">20.04</span><span class="o">.</span><span class="mi">1</span> <span class="n">LTS</span>   <span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">1022</span><span class="o">-</span><span class="n">raspi</span>   <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="mf">19.3</span><span class="o">.</span><span class="mi">8</span>
</pre></div>
</div>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code> namespace的pod:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
</li>
</ul>
<p>输出信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                           <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">IP</span>             <span class="n">NODE</span>         <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">dd569645</span><span class="o">-</span><span class="n">q9hzc</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">39</span><span class="n">h</span>     <span class="mf">10.244</span><span class="o">.</span><span class="mf">5.161</span>   <span class="n">jetson</span>       <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">dd569645</span><span class="o">-</span><span class="n">s5qb5</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">d18h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">2.2</span>     <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">dd569645</span><span class="o">-</span><span class="n">v9zxt</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">d18h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">1.2</span>     <span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul>
<li><p>登陆检查 <code class="docutils literal notranslate"><span class="pre">pi-worker1</span></code> 上的pod <code class="docutils literal notranslate"><span class="pre">kube-verify-69dd569645-v9zxt</span></code> 确认存储情况:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">dd569645</span><span class="o">-</span><span class="n">v9zxt</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
</li>
</ul>
<p>然后检查磁盘 <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">-h</span></code> 看到如下信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filesystem</span>      <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="n">overlay</span>          <span class="mi">32</span><span class="n">G</span>  <span class="mf">4.9</span><span class="n">G</span>   <span class="mi">26</span><span class="n">G</span>  <span class="mi">17</span><span class="o">%</span> <span class="o">/</span>
<span class="n">tmpfs</span>            <span class="mi">64</span><span class="n">M</span>     <span class="mi">0</span>   <span class="mi">64</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span>
<span class="n">tmpfs</span>           <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>        <span class="mi">32</span><span class="n">G</span>  <span class="mf">4.9</span><span class="n">G</span>   <span class="mi">26</span><span class="n">G</span>  <span class="mi">17</span><span class="o">%</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="n">shm</span>              <span class="mi">64</span><span class="n">M</span>     <span class="mi">0</span>   <span class="mi">64</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
<span class="n">tmpfs</span>           <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">12</span><span class="n">K</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span>
<span class="n">tmpfs</span>           <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">scsi</span>
<span class="n">tmpfs</span>           <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
</section>
<section id="persistent-volume">
<h2>创建持久化卷(persistent Volume)</h2>
<ul>
<li><p>在主机上创建一个persistent volume:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">pv</span><span class="o">/</span><span class="n">hostpath</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">vol</span>
<span class="n">chcon</span> <span class="o">-</span><span class="n">Rt</span> <span class="n">svirt_sandbox_file_t</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">pv</span><span class="o">/</span><span class="n">hostpath</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">vol</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>执行 <code class="docutils literal notranslate"><span class="pre">chcon</span> <span class="pre">-Rt</span> <span class="pre">svirt_sandbox_file_t</span> <span class="pre">&lt;PATH&gt;</span></code> 报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chcon</span><span class="p">:</span> <span class="n">can</span><span class="s1">&#39;t apply partial context to unlabeled file &#39;</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">pv</span><span class="o">/</span><span class="n">hostpath</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">vol</span><span class="s1">&#39;</span>
</pre></div>
</div>
</div>
</section>
<section id="id3">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/">Configure a Pod to Use a PersistentVolume for Storage</a><span class="link-target"> [https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/]</span></p></li>
<li><p><a class="reference external" href="https://vocon-it.com/2018/12/10/kubernetes-4-persistent-volumes-hello-world/">Kubernetes (4): Persistent Volumes – Hello World</a><span class="link-target"> [https://vocon-it.com/2018/12/10/kubernetes-4-persistent-volumes-hello-world/]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>