<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>安全地清空一个Kubernetes节点</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="kubernetes">
<span id="drain-node"></span><h1>安全地清空一个Kubernetes节点</h1>
<p>当我们需要下线一个Kubernetes节点前，我们需要先把节点上的pods都驱逐 <code class="docutils literal notranslate"><span class="pre">evict</span></code> 出去。Kubernetes提供了一个简单的不需要指定pods的驱逐方法，就是 <code class="docutils literal notranslate"><span class="pre">drain</span></code> 节点。Kubernetes提供了一个简单的不需要指定pods的驱逐方法，就是 <code class="docutils literal notranslate"><span class="pre">drain</span></code> 节点。</p>
<ul>
<li><p>举例，我们清空节点 <code class="docutils literal notranslate"><span class="pre">jetson</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">drain</span> <span class="n">jetson</span> <span class="o">--</span><span class="n">delete</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">data</span> <span class="o">--</span><span class="n">force</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">daemonsets</span>
</pre></div>
</div>
</li>
</ul>
<p>此时会提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span><span class="o">/</span><span class="n">jetson</span> <span class="n">cordoned</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">ignoring</span> <span class="n">DaemonSet</span><span class="o">-</span><span class="n">managed</span> <span class="n">Pods</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">arm64</span><span class="o">-</span><span class="n">f6z9b</span><span class="p">,</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">rxw88</span><span class="p">,</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="mi">8</span><span class="n">lclg</span>
<span class="n">evicting</span> <span class="n">pod</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">dd569645</span><span class="o">-</span><span class="n">q24vf</span>
<span class="n">pod</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">dd569645</span><span class="o">-</span><span class="n">q24vf</span> <span class="n">evicted</span>
<span class="n">node</span><span class="o">/</span><span class="n">jetson</span> <span class="n">evicted</span>
</pre></div>
</div>
<section id="drain">
<h2>恢复drain节点</h2>
<p>如果Kubernetes节点已经修复完成，确定节点可以恢复调度，则执行 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">uncordon</span></code> 来恢复节点(这个指令实际上是常用的 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">cordon</span></code> 的逆反):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">uncordon</span> <span class="n">jetson</span>
</pre></div>
</div>
<p>此时会看到输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span><span class="o">/</span><span class="n">jetson</span> <span class="n">uncordoned</span>
</pre></div>
</div>
<p>再次检查节点 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">-o</span> <span class="pre">wide</span></code> 会看到jetson节点恢复调度:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>         <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>     <span class="n">VERSION</span>   <span class="n">INTERNAL</span><span class="o">-</span><span class="n">IP</span>    <span class="n">EXTERNAL</span><span class="o">-</span><span class="n">IP</span>   <span class="n">OS</span><span class="o">-</span><span class="n">IMAGE</span>             <span class="n">KERNEL</span><span class="o">-</span><span class="n">VERSION</span>     <span class="n">CONTAINER</span><span class="o">-</span><span class="n">RUNTIME</span>
<span class="n">jetson</span>       <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">59</span><span class="n">m</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>   <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.10</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="n">Ubuntu</span> <span class="mf">18.04</span><span class="o">.</span><span class="mi">5</span> <span class="n">LTS</span>   <span class="mf">4.9</span><span class="o">.</span><span class="mi">140</span><span class="o">-</span><span class="n">tegra</span>      <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="mf">19.3</span><span class="o">.</span><span class="mi">6</span>
</pre></div>
</div>
</section>
<section id="id1">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/">Safely Drain a Node</a><span class="link-target"> [https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>