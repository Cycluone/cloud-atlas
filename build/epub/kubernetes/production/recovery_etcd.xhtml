<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>etcd故障恢复</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="etcd">
<span id="recovery-etcd"></span><h1>etcd故障恢复</h1>
<p>etcd被设计成在服务器故障时依然可用，etcd集群会自动从临时故障中恢复（例如主机重启）并且可以承受最多 <code class="docutils literal notranslate"><span class="pre">(N-1)/2</span></code> 节点的持续故障（N表示集群etcd节点数量）。当etcd成员服务器永久性故障，无论是硬件或磁盘故障，就会和集群失去联系。需要注意，当出现超过 <code class="docutils literal notranslate"><span class="pre">(N-1)/2</span></code> 节点故障，etcd集群将持续故障，因为集群缺少足够的法定投票。如果投票不足，集群就不能达成一致，这样也就不能更新数据。</p>
<p>为了从灾难性故障中恢复，etcd v3提供了快照(snapshot)和恢复机制，以便能够在丢失v3关键数据时重建集群。</p>
<section id="keyspace">
<h2>keyspace快照</h2>
<p>要恢复一个集群，首先需要从给一个etcd成员服务器上获取keyspace的快照。快照可以从活着的成员服务器上使用 <code class="docutils literal notranslate"><span class="pre">etcdctl</span> <span class="pre">snapshot</span> <span class="pre">save</span></code> 命令获取，也可以从一个 etcd 数据目录中复制 <code class="docutils literal notranslate"><span class="pre">member/snap/db</span></code> 文件来得到。举例，以下通过 <code class="docutils literal notranslate"><span class="pre">$ENDPOINT</span></code> 从keyspace获得快照，存储到文件 <code class="docutils literal notranslate"><span class="pre">snapshot.db</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ETCDCTL_API=3 etcdctl --endpoints $ENDPOINT snapshot save snapshot.db
</pre></div>
</div>
<section id="id1">
<h3>参考</h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/recovery.md">Disaster recovery</a><span class="link-target"> [https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/recovery.md]</span></p></li>
</ul>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>