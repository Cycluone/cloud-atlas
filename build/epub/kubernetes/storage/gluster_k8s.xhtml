<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>在Kubernetes中部署GlusterFS</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="kubernetesglusterfs">
<span id="gluster-k8s"></span><h1>在Kubernetes中部署GlusterFS</h1>
<p>我在 <a class="reference internal" href="../arm/arm_k8s_deploy.xhtml#arm-k8s-deploy"><span class="std std-ref">部署ARM架构Kubernetes</span></a> 后，需要为Kubernetes提供基于GlusterFS的持久化存储。</p>
<p>有两种方式在Kubernetes中提供GlusterFS存储卷服务：</p>
<ul class="simple">
<li><p>方法一：物理主机构建GlusterFS集群以及对应的卷，然后仅在Kubernetes作为客户端挂载已经构建好的GlusterFS卷。这种方式比较接近于传统的GlusterFS集群维护</p></li>
<li><p>方法二：完全采用Kubernetes结合Heketi实现完整的动态创建GlusterFS以及块分配，同时实现支持多个GlusterFS集群管理。这种方式符合Kubernetes原生管理</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在Kubernetes中实现原生管理的另外一个著名开源分布式存储是 <a class="reference internal" href="../../ceph/index.xhtml#ceph"><span class="std std-ref">Ceph Atlas</span></a> ，使用 <a class="reference internal" href="rook/index.xhtml#rook"><span class="std std-ref">Rook - 云原生存储调度器</span></a> 实现云原生管理ceph。</p>
</div>
<p>本文采用手工部署GlusterFS服务，并配置 PV/PVC 提供给Kubernetes使用存储卷。后续在 <a class="reference internal" href="heketi/index.xhtml#heketi"><span class="std std-ref">Heketi - 云原生GlusterFS管理框架</span></a> 实践中介绍如何云原生管理GlusterFS分布式存储。</p>
<section id="glusterfs">
<h2>安装GlusterFS服务器软件</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>本文实践是在树莓派上运行的Ubuntu操作系统上部署GlusterFS集群。Ubuntu Server for Raspberry Pi已经在软件仓库提供了GlusterFS，所以可以跳过添加GlusterFS仓库配置部分。也可以直接添加GlusterFS官方仓库安装最新版本。</p>
</div>
<section id="debian-glusterfs">
<h3>Debian:添加GlusterFS仓库配置</h3>
<ul>
<li><p>添加apt GPG key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">gluster</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pub</span><span class="o">/</span><span class="n">gluster</span><span class="o">/</span><span class="n">glusterfs</span><span class="o">/</span><span class="n">LATEST</span><span class="o">/</span><span class="n">rsa</span><span class="o">.</span><span class="n">pub</span> <span class="o">|</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">-</span>
</pre></div>
</div>
</li>
<li><p>添加apt仓库配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>DEBID=$(grep &#39;VERSION_ID=&#39; /etc/os-release | cut -d &#39;=&#39; -f 2 | tr -d &#39;&quot;&#39;)
DEBVER=$(grep &#39;VERSION=&#39; /etc/os-release | grep -Eo &#39;[a-z]+&#39;)
DEBARCH=$(dpkg --print-architecture)
echo deb https://download.gluster.org/pub/gluster/glusterfs/LATEST/Debian/${DEBID}/${DEBARCH}/apt ${DEBVER} main &gt; /etc/apt/sources.list.d/gluster.list
</pre></div>
</div>
</li>
<li><p>更新软件列表:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">update</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="ubuntu">
<h3>Ubuntu添加软件仓库</h3>
<p>对于Ubuntu系统，请参考 <a class="reference external" href="https://launchpad.net/~gluster">launchpad.net “Gluster” team</a><span class="link-target"> [https://launchpad.net/~gluster]</span> ，提供了最新的GlusterFS 8 / 9 系列。我这里为了简化部署，直接使用了Ubuntu for Raspberry Pi内建提供的GlusterFS 7。</p>
<p>你可以通过上述仓库安装最新版本，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
<span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">gluster</span><span class="o">/</span><span class="n">glusterfs</span><span class="o">-</span><span class="mi">9</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3>安装GlusterFS软件</h3>
<ul>
<li><p>安装软件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">glusterfs</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="id2">
<h2>配置GlusterFS服务器</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里仅做演示，本文暂时采用简单的双节点部署双副本复制卷，提供简单数据冗余。不过双节点服务器容易出现脑裂，实际生产环境建议采用3个节点或跟多节点部署复制卷，或者分布式复制卷。</p>
<p>(取消:这里仅做演示，本文暂时采用简单的双节点部署分布式卷，没有任何数据冗余，不能保证数据安全，请勿直接照搬。)</p>
</div>
<p>演示环境仅有2台节点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span> <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>
</pre></div>
</div>
<ul>
<li><p>启动glusterd服务并配置激活:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">start</span> <span class="n">glusterd</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">glusterd</span>
</pre></div>
</div>
</li>
<li><p>检查服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">status</span> <span class="n">glusterd</span>
<span class="n">glusterfsd</span> <span class="o">--</span><span class="n">version</span>
</pre></div>
</div>
</li>
</ul>
<p>这里安装的版本是 glusterfs 7.2</p>
<ul>
<li><p>在第一台服务器上执行以下命令建立信任存储池:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">peer</span> <span class="n">probe</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span>
</pre></div>
</div>
</li>
</ul>
<p>然后检查对端状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">peer</span> <span class="n">status</span>
</pre></div>
</div>
<p>显示如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Number</span> <span class="n">of</span> <span class="n">Peers</span><span class="p">:</span> <span class="mi">1</span>

<span class="n">Hostname</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span>
<span class="n">Uuid</span><span class="p">:</span> <span class="n">c4d1d2e0</span><span class="o">-</span><span class="mi">460</span><span class="n">c</span><span class="o">-</span><span class="mi">46</span><span class="n">b6</span><span class="o">-</span><span class="n">b9c2</span><span class="o">-</span><span class="n">e908dc140c1a</span>
<span class="n">State</span><span class="p">:</span> <span class="n">Peer</span> <span class="ow">in</span> <span class="n">Cluster</span> <span class="p">(</span><span class="n">Connected</span><span class="p">)</span>
</pre></div>
</div>
<p>检查资源池:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">pool</span> <span class="nb">list</span>
</pre></div>
</div>
<p>显示如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUID</span>                                    <span class="n">Hostname</span>        <span class="n">State</span>
<span class="n">c4d1d2e0</span><span class="o">-</span><span class="mi">460</span><span class="n">c</span><span class="o">-</span><span class="mi">46</span><span class="n">b6</span><span class="o">-</span><span class="n">b9c2</span><span class="o">-</span><span class="n">e908dc140c1a</span>    <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span>    <span class="n">Connected</span>
<span class="mi">61</span><span class="n">a731af</span><span class="o">-</span><span class="mi">19</span><span class="n">af</span><span class="o">-</span><span class="mi">4</span><span class="n">ed3</span><span class="o">-</span><span class="mi">8700</span><span class="o">-</span><span class="mi">4</span><span class="n">adc508f5771</span>    <span class="n">localhost</span>       <span class="n">Connected</span>
</pre></div>
</div>
<ul>
<li><p>在上述2台服务器上同时创建本地目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
<li><p>(重要步骤)修订GluserFS卷的brick目录属主uid/gid，这个uid/gid将和后续容器中运行进程uid/gid匹配，这样才能确保容器挂载的GluserFS卷能够读写:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">groupadd</span> <span class="o">-</span><span class="n">g</span> <span class="mi">590</span> <span class="n">hadoop</span>
<span class="n">useradd</span> <span class="o">-</span><span class="n">g</span> <span class="mi">590</span> <span class="o">-</span><span class="n">u</span> <span class="mi">592</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">yarn</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">-</span><span class="n">m</span> <span class="n">yarn</span>
<span class="n">chown</span> <span class="n">yarn</span><span class="p">:</span><span class="n">hadoop</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>上述修订GlusterFS卷属主是假设我们后续读写该卷的pod的运行属主使用相同的 <code class="docutils literal notranslate"><span class="pre">uid/gid</span></code> (592/590) ，我们假设这个容器中运行的是yarn服务，作为演示。后续定义Pod运行角色的 <code class="docutils literal notranslate"><span class="pre">uid/gid</span></code> 一定要和上述配置一致。</p>
</div>
<ul>
<li><p>选择 <strong>任意一台服务器</strong> 创建双副本卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">create</span> <span class="n">gv0</span> <span class="n">replica</span> <span class="mi">2</span> \
  <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> \
  <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
</li>
</ul>
<p>注意，双节点双副本模式，会提示警告:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Replica 2 volumes are prone to split-brain. Use Arbiter or Replica 3 to avoid this. See: http://docs.gluster.org/en/latest/Administrator%20Guide/Split%20brain%20and%20ways%20to%20deal%20with%20it/.
Do you still want to continue?
 (y/n)
</pre></div>
</div>
<p>此外，直接在根目录下建立glusterfs卷会提示不推荐，需要使用 <code class="docutils literal notranslate"><span class="pre">force</span></code> 参数强制:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volume</span> <span class="n">create</span><span class="p">:</span> <span class="n">gv0</span><span class="p">:</span> <span class="n">failed</span><span class="p">:</span> <span class="n">The</span> <span class="n">brick</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">created</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">root</span> <span class="n">partition</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">recommended</span> <span class="n">that</span> <span class="n">you</span> <span class="n">don</span><span class="s1">&#39;t use the system&#39;</span><span class="n">s</span> <span class="n">root</span> <span class="n">partition</span> <span class="k">for</span> <span class="n">storage</span> <span class="n">backend</span><span class="o">.</span> <span class="n">Or</span> <span class="n">use</span> <span class="s1">&#39;force&#39;</span> <span class="n">at</span> <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">command</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">override</span> <span class="n">this</span> <span class="n">behavior</span><span class="o">.</span>
</pre></div>
</div>
<p>所以实际需要执行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">create</span> <span class="n">gv0</span> <span class="n">replica</span> <span class="mi">2</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span> <span class="n">force</span>
</pre></div>
</div>
<ul>
<li><p>启动卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">start</span> <span class="n">gv0</span>
</pre></div>
</div>
</li>
<li><p>现在检查卷状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gluster</span> <span class="n">volume</span> <span class="n">info</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Volume</span> <span class="n">Name</span><span class="p">:</span> <span class="n">gv0</span>
<span class="n">Type</span><span class="p">:</span> <span class="n">Replicate</span>
<span class="n">Volume</span> <span class="n">ID</span><span class="p">:</span> <span class="mi">73</span><span class="n">f3cb83</span><span class="o">-</span><span class="mi">7</span><span class="n">a31</span><span class="o">-</span><span class="mi">41</span><span class="n">b1</span><span class="o">-</span><span class="n">a49c</span><span class="o">-</span><span class="n">aafd6fc92fd8</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Started</span>
<span class="n">Snapshot</span> <span class="n">Count</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">Bricks</span><span class="p">:</span> <span class="mi">1</span> <span class="n">x</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">Transport</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">tcp</span>
<span class="n">Bricks</span><span class="p">:</span>
<span class="n">Brick1</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Brick2</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">Options</span> <span class="n">Reconfigured</span><span class="p">:</span>
<span class="n">transport</span><span class="o">.</span><span class="n">address</span><span class="o">-</span><span class="n">family</span><span class="p">:</span> <span class="n">inet</span>
<span class="n">storage</span><span class="o">.</span><span class="n">fips</span><span class="o">-</span><span class="n">mode</span><span class="o">-</span><span class="n">rchecksum</span><span class="p">:</span> <span class="n">on</span>
<span class="n">nfs</span><span class="o">.</span><span class="n">disable</span><span class="p">:</span> <span class="n">on</span>
<span class="n">performance</span><span class="o">.</span><span class="n">client</span><span class="o">-</span><span class="n">io</span><span class="o">-</span><span class="n">threads</span><span class="p">:</span> <span class="n">off</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>Kubernetes使用GlusterFS卷</h2>
<section id="gluserfs-client">
<h3>gluserfs-client</h3>
<p>为了能够在Kubernetes集群使用GlusterFS卷，首先需要在Kubernetes的管控节点上安装 <code class="docutils literal notranslate"><span class="pre">gluster-client</span></code> 软件包，因为Kubernetes scheduler需要用来创建gluster卷。</p>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">pi-master1</span></code> 服务器(管控)上执行以下命令安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">glusterfs</span><span class="o">-</span><span class="n">client</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>我这里案例worker节点也是GlusterFS的服务器节点，所以worker节点也就已经在上述部署GlusterFS服务器版本时同时安装了 <code class="docutils literal notranslate"><span class="pre">glusterfs-client</span></code> ，就不需要单独安装了。实际上，在Docker容器中使用GlustrerFS挂载是通过worker服务器先挂载好GlusterFS卷，然后映射到容器内部，所以实际GlusterFS客户端是运行在worker服务器上的。必须在worker服务器上确保安装好 <code class="docutils literal notranslate"><span class="pre">glusterfs-client</span></code> 。</p>
</div>
</section>
<section id="id4">
<h3>持久化卷</h3>
<ul class="simple">
<li><p>创建Service和Endpoints</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-endpoints_kube-verify.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="hll">  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
</span><span class="hll">  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
</span><span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Endpoints</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="hll">  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
</span><span class="hll">  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
</span><span class="nt">subsets</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">addresses</span><span class="p">:</span>
<span class="hll">      <span class="p p-Indicator">-</span> <span class="nt">ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.6.15</span>
</span>    <span class="nt">ports</span><span class="p">:</span>
<span class="hll">      <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
</span>  <span class="p p-Indicator">-</span> <span class="nt">addresses</span><span class="p">:</span>
<span class="hll">      <span class="p p-Indicator">-</span> <span class="nt">ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.6.16</span>
</span>    <span class="nt">ports</span><span class="p">:</span>
<span class="hll">      <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>参数解析:</p>
<blockquote>
<div><ul class="simple">
<li><p>注意 <code class="docutils literal notranslate"><span class="pre">name</span></code> 必须在各个配置中完全匹配</p></li>
<li><p>一定要正确配置 <code class="docutils literal notranslate"><span class="pre">namespace</span></code> (这里案例假设Pod的namespace是kube-verify) : 确保 <code class="docutils literal notranslate"><span class="pre">service</span></code> , <code class="docutils literal notranslate"><span class="pre">endpoints</span></code> 和 Pod 的 <code class="docutils literal notranslate"><span class="pre">namespace</span></code> 完全匹配，因为Pod启动后挂载卷需要找到相同namespace中的 <code class="docutils literal notranslate"><span class="pre">endpoints</span></code> 才能挂载</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ip</span></code> 必须是Gluster存储服务器的实际IP地址，而不是主机名。这里的IP地址可以配置多个GlusterFS服务器节点的IP</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">port</span></code> 号是忽略的，所以这里填写1</p></li>
</ul>
</div></blockquote>
<p>执行创建:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">gluster</span><span class="o">-</span><span class="n">endpoints_kube</span><span class="o">-</span><span class="n">verify</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>检查service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">service</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>              <span class="n">TYPE</span>           <span class="n">CLUSTER</span><span class="o">-</span><span class="n">IP</span>       <span class="n">EXTERNAL</span><span class="o">-</span><span class="n">IP</span>    <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>        <span class="n">AGE</span>
<span class="n">gluster</span><span class="o">-</span><span class="n">cluster</span>   <span class="n">ClusterIP</span>      <span class="mf">10.106</span><span class="o">.</span><span class="mf">245.123</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>         <span class="mi">1</span><span class="o">/</span><span class="n">TCP</span>          <span class="mi">24</span><span class="n">h</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>需要注意每个项目都需要唯一的endpoints，每个项目访问GlusterFS卷都需要自己的Endpoints。</p>
</div>
<ul class="simple">
<li><p>创建一个持久化卷(presistence volume, pv)</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-pv_kube-verify.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="c1"># The name of the PV, which is referenced in pod definitions or displayed in various oc volume commands.</span>
<span class="hll">  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-pv</span>
</span><span class="hll">  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
</span><span class="nt">spec</span><span class="p">:</span>
  <span class="nt">capacity</span><span class="p">:</span>
    <span class="c1"># The amount of storage allocated to this volume.</span>
<span class="hll">    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</span>  <span class="nt">accessModes</span><span class="p">:</span>
    <span class="c1"># labels to match a PV and a PVC. They currently do not define any form of access control.</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
  <span class="c1"># The glusterfs plug-in defines the volume type being used</span>
  <span class="nt">glusterfs</span><span class="p">:</span>
<span class="hll">    <span class="nt">endpoints</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
</span>    <span class="c1"># Gluster volume name, preceded by /</span>
<span class="hll">    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/gv0</span>
</span>    <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="hll">  <span class="c1"># volume reclaim policy indicates that the volume will be preserved after the pods accessing it terminate.</span>
</span>  <span class="c1"># Accepted values include Retain, Delete, and Recycle.</span>
  <span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retain</span>
<span class="hll">  <span class="nt">claimRef</span><span class="p">:</span>
</span><span class="hll">    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
</span><span class="hll">    <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>解析参数:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">metadata.name</span></code> 是在pod定义中使用的卷名字</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metadata.namespace</span></code> 是PV所在的namespace，同样要确保和前面定义的 <code class="docutils literal notranslate"><span class="pre">sevice</span></code> , <code class="docutils literal notranslate"><span class="pre">endpoints</span></code> 以及之后定义的 Pod 的 <code class="docutils literal notranslate"><span class="pre">namespace</span></code> 完全一致</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec.capacity.storage</span></code> 配置卷容量大小</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec.accessMode</span></code> 是用于PV和PVC的标签，定义需要相同，不过当前没有定义任何访问控制</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec.glusterfs.endpoints</span></code> 是访问GlusterFS入口</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec.glusterfs.path</span></code> 定义就是GlusterFS的卷，见上文 <code class="docutils literal notranslate"><span class="pre">pv0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec.claimRef</span></code> 可以不配置，但是为了能够确保和PVC正确关联(虽然默认也能关联)，不重复多个PV链接相同PVC，建议配置</p></li>
</ul>
</div></blockquote>
<p>执行创建PV:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">gluster</span><span class="o">-</span><span class="n">pv_kube</span><span class="o">-</span><span class="n">verify</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<ul class="simple">
<li><p>创建持久化卷声明(persistent volume claim, PVC): 所谓PVC就是指定访问模式和存储容量，这里PVC绑定到前面创建的PV。一旦PV被绑定到一个PVC，这个PV就被绑定到了这个PVC所属项目，也就不能被绑到其他PVC上。这就是 <code class="docutils literal notranslate"><span class="pre">一对一</span></code> 映射PVs和PVCs，不过，在相同项目中的多个Pods可以使用相同PVC。</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-pvc_kube-verify.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="hll">  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
</span><span class="hll">  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
</span><span class="nt">spec</span><span class="p">:</span>
  <span class="nt">accessModes</span><span class="p">:</span>
<span class="hll">  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
</span>  <span class="nt">resources</span><span class="p">:</span>
     <span class="nt">requests</span><span class="p">:</span>
       <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</pre></div>
</td></tr></table></div>
</div>
<p>解析参数:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">metadata.name</span></code> 是在pod定义的 <code class="docutils literal notranslate"><span class="pre">volume</span></code> 段落引用</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metadata.namespace</span></code> 是PVC所在的namespace，要确保和前面定义的 <code class="docutils literal notranslate"><span class="pre">sevice</span></code> , <code class="docutils literal notranslate"><span class="pre">endpoints</span></code> 以及之后定义的 Pod 的 <code class="docutils literal notranslate"><span class="pre">namespace</span></code> 完全一致</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec.accessModes</span></code> 必须和PV的对应一致</p></li>
<li><p>PVC中 <code class="docutils literal notranslate"><span class="pre">spec.resources.requests.storage</span></code> 请求PV提供1G或其他容量</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>检查PV和PVC</p></li>
</ul>
<p>检查PV:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">pv</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>         <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">RECLAIM</span> <span class="n">POLICY</span>   <span class="n">STATUS</span>   <span class="n">CLAIM</span>                       <span class="n">STORAGECLASS</span>   <span class="n">REASON</span>   <span class="n">AGE</span>
<span class="n">gluster</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">RWX</span>            <span class="n">Retain</span>           <span class="n">Bound</span>    <span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">/</span><span class="n">gluster</span><span class="o">-</span><span class="n">claim</span>                           <span class="mi">25</span><span class="n">h</span>
</pre></div>
</div>
<p>检查PVC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">pvc</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>            <span class="n">STATUS</span>   <span class="n">VOLUME</span>       <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">STORAGECLASS</span>   <span class="n">AGE</span>
<span class="n">gluster</span><span class="o">-</span><span class="n">claim</span>   <span class="n">Bound</span>    <span class="n">gluster</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">RWX</span>                           <span class="mi">25</span><span class="n">h</span>
</pre></div>
</div>
<p>可以看到PVC已经和PV绑定起来了</p>
</section>
<section id="gluster">
<h3>使用Gluster存储</h3>
<p>我在 <a class="reference internal" href="../arm/arm_k8s_deploy.xhtml#arm-k8s-deploy"><span class="std std-ref">部署ARM架构Kubernetes</span></a> 中部署了3个测试容器 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                           <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>            <span class="n">NODE</span>         <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="mi">9</span><span class="n">rv6m</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">2.13</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="n">fgc4m</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">1.26</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="n">k7sv5</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">2.14</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>对应的 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code> 的deployment:</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">../../kubernetes/arm/arm_k8s_deploy/kube_verify_deployment.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/clcollins/kube-verify:01</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
</pre></div>
</td></tr></table></div>
</div>
<p>修订上述deployment，添加卷挂载:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/kube_verify_gluster-pvc_pid-gid_deployment.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/clcollins/kube-verify:01</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="hll">        <span class="nt">volumeMounts</span><span class="p">:</span>
</span><span class="hll">        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dbdata</span>
</span><span class="hll">          <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/dbdata</span>
</span><span class="hll">          <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span class="hll">      <span class="nt">securityContext</span><span class="p">:</span>
</span><span class="hll">        <span class="nt">runAsUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">592</span>
</span><span class="hll">        <span class="nt">supplementalGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">590</span><span class="p p-Indicator">]</span>
</span><span class="hll">      <span class="nt">volumes</span><span class="p">:</span>
</span><span class="hll">      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dbdata</span>
</span><span class="hll">        <span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span class="hll">          <span class="nt">claimName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>解析参数:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">spec.containers.volumeMounts</span></code> 是容器挂载的卷</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> 是容器内挂载目录命名</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mountPath</span></code> 是容器中的映射目录，对应了 PV 中设置的 <code class="docutils literal notranslate"><span class="pre">path</span></code> 映射</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">securityContex</span></code> 是非常重要的设置容器运行 <code class="docutils literal notranslate"><span class="pre">uid/pid</span></code> ，也决定了进程如何读写GlusterFS卷，所以必须和前文创建GlusterFS卷的属主一致</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">runAsUser</span></code> 进程uid，请确保容器内 <code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code> 配置了用户</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">supplementalGroup</span></code> 进程gid</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">volumes</span></code> 定义了可以被挂载的卷，这里可以配置多个卷</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">persistentVolumeClai</span></code> 定义和PVC中定义名关联</p></li>
</ul>
</li>
</ul>
</div></blockquote>
<p>执行deployments修订:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">kube_verify_gluster</span><span class="o">-</span><span class="n">pvc_pid</span><span class="o">-</span><span class="n">gid_deployment</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>完成后最终检查容器重建:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
<p>如果一切正常，则会替换生成新容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                          <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>            <span class="n">NODE</span>         <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">cc7bd8ff8</span><span class="o">-</span><span class="n">vc6bl</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">84</span><span class="n">m</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">2.17</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">cc7bd8ff8</span><span class="o">-</span><span class="n">wn99p</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">84</span><span class="n">m</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">2.16</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">cc7bd8ff8</span><span class="o">-</span><span class="n">xzjv4</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">84</span><span class="n">m</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">1.29</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>登陆其中一个容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">cc7bd8ff8</span><span class="o">-</span><span class="n">vc6bl</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p>在容器中检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<p>可以看到正确挂载了GlusterFS卷 <code class="docutils literal notranslate"><span class="pre">192.168.6.16:/gv0</span>&#160;&#160; <span class="pre">32G</span>&#160; <span class="pre">6.3G</span>&#160;&#160; <span class="pre">24G</span>&#160; <span class="pre">21%</span> <span class="pre">/var/dbdata</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filesystem</span>         <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="n">overlay</span>             <span class="mi">32</span><span class="n">G</span>  <span class="mf">5.9</span><span class="n">G</span>   <span class="mi">24</span><span class="n">G</span>  <span class="mi">20</span><span class="o">%</span> <span class="o">/</span>
<span class="n">tmpfs</span>               <span class="mi">64</span><span class="n">M</span>     <span class="mi">0</span>   <span class="mi">64</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>           <span class="mi">32</span><span class="n">G</span>  <span class="mf">5.9</span><span class="n">G</span>   <span class="mi">24</span><span class="n">G</span>  <span class="mi">20</span><span class="o">%</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="o">/</span><span class="n">gv0</span>   <span class="mi">32</span><span class="n">G</span>  <span class="mf">6.3</span><span class="n">G</span>   <span class="mi">24</span><span class="n">G</span>  <span class="mi">21</span><span class="o">%</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">dbdata</span>
<span class="n">shm</span>                 <span class="mi">64</span><span class="n">M</span>     <span class="mi">0</span>   <span class="mi">64</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">12</span><span class="n">K</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">scsi</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
<ul>
<li><p>进入 <code class="docutils literal notranslate"><span class="pre">/var/dbdata</span></code> 目录进行读写测试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">dbdata</span><span class="o">/</span><span class="n">testfile</span> <span class="n">bs</span><span class="o">=</span><span class="mi">10</span><span class="n">M</span> <span class="n">count</span><span class="o">=</span><span class="mi">10</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">10</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="ow">in</span>
<span class="mi">10</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="n">out</span>
<span class="mi">104857600</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mi">105</span> <span class="n">MB</span><span class="p">,</span> <span class="mi">100</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">copied</span><span class="p">,</span> <span class="mf">1.80953</span> <span class="n">s</span><span class="p">,</span> <span class="mf">57.9</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>

<span class="n">real</span> <span class="mi">0</span><span class="n">m1</span><span class="o">.</span><span class="mi">829</span><span class="n">s</span>
<span class="n">user</span> <span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">000</span><span class="n">s</span>
<span class="n">sys</span>  <span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">452</span><span class="n">s</span>
</pre></div>
</div>
<p>这就证明GlusterFS卷写入正常</p>
<ul>
<li><p>在物理服务器 <code class="docutils literal notranslate"><span class="pre">pi-worker2</span></code> 上检查 <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">-h</span></code> 输出可以看到，实际上GlusterFS卷挂载到了容器内部目录，在 <code class="docutils literal notranslate"><span class="pre">pi-worker2</span></code> 上运行了2个 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code> 容器，可以看到挂载了2次:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filesystem</span>         <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="o">...</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span><span class="p">:</span><span class="o">/</span><span class="n">gv0</span>   <span class="mi">32</span><span class="n">G</span>  <span class="mf">6.4</span><span class="n">G</span>   <span class="mi">24</span><span class="n">G</span>  <span class="mi">21</span><span class="o">%</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubelet</span><span class="o">/</span><span class="n">pods</span><span class="o">/</span><span class="n">f9627a9b</span><span class="o">-</span><span class="mi">4661</span><span class="o">-</span><span class="mi">4</span><span class="n">fb3</span><span class="o">-</span><span class="n">bd1d</span><span class="o">-</span><span class="n">ccaf7d990cc6</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">~</span><span class="n">glusterfs</span><span class="o">/</span><span class="n">gluster</span><span class="o">-</span><span class="n">pv</span>
<span class="o">...</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="o">/</span><span class="n">gv0</span>   <span class="mi">32</span><span class="n">G</span>  <span class="mf">6.4</span><span class="n">G</span>   <span class="mi">24</span><span class="n">G</span>  <span class="mi">21</span><span class="o">%</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubelet</span><span class="o">/</span><span class="n">pods</span><span class="o">/</span><span class="mi">0</span><span class="n">cbb2c9d</span><span class="o">-</span><span class="mi">39</span><span class="n">a2</span><span class="o">-</span><span class="mi">48</span><span class="n">b4</span><span class="o">-</span><span class="n">a472</span><span class="o">-</span><span class="mi">694</span><span class="n">b8692aaf4</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">~</span><span class="n">glusterfs</span><span class="o">/</span><span class="n">gluster</span><span class="o">-</span><span class="n">pv</span>
</pre></div>
</div>
</li>
</ul>
<p>由于是镜像模式的GlusterFS，所以在 <code class="docutils literal notranslate"><span class="pre">pi-worker1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">pi-worker2</span></code> 的 <code class="docutils literal notranslate"><span class="pre">/data/brick1/gv0</span></code> 目录下，有完全相同的文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@pi</span><span class="o">-</span><span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span><span class="c1"># pwd</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">root</span><span class="nd">@pi</span><span class="o">-</span><span class="n">worker1</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span><span class="c1"># ls -lh</span>
<span class="n">total</span> <span class="mi">101</span><span class="n">M</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">2</span> <span class="n">yarn</span> <span class="n">root</span> <span class="mi">100</span><span class="n">M</span> <span class="n">May</span> <span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">58</span> <span class="n">testfile</span>

<span class="n">root</span><span class="nd">@pi</span><span class="o">-</span><span class="n">worker2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span><span class="c1"># pwd</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
<span class="n">root</span><span class="nd">@pi</span><span class="o">-</span><span class="n">worker2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span><span class="c1"># ls -lh</span>
<span class="n">total</span> <span class="mi">101</span><span class="n">M</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">2</span> <span class="n">yarn</span> <span class="n">root</span> <span class="mi">100</span><span class="n">M</span> <span class="n">May</span> <span class="mi">20</span> <span class="mi">00</span><span class="p">:</span><span class="mi">58</span> <span class="n">testfile</span>
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2>Kubernetes使用GlusterFS卷(探索记录)</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以下步骤是我探索GlusterFS卷的步骤，所以有一个渐进的排查过程，如果你一步步按照我的步骤来做，会有一点点挫折。不过这个挫折会让你能够排查和找出为什么会出错以及解决方法，所以我完整保留了这个步骤。</p>
<p>如果你只想快速完成部署，避免走弯路，请参考上文 <code class="docutils literal notranslate"><span class="pre">Kubernetes使用GlusterFS卷</span></code> 段落，我一次性提供正确配置步骤，并且做了配置注释。</p>
</div>
<section id="id6">
<h3>持久化卷</h3>
<ul class="simple">
<li><p>创建Service和Endpoints</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-endpoints.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Endpoints</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
<span class="nt">subsets</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">addresses</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.6.15</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="p p-Indicator">-</span> <span class="nt">addresses</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.6.16</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
</pre></div>
</td></tr></table></div>
</div>
<p>参数解析:</p>
<blockquote>
<div><ul class="simple">
<li><p>注意 <code class="docutils literal notranslate"><span class="pre">name</span></code> 必须在各个配置中完全匹配</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ip</span></code> 必须是Gluster存储服务器的实际IP地址，而不是主机名</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">port</span></code> 号是忽略的</p></li>
</ul>
</div></blockquote>
<p>执行创建:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">gluster</span><span class="o">-</span><span class="n">endpoints</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>检查service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">service</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                <span class="n">TYPE</span>        <span class="n">CLUSTER</span><span class="o">-</span><span class="n">IP</span>       <span class="n">EXTERNAL</span><span class="o">-</span><span class="n">IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>   <span class="n">AGE</span>
<span class="n">glusterfs</span><span class="o">-</span><span class="n">cluster</span>   <span class="n">ClusterIP</span>   <span class="mf">10.106</span><span class="o">.</span><span class="mf">210.154</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">1</span><span class="o">/</span><span class="n">TCP</span>     <span class="mi">36</span><span class="n">s</span>
<span class="n">kubernetes</span>          <span class="n">ClusterIP</span>   <span class="mf">10.96</span><span class="o">.</span><span class="mf">0.1</span>        <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">443</span><span class="o">/</span><span class="n">TCP</span>   <span class="mi">169</span><span class="n">d</span>
</pre></div>
</div>
<p>检查endpoints:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">endpoints</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                <span class="n">ENDPOINTS</span>                       <span class="n">AGE</span>
<span class="n">glusterfs</span><span class="o">-</span><span class="n">cluster</span>   <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.15</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="mi">1</span>   <span class="mi">2</span><span class="n">m3s</span>
<span class="n">kubernetes</span>          <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">6443</span>               <span class="mi">169</span><span class="n">d</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>需要注意每个项目都需要唯一的endpoints，每个项目访问GlusterFS卷都需要自己的Endpoints。</p>
</div>
<ul class="simple">
<li><p>创建一个持久化卷(presistence volume, pv)</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-pv.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="c1"># The name of the PV, which is referenced in pod definitions or displayed in various oc volume commands.</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-pv</span>   
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">capacity</span><span class="p">:</span>
    <span class="c1"># The amount of storage allocated to this volume.</span>
    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>     
  <span class="nt">accessModes</span><span class="p">:</span>
    <span class="c1"># labels to match a PV and a PVC. They currently do not define any form of access control.</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>    
  <span class="c1"># The glusterfs plug-in defines the volume type being used </span>
  <span class="nt">glusterfs</span><span class="p">:</span>         
    <span class="nt">endpoints</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span> 
    <span class="c1"># Gluster volume name, preceded by /</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/gv0</span>
    <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="c1"># volume reclaim policy indicates that the volume will be preserved after the pods accessing it terminate.</span>
  <span class="c1"># Accepted values include Retain, Delete, and Recycle.</span>
  <span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retain</span>
</pre></div>
</td></tr></table></div>
</div>
<p>解析参数:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> 是在pod定义中使用的卷名字</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spec.capacity.storage</span></code> 配置卷容量大小</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accessMode</span></code> 是用于PV和PVC的标签，定义需要相同，不过当前没有定义任何访问控制</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">endpoints</span></code> 是前面创建的Endppints</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">path</span></code> 定义就是GlusterFS的卷</p></li>
</ul>
</div></blockquote>
<p>执行创建PV:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">gluster</span><span class="o">-</span><span class="n">pv</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<ul class="simple">
<li><p>创建持久化卷声明(persistent volume claim, PVC): 所谓PVC就是指定访问模式和存储容量，这里PVC绑定到前面创建的PV。一旦PV被绑定到一个PVC，这个PV就被绑定到了这个PVC所属项目，也就不能被绑到其他PVC上。这就是 <code class="docutils literal notranslate"><span class="pre">一对一</span></code> 映射PVs和PVCs，不过，在相同项目中的多个Pods可以使用相同PVC。</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-pvc.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">accessModes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
  <span class="nt">resources</span><span class="p">:</span>
     <span class="nt">requests</span><span class="p">:</span>
       <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</pre></div>
</td></tr></table></div>
</div>
<p>解析参数:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> 是在pod定义的 <code class="docutils literal notranslate"><span class="pre">volume</span></code> 段落引用</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accessModes</span></code> 必须和PV的对应一致</p></li>
<li><p>PVC中 <code class="docutils literal notranslate"><span class="pre">spec.resources.requests.storage</span></code> 请求PV提供1G或其他容量</p></li>
</ul>
</div></blockquote>
<p>创建PVC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">gluster</span><span class="o">-</span><span class="n">pvc</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>创建完成后检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pvc</span>
</pre></div>
</div>
<p>可以看到PVC已经和PV绑定起来了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>            <span class="n">STATUS</span>   <span class="n">VOLUME</span>       <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">STORAGECLASS</span>   <span class="n">AGE</span>
<span class="n">gluster</span><span class="o">-</span><span class="n">claim</span>   <span class="n">Bound</span>    <span class="n">gluster</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">RWX</span>                           <span class="mi">18</span><span class="n">m</span>
</pre></div>
</div>
<p>检查PV:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pv</span>
</pre></div>
</div>
<p>显示状态绑定PVC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>         <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">RECLAIM</span> <span class="n">POLICY</span>   <span class="n">STATUS</span>   <span class="n">CLAIM</span>                   <span class="n">STORAGECLASS</span>   <span class="n">REASON</span>   <span class="n">AGE</span>
<span class="n">gluster</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">RWX</span>            <span class="n">Retain</span>           <span class="n">Bound</span>    <span class="n">default</span><span class="o">/</span><span class="n">gluster</span><span class="o">-</span><span class="n">claim</span>                           <span class="mi">16</span><span class="n">h</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2>使用Gluster存储</h2>
<p>我在 <a class="reference internal" href="../arm/arm_k8s_deploy.xhtml#arm-k8s-deploy"><span class="std std-ref">部署ARM架构Kubernetes</span></a> 中部署了3个测试容器 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                           <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>   <span class="n">IP</span>            <span class="n">NODE</span>         <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="mi">9</span><span class="n">rv6m</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">2.13</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="n">fgc4m</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">1.26</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="n">k7sv5</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">h</span>   <span class="mf">10.244</span><span class="o">.</span><span class="mf">2.14</span>   <span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>对应的 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code> 的deployment:</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">../../kubernetes/arm/arm_k8s_deploy/kube_verify_deployment.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/clcollins/kube-verify:01</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
</pre></div>
</td></tr></table></div>
</div>
<p>修订上述deployment，添加卷挂载:</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/kube_verify_gluster_deployment.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/clcollins/kube-verify:01</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="hll">        <span class="nt">volumeMounts</span><span class="p">:</span>
</span><span class="hll">        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dbdata</span>
</span><span class="hll">          <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/dbdata</span>
</span><span class="hll">          <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span class="hll">      <span class="nt">volumes</span><span class="p">:</span>
</span><span class="hll">      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dbdata</span>
</span><span class="hll">        <span class="nt">persistentVolumeClaim</span><span class="p">:</span>
</span><span class="hll">          <span class="nt">claimName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>执行deployments修订:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">kube_verify_gluster_deployment</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</section>
<section id="id8">
<h2>问题排查</h2>
<section id="pvc">
<h3>找不到PVC</h3>
<ul>
<li><p>检查使用glusterfs的pod:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">get</span> <span class="n">pods</span>
</pre></div>
</div>
</li>
</ul>
<p>显示新创建的pod容器一致 <code class="docutils literal notranslate"><span class="pre">pending</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                           <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">bddb4868</span><span class="o">-</span><span class="n">jfb5p</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Pending</span>   <span class="mi">0</span>          <span class="mi">22</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="mi">9</span><span class="n">rv6m</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">h</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="n">fgc4m</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">h</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">7</span><span class="n">d4878dfdc</span><span class="o">-</span><span class="n">k7sv5</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">26</span><span class="n">h</span>
</pre></div>
</div>
<ul>
<li><p>检查pending容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">describe</span> <span class="n">pods</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">bddb4868</span><span class="o">-</span><span class="n">jfb5p</span>
</pre></div>
</div>
</li>
</ul>
<p>显示事件是因为没有找到 <code class="docutils literal notranslate"><span class="pre">persistentvolumeclaim</span> <span class="pre">&quot;gluster-claim&quot;</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Events</span><span class="p">:</span>
  <span class="n">Type</span>     <span class="n">Reason</span>            <span class="n">Age</span>   <span class="n">From</span>               <span class="n">Message</span>
  <span class="o">----</span>     <span class="o">------</span>            <span class="o">----</span>  <span class="o">----</span>               <span class="o">-------</span>
  <span class="ne">Warning</span>  <span class="n">FailedScheduling</span>  <span class="mi">23</span><span class="n">m</span>   <span class="n">default</span><span class="o">-</span><span class="n">scheduler</span>  <span class="n">persistentvolumeclaim</span> <span class="s2">&quot;gluster-claim&quot;</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p>奇怪，检查PVC明明存在:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pvc</span>
</pre></div>
</div>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>            <span class="n">STATUS</span>   <span class="n">VOLUME</span>       <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">STORAGECLASS</span>   <span class="n">AGE</span>
<span class="n">gluster</span><span class="o">-</span><span class="n">claim</span>   <span class="n">Bound</span>    <span class="n">gluster</span><span class="o">-</span><span class="n">pv</span>   <span class="mi">1</span><span class="n">Gi</span>        <span class="n">RWX</span>                           <span class="mi">103</span><span class="n">m</span>
</pre></div>
</div>
<p>仔细检查了 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">-n</span> <span class="pre">kube-verify</span> <span class="pre">describe</span> <span class="pre">pod</span> <span class="pre">kube-verify-69bddb4868-jfb5p</span></code> 的输出信息，我注意到有如下内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">Volumes</span><span class="p">:</span>
  <span class="n">dbdata</span><span class="p">:</span>
    <span class="n">Type</span><span class="p">:</span>       <span class="n">PersistentVolumeClaim</span> <span class="p">(</span><span class="n">a</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">a</span> <span class="n">PersistentVolumeClaim</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="n">ClaimName</span><span class="p">:</span>  <span class="n">gluster</span><span class="o">-</span><span class="n">claim</span>
    <span class="n">ReadOnly</span><span class="p">:</span>   <span class="n">false</span>
<span class="o">...</span>
</pre></div>
</div>
<p>原来，默认pod是使用自己相同的namespace的PVC，难怪，我创建 <code class="docutils literal notranslate"><span class="pre">gluster-claim</span></code> 时候没有指定 namespace ，创建在默认namespace，就和pod不在同一个namespace中。</p>
<p>重新修订 service, endpoint, PV 和 PVC (原先在 default namespace 的 service,endpoint,pv,pvc 需要删除) ，添加上 <code class="docutils literal notranslate"><span class="pre">namespace:</span> <span class="pre">kube-verify</span></code></p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-endpoints_kube-verify.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Endpoints</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">subsets</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">addresses</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.6.15</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="p p-Indicator">-</span> <span class="nt">addresses</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">ip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.6.16</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-pv_kube-verify.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="c1"># The name of the PV, which is referenced in pod definitions or displayed in various oc volume commands.</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-pv</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">capacity</span><span class="p">:</span>
    <span class="c1"># The amount of storage allocated to this volume.</span>
    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
  <span class="nt">accessModes</span><span class="p">:</span>
    <span class="c1"># labels to match a PV and a PVC. They currently do not define any form of access control.</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
  <span class="c1"># The glusterfs plug-in defines the volume type being used</span>
  <span class="nt">glusterfs</span><span class="p">:</span>
    <span class="nt">endpoints</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-cluster</span>
    <span class="c1"># Gluster volume name, preceded by /</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/gv0</span>
    <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="c1"># volume reclaim policy indicates that the volume will be preserved after the pods accessing it terminate.</span>
  <span class="c1"># Accepted values include Retain, Delete, and Recycle.</span>
  <span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retain</span>
  <span class="nt">claimRef</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
    <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/gluster-pvc_kube-verify.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">accessModes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
  <span class="nt">resources</span><span class="p">:</span>
     <span class="nt">requests</span><span class="p">:</span>
       <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</pre></div>
</td></tr></table></div>
</div>
<p>重建了对应Pod所在namespace的PVC(以及相应的PV,endpoint等)之后，终于能够挂载GlusterFS卷启动Pod了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                           <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">bddb4868</span><span class="o">-</span><span class="mi">7</span><span class="n">lfw4</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">17</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">bddb4868</span><span class="o">-</span><span class="mi">8</span><span class="n">pzk7</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">12</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">bddb4868</span><span class="o">-</span><span class="n">nf5l7</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">13</span><span class="n">m</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>GlusterFS卷权限</h3>
<p>通过以下命令登陆到容器内部:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="mi">69</span><span class="n">bddb4868</span><span class="o">-</span><span class="mi">7</span><span class="n">lfw4</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p>检查挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<p>可以看到GlusterFS卷已经挂载成功:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filesystem</span>         <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="n">overlay</span>            <span class="mi">953</span><span class="n">G</span>   <span class="mi">25</span><span class="n">G</span>  <span class="mi">890</span><span class="n">G</span>   <span class="mi">3</span><span class="o">%</span> <span class="o">/</span>
<span class="n">tmpfs</span>               <span class="mi">64</span><span class="n">M</span>     <span class="mi">0</span>   <span class="mi">64</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">6.16</span><span class="p">:</span><span class="o">/</span><span class="n">gv0</span>   <span class="mi">32</span><span class="n">G</span>  <span class="mf">6.2</span><span class="n">G</span>   <span class="mi">24</span><span class="n">G</span>  <span class="mi">21</span><span class="o">%</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">dbdata</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>          <span class="mi">953</span><span class="n">G</span>   <span class="mi">25</span><span class="n">G</span>  <span class="mi">890</span><span class="n">G</span>   <span class="mi">3</span><span class="o">%</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="n">shm</span>                 <span class="mi">64</span><span class="n">M</span>     <span class="mi">0</span>   <span class="mi">64</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">12</span><span class="n">K</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">scsi</span>
<span class="n">tmpfs</span>              <span class="mf">3.9</span><span class="n">G</span>     <span class="mi">0</span>  <span class="mf">3.9</span><span class="n">G</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
<p>但是，当你进入到 <code class="docutils literal notranslate"><span class="pre">/var/dbdata</span></code> 挂载目录下尝试写入文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>bash-5.0$ cd /var/dbdata/
bash-5.0$ touch test
touch: cannot touch &#39;test&#39;: Permission denied
</pre></div>
</div>
<p>无法写入是因为容器默认的用户id没有写入权限:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>bash-5.0$ id
uid=1001 gid=0(root) groups=0(root)
</pre></div>
</div>
<p>我们需要根据挂载GlusterFS卷的容器的运行uid/gid修订我们的GlusterFS的PVC</p>
<ul>
<li><p>在定义 <code class="docutils literal notranslate"><span class="pre">kube-verify</span></code> deployment时，可以为pod运行设置 <code class="docutils literal notranslate"><span class="pre">spec.securityContext.supplementalGroups</span></code> 来匹配访问GlusterFS的gid，并且设置GlusterFS的卷的目录 <code class="docutils literal notranslate"><span class="pre">775</span></code> 权限就可以解决这个问题:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="n">securityContext</span><span class="p">:</span>
    <span class="n">runAsUser</span><span class="p">:</span> <span class="mi">592</span>
    <span class="n">supplementalGroups</span><span class="p">:</span> <span class="p">[</span><span class="mi">590</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
<p>这里假设 GlusterFS 卷挂载后的目录 <code class="docutils literal notranslate"><span class="pre">uid/gid</span></code> 分别是 <code class="docutils literal notranslate"><span class="pre">592/590</span></code> (在创建brick目录时，就在GlusterFS服务器上配置好目录属主) ，这样只要配置了pod的运行pid/gid，就可以实现写入</p>
<p>所以修订 Pod 配置如下:</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">gluster_k8s/kube_verify_gluster-pvc_pid-gid_deployment.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-verify</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">quay.io/clcollins/kube-verify:01</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dbdata</span>
          <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/dbdata</span>
          <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="nt">securityContext</span><span class="p">:</span>
        <span class="nt">runAsUser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">592</span>
        <span class="nt">supplementalGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">590</span><span class="p p-Indicator">]</span>
      <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dbdata</span>
        <span class="nt">persistentVolumeClaim</span><span class="p">:</span>
          <span class="nt">claimName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gluster-claim</span>
</pre></div>
</td></tr></table></div>
</div>
<p>并且，需要注意，在GlusterFS的服务器上通过以下方式添加用户账号以及修订GlusterFS卷目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">groupadd</span> <span class="o">-</span><span class="n">g</span> <span class="mi">590</span> <span class="n">hadoop</span>
<span class="n">useradd</span> <span class="o">-</span><span class="n">g</span> <span class="mi">590</span> <span class="o">-</span><span class="n">u</span> <span class="mi">592</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">yarn</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">-</span><span class="n">m</span> <span class="n">yarn</span>
<span class="n">chown</span> <span class="n">yarn</span><span class="p">:</span><span class="n">hadoop</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">brick1</span><span class="o">/</span><span class="n">gv0</span>
</pre></div>
</div>
<p>这样，GlusterFS服务器上存储卷就会修订成用户 <code class="docutils literal notranslate"><span class="pre">yarn</span></code> (uid=592) 以及组 <code class="docutils literal notranslate"><span class="pre">hadoop</span></code> (gid=590)。</p>
<p>根据上述Pod的yaml重新创建的Pod:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl -n kube-verify get pods
NAME                          READY   STATUS    RESTARTS   AGE
kube-verify-cc7bd8ff8-vc6bl   1/1     Running   0          9m5s
kube-verify-cc7bd8ff8-wn99p   1/1     Running   0          9m11s
kube-verify-cc7bd8ff8-xzjv4   1/1     Running   0          9m8s
</pre></div>
</div>
<p>登陆pod:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">kube</span><span class="o">-</span><span class="n">verify</span><span class="o">-</span><span class="n">cc7bd8ff8</span><span class="o">-</span><span class="n">vc6bl</span> <span class="o">--</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p>在容器中检查进程id:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ id
uid=592 gid=0(root) groups=0(root),590
</pre></div>
</div>
<p>现在该用户就能够自如地读写挂载的GlusterFS卷。</p>
</section>
</section>
<section id="id10">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.howtoforge.com/tutorial/high-availability-storage-with-glusterfs-on-ubuntu-1804">High-Availability Storage with GlusterFS on Ubuntu 18.04 LTS</a><span class="link-target"> [https://www.howtoforge.com/tutorial/high-availability-storage-with-glusterfs-on-ubuntu-1804]</span></p></li>
<li><p><a class="reference external" href="https://gluster.readthedocs.io/en/latest/Install-Guide/Install/">Gluster Docs: Installing Gluster</a><span class="link-target"> [https://gluster.readthedocs.io/en/latest/Install-Guide/Install/]</span></p></li>
<li><p><a class="reference external" href="https://ralph.blog.imixs.com/2020/03/03/kubernetes-and-glusterfs/">Kubernetes and GlusterFS</a><span class="link-target"> [https://ralph.blog.imixs.com/2020/03/03/kubernetes-and-glusterfs/]</span></p></li>
<li><p><a class="reference external" href="https://my.oschina.net/yx571304/blog/3043065">k8s配置GlusterFS存储</a><span class="link-target"> [https://my.oschina.net/yx571304/blog/3043065]</span></p></li>
<li><p><a class="reference external" href="https://docs.okd.io/1.2/install_config/persistent_storage/persistent_storage_glusterfs.html">Persistent Storage Using GlusterFS</a><span class="link-target"> [https://docs.okd.io/1.2/install_config/persistent_storage/persistent_storage_glusterfs.html]</span></p></li>
<li><p><a class="reference external" href="https://docs.openshift.com/container-platform/3.3/install_config/storage_examples/gluster_example.html">Complete Example Using GlusterFS</a><span class="link-target"> [https://docs.openshift.com/container-platform/3.3/install_config/storage_examples/gluster_example.html]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>