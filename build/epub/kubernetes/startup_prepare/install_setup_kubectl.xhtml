<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>安装和设置kubectl</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="kubectl">
<span id="install-setup-kubectl"></span><h1>安装和设置kubectl</h1>
<p>在安装并运行了minikube之后，我们需要在主机上安装kubectl，以便能够管理kubernetes集群（这里即为minikube单机）。</p>
<section id="id1">
<h2>安装kubectl</h2>
<section id="linuxcurlkubectl">
<h3>在Linux平台使用curl安装kubectl执行程序</h3>
<ul>
<li><p>通过命令行可以直接下载64位X86 Linux版本执行程序:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="s2">&quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span>
</pre></div>
</div>
</li>
<li><p>验证(可选):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="s2">&quot;https://dl.k8s.io/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256&quot;</span>
<span class="n">echo</span> <span class="s2">&quot;$(&lt;kubectl.sha256) kubectl&quot;</span> <span class="o">|</span> <span class="n">sha256sum</span> <span class="o">--</span><span class="n">check</span>
</pre></div>
</div>
</li>
<li><p>执行安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">install</span> <span class="o">-</span><span class="n">o</span> <span class="n">root</span> <span class="o">-</span><span class="n">g</span> <span class="n">root</span> <span class="o">-</span><span class="n">m</span> <span class="mi">0755</span> <span class="n">kubectl</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">kubectl</span>
</pre></div>
</div>
</li>
<li><p>验证:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">version</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="centos-rhel-fedora-kubectl">
<h3>CentOS, RHEL, Fedora 安装kubectl</h3>
<ul>
<li><p>通过官方软件仓库安装kubectl:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">repo</span>
<span class="p">[</span><span class="n">kubernetes</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">Kubernetes</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">el7</span><span class="o">-</span><span class="n">x86_64</span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">repo_gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgkey</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">yum</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">rpm</span><span class="o">-</span><span class="n">package</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span>
<span class="n">EOF</span>
<span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">kubectl</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>通过Google官方软件库安装需要 <a class="reference internal" href="../../linux/security/vpn/openconnect_vpn.xhtml#openconnect-vpn"><span class="std std-ref">OpenConnect VPN</span></a></p>
</div>
</section>
<section id="ubuntu-debian-kubectl">
<h3>Ubuntu, Debian 安装kubectl</h3>
<ul>
<li><p>通过官方软件仓库安装kubectl:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span> <span class="n">gnupg2</span> <span class="n">curl</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">apt</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">-</span>
<span class="n">echo</span> <span class="s2">&quot;deb https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">list</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">kubectl</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>由于我在 <a class="reference internal" href="../../studio/index.xhtml#studio"><span class="std std-ref">Studio Atlas</span></a> 环境采用了Ubuntu，并且 <a class="reference internal" href="../../studio/kubenetes_in_studio.xhtml#kubenetes-in-studio"><span class="std std-ref">Studio中的kubernetes</span></a> 为了能够提高运行效率，我 <a class="reference internal" href="install_run_minikube.xhtml#install-run-minikube"><span class="std std-ref">安装和运行minikube</span></a> 直接在物理主机运行 minikube 来学习和验证kubernetes技术。目前，采用通过官方软件仓库来安装kubectl。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Ubuntu/Debian有不同版本代号，请参考 <a class="reference external" href="https://packages.cloud.google.com/apt/dists">https://packages.cloud.google.com/apt/dists</a> 选择适合你的发行版，例如，我在 <a class="reference internal" href="../../arm/raspberry_pi/startup/pi_400.xhtml#pi-400"><span class="std std-ref">树莓派Raspberry Pi 400</span></a> 上使用的是32位ARM的Raspberry Pi OS，当前是 <code class="docutils literal notranslate"><span class="pre">debian</span> <span class="pre">10.8</span></code> 版本代码是 <code class="docutils literal notranslate"><span class="pre">buster</span></code> ，对应的Ubuntu版本是 <code class="docutils literal notranslate"><span class="pre">18.04</span> <span class="pre">bionic</span></code> 到 <code class="docutils literal notranslate"><span class="pre">19.10</span> <span class="pre">eoan</span></code> ，取Ubuntu LTS版本代号 <code class="docutils literal notranslate"><span class="pre">bionic</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;deb https://apt.kubernetes.io/ kubernetes-bionic main&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">list</span>
</pre></div>
</div>
<p>不过，也可能当前Google并没有针对这个Ubuntu/Debian发布对应版本，例如，目前还只能使用 <code class="docutils literal notranslate"><span class="pre">kubernetes-xenial</span></code></p>
</div>
</section>
<section id="macos-kubectl">
<h3>macOS 安装kubectl</h3>
<ul>
<li><p>下载最新版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl
</pre></div>
</div>
</li>
<li><p>设置可执行权限:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">./</span><span class="n">kubectl</span>
</pre></div>
</div>
</li>
<li><p>移动到路径中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mv</span> <span class="o">./</span><span class="n">kubectl</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">kubectl</span>
</pre></div>
</div>
</li>
<li><p>检查程序:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">version</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="id2">
<h2>配置kubectl</h2>
<p>为了能够使kubectl发现并访问Kubernetes集群，需要使用 <a class="reference external" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">kubeconfig</a><span class="link-target"> [https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/]</span> 配置文件，这个配置文件是通过使用 <code class="docutils literal notranslate"><span class="pre">kube-up.sh</span></code> 脚本创建集群自动生成，或者是部署minikube集群生成的。</p>
<p>如果要访问多个kubernetes集群，请参考 <a class="reference external" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">Shareing Cluster Access document</a><span class="link-target"> [https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/]</span> 。我将在后续撰写相关实践文档。</p>
<p>默认的kubectl配置文件位于 <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">clusters</span><span class="p">:</span>
<span class="o">-</span> <span class="n">cluster</span><span class="p">:</span>
    <span class="n">certificate</span><span class="o">-</span><span class="n">authority</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">minikube</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>
    <span class="n">server</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span><span class="p">:</span><span class="mi">8443</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">minikube</span>
<span class="o">-</span> <span class="n">cluster</span><span class="p">:</span>
    <span class="n">certificate</span><span class="o">-</span><span class="n">authority</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">minikube</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>
    <span class="n">server</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span><span class="p">:</span><span class="mi">8443</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">xminikube</span>
<span class="n">contexts</span><span class="p">:</span>
<span class="o">-</span> <span class="n">context</span><span class="p">:</span>
    <span class="n">cluster</span><span class="p">:</span> <span class="n">minikube</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">minikube</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">minikube</span>
<span class="o">-</span> <span class="n">context</span><span class="p">:</span>
    <span class="n">cluster</span><span class="p">:</span> <span class="n">xminikube</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">xminikube</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">xminikube</span>
<span class="n">current</span><span class="o">-</span><span class="n">context</span><span class="p">:</span> <span class="n">xminikube</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Config</span>
<span class="n">preferences</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">users</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">minikube</span>
  <span class="n">user</span><span class="p">:</span>
    <span class="n">client</span><span class="o">-</span><span class="n">certificate</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">minikube</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">crt</span>
    <span class="n">client</span><span class="o">-</span><span class="n">key</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">minikube</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">key</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">xminikube</span>
  <span class="n">user</span><span class="p">:</span>
    <span class="n">client</span><span class="o">-</span><span class="n">certificate</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">minikube</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">crt</span>
    <span class="n">client</span><span class="o">-</span><span class="n">key</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">minikube</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">key</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>根据你采用的minikube安装方式不同，这里默认 <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code> 指向的服务器IP地址会不同。我这里采用了裸物理机运行minikube并且指定集群名字是 <code class="docutils literal notranslate"><span class="pre">xminikube</span></code> 。这里服务器的IP地址是从 <a class="reference internal" href="../../linux/security/vpn/openconnect_vpn.xhtml#openconnect-vpn"><span class="std std-ref">OpenConnect VPN</span></a> 环境获得的tun接口的IP，因为我的测试环境启动了VPN连接到外部网络。</p>
</div>
<ul>
<li><p>现在我们来验证集群状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Kubernetes</span> <span class="n">master</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span><span class="p">:</span><span class="mi">8443</span>
<span class="n">KubeDNS</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span><span class="p">:</span><span class="mi">8443</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">:</span><span class="n">dns</span><span class="o">/</span><span class="n">proxy</span>

<span class="n">To</span> <span class="n">further</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">diagnose</span> <span class="n">cluster</span> <span class="n">problems</span><span class="p">,</span> <span class="n">use</span> <span class="s1">&#39;kubectl cluster-info dump&#39;</span><span class="o">.</span>
</pre></div>
</div>
<p>这表明之前安装的minikube已经正常工作了。</p>
<p>更详细的集群信息可以通过如下命令显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span> <span class="n">dump</span>
</pre></div>
</div>
</section>
<section id="shell">
<h2>激活shell自动补全</h2>
<p>kubectl包含了一个自动补全命令功能，可以大大提高工作效率。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>CentOS可能需要先安装 <code class="docutils literal notranslate"><span class="pre">bash-completion</span></code> 软件包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">bash</span><span class="o">-</span><span class="n">completion</span> <span class="o">-</span><span class="n">y</span>
</pre></div>
</div>
<p>Ubuntu则默认已经安装了 <code class="docutils literal notranslate"><span class="pre">bash-completion</span></code></p>
</div>
<p>为了能够在当前shell中使用kubectl的自动补全功能，请执行 <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">&lt;(kubectl</span> <span class="pre">completion</span> <span class="pre">bash)</span></code></p>
<p>也可以加入shell环境变量，这样登陆就可以使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;source &lt;(kubectl completion bash)&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">~/.</span><span class="n">bashrc</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Install and Set Up kubectl</a><span class="link-target"> [https://kubernetes.io/docs/tasks/tools/install-kubectl/]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>