<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Studio环境libvirt静态分配IP</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="studiolibvirtip">
<span id="libvirt-static-ip-in-studio"></span><h1>Studio环境libvirt静态分配IP</h1>
<p>默认情况下libvirt内置的dnsmasq服务会动态分配IP地址给虚拟机，这导致每次启动的虚拟机IP地址可能不同。有部分作为固定服务的虚拟机IP地址期望不变，需要对libvirt的default网络做一些修改。</p>
<p>详细配置请参考 <a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/virtual/kvm/startup/in_action/kvm_libvirt_static_ip_for_dhcp_and_port_forwarding.md">KVM libvirt静态分配IP和端口转发</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/virtual/kvm/startup/in_action/kvm_libvirt_static_ip_for_dhcp_and_port_forwarding.md]</span></p>
<p>这里没有采用配置dnsmasq的static DHCP方法，而是修改libvirt的DHCP的range，空出部分IP地址不分配，然后在虚拟机内部配置静态IP地址，这样更为简洁方便，</p>
<section id="libvirtdhcp">
<h2>libvirt的DHCP分配范围调整</h2>
<ul>
<li><p>检查libvirt网络:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">net</span><span class="o">-</span><span class="nb">list</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Name</span>                 <span class="n">State</span>      <span class="n">Autostart</span>     <span class="n">Persistent</span>
<span class="o">----------------------------------------------------------</span>
<span class="n">default</span>              <span class="n">active</span>     <span class="n">yes</span>           <span class="n">yes</span>
</pre></div>
</div>
<ul>
<li><p>编辑默认网络:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">net</span><span class="o">-</span><span class="n">edit</span> <span class="n">default</span>
</pre></div>
</div>
</li>
</ul>
<p>将:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dhcp</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nb">range</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;192.168.122.2&#39;</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;192.168.122.254&#39;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">dhcp</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>修改成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dhcp</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nb">range</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;192.168.122.51&#39;</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;192.168.122.254&#39;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">dhcp</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>这样，IP地址段 <code class="docutils literal notranslate"><span class="pre">192.168.122.1</span> <span class="pre">~</span> <span class="pre">192.168.122.50</span></code> 就不会动态分批，保留给固定IP地址使用。</p>
<ul>
<li><p>重新生成libvirt网络:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span>  <span class="n">net</span><span class="o">-</span><span class="n">destroy</span> <span class="n">default</span>
<span class="n">virsh</span>  <span class="n">net</span><span class="o">-</span><span class="n">start</span> <span class="n">default</span>
</pre></div>
</div>
</li>
<li><p>然后重新将虚拟机网络连接:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">brctl</span> <span class="n">addif</span> <span class="n">virbr0</span> <span class="n">vnet0</span>
<span class="n">brctl</span> <span class="n">addif</span> <span class="n">virbr0</span> <span class="n">vnet1</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Host主机 <code class="docutils literal notranslate"><span class="pre">/var/lib/libvirt/dnsmasq/virbr0.status</span></code> 提供了当前dnsmasq分配的IP地址情况。</p>
</div>
</section>
<section id="ubuntuip">
<h2>配置Ubuntu虚拟机的静态IP</h2>
<p>对于Kubernetes master等服务器，我期望IP地址是固定的IP地址，所以准备配置static IP。不过，Ubuntu 18系列的静态IP地址配置方法和以前传统配置方法不同，采用了 <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> 配置文件，通过 <code class="docutils literal notranslate"><span class="pre">netplan</span></code> 网络配置工具来修改。</p>
<p>请参考 <a class="reference internal" href="../../../linux/ubuntu_linux/network/netplan.xhtml#netplan-static-ip"><span class="std std-ref">激活netplan</span></a></p>
<p>依次对必要的测试虚拟机调整静态IP，调整后的IP地址见 <a class="reference internal" href="../../../studio/studio_ip.xhtml#studio-ip"><span class="std std-ref">Studio测试环境IP分配</span></a> 。</p>
</section>
<section id="id1">
<h2>下一步</h2>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>