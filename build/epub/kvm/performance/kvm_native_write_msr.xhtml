<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>KVM运行时native_write_msr</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="kvmnative-write-msr">
<span id="kvm-native-write-msr"></span><h1>KVM运行时native_write_msr</h1>
<p><a class="reference internal" href="../../linux/arch_linux/archlinux_on_mbp.xhtml#archlinux-on-mbp"><span class="std std-ref">MacBook Pro上运行Arch Linux</span></a> 的 <a class="reference internal" href="../../studio/kvm_docker_in_studio.xhtml#kvm-docker-in-studio"><span class="std std-ref">Studio环境KVM和Docker</span></a> 上运行Windows 10的KVM虚拟机，感觉性能不佳，使用 <code class="docutils literal notranslate"><span class="pre">top</span></code> 检查发现虚拟机几乎空载情况下依然消耗了CPU 70%</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">top</span> <span class="o">-</span> <span class="mi">06</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">17</span> <span class="n">up</span> <span class="mi">22</span><span class="p">:</span><span class="mi">08</span><span class="p">,</span>  <span class="mi">5</span> <span class="n">users</span><span class="p">,</span>  <span class="n">load</span> <span class="n">average</span><span class="p">:</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="mf">1.12</span>
<span class="n">Tasks</span><span class="p">:</span> <span class="mi">237</span> <span class="n">total</span><span class="p">,</span>   <span class="mi">1</span> <span class="n">running</span><span class="p">,</span> <span class="mi">236</span> <span class="n">sleeping</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">stopped</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">zombie</span>
<span class="o">%</span><span class="n">Cpu</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="mf">5.1</span> <span class="n">us</span><span class="p">,</span>  <span class="mf">4.1</span> <span class="n">sy</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">ni</span><span class="p">,</span> <span class="mf">90.3</span> <span class="nb">id</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">wa</span><span class="p">,</span>  <span class="mf">0.4</span> <span class="n">hi</span><span class="p">,</span>  <span class="mf">0.2</span> <span class="n">si</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">st</span>
<span class="n">MiB</span> <span class="n">Mem</span> <span class="p">:</span>  <span class="mf">15923.5</span> <span class="n">total</span><span class="p">,</span>    <span class="mf">582.5</span> <span class="n">free</span><span class="p">,</span>   <span class="mf">6878.5</span> <span class="n">used</span><span class="p">,</span>   <span class="mf">8462.5</span> <span class="n">buff</span><span class="o">/</span><span class="n">cache</span>
<span class="n">MiB</span> <span class="n">Swap</span><span class="p">:</span>      <span class="mf">0.0</span> <span class="n">total</span><span class="p">,</span>      <span class="mf">0.0</span> <span class="n">free</span><span class="p">,</span>      <span class="mf">0.0</span> <span class="n">used</span><span class="o">.</span>   <span class="mf">7864.2</span> <span class="n">avail</span> <span class="n">Mem</span>

    <span class="n">PID</span> <span class="n">USER</span>      <span class="n">PR</span>  <span class="n">NI</span>    <span class="n">VIRT</span>    <span class="n">RES</span>    <span class="n">SHR</span> <span class="n">S</span>  <span class="o">%</span><span class="n">CPU</span>  <span class="o">%</span><span class="n">MEM</span>     <span class="n">TIME</span><span class="o">+</span> <span class="n">COMMAND</span>
  <span class="mi">14493</span> <span class="n">nobody</span>    <span class="mi">20</span>   <span class="mi">0</span> <span class="mi">5011304</span>   <span class="mf">4.1</span><span class="n">g</span>  <span class="mi">23856</span> <span class="n">S</span>  <span class="mf">70.1</span>  <span class="mf">26.4</span> <span class="mi">143</span><span class="p">:</span><span class="mf">26.38</span> <span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86</span>
    <span class="mi">543</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>  <span class="mi">582072</span> <span class="mi">232040</span> <span class="mi">153984</span> <span class="n">S</span>   <span class="mf">1.0</span>   <span class="mf">1.4</span>  <span class="mi">23</span><span class="p">:</span><span class="mf">43.42</span> <span class="n">Xorg</span>
    <span class="mi">918</span> <span class="n">huatai</span>    <span class="mi">20</span>   <span class="mi">0</span>  <span class="mi">521388</span>  <span class="mi">62116</span>  <span class="mi">40748</span> <span class="n">S</span>   <span class="mf">1.0</span>   <span class="mf">0.4</span>   <span class="mi">2</span><span class="p">:</span><span class="mf">26.94</span> <span class="n">xfce4</span><span class="o">-</span><span class="n">terminal</span>
</pre></div>
</div>
<p>在KVM虚拟机运行时，使用 <code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">top</span></code> 可以看到系统最大消耗在内核 <code class="docutils literal notranslate"><span class="pre">native_write_msr</span></code> 上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">6.32</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">native_write_msr</span>
<span class="mf">2.56</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__fget</span>
<span class="mf">2.22</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">do_syscall_64</span>
<span class="mf">2.05</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">do_sys_poll</span>
<span class="mf">1.97</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">preempt_count_add</span>
<span class="mf">1.81</span><span class="o">%</span>  <span class="p">[</span><span class="n">kvm_intel</span><span class="p">]</span>                              <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">vmx_vcpu_run</span>
<span class="mf">1.74</span><span class="o">%</span>  <span class="p">[</span><span class="n">kvm_intel</span><span class="p">]</span>                              <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">vmx_vmexit</span>
<span class="mf">1.65</span><span class="o">%</span>  <span class="p">[</span><span class="n">kvm</span><span class="p">]</span>                                    <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">kvm_arch_vcpu_ioctl_run</span>
<span class="mf">1.28</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">_raw_spin_lock_irqsave</span>
<span class="mf">1.22</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">psi_task_change</span>
<span class="mf">1.13</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">preempt_count_sub</span>
<span class="mf">1.11</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__x86_indirect_thunk_rax</span>
<span class="mf">0.98</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">eventfd_poll</span>
<span class="mf">0.94</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__pollwait</span>
<span class="mf">0.91</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">_raw_spin_unlock_irqrestore</span>
<span class="mf">0.90</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">fput_many</span>
<span class="mf">0.86</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">entry_SYSCALL_64</span>
<span class="mf">0.85</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">syscall_return_via_sysret</span>
<span class="mf">0.84</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__schedule</span>
<span class="mf">0.83</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">menu_select</span>
<span class="mf">0.81</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">debug_smp_processor_id</span>
<span class="mf">0.79</span><span class="o">%</span>  <span class="n">libglib</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="n">so</span><span class="o">.</span><span class="mf">0.6200</span><span class="o">.</span><span class="mi">2</span>                  <span class="p">[</span><span class="o">.</span><span class="p">]</span> <span class="n">g_main_context_check</span>
<span class="mf">0.74</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">switch_mm_irqs_off</span>
<span class="mf">0.68</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__fget_light</span>
<span class="mf">0.67</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">enqueue_entity</span>
<span class="mf">0.64</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">update_cfs_group</span>
<span class="mf">0.57</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">sock_poll</span>
<span class="mf">0.54</span><span class="o">%</span>  <span class="n">perf</span>                                     <span class="p">[</span><span class="o">.</span><span class="p">]</span> <span class="n">dso__find_symbol</span>
<span class="mf">0.52</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__srcu_read_lock</span>
<span class="mf">0.51</span><span class="o">%</span>  <span class="p">[</span><span class="n">kvm_intel</span><span class="p">]</span>                              <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__vmx_vcpu_run</span>
<span class="mf">0.51</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">__rcu_read_unlock</span>
<span class="mf">0.48</span><span class="o">%</span>  <span class="p">[</span><span class="n">kernel</span><span class="p">]</span>                                 <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="n">in_lock_functions</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>