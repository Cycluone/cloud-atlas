<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>KVM虚拟机磁盘性能优化</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="kvm">
<span id="kvm-disk-performance"></span><h1>KVM虚拟机磁盘性能优化</h1>
<p><a class="reference internal" href="../../linux/arch_linux/archlinux_on_mbp.xhtml#archlinux-on-mbp"><span class="std std-ref">MacBook Pro上运行Arch Linux</span></a> 在物理主机上测试磁盘dd性能:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="p">(</span><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=</span><span class="n">testdisk</span> <span class="n">oflag</span><span class="o">=</span><span class="n">direct</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="n">k</span> <span class="n">count</span><span class="o">=</span><span class="mi">16000</span><span class="p">;</span><span class="n">sync</span><span class="p">)</span>
</pre></div>
</div>
<p>磁盘写入性能(nvme)可以达到300MB/s:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">16000</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="ow">in</span>
<span class="mi">16000</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="n">out</span>
<span class="mi">1048576000</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mf">1.0</span> <span class="n">GB</span><span class="p">,</span> <span class="mi">1000</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">copied</span><span class="p">,</span> <span class="mf">3.47852</span> <span class="n">s</span><span class="p">,</span> <span class="mi">301</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>

<span class="n">real</span> <span class="mi">0</span><span class="n">m4</span><span class="o">.</span><span class="mi">078</span><span class="n">s</span>
<span class="n">user</span> <span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">035</span><span class="n">s</span>
<span class="n">sys</span>  <span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">990</span><span class="n">s</span>
</pre></div>
</div>
<p>但是，默认 <a class="reference internal" href="../startup/create_vm.xhtml#create-vm"><span class="std std-ref">Studio环境创建KVM虚拟机</span></a> (CentOS 8)，即使采用了 <code class="docutils literal notranslate"><span class="pre">virtio</span></code> 驱动，同样的测试命令连续写入磁盘显示性能只达到100MB/s多一点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">16000</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="ow">in</span>
<span class="mi">16000</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="n">out</span>
<span class="mi">1048576000</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mf">1.0</span> <span class="n">GB</span><span class="p">,</span> <span class="mi">1000</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">copied</span><span class="p">,</span> <span class="mf">9.63737</span> <span class="n">s</span><span class="p">,</span> <span class="mi">109</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>

<span class="n">real</span> <span class="mi">0</span><span class="n">m9</span><span class="o">.</span><span class="mi">667</span><span class="n">s</span>
<span class="n">user</span> <span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">047</span><span class="n">s</span>
<span class="n">sys</span>  <span class="mi">0</span><span class="n">m1</span><span class="o">.</span><span class="mi">270</span><span class="n">s</span>
</pre></div>
</div>
<section id="virtioio-native">
<h2>virtio磁盘设置io=’native’</h2>
<p>qcow2磁盘的aio支持两种模式 <code class="docutils literal notranslate"><span class="pre">native</span></code> 和 <code class="docutils literal notranslate"><span class="pre">threads</span></code> :</p>
<p>The optional io attribute controls specific policies on I/O; qemu guests support “threads” and “native”. Since 0.8.8</p>
<ul>
<li><p>修改虚拟机配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
  &lt;!-- driver name=&#39;qemu&#39; type=&#39;qcow2&#39; cache=&#39;none&#39;/--&gt;
  &lt;driver name=&#39;qemu&#39; type=&#39;qcow2&#39; cache=&#39;none&#39; io=&#39;native&#39;/&gt;
  &lt;source file=&#39;/var/lib/libvirt/images/centos8.qcow2&#39;/&gt;
  &lt;backingStore/&gt;
  &lt;target dev=&#39;vda&#39; bus=&#39;virtio&#39;/&gt;
  &lt;alias name=&#39;virtio-disk0&#39;/&gt;
  &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x04&#39; slot=&#39;0x00&#39; function=&#39;0x0&#39;/&gt;
&lt;/disk&gt;
</pre></div>
</div>
</li>
</ul>
<p>其中: <code class="docutils literal notranslate"><span class="pre">&lt;driver</span> <span class="pre">name='qemu'</span> <span class="pre">type='qcow2'</span> <span class="pre">cache='none'/&gt;</span></code> 修改成 <code class="docutils literal notranslate"><span class="pre">&lt;driver</span> <span class="pre">name='qemu'</span> <span class="pre">type='qcow2'</span> <span class="pre">cache='none'</span> <span class="pre">io='native'/&gt;</span></code></p>
<ul>
<li><p>同样磁盘测试性能，大约提高50%，吞吐量达到物理主机性能的55%，即 166MB/s</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">16000</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="ow">in</span>
<span class="mi">16000</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="n">out</span>
<span class="mi">1048576000</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mf">1.0</span> <span class="n">GB</span><span class="p">,</span> <span class="mi">1000</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">copied</span><span class="p">,</span> <span class="mf">6.305</span> <span class="n">s</span><span class="p">,</span> <span class="mi">166</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>

<span class="n">real</span> <span class="mi">0</span><span class="n">m6</span><span class="o">.</span><span class="mi">327</span><span class="n">s</span>
<span class="n">user</span> <span class="mi">0</span><span class="n">m0</span><span class="o">.</span><span class="mi">054</span><span class="n">s</span>
<span class="n">sys</span>  <span class="mi">0</span><span class="n">m1</span><span class="o">.</span><span class="mi">118</span><span class="n">s</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id1">
<h2>进一步优化参考</h2>
<p>后续准备参考 <a class="reference external" href="https://wiki.mikejung.biz/KVM_/_Xen">KVM / Xen</a><span class="link-target"> [https://wiki.mikejung.biz/KVM_/_Xen]</span> 做进一步实践</p>
</section>
<section id="id2">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://serverfault.com/questions/407842/incredibly-low-kvm-disk-performance-qcow2-disk-files-virtio">Incredibly low KVM disk performance (qcow2 disk files + virtio)</a><span class="link-target"> [https://serverfault.com/questions/407842/incredibly-low-kvm-disk-performance-qcow2-disk-files-virtio]</span></p></li>
<li><p><a class="reference external" href="https://turlucode.com/qemu-disk-io-performance-comparison-native-or-threads-windows-10-version/#1528572626148-2b30f3e4-f00f">aio=native or aio=threads – Intro</a><span class="link-target"> [https://turlucode.com/qemu-disk-io-performance-comparison-native-or-threads-windows-10-version/#1528572626148-2b30f3e4-f00f]</span></p></li>
<li><p><a class="reference external" href="https://wiki.mikejung.biz/KVM_/_Xen">KVM / Xen</a><span class="link-target"> [https://wiki.mikejung.biz/KVM_/_Xen]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>