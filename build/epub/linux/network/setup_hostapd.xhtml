<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>hostapd实现无线热点</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="hostapd">
<span id="setup-hostapd"></span><h1>hostapd实现无线热点</h1>
<p>我曾经使用 <a class="reference internal" href="create_ap.xhtml#create-ap"><span class="std std-ref">使用create_ap工具创建软AP</span></a> 实现了简单的无线AP提供多个设备共享上网，不过，最近 <a class="reference internal" href="setup_hostapd_failed.xhtml#setup-hostapd-failed"><span class="std std-ref">配置hostapd实现无线热点(失败记录)</span></a> 。不过，我参考了多个文档后，决定在 <a class="reference internal" href="../../arm/raspberry_pi/startup/pi_4.xhtml#pi-4"><span class="std std-ref">树莓派Raspberry Pi 4</span></a> 上(也就是我的 <a class="reference internal" href="../../kubernetes/arm/arm_k8s.xhtml#arm-k8s"><span class="std std-ref">ARM部署Kubernetes</span></a> 的master节点)上部署一个无线热点。</p>
<section id="apwifi">
<h2>激活AP和管理模式并用的WiFi</h2>
<p>通常情况下，我们都使用无线网卡作为无线网络的 “客户端” 模式去连接一个无线AP，这种模式称为 <code class="docutils literal notranslate"><span class="pre">managed</span></code> 设备。但是，如果要将Linux主机的无线网卡作为一个WiFi热点，则称为AP模式。由于我们只有一个无线网卡，所以我们需要配置树莓派上的无线网卡 <code class="docutils literal notranslate"><span class="pre">wlan0</span></code> 同时工作在AP和管理模式下，以便能够既连接Internet，同时共享AP给其他设备使用，实现一个无线路由器功能。</p>
<p>在树莓派启动时，无线网卡被识别为 <code class="docutils literal notranslate"><span class="pre">wlan0</span></code> ，我们需要创建一个udev规则，使得无线网卡 <code class="docutils literal notranslate"><span class="pre">wlan0</span></code> 启动时同时能够创建一个 <code class="docutils literal notranslate"><span class="pre">managed</span></code> 模式的虚拟网卡。</p>
<ul>
<li><p>创建 <code class="docutils literal notranslate"><span class="pre">/etc/udev/rules.d/70-persistent-net.rules</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;ieee80211&quot;</span><span class="p">,</span> <span class="n">ACTION</span><span class="o">==</span><span class="s2">&quot;add|change&quot;</span><span class="p">,</span> <span class="n">ATTR</span><span class="p">{</span><span class="n">macaddress</span><span class="p">}</span><span class="o">==</span><span class="s2">&quot;b8:27:eb:ff:ff:ff&quot;</span><span class="p">,</span> <span class="n">KERNEL</span><span class="o">==</span><span class="s2">&quot;phy0&quot;</span><span class="p">,</span> \
  <span class="n">RUN</span><span class="o">+=</span><span class="s2">&quot;/sbin/iw phy phy0 interface add ap0 type __ap&quot;</span><span class="p">,</span> \
  <span class="n">RUN</span><span class="o">+=</span><span class="s2">&quot;/bin/ip link set ap0 address b8:27:eb:ff:ff:ff&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p>注意，这里的mac地址必须是无线网卡的mac地址，通过 <code class="docutils literal notranslate"><span class="pre">iw</span> <span class="pre">dev</span></code> 命令可以查看mac地址，这里创建的虚拟网络设备是 <code class="docutils literal notranslate"><span class="pre">ap0</span></code> 。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这步我没有成功，所以我最后还是手工执行命令来激活ap0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iw</span> <span class="n">phy</span> <span class="n">phy0</span> <span class="n">interface</span> <span class="n">add</span> <span class="n">ap0</span> <span class="nb">type</span> <span class="n">__ap</span>
<span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ip</span> <span class="n">link</span> <span class="nb">set</span> <span class="n">ap0</span> <span class="n">address</span> <span class="n">b8</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">eb</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
</pre></div>
</div>
</div>
</section>
<section id="dnsmasqhostapd">
<h2>安装DNSmasq和Hostapd</h2>
<ul class="simple">
<li><p>Dnsmasq 为WiFi AP 提供DHCP服务</p></li>
<li><p>Hostapd 基于驱动配置来定义无线AP的物理操作</p></li>
</ul>
<p>安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">dnsmasq</span> <span class="n">hostapd</span>
</pre></div>
</div>
<p>这里默认启动的dnsmasq服务只启动了dns服务，不会启动dhcp，所以下一步我们需要配置</p>
<ul>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/dnsmasq.conf</span></code> 添加如下配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span><span class="o">=</span><span class="n">lo</span><span class="p">,</span><span class="n">ap0</span><span class="p">,</span><span class="n">eth0</span>
<span class="n">no</span><span class="o">-</span><span class="n">dhcp</span><span class="o">-</span><span class="n">interface</span><span class="o">=</span><span class="n">lo</span><span class="p">,</span><span class="n">wlan0</span>
<span class="n">bind</span><span class="o">-</span><span class="n">interfaces</span>
<span class="n">server</span><span class="o">=</span><span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span>
<span class="n">domain</span><span class="o">-</span><span class="n">needed</span>
<span class="n">bogus</span><span class="o">-</span><span class="n">priv</span>
<span class="n">dhcp</span><span class="o">-</span><span class="nb">range</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">10.50</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">10.150</span><span class="p">,</span><span class="mi">12</span><span class="n">h</span>
</pre></div>
</div>
</li>
<li><p>修订 <code class="docutils literal notranslate"><span class="pre">/etc/hostapd/hostapd.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctrl_interface</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">hostapd</span>
<span class="n">ctrl_interface_group</span><span class="o">=</span><span class="mi">0</span>
<span class="n">interface</span><span class="o">=</span><span class="n">ap0</span>
<span class="n">driver</span><span class="o">=</span><span class="n">nl80211</span>
<span class="n">ssid</span><span class="o">=</span><span class="n">YourApNameHere</span>
<span class="n">hw_mode</span><span class="o">=</span><span class="n">g</span>
<span class="n">channel</span><span class="o">=</span><span class="mi">11</span>
<span class="n">wmm_enabled</span><span class="o">=</span><span class="mi">0</span>
<span class="n">macaddr_acl</span><span class="o">=</span><span class="mi">0</span>
<span class="n">auth_algs</span><span class="o">=</span><span class="mi">1</span>
<span class="n">wpa</span><span class="o">=</span><span class="mi">2</span>
<span class="n">wpa_passphrase</span><span class="o">=</span><span class="n">YourPassPhraseHere</span>
<span class="n">wpa_key_mgmt</span><span class="o">=</span><span class="n">WPA</span><span class="o">-</span><span class="n">PSK</span>
<span class="n">wpa_pairwise</span><span class="o">=</span><span class="n">TKIP</span> <span class="n">CCMP</span>
<span class="n">rsn_pairwise</span><span class="o">=</span><span class="n">CCMP</span>
</pre></div>
</div>
</li>
</ul>
<p>如果要隐藏SSID，可以添加一行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ignore_broadcast_ssid</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<ul>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/default/hostapd</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DAEMON_CONF</span><span class="o">=</span><span class="s2">&quot;/etc/hostapd/hostapd.conf&quot;</span>
</pre></div>
</div>
</li>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> 来支持AP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">auto</span> <span class="n">lo</span>
<span class="n">iface</span> <span class="n">lo</span> <span class="n">inet</span> <span class="n">loopback</span>

<span class="n">auto</span> <span class="n">ap0</span>
<span class="n">allow</span><span class="o">-</span><span class="n">hotplug</span> <span class="n">ap0</span>
<span class="n">iface</span> <span class="n">ap0</span> <span class="n">inet</span> <span class="n">static</span>
    <span class="n">address</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">10.1</span>
    <span class="n">netmask</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span>
    <span class="n">hostapd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hostapd</span><span class="o">/</span><span class="n">hostapd</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里没有配置 <code class="docutils literal notranslate"><span class="pre">eth0</span></code> 和 <code class="docutils literal notranslate"><span class="pre">wlan0</span></code> ，因为我已经配置了使用 <a class="reference internal" href="../ubuntu_linux/network/netplan.xhtml#netplan"><span class="std std-ref">netplan网络配置</span></a> 来管理这两个设备。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>不需要单独启动hostapd服务，这个服务是通过启动网络接口来启动的。</p>
</div>
</section>
<section id="id1">
<h2>手工启动</h2>
<ul>
<li><p>手工启动虚拟网卡 <code class="docutils literal notranslate"><span class="pre">ap0</span></code> (也就是 udev 规则中命令)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iw</span> <span class="n">phy</span> <span class="n">phy0</span> <span class="n">interface</span> <span class="n">add</span> <span class="n">ap0</span> <span class="nb">type</span> <span class="n">__ap</span>
<span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ip</span> <span class="n">link</span> <span class="nb">set</span> <span class="n">ap0</span> <span class="n">address</span> <span class="n">b8</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">eb</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
</pre></div>
</div>
</li>
<li><p>重启一次 <code class="docutils literal notranslate"><span class="pre">ap0</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ifdown</span> <span class="o">--</span><span class="n">force</span> <span class="n">ap0</span>
<span class="n">sudo</span> <span class="n">ifup</span> <span class="n">ap0</span>
</pre></div>
</div>
</li>
</ul>
<p>启动以后可以看到接口:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">addr</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="mi">3</span><span class="p">:</span> <span class="n">wlan0</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">NO</span><span class="o">-</span><span class="n">CARRIER</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">fq_codel</span> <span class="n">state</span> <span class="n">DOWN</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="n">b8</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">eb</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">96</span><span class="n">eb</span><span class="p">:</span><span class="n">cdff</span><span class="p">:</span><span class="n">fe8e</span><span class="p">:</span><span class="n">eb3f</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
<span class="o">...</span>
<span class="mi">9</span><span class="p">:</span> <span class="n">ap0</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">fq_codel</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="n">b8</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">eb</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">10.1</span><span class="o">/</span><span class="mi">24</span> <span class="n">brd</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">10.255</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">ap0</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">96</span><span class="n">eb</span><span class="p">:</span><span class="n">cdff</span><span class="p">:</span><span class="n">fe8e</span><span class="p">:</span><span class="n">eb3f</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
</pre></div>
</div>
<p>可以看到之前 <code class="docutils literal notranslate"><span class="pre">wlan0</span></code> 上通过 <a class="reference internal" href="../ubuntu_linux/network/netplan.xhtml#netplan"><span class="std std-ref">netplan网络配置</span></a> 获得的无线IP地址消失了，而我们重新启动的 <code class="docutils literal notranslate"><span class="pre">ap0</span></code> 则已经分配了静态IP地址。</p>
<ul>
<li><p>再次执行 <code class="docutils literal notranslate"><span class="pre">netplan</span></code> 恢复wlan0的无线IP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netplan</span> <span class="n">apply</span>
</pre></div>
</div>
</li>
</ul>
<p>则再次观察 <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">addr</span></code> 输出可以看到 <code class="docutils literal notranslate"><span class="pre">wlan0</span></code> 和 <code class="docutils literal notranslate"><span class="pre">ap0</span></code> 都正确获得IP地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span><span class="p">:</span> <span class="n">wlan0</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">NO</span><span class="o">-</span><span class="n">CARRIER</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">fq_codel</span> <span class="n">state</span> <span class="n">DOWN</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="n">b8</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">eb</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">96</span><span class="n">eb</span><span class="p">:</span><span class="n">cdff</span><span class="p">:</span><span class="n">fe8e</span><span class="p">:</span><span class="n">eb3f</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
<span class="o">...</span>
<span class="mi">9</span><span class="p">:</span> <span class="n">ap0</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">fq_codel</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="n">b8</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="n">eb</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">10.1</span><span class="o">/</span><span class="mi">24</span> <span class="n">brd</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">10.255</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">ap0</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">96</span><span class="n">eb</span><span class="p">:</span><span class="n">cdff</span><span class="p">:</span><span class="n">fe8e</span><span class="p">:</span><span class="n">eb3f</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
</pre></div>
</div>
<ul>
<li><p>现在我们重新启动dnsmasq为我们的 <code class="docutils literal notranslate"><span class="pre">ap0</span></code> 提供DHCP服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">dnsmasq</span>
</pre></div>
</div>
</li>
</ul>
<p>通过 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">dnsmasq</span></code> 可以看到分配DHCP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server
     Loaded: loaded (/lib/systemd/system/dnsmasq.service; enabled; vendor preset: enabled)
     Active: active (running) since Tue 2021-04-27 23:32:39 CST; 28s ago
    Process: 2542555 ExecStartPre=/usr/sbin/dnsmasq --test (code=exited, status=0/SUCCESS)
    Process: 2542564 ExecStart=/etc/init.d/dnsmasq systemd-exec (code=exited, status=0/SUCCESS)
    Process: 2542574 ExecStartPost=/etc/init.d/dnsmasq systemd-start-resolvconf (code=exited, status=0/SUCCESS)
   Main PID: 2542573 (dnsmasq)
      Tasks: 1 (limit: 2101)
     Memory: 2.0M
     CGroup: /system.slice/dnsmasq.service
             └─2542573 /usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.pid -u dnsmasq -7 /etc/dnsmasq.d,.dpkg-dist,.dpkg-old,.dpkg-new --local-service --trust-anchor=.,20326,8,2,e06d4&gt;

Apr 27 23:32:39 pi-master1 dnsmasq[2542573]: started, version 2.80 cachesize 150
Apr 27 23:32:39 pi-master1 dnsmasq[2542573]: compile time options: IPv6 GNU-getopt DBus i18n IDN DHCP DHCPv6 no-Lua TFTP conntrack ipset auth nettlehash DNSSEC loop-detect inoti&gt;
Apr 27 23:32:39 pi-master1 dnsmasq-dhcp[2542573]: DHCP, IP range 192.168.10.50 -- 192.168.10.150, lease time 12h
Apr 27 23:32:39 pi-master1 dnsmasq-dhcp[2542573]: DHCP, sockets bound exclusively to interface ap0
Apr 27 23:32:39 pi-master1 dnsmasq[2542573]: using nameserver 8.8.8.8#53
Apr 27 23:32:39 pi-master1 dnsmasq[2542573]: reading /etc/resolv.conf
Apr 27 23:32:39 pi-master1 dnsmasq[2542573]: using nameserver 8.8.8.8#53
Apr 27 23:32:39 pi-master1 dnsmasq[2542573]: using nameserver 127.0.0.53#53
Apr 27 23:32:39 pi-master1 dnsmasq[2542573]: read /etc/hosts - 10 addresses
Apr 27 23:32:39 pi-master1 systemd[1]: Started dnsmasq - A lightweight DHCP and caching DNS server.
</pre></div>
</div>
<ul>
<li><p>万事具备，我们现在可以启动 iptables masquerade</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo sysctl -w net.ipv4.ip_forward=1
sudo iptables -t nat -A POSTROUTING -s 192.168.10.0/24 ! -d 192.168.10.0/24 -j MASQUERADE
</pre></div>
</div>
</li>
</ul>
<section id="id2">
<h3>问题排查</h3>
<p>我遇到一个问题，客户端可以正确连接到AP并且获得IP地址，也能够ping通网关(即无线AP的地址 192.168.10.1)，而且检查DNS解析也正确(DNS是192.168.10.1，即通过该路由器的dnsmasq代理解析正确)。</p>
<p>但是，无法ping通外网，也无法和外网通讯</p>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">iptables</span> <span class="pre">-t</span> <span class="pre">nat</span> <span class="pre">-L</span></code> 显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
KUBE-POSTROUTING  all  --  anywhere             anywhere             /* kubernetes postrouting rules */
MASQUERADE  all  --  172.17.0.0/16        anywhere
RETURN     all  --  pi-master1/16        pi-master1/16
MASQUERADE  all  --  pi-master1/16       !base-address.mcast.net/4  random-fully
RETURN     all  -- !pi-master1/16        pi-master1/24
MASQUERADE  all  -- !pi-master1/16        pi-master1/16        random-fully
MASQUERADE  all  --  192.168.10.0/24     !192.168.10.0/24
</pre></div>
</div>
</li>
</ul>
<p>这里可以看到很多NTA规则，原因是这台服务器同时是kubernetes集群的master管控主机。</p>
<p>我怀疑是顺序原因，所以改为在头部插入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">L</span> <span class="n">POSTROUTING</span> <span class="o">--</span><span class="n">line</span><span class="o">-</span><span class="n">numbers</span> <span class="o">-</span><span class="n">n</span>
</pre></div>
</div>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Chain POSTROUTING (policy ACCEPT)
num  target     prot opt source               destination
1    KUBE-POSTROUTING  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */
2    MASQUERADE  all  --  172.17.0.0/16        0.0.0.0/0
3    RETURN     all  --  10.244.0.0/16        10.244.0.0/16
4    MASQUERADE  all  --  10.244.0.0/16       !224.0.0.0/4          random-fully
5    RETURN     all  -- !10.244.0.0/16        10.244.0.0/24
6    MASQUERADE  all  -- !10.244.0.0/16        10.244.0.0/16        random-fully
7    MASQUERADE  all  --  192.168.10.0/24     !192.168.10.0/24
</pre></div>
</div>
<ul>
<li><p>在第二行插入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>iptables -t nat -I POSTROUTING 2 -s 192.168.10.0/24 ! -d 192.168.10.0/24 -j MASQUERADE
</pre></div>
</div>
</li>
</ul>
<p>但是依然无效</p>
<ul>
<li><p>我尝试了清理nat规则:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">F</span>
</pre></div>
</div>
</li>
</ul>
<p>但是发现系统会自动恢复添加以下NAT规则:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>RETURN     all  --  pi-master1/16        pi-master1/16
MASQUERADE  all  --  pi-master1/16       !base-address.mcast.net/4  random-fully
RETURN     all  -- !pi-master1/16        pi-master1/24
MASQUERADE  all  -- !pi-master1/16        pi-master1/16        random-fully
</pre></div>
</div>
<p>然后即使加了以下nat规则也没有效果:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>MASQUERADE  all  --  192.168.10.0/24     !192.168.10.0/24
</pre></div>
</div>
<p>我尝试删除:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">D</span> <span class="n">POSTROUTING</span> <span class="mi">1</span>
<span class="o">...</span>
</pre></div>
</div>
<p>但是系统不断自动刷新添加，最终么有成功解决</p>
</section>
</section>
<section id="id3">
<h2>自动化脚本</h2>
<p>以上手工命令我们可以综合成一个脚本 <code class="docutils literal notranslate"><span class="pre">/home/pi/start-ap-managed-wifi.sh</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
sleep 30
sudo ifdown --force ap0 &amp;&amp; sudo ifup ap0
sudo netplan apply
sudo sysctl -w net.ipv4.ip_forward=1
sudo iptables -t nat -A POSTROUTING -s 192.168.10.0/24 ! -d 192.168.10.0/24 -j MASQUERADE
sudo systemctl restart dnsmasq
</pre></div>
</div>
<p>然后配置一个启动cron:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">crontab</span> <span class="o">-</span><span class="n">e</span>
</pre></div>
</div>
<p>添加内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@reboot</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pi</span><span class="o">/</span><span class="n">start</span><span class="o">-</span><span class="n">ap</span><span class="o">-</span><span class="n">managed</span><span class="o">-</span><span class="n">wifi</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>这样每次重启都会执行上述脚本(脚本第一行添加 <code class="docutils literal notranslate"><span class="pre">sleep</span> <span class="pre">30</span></code> 是为了估算启动到网卡时间)</p>
</section>
<section id="id4">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.thewalr.us/2017/09/26/raspberry-pi-zero-w-simultaneous-ap-and-managed-mode-wifi/">Raspberry Pi Zero W Simultaneous AP and Managed Mode Wifi</a><span class="link-target"> [https://blog.thewalr.us/2017/09/26/raspberry-pi-zero-w-simultaneous-ap-and-managed-mode-wifi/]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>