<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>EDAC 诊断系统硬件故障</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="edac">
<span id="id1"></span><h1>EDAC 诊断系统硬件故障</h1>
<p>当前Linux内核和故障检测框架已经转向 Error detection and correction (EDAC) 架构，替代了早期使用的MCE(mcelog)。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>EDAC和服务器硬件架构相关，只支持x86架构系统。</p>
</div>
<section id="mcelog">
<h2>mcelog</h2>
<p><code class="docutils literal notranslate"><span class="pre">mcelog</span></code> 记录了在现代x86 Linxu系统上的硬件的 <code class="docutils literal notranslate"><span class="pre">主机检查</span></code> （主要是内存，IO和CPU的硬件错误）日志。当硬件报告了主机自检错误，内核会立即执行操作（例如杀死进程等）然后mcelog就会解码这些错误并且进行一些高级的错误响应，例如屏蔽故障的内存、CPU，或者触发事件。另外，mcelog也能够通过记录日志来处理修正后的错误。</p>
<p>mcelog服务记录 <a class="reference external" href="http://www.mcelog.org/memory.html">内存</a><span class="link-target"> [http://www.mcelog.org/memory.html]</span> 和 <a class="reference external" href="http://www.mcelog.org/error-flow.png">各种途径</a><span class="link-target"> [http://www.mcelog.org/error-flow.png]</span> 搜集的其它错误。</p>
<p><code class="docutils literal notranslate"><span class="pre">mcelog</span> <span class="pre">--client</span></code> 命令可以用来查询一个运行的 <code class="docutils literal notranslate"><span class="pre">mcelog</span></code> 服务。这个服务也可以在可配置的阀值到达时 <a class="reference external" href="http://www.mcelog.org/triggers.html">触发一些动作</a><span class="link-target"> [http://www.mcelog.org/triggers.html]</span> 。这对于一些自动化 <a class="reference external" href="http://www.mcelog.org/glossary.html#pfa">预测故障分析</a><span class="link-target"> [http://www.mcelog.org/glossary.html#pfa]</span> 算法：包括 <a class="reference external" href="http://www.mcelog.org/badpageofflining.html">坏页下线</a><span class="link-target"> [http://www.mcelog.org/badpageofflining.html]</span> 和自动化的 <a class="reference external" href="http://www.mcelog.org/cache.html">缓存错误处理</a><span class="link-target"> [http://www.mcelog.org/cache.html]</span> 。</p>
<p>用户也可以 <a class="reference external" href="http://www.mcelog.org/config.html">配置</a><span class="link-target"> [http://www.mcelog.org/config.html]</span> 自己定义的 <a class="reference external" href="http://www.mcelog.org/triggers.html">动作</a><span class="link-target"> [http://www.mcelog.org/triggers.html]</span> 。</p>
<p>所有的错误都被记录到 <code class="docutils literal notranslate"><span class="pre">/var/log/mcelog</span></code> 或 <code class="docutils literal notranslate"><span class="pre">syslog</span></code> 或 <code class="docutils literal notranslate"><span class="pre">journal</span></code> 中。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在线上的实践中，往往会采用日志采集方式，统一采集mcelog日志进行分析，并通过平台触发报警或自动服务器下线维修。上述mcelog自带的trigger机制也不失为一种硬件监控维护手段，可以不用以来统一日志平台，不过，各自服务和组件的独立维护方式可能在小规模或者比较单一简单的应用环境下合适。</p>
</div>
</section>
<section id="rasdaemon">
<h2>rasdaemon</h2>
<p>以往发行版，如RHEL 5/6 和 arch linux早期版本都提供一个 <code class="docutils literal notranslate"><span class="pre">mcelog</span></code> 包包含了mcelog工具，但是这个方式已经不再使用，并且Arch Linux内核不再配置 <code class="docutils literal notranslate"><span class="pre">CONFIG_X86_MCELOG_LEGACY</span></code> 选项。现在发行版使用的是 <a class="reference external" href="https://pagure.io/rasdaemon">rasdaemon</a><span class="link-target"> [https://pagure.io/rasdaemon]</span> ，例如, RHEL 7引入了新的硬件事件报告机制(hardware event report mechanism, HERM)。</p>
<ul>
<li><p>安装rasdaemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yay</span> <span class="o">-</span><span class="n">S</span> <span class="n">rasdaemon</span>
</pre></div>
</div>
</li>
</ul>
<p>rasdaemon可以之际命令启动，此时会在后台运行，并不断通过syslog输出。如果要在前台运行，将日志输出到控制台，则运行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rasdaemon</span> <span class="o">-</span><span class="n">f</span>
</pre></div>
</div>
<p>如果希望同时将错误记录到数据库(编译时使用了参数 <code class="docutils literal notranslate"><span class="pre">--enable-sqlite3</span></code>)，则可以增加一个 <code class="docutils literal notranslate"><span class="pre">-r</span></code> 参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rasdaemon</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">r</span>
</pre></div>
</div>
<section id="id11">
<h3>配置rasdaemon</h3>
<ul>
<li><p>需要启动两个systemd服务: <code class="docutils literal notranslate"><span class="pre">ras-mc-ctl.service</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rasdaemon.service</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">ras</span><span class="o">-</span><span class="n">mc</span><span class="o">-</span><span class="n">ctl</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">rasdaemon</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">ras</span><span class="o">-</span><span class="n">mc</span><span class="o">-</span><span class="n">ctl</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">rasdaemon</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id12">
<h3>使用rasdaemon</h3>
<p><code class="docutils literal notranslate"><span class="pre">ras-mc-ctl</span></code> 是RAS内存控制器管理工具，用于执行一些针对EDAC(Error Detection and Correction)驱动的RAS管理任务。</p>
</section>
</section>
<section id="id13">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="http://www.mcelog.org">mcelog官方网站</a><span class="link-target"> [http://www.mcelog.org]</span></p></li>
<li><p><a class="reference external" href="http://www.cyberciti.biz/tips/linux-server-predicting-hardware-failure.html">Linux x86_64: Detecting Hardware Errors</a><span class="link-target"> [http://www.cyberciti.biz/tips/linux-server-predicting-hardware-failure.html]</span></p></li>
<li><p><a class="reference external" href="http://www.halobates.de/lk10-mcelog.pdf">mcelog: memory error handling in user space</a><span class="link-target"> [http://www.halobates.de/lk10-mcelog.pdf]</span></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Machine-check_exception">Machine-check exception</a><span class="link-target"> [https://wiki.archlinux.org/index.php/Machine-check_exception]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>