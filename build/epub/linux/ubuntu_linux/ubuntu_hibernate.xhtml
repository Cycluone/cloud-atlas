<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Ubuntu Hibernate休眠</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="ubuntu-hibernate">
<span id="id1"></span><h1>Ubuntu Hibernate休眠</h1>
<p>在 <a class="reference internal" href="ubuntu_on_mbp.xhtml#ubuntu-on-mbp"><span class="std std-ref">MacBook Pro上运行Ubuntu</span></a> 实现 <a class="reference internal" href="../../studio/kvm_docker_in_studio.xhtml#kvm-docker-in-studio"><span class="std std-ref">Studio环境KVM和Docker</span></a> ，可以模拟出集群进行实践。在使用中，经常需要把笔记本携带在身边，每次都需要开关电脑，实际上就会不断重启虚拟机。对于恢复工作环境非常麻烦。</p>
<p>Linux支持 <code class="docutils literal notranslate"><span class="pre">Suspend</span></code> (挂起到内存) 和 <code class="docutils literal notranslate"><span class="pre">Hibernate</span></code> (挂起到磁盘) ，建议使用 <code class="docutils literal notranslate"><span class="pre">Hibernate</span></code> ，这样可以把内存中数据完全存储到磁盘，就可以断开电源，也不会出现因电能不足而关机。</p>
<p>不过，Linux上到Hibernate实现起来有点曲折，我的实践：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/redhat/system_administration/systemd/hibernate_with_fedora_in_laptop.md">fedora系统使用systemd设置Hibernate休眠</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/redhat/system_administration/systemd/hibernate_with_fedora_in_laptop.md]</span></p></li>
<li><p><a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/gentoo/suspend_hibernate.md">Gentoo系统的suspend和hibernate休眠</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/gentoo/suspend_hibernate.md]</span></p></li>
<li><p><a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/ubuntu/system_administration/ubuntu_hibernate.md">Ubuntu系统hibernate休眠</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/ubuntu/system_administration/ubuntu_hibernate.md]</span></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>我在实现Hibvernate上可能走了弯路，也许用默认的 <code class="docutils literal notranslate"><span class="pre">swsusp</span></code> 可能更简单些（但是我只测试了 <code class="docutils literal notranslate"><span class="pre">uswsusp</span></code> ）。另外，我只解决了命令行休眠，集成到systemd的步骤没有实践成功。</p>
</div>
<section id="id2">
<h2>内核和驱动准备（关键）</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>之前花费了一周时间反复折腾MacBook Pro上的Hibernate(save to disk)，总是发现恢复时异常死机或者图形界面无响应，最后总结经验如下:</p>
<ul class="simple">
<li><p>显卡驱动需要从默认 <code class="docutils literal notranslate"><span class="pre">nouveau</span></code> 替换成Nvidia闭源驱动</p></li>
<li><p>内核传递参数 <code class="docutils literal notranslate"><span class="pre">acpi_osi=Windows</span></code> 避免BIOS访问操作系统不支持的ACPI特性</p></li>
</ul>
<p>详细记录见 <a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/ubuntu/system_administration/ubuntu_hibernate.md">Ubuntu系统hibernate休眠</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/ubuntu/system_administration/ubuntu_hibernate.md]</span></p>
</div>
<ul>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code> 设置BIOS标示( <code class="docutils literal notranslate"><span class="pre">acpi_osi</span></code> )系统为Windows避免MacBook Pro查询系统不支持的Darwin特性:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash&quot;</span>
<span class="n">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;text&quot;</span>
<span class="n">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;ipv6.disable=1 acpi_osi=Windows&quot;</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>启动内核text模式以便查看系统启动信息，关闭IPv6是避免无线网卡驱动触发不支持IPv6特性Segment Fault</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>参考`archLinux的Mac Power management段落 &lt;<a class="reference external" href="https://wiki.archlinux.org/index.php/mac#Power_management">https://wiki.archlinux.org/index.php/mac#Power_management</a>&gt;`_ 也可以设置 <code class="docutils literal notranslate"><span class="pre">acpi_osi=!Darwin</span></code> 内核参数告知firmware系统是不兼容macOS，这样在Mac尚会禁用Thunderbolt adapter，可以极大降低电力消耗。我在 <a class="reference internal" href="../../appendix/reduce_laptop_overheat.xhtml#reduce-laptop-overheat"><span class="std std-ref">降低笔记本温度过热</span></a> 中采用了禁用thunderbolt 模块的方法。</p>
</div>
<ul>
<li><p>执行更新grub:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">grub</span>
</pre></div>
</div>
</li>
<li><p>安装Nvidia驱动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">drivers</span><span class="o">-</span><span class="n">common</span>
<span class="n">ubuntu</span><span class="o">-</span><span class="n">drivers</span> <span class="n">devices</span>
<span class="n">sudo</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">drivers</span> <span class="n">autoinstall</span>
</pre></div>
</div>
</li>
<li><p>重启系统，重启后使用 <code class="docutils literal notranslate"><span class="pre">lspci</span> <span class="pre">-vvv</span></code> 检查确保显卡设备使用了Nvidia驱动。并使用 <code class="docutils literal notranslate"><span class="pre">lsmod</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">nouveau</span></code> 检查确保没有加载 <code class="docutils literal notranslate"><span class="pre">nouveau</span></code> 内核模块</p></li>
<li><p>卸载 <code class="docutils literal notranslate"><span class="pre">nouveau</span></code> 相关Xorg软件包（可选）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="o">--</span><span class="n">purge</span> <span class="n">remove</span> <span class="n">xserver</span><span class="o">-</span><span class="n">xorg</span><span class="o">-</span><span class="n">video</span><span class="o">-</span><span class="n">nouveau</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">autoremove</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id4">
<h2>测试Ubuntu Hibernate</h2>
<ul>
<li><p>检查内核是否支持Hibernate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">power</span><span class="o">/</span><span class="n">state</span>
</pre></div>
</div>
</li>
</ul>
<p>输出中包含 <code class="docutils literal notranslate"><span class="pre">disk</span></code> 就表明支持Hibernate，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">freeze</span> <span class="n">mem</span> <span class="n">disk</span>
</pre></div>
</div>
<p>要验证当前系统是否已经支持Hibernate，只需要执行如下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">hibernate</span>
</pre></div>
</div>
<p>如果系统能够自动保存所有当前状态，并且在按下电源键自动恢复原先的工作状态则表明已经支持了hibernate。不过，很不幸，默认的系统验证下来是直接关机了。</p>
</section>
<section id="hibernateswap">
<h2>创建Hibernate使用的swap文件</h2>
<p>在hibernate状态（HTD或ACPI S4）主机的状态需要写入磁盘，这样就无需电力维持。这个状态是通过写入swap分区或swap文件实现的。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>不要在BTRFS上尝试使用swap文件，这会导致文件系统损坏！！！</p>
</div>
<p>swap分区或swap文件需要和RAM一样大小，或者至少 2/5的内存大小，参考 <a class="reference external" href="https://wiki.archlinux.org/index.php/Power_management/Suspend_and_hibernate#About_swap_partition.2Ffile_size">About swap partition/file size</a><span class="link-target"> [https://wiki.archlinux.org/index.php/Power_management/Suspend_and_hibernate#About_swap_partition.2Ffile_size]</span> 可以看到 <code class="docutils literal notranslate"><span class="pre">/sys/power/image_size</span></code> 设置了suspend-to-disk创建映像的大小，默认这个值设置的是内存的2/5大小。如果将数值 <code class="docutils literal notranslate"><span class="pre">0</span></code> 写入到 <code class="docutils literal notranslate"><span class="pre">/sys/power/image_size</span></code> 则系统会尽可能缩小suspend镜像。通过调整 <code class="docutils literal notranslate"><span class="pre">/sys/power/image_size</span></code> 你可以使得suspend镜像尽可能小，或者增加这个值以便hibernate处理速度更快。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里建议可以设置swap分区至少 2/5 的内存大小是假设系统内存足够，这样一般情况下系统不会使用swap，所以就可以把所有swap都用于hibernate，也就是默认的 2/5 内存大小的swap应该也够用于保存内存状态。</p>
</div>
<p>实际我采用了 <code class="docutils literal notranslate"><span class="pre">2/5</span> <span class="pre">内存</span> <span class="pre">+</span> <span class="pre">2G</span></code> 的swap大小，这是因为默认Ubuntu安装就设置了2G的swap文件，我再加上 2/5 的内存大小swap文件来做保障。我的笔记本是16G内存，所以，将原先2G的 <code class="docutils literal notranslate"><span class="pre">/swapfile</span></code> 改成 9G:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swapoff</span> <span class="o">/</span><span class="n">swapfile</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">swapfile</span>

<span class="n">sudo</span> <span class="n">fallocate</span> <span class="o">-</span><span class="n">l</span> <span class="mi">9</span><span class="n">g</span> <span class="o">/</span><span class="n">swapfile</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">600</span> <span class="o">/</span><span class="n">swapfile</span>
<span class="n">sudo</span> <span class="n">mkswap</span> <span class="o">/</span><span class="n">swapfile</span>
<span class="n">sudo</span> <span class="n">swapon</span> <span class="o">/</span><span class="n">swapfile</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在之前测试通过内核参数传递的 <code class="docutils literal notranslate"><span class="pre">resume=</span></code> 参数是指磁盘设备名，通常是磁盘swap分区。如果使用swap文件，则需要指定swap文件所在的磁盘分区，同时加上这个磁盘文件的物理偏移量（ <code class="docutils literal notranslate"><span class="pre">physical_offset</span></code> ）。这种内核参数传递方法，请参考我之前的测试:</p>
<p><a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/ubuntu/system_administration/ubuntu_hibernate.md">Ubuntu系统hibernate休眠</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/ubuntu/system_administration/ubuntu_hibernate.md]</span></p>
</div>
</section>
<section id="uswsusp">
<h2>安装uswsusp</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>参考 <a class="reference external" href="https://help.ubuntu.com/community/PowerManagement/Hibernate">PowerManagement/Hibernate</a><span class="link-target"> [https://help.ubuntu.com/community/PowerManagement/Hibernate]</span></p>
<p>在Ubuntu系统，默认的hibernate是使用内核build的 <code class="docutils literal notranslate"><span class="pre">swsusp</span></code> ，而且 Gnome 和 <code class="docutils literal notranslate"><span class="pre">pm-utils`</span> <span class="pre">也使用这个方式（推荐使用</span> <span class="pre">``platform</span></code> 如果BIOS支持问题，也可以改为 <code class="docutils literal notranslate"><span class="pre">shutdown</span></code> ）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">s</span>
<span class="n">echo</span> <span class="n">platform</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">power</span><span class="o">/</span><span class="n">disk</span>
<span class="n">echo</span> <span class="n">disk</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">power</span><span class="o">/</span><span class="n">state</span>
</pre></div>
</div>
</div>
<p>我在MacBook Pro上实践遇到恢复时图形界面无响应问题（排查最终是通过更换驱动和添加内核 <code class="docutils literal notranslate"><span class="pre">acpi_osi</span></code> 参数解决），所以改为采用了用户空间 <code class="docutils literal notranslate"><span class="pre">uswsusp</span></code> 。推测如果正确安装了驱动和设置了内核参数，使用默认的 <code class="docutils literal notranslate"><span class="pre">swsusp</span></code> 应该也是可以工作的。</p>
<ul>
<li><p>安装用户空间软件suspend – Userspace Software Suspend (uswsusp):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">uswsusp</span>
</pre></div>
</div>
</li>
</ul>
<p>安装过程就会提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>The swap file or partition that was found in uswsusp&#39;s configuration file is not active.
In most cases this means userspace software suspend will not work as expected. You should choose another swap space.
However, in some rare cases, this configuration may be intentional.
Continue without a valid swap space?
</pre></div>
</div>
<p>这里可以暂时回答Yes，因为我们下一步会进行配置。</p>
</section>
<section id="id6">
<h2>配置uswsusp</h2>
<ul>
<li><p>验证Swap文件分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">findmnt</span> <span class="o">-</span><span class="n">no</span> <span class="n">SOURCE</span><span class="p">,</span><span class="n">UUID</span> <span class="o">-</span><span class="n">T</span> <span class="o">/</span><span class="n">swapfile</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="n">e5b8f8ad</span><span class="o">-</span><span class="n">b767</span><span class="o">-</span><span class="mi">4719</span><span class="o">-</span><span class="mi">8796</span><span class="o">-</span><span class="mi">88</span><span class="n">eae998a056</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在激活了 <code class="docutils literal notranslate"><span class="pre">/swapfile</span></code> 后，首次安装 <code class="docutils literal notranslate"><span class="pre">uswsusp</span></code> 工具包就会自动配置好 <code class="docutils literal notranslate"><span class="pre">/etc/uswsusp.conf</span></code> 配置文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/uswsusp.conf(5) -- Configuration file for s2disk/s2both</span>
<span class="n">resume</span> <span class="n">device</span> <span class="o">=</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
<span class="n">compress</span> <span class="o">=</span> <span class="n">y</span>
<span class="n">early</span> <span class="n">writeout</span> <span class="o">=</span> <span class="n">y</span>
<span class="n">image</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">7692818022</span>
<span class="n">RSA</span> <span class="n">key</span> <span class="n">file</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">uswsusp</span><span class="o">.</span><span class="n">key</span>
<span class="n">shutdown</span> <span class="n">method</span> <span class="o">=</span> <span class="n">platform</span>
<span class="n">resume</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">8617984</span>
</pre></div>
</div>
<p>这里的 <code class="docutils literal notranslate"><span class="pre">resume</span> <span class="pre">offset</span> <span class="pre">=</span> <span class="pre">8617984</span></code> 是 <code class="docutils literal notranslate"><span class="pre">uswsusp</span></code> 自动计算出的，实际上使用 <code class="docutils literal notranslate"><span class="pre">swap-offset</span> <span class="pre">/swapfile</span></code> 也可以验证这个偏移量。</p>
</div>
</section>
<section id="id7">
<h2>配置uswsusp（可选）</h2>
<ul>
<li><p>(可选，如果安装时没有自动创建的话）创建 <code class="docutils literal notranslate"><span class="pre">/etc/uswsusp.conf</span></code> ，即执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="o">-</span><span class="n">pmedium</span> <span class="n">uswsusp</span>
</pre></div>
</div>
</li>
</ul>
<p>此时再次显示之前的提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>The swap file or partition that was found in uswsusp&#39;s configuration file is not active.
In most cases this means userspace software suspend will not work as expected. You should choose another swap space.
However, in some rare cases, this configuration may be intentional.
Continue without a valid swap space?
</pre></div>
</div>
<p>这里选择：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Yes</span></code> 表示 <code class="docutils literal notranslate"><span class="pre">Continue</span> <span class="pre">without</span> <span class="pre">a</span> <span class="pre">valid</span> <span class="pre">swap</span> <span class="pre">space?</span></code> （此时Wizard还没有设置swap文件）</p></li>
<li><p>在下一个选择问题:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">To</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">suspend</span> <span class="n">the</span> <span class="n">system</span><span class="p">,</span> <span class="n">uswsusp</span> <span class="n">needs</span> <span class="n">a</span> <span class="n">swap</span> <span class="n">partition</span> <span class="ow">or</span> <span class="n">file</span> <span class="n">to</span> <span class="n">store</span> <span class="n">a</span> <span class="n">system</span> <span class="n">snapshot</span><span class="o">.</span> <span class="n">Please</span> <span class="n">choose</span> <span class="n">the</span> <span class="n">device</span> <span class="n">to</span> <span class="n">use</span><span class="p">,</span> <span class="kn">from</span> <span class="nn">the</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">suitable</span> <span class="n">swap</span> <span class="n">spaces</span><span class="p">,</span> <span class="nb">sorted</span> <span class="n">by</span> <span class="n">size</span> <span class="p">(</span><span class="n">largest</span> <span class="n">first</span><span class="p">)</span><span class="o">.</span>

<span class="n">Swap</span> <span class="n">space</span> <span class="n">to</span> <span class="n">resume</span> <span class="n">from</span><span class="p">:</span>

                           <span class="o">/</span><span class="n">swapfile1</span>
                           <span class="o">/</span><span class="n">swapfile</span>
                           <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">uuid</span><span class="o">/</span><span class="n">e5b8f8ad</span><span class="o">-</span><span class="n">b767</span><span class="o">-</span><span class="mi">4719</span><span class="o">-</span><span class="mi">8796</span><span class="o">-</span><span class="mi">88</span><span class="n">eae998a056</span>
</pre></div>
</div>
</li>
</ul>
<p>注意：选择 swap 文件所在的 <code class="docutils literal notranslate"><span class="pre">partition</span></code> ，即之前的命令 <code class="docutils literal notranslate"><span class="pre">findmnt</span></code> 输出的内容， <code class="docutils literal notranslate"><span class="pre">不要</span></code> 选择swap文件自身。所以，我们这里选择最后一行 <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-uuid/e5b8f8ad-b767-4719-8796-88eae998a056</span></code></p>
<ul>
<li><p>在下一个页面中提问是否加密suspend内容（会影响速度）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>For increased security, it is possible to encrypt the snapshot that is written to disk during suspend. On resume (and suspend if you don&#39;t use an RSA key), you will be prompted for a passphrase. Encryption adds a significant time to the suspend and resume processes.

Encrypt snapshot?
</pre></div>
</div>
</li>
</ul>
<p>安全要求不高，我选择默认 <code class="docutils literal notranslate"><span class="pre">No</span></code> 不加密</p>
<ul>
<li><p>检查swap文件的 <code class="docutils literal notranslate"><span class="pre">swap_id</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">s</span> <span class="n">swaplabel</span> <span class="o">/</span><span class="n">swapfile</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUID</span><span class="p">:</span>  <span class="mi">825</span><span class="n">fa235</span><span class="o">-</span><span class="n">e08c</span><span class="o">-</span><span class="mf">441e-8637</span><span class="o">-</span><span class="mi">57309</span><span class="n">d600ad6</span>
</pre></div>
</div>
<ul>
<li><p>创建文件 <code class="docutils literal notranslate"><span class="pre">/etc/initramfs-tools/conf.d/resume</span></code> 加入 <code class="docutils literal notranslate"><span class="pre">swap_id</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;RESUME=UUID=825fa235-e08c-441e-8637-57309d600ad6&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">resume</span>

<span class="n">update</span><span class="o">-</span><span class="n">initramfs</span> <span class="o">-</span><span class="n">u</span>
</pre></div>
</div>
</li>
<li><p>测试Hibernate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">s2disk</span>
</pre></div>
</div>
</li>
</ul>
<p>此时看到屏幕一闪进入终端模式，并显示在保存image。保存过程结束后，笔记本关机。再次按下电源按钮，会有一个image恢复过程，然后就会恢复到之前的图形界面。</p>
</section>
<section id="uswsusppm-utils">
<h2>集成uswsusp到pm-utils</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>需要安装 <code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">install</span> <span class="pre">pm-utils</span></code> ( 依赖安装 <code class="docutils literal notranslate"><span class="pre">ethtool</span> <span class="pre">pm-utils</span> <span class="pre">vbetool</span></code> )</p>
<p>推荐使用 <code class="docutils literal notranslate"><span class="pre">pm-hibernate</span></code> 是因为gnome的默认hibernate是通过pm-hibernate实现的。</p>
</div>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/etc/pm/config.d/00sleep_module</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SLEEP_MODULE</span><span class="o">=</span><span class="s2">&quot;uswsusp&quot;</span>
</pre></div>
</div>
</li>
<li><p>测试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">pm</span><span class="o">-</span><span class="n">suspend</span><span class="o">.</span><span class="n">log</span> <span class="o">&amp;</span>
<span class="n">sudo</span> <span class="n">pm</span><span class="o">-</span><span class="n">hibernate</span>
</pre></div>
</div>
</li>
</ul>
<p>在系统休眠之后，按下电源开关恢复，可以看到屏幕字符终端显示恢复保存的镜像，确保正确恢复图形工作洁面后，再进行下一步集成systemd操作。</p>
</section>
<section id="systemd">
<h2>集成systemd</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>目前只在字符界面测试成功，但是在图形界面测试遇到恢复后黑屏问题，所以暂时放弃图形界面改为启动后直接进入字符终端界面。</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">systemd-suspend.service</span></code> 是一个系统服务，通过 <code class="docutils literal notranslate"><span class="pre">suspend.target</span></code> 拉取并响应实际的系统挂起。同样， <code class="docutils literal notranslate"><span class="pre">systemd-hibernate.service</span></code> 则是有 <code class="docutils literal notranslate"><span class="pre">hibernate.target</span></code> 拉取并执行相应的hibernate。</p>
<p>在进入系统 syspend 和/或 hibernation 之前，systemd会执行所有在 <code class="docutils literal notranslate"><span class="pre">/usr/lib/systemd/system-sleep/</span></code> 目录下的可执行文件并传递2个参数给这些程序。第一个参数是 <code class="docutils literal notranslate"><span class="pre">pre</span></code> ，第二个参数是根据选择的动作传递 <code class="docutils literal notranslate"><span class="pre">suspend</span></code> ， <code class="docutils literal notranslate"><span class="pre">hibernate</span></code> , <code class="docutils literal notranslate"><span class="pre">hybrid-sleep</span></code> 或 <code class="docutils literal notranslate"><span class="pre">suspend-then-hibernate</span></code> 。而当系统离开 <code class="docutils literal notranslate"><span class="pre">suspend</span></code> 和/或 <code class="docutils literal notranslate"><span class="pre">hibernate</span></code> 之前，会执行相同的目录下的可执行程序，只不过第一个参数被改成了 <code class="docutils literal notranslate"><span class="pre">post</span></code> 。所有在这个目录下的可执行程序是并发执行的，并且只有所有的可执行程序执行完毕之后，才会继续动作。</p>
<p>注意在 <code class="docutils literal notranslate"><span class="pre">/usr/lib/systemd/system-sleep/</span></code> 目录下的脚本或程序倾向于本地使用并且可以hack。如果应用程序想要重新执行系统 suspend/hibernation 并恢复，则应该使用 <a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/inhibit">Inhibitor interface</a><span class="link-target"> [https://www.freedesktop.org/wiki/Software/systemd/inhibit]</span> 。</p>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">hibernate</span></code> 服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">edit</span> <span class="n">systemd</span><span class="o">-</span><span class="n">hibernate</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
<p>粘贴以下代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">ExecStart</span><span class="o">=</span>
<span class="n">ExecStartPre</span><span class="o">=-/</span><span class="nb">bin</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">parts</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">a</span> <span class="n">pre</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">sleep</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">s2disk</span>
<span class="n">ExecStartPost</span><span class="o">=-/</span><span class="nb">bin</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">parts</span> <span class="o">-</span><span class="n">v</span> <span class="o">--</span><span class="n">reverse</span> <span class="o">-</span><span class="n">a</span> <span class="n">post</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">-</span><span class="n">sleep</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>注意在Ubuntu 18.04及以上版本中， <code class="docutils literal notranslate"><span class="pre">pre/post</span></code> 脚本位于 <code class="docutils literal notranslate"><span class="pre">/lib/systemd/system-sleep</span></code> 目录，和一些介绍debian的文档中设置 <code class="docutils literal notranslate"><span class="pre">/usr/lib/systemd/system-sleep</span></code> 不同。错误指向目录的话会导致休眠唤醒之后，图形界面始终是黑屏（虽然系统依然可以ssh登陆和使用）。</p>
<p><code class="docutils literal notranslate"><span class="pre">不过，这个集成systemd的步骤我测试没有成功，目前只能使用命令行pm-hibernate完成休眠</span></code></p>
</div>
<ul>
<li><p>更新systemd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
</pre></div>
</div>
</li>
<li><p>测试运行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">hibernate</span>
</pre></div>
</div>
</li>
</ul>
<section id="id8">
<h3>笔记本合上屏幕休眠</h3>
<p>笔记本合上屏幕的时候会触发systemd事件，所以通过修改 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/logind.conf</span></code> 如下可以在合上屏幕时进入hibernate而不是默认的suspend:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#HandleLidSwitch=suspend</span>
<span class="n">HandleLidSwitch</span><span class="o">=</span><span class="n">hibernate</span>
</pre></div>
</div>
<p>然后重新加载 <code class="docutils literal notranslate"><span class="pre">systemd-logind</span></code> 生效:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">systemd</span><span class="o">-</span><span class="n">logind</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>现在在字符终端界面合上笔记本屏幕会自动休眠，然后也能够恢复运行。不过目前图形界面尚未解决问题。</p>
</div>
</section>
</section>
<section id="hibernate">
<h2>激活图形界面hibernate</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>由于集成systemd步骤在图形界面测试未成功，所以此步骤也没有成功。</p>
</div>
<ul>
<li><p>创建 <code class="docutils literal notranslate"><span class="pre">/etc/polkit-1/localauthority/50-local.d/com.ubuntu.enable-hibernate.pkla</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Re</span><span class="o">-</span><span class="n">enable</span> <span class="n">hibernate</span> <span class="n">by</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">upower</span><span class="p">]</span>
<span class="n">Identity</span><span class="o">=</span><span class="n">unix</span><span class="o">-</span><span class="n">user</span><span class="p">:</span><span class="o">*</span>
<span class="n">Action</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">upower</span><span class="o">.</span><span class="n">hibernate</span>
<span class="n">ResultActive</span><span class="o">=</span><span class="n">yes</span>

<span class="p">[</span><span class="n">Re</span><span class="o">-</span><span class="n">enable</span> <span class="n">hibernate</span> <span class="n">by</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">logind</span><span class="p">]</span>
<span class="n">Identity</span><span class="o">=</span><span class="n">unix</span><span class="o">-</span><span class="n">user</span><span class="p">:</span><span class="o">*</span>
<span class="n">Action</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">login1</span><span class="o">.</span><span class="n">hibernate</span><span class="p">;</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">login1</span><span class="o">.</span><span class="n">handle</span><span class="o">-</span><span class="n">hibernate</span><span class="o">-</span><span class="n">key</span><span class="p">;</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">login1</span><span class="p">;</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">login1</span><span class="o">.</span><span class="n">hibernate</span><span class="o">-</span><span class="n">multiple</span><span class="o">-</span><span class="n">sessions</span><span class="p">;</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">login1</span><span class="o">.</span><span class="n">hibernate</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">inhibit</span>
<span class="n">ResultActive</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
</li>
</ul>
<p>然后重启系统就可以看到图形界面菜单显示了 <code class="docutils literal notranslate"><span class="pre">Hibernate</span></code> 功能。不过，这个功能我测试返回还是需要 <code class="docutils literal notranslate"><span class="pre">systemd-hibernate.service</span></code> 支持，否则也是黑屏（虽然可以ssh访问）</p>
</section>
<section id="id9">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://askubuntu.com/questions/768136/how-can-i-hibernate-on-ubuntu-16-04">How can I hibernate on Ubuntu 16.04?</a><span class="link-target"> [https://askubuntu.com/questions/768136/how-can-i-hibernate-on-ubuntu-16-04]</span> 其中最重要的一个解决方案是 “Hibernation using systemctl and getting it working in tough cases” ，在这篇问答的第2个回答中。</p></li>
<li><p><a class="reference external" href="https://help.ubuntu.com/community/PowerManagement/Hibernate">PowerManagement/Hibernate</a><span class="link-target"> [https://help.ubuntu.com/community/PowerManagement/Hibernate]</span></p></li>
<li><p><a class="reference external" href="https://medium.com/&#64;lzcoder/enable-hibernate-on-ubuntu-using-uswsusp-s2disk-ae0b71862eb5">Enable hibernate on Ubuntu using uswsusp (s2disk)</a><span class="link-target"> [https://medium.com/&#64;lzcoder/enable-hibernate-on-ubuntu-using-uswsusp-s2disk-ae0b71862eb5]</span></p></li>
<li><p><a class="reference external" href="https://www.freedesktop.org/software/systemd/man/systemd-suspend.service.html">systemd-suspend.service</a><span class="link-target"> [https://www.freedesktop.org/software/systemd/man/systemd-suspend.service.html]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>