<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>OpenConnect VPN</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="openconnect-vpn">
<span id="id1"></span><h1>OpenConnect VPN</h1>
<p>Kubernetes是Google开发的容器编排系统，当你开始学习和测试Kubernetes时候，你会发现，很多基于Google的软件仓库无法访问，会给你的学习和工作带来极大的困扰。</p>
<p>OpenConnect VPN Server，也称为 <code class="docutils literal notranslate"><span class="pre">ocserv</span></code> ，采用OpenConnect SSL VPN协议，并且和Cisco AnyConnect SSL VPN协议的客户端兼容。目前不仅加密安全性好，而且客户端可以跨平台，主流操作系统以及手机操作系统都可以使用。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果你使用Google的软件仓库来安装最新版本的Kubernetes，并按照Google的文档进行实践，需要一个科学上网的梯子来帮助你。</p>
</div>
<ul class="simple">
<li><p>准备工作：</p>
<ul>
<li><p>需要购买一台海外VPS</p></li>
<li><p>需要一个域名，在注册域名中添加一条记录指向新购买VPS的IP地址</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>使用Let’s Encrypt签发的证书是针对域名的，所以不仅需要购买VPS，还需要提前准备好域名。</p>
</div>
<section id="openconnect-vpn-server">
<h2>部署OpenConnect VPN Server</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>本文方案实践服务器和客户端都基于Ubuntu 18.10系统，其他发行版可能会有一些差异。</p>
<p>详细操作步骤参考 <a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/security/vpn/openconnect/deploy_ocserv_vpn_server_on_ubuntu.md">在Ubuntu部署OpenConnect VPN服务器</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/security/vpn/openconnect/deploy_ocserv_vpn_server_on_ubuntu.md]</span></p>
</div>
<ul>
<li><p>安装ocserv:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">ocserv</span>
</pre></div>
</div>
</li>
</ul>
<p>安装完成后，OpenConnect VPN服务自动启动，可以通过 <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">ocserv</span></code> 检查。</p>
<ul>
<li><p>安装Let’s Encrypt客户端（Certbot）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
<span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">certbot</span><span class="o">/</span><span class="n">certbot</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">certbot</span>
</pre></div>
</div>
</li>
<li><p>从Let’s Encrypt获取一个TLS证书:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">certbot</span> <span class="n">certonly</span> <span class="o">--</span><span class="n">standalone</span> <span class="o">--</span><span class="n">preferred</span><span class="o">-</span><span class="n">challenges</span> <span class="n">http</span> <span class="o">--</span><span class="n">agree</span><span class="o">-</span><span class="n">tos</span> <span class="o">--</span><span class="n">email</span> <span class="n">your</span><span class="o">-</span><span class="n">email</span><span class="o">-</span><span class="n">address</span> <span class="o">-</span><span class="n">d</span> <span class="n">vpn</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</li>
<li><p>修改ocserv配置文件 <code class="docutils literal notranslate"><span class="pre">/etc/ocserv/ocserv.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 以下行注释关闭使用系统账号登陆</span>
<span class="c1"># auth = &quot;pam[gid-min=1000]&quot;</span>

<span class="c1"># 添加以下行表示独立密码文件认证</span>
<span class="n">auth</span> <span class="o">=</span> <span class="s2">&quot;plain[passwd=/etc/ocserv/ocpasswd]&quot;</span>

<span class="c1"># 只开启TCP端口，关闭UDP端口，以便使用BBR加速</span>
<span class="n">tcp</span><span class="o">-</span><span class="n">port</span> <span class="o">=</span> <span class="mi">443</span>
<span class="c1"># udp-port = 443</span>

<span class="c1"># 修改证书，注释前两行，添加后两行，表示使用Let&#39;s Encrypt服务器证书</span>
<span class="c1"># server-cert = /etc/ssl/certs/ssl-cert-snakeoil.pem</span>
<span class="c1"># server-key = /etc/ssl/private/ssl-cert-snakeoil.key</span>
<span class="n">server</span><span class="o">-</span><span class="n">cert</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">vpn</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">fullchain</span><span class="o">.</span><span class="n">pem</span>
<span class="n">server</span><span class="o">-</span><span class="n">key</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">letsencrypt</span><span class="o">/</span><span class="n">live</span><span class="o">/</span><span class="n">vpn</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">privkey</span><span class="o">.</span><span class="n">pem</span>

<span class="c1"># 设置客户端最大连接数量，默认是16</span>
<span class="nb">max</span><span class="o">-</span><span class="n">clients</span> <span class="o">=</span> <span class="mi">16</span>
<span class="c1"># 每个用户并发设备数量</span>
<span class="nb">max</span><span class="o">-</span><span class="n">same</span><span class="o">-</span><span class="n">clients</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># 启用MTU discovery以提高性能</span>
<span class="k">try</span><span class="o">-</span><span class="n">mtu</span><span class="o">-</span><span class="n">discovery</span> <span class="o">=</span> <span class="n">false</span>

<span class="c1"># 设置默认域名为vpn.example.com</span>
<span class="n">default</span><span class="o">-</span><span class="n">domain</span> <span class="o">=</span> <span class="n">vpn</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="c1"># 修改IPv4网段配置，注意不要和本地的IP网段重合</span>
<span class="n">ipv4</span><span class="o">-</span><span class="n">network</span> <span class="o">=</span> <span class="mf">10.10</span><span class="o">.</span><span class="mf">10.0</span>

<span class="c1"># 将所有DNS查询都通过VPN（防止受到DNS污染）</span>
<span class="n">tunnel</span><span class="o">-</span><span class="nb">all</span><span class="o">-</span><span class="n">dns</span> <span class="o">=</span> <span class="n">true</span>

<span class="c1"># 设置使用Google的公共DNS</span>
<span class="n">dns</span> <span class="o">=</span> <span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span>

<span class="c1"># 注释掉所有路由参数</span>
<span class="c1"># route = 10.10.10.0/255.255.255.0</span>
<span class="c1"># route = 192.168.0.0/255.255.0.0</span>
<span class="c1"># route = fef4:db8:1000:1001::/64</span>
<span class="c1"># no-route = 192.168.5.0/255.255.255.0</span>
</pre></div>
</div>
</li>
<li><p>重启ocserv:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">ocserv</span>
</pre></div>
</div>
</li>
<li><p>创建VPN账号:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ocpasswd</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ocserv</span><span class="o">/</span><span class="n">ocpasswd</span> <span class="n">username</span>
</pre></div>
</div>
</li>
<li><p>激活IP Forwarding （重要步骤）</p></li>
</ul>
<p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code> 添加:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">ip_forward</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>然后执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sysctl</span> <span class="o">-</span><span class="n">p</span>
</pre></div>
</div>
<ul>
<li><p>配置防火墙的IP Masquerading (这里加设网卡接口是 <code class="docutils literal notranslate"><span class="pre">ens3</span></code> ）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">o</span> <span class="n">ens3</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>
</pre></div>
</div>
</li>
<li><p>在防火墙上开启端口443:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">sudo</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>
</div>
</li>
</ul>
<p>保存防火墙配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">iptables</span><span class="o">-</span><span class="n">save</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
<ul>
<li><p>创建一个systemd服务来启动时恢复iptables规则，编辑 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/iptables-restore.service</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Packet</span> <span class="n">Filtering</span> <span class="n">Framework</span>
<span class="n">Before</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">pre</span><span class="o">.</span><span class="n">target</span>
<span class="n">Wants</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">pre</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">.</span><span class="n">rules</span>
<span class="n">ExecReload</span><span class="o">=/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">iptables</span><span class="o">.</span><span class="n">rules</span>
<span class="n">RemainAfterExit</span><span class="o">=</span><span class="n">yes</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</li>
<li><p>激活 <code class="docutils literal notranslate"><span class="pre">iptables-restore</span></code> 服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">iptables</span><span class="o">-</span><span class="n">restore</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="openconnect-vpn-client">
<h2>使用OpenConnect VPN Client</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>详细操作步骤参考 <a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/security/vpn/openconnect/openconnect.md">使用OpenConnect客户端</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/security/vpn/openconnect/openconnect.md]</span></p>
</div>
<ul>
<li><p>安装 OpenConnect:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">openconnect</span>
</pre></div>
</div>
</li>
<li><p>连接服务器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">openconnect</span> <span class="o">&lt;</span><span class="n">VPN服务器域名</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
</ul>
<p>连接建立以后，就可以正常使用apt安装Google软件仓库中的软件。</p>
</section>
<section id="cisco-anyconnect-vpn-client">
<h2>Cisco AnyConnect VPN Client</h2>
<p><a class="reference external" href="https://software.cisco.com/download/home/286281283/type/282364313/release/4.8.02045">Cisco AnyConnnect VPN Client</a><span class="link-target"> [https://software.cisco.com/download/home/286281283/type/282364313/release/4.8.02045]</span> 和OpenConnect VPN Server (ocserv) 兼容，所以可以从Cisco官方网站下载客户端。</p>
</section>
<section id="id2">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.linuxbabe.com/ubuntu/openconnect-vpn-server-ocserv-ubuntu-16-04-17-10-lets-encrypt">Set up OpenConnect VPN Server (ocserv) on Ubuntu 16.04/18.04 with Let’s Encrypt</a><span class="link-target"> [https://www.linuxbabe.com/ubuntu/openconnect-vpn-server-ocserv-ubuntu-16-04-17-10-lets-encrypt]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>