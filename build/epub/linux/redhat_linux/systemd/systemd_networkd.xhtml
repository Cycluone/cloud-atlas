<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Systemd Networkd服务</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="systemd-networkd">
<span id="id1"></span><h1>Systemd Networkd服务</h1>
<section id="systemd-networkdmac">
<h2>systemd-networkd设置MAC地址欺骗</h2>
<p><code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code> 支持通过 <code class="docutils literal notranslate"><span class="pre">systemd.link</span></code> 配置实现MAC地址欺骗。</p>
<ul class="simple">
<li><p>配置 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/network/00-wlan0.link</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">00-wlan0.network</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">systemd_networkd/00-wlan0.network</span></div>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">[</span>Match<span class="o">]</span>
<span class="nv">MACAddress</span><span class="o">=</span>original MAC

<span class="o">[</span>Link<span class="o">]</span>
<span class="nv">MACAddress</span><span class="o">=</span>spoofed MAC
<span class="nv">NamePolicy</span><span class="o">=</span>kernel database onboard slot path
</pre></div>
</td></tr></table></div>
</div>
</section>
<section id="systemdip">
<h2>systemd配置静态IP地址</h2>
<p><code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code> 配置静态IP地址非常简单，创建一个和网卡接口名相同配置文件，例如 <code class="docutils literal notranslate"><span class="pre">eth0</span></code> 创建 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/network/10-eth0.network</span></code> 内容如下:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">systemd_networkd/10-eth0.network</span></div>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">[</span>Match<span class="o">]</span>
<span class="nv">MACAddress</span><span class="o">=</span><span class="m">00</span>:00:00:00:00:01

<span class="o">[</span>Network<span class="o">]</span>
<span class="nv">Address</span><span class="o">=</span><span class="m">192</span>.168.6.10/24
<span class="nv">Gateway</span><span class="o">=</span><span class="m">192</span>.168.6.200
<span class="nv">DNS</span><span class="o">=</span><span class="m">192</span>.168.6.1
<span class="nv">DNS</span><span class="o">=</span><span class="m">192</span>.168.6.2
</pre></div>
</td></tr></table></div>
</div>
<ul>
<li><p>执行以下命令将默认NetworkManager切换成 <code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">NetworkManager</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">systemd</span><span class="o">-</span><span class="n">networkd</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">systemd</span><span class="o">-</span><span class="n">resolved</span><span class="o">.</span><span class="n">service</span>

<span class="n">systemctl</span> <span class="n">disable</span> <span class="n">NetworkManager</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">systemd</span><span class="o">-</span><span class="n">networkd</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="systemd">
<h2>systemd创建网桥</h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在使用 <code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code> 创建网桥前，我们已经有一个 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/network/enp0s25.network</span></code> 配置了有线以太网的IP地址</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">[</span>Match<span class="o">]</span>
<span class="nv">Name</span><span class="o">=</span>enp0s25

<span class="o">[</span>Network<span class="o">]</span>
<span class="nv">Address</span><span class="o">=</span><span class="m">192</span>.168.6.9/24
</pre></div>
</td></tr></table></div>
<p>所以此时 <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">addr</span></code> 显示 <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 的地址如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span><span class="p">:</span> <span class="n">enp0s25</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">fq_codel</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="n">f0</span><span class="p">:</span><span class="n">de</span><span class="p">:</span><span class="n">f1</span><span class="p">:</span><span class="mi">9</span><span class="n">b</span><span class="p">:</span><span class="mi">0</span><span class="n">c</span><span class="p">:</span><span class="mi">7</span><span class="n">b</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.9</span><span class="o">/</span><span class="mi">24</span> <span class="n">brd</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">6.255</span> <span class="n">scope</span> <span class="k">global</span> <span class="n">enp0s25</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="n">f2de</span><span class="p">:</span><span class="n">f1ff</span><span class="p">:</span><span class="n">fe9b</span><span class="p">:</span><span class="n">c7b</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
</pre></div>
</div>
<p>我们配置bridge网络，将bridge绑定到 <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 上，绑定过程中  <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 接口的IP地址 <code class="docutils literal notranslate"><span class="pre">192.168.6.9</span></code> 会丢失</p>
</div>
<ul class="simple">
<li><p>systemd创建名为 <code class="docutils literal notranslate"><span class="pre">br0</span></code> 的网桥使用配置文件 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/network/mybridge.netdev</span></code> :</p></li>
</ul>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">[</span>NetDev<span class="o">]</span>
<span class="nv">Name</span><span class="o">=</span>br0
<span class="nv">Kind</span><span class="o">=</span>bridge
</pre></div>
</td></tr></table></div>
<ul>
<li><p>然后重启 <code class="docutils literal notranslate"><span class="pre">systemd-networkd.service</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">systemd</span><span class="o">-</span><span class="n">networkd</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</li>
<li><p>然后执行 <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">addr</span></code> 检查可以看到以下网桥:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">8</span><span class="p">:</span> <span class="n">br0</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">noop</span> <span class="n">state</span> <span class="n">DOWN</span> <span class="n">group</span> <span class="n">default</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="mi">7</span><span class="n">e</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="n">f1</span><span class="p">:</span><span class="n">ea</span><span class="p">:</span><span class="mi">9</span><span class="n">e</span><span class="p">:</span><span class="n">e3</span> <span class="n">brd</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span>
</pre></div>
</div>
</li>
</ul>
<p>注意，此时接口 <code class="docutils literal notranslate"><span class="pre">br0</span></code> 状态还是 <code class="docutils literal notranslate"><span class="pre">DOWN</span></code></p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code> 是基于接口名字和主机ID为网桥设置MAC地址的，但是在某些场景可能存在问题，例如基于MAC过滤的路由。为了能够精确控制网桥MAC地址，可以在上述 <code class="docutils literal notranslate"><span class="pre">NetDev</span></code> 段落添加 <code class="docutils literal notranslate"><span class="pre">MACAddress=xx:xx:xx:xx:xx:xx</span></code> 来创建指定MAC地址的网桥。</p>
</div>
<ul class="simple">
<li><p>将以太网接口绑定到bridge</p></li>
</ul>
<p>接下来需要将物理网络接口( <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> )绑定到网桥( <code class="docutils literal notranslate"><span class="pre">br0</span></code> )上，则增加一个配置 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/network/bind.network</span></code> :</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">[</span>Match<span class="o">]</span>
<span class="nv">Name</span><span class="o">=</span>enp0s25

<span class="o">[</span>Network<span class="o">]</span>
<span class="nv">Bridge</span><span class="o">=</span>br0
</pre></div>
</td></tr></table></div>
<p>这里 <code class="docutils literal notranslate"><span class="pre">[Match]</span></code> 段落也配置通配符，也能起到相似作用，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Match</span><span class="p">]</span>
<span class="n">Name</span><span class="o">=</span><span class="n">en</span><span class="o">*</span>
</pre></div>
</div>
<ul>
<li><p>现在重启一次 <code class="docutils literal notranslate"><span class="pre">systemd-networkd</span></code> ，此时使用 <code class="docutils literal notranslate"><span class="pre">brctl</span> <span class="pre">show</span></code> 检查，就看到 <code class="docutils literal notranslate"><span class="pre">br0</span></code> 网桥已经启动，并且绑定在 <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 接口上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bridge</span> <span class="n">name</span>  <span class="n">bridge</span> <span class="nb">id</span>               <span class="n">STP</span> <span class="n">enabled</span>     <span class="n">interfaces</span>
<span class="n">br0</span>          <span class="mf">8000.7e33</span><span class="n">f1ea9ee3</span>       <span class="n">no</span>                  <span class="n">enp0s25</span>
</pre></div>
</div>
</li>
<li><p>配置网桥IP</p></li>
</ul>
<p>网桥 <code class="docutils literal notranslate"><span class="pre">br0</span></code> 已经绑定到以太网物理接口 <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 上，需要为网桥配置一个指定IP地址。这个配置也是通过 <code class="docutils literal notranslate"><span class="pre">.network</span></code> 文件定义，和配置普通网卡相同， <code class="docutils literal notranslate"><span class="pre">/etc/systemd/network/mybridge.network</span></code> 配置一个静态IP地址:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">[</span>Match<span class="o">]</span>
<span class="nv">Name</span><span class="o">=</span>br0

<span class="o">[</span>Network<span class="o">]</span>
<span class="nv">Address</span><span class="o">=</span><span class="m">192</span>.168.6.200/24
</pre></div>
</td></tr></table></div>
<p>这里也可以使用DHCP来配置网桥:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Match</span><span class="p">]</span>
<span class="n">Name</span><span class="o">=</span><span class="n">br0</span>

<span class="p">[</span><span class="n">Network</span><span class="p">]</span>
<span class="n">DHCP</span><span class="o">=</span><span class="n">ipv4</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里有一个疑惑 <code class="docutils literal notranslate"><span class="pre">enp0s25.network</span></code> 配置绑定到 <code class="docutils literal notranslate"><span class="pre">enp0s25</span></code> 的配置没有生效。在bind到br0之后，IP地址丢失。虽然可以通过 <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code> 手工恢复，但是networkd配置文件没有生效。</p>
</div>
</section>
<section id="id2">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Systemd-networkd">arch linxu wiki: systemd-networkd</a><span class="link-target"> [https://wiki.archlinux.org/index.php/Systemd-networkd]</span></p></li>
<li><p><a class="reference external" href="https://askubuntu.com/questions/1098052/18-04-does-it-force-netplan-or-can-i-still-use-resolved-conf">18.04 - does it force netplan or can I still use resolved.conf?</a><span class="link-target"> [https://askubuntu.com/questions/1098052/18-04-does-it-force-netplan-or-can-i-still-use-resolved-conf]</span> 引用了 <a class="reference external" href="https://www.freedesktop.org/software/systemd/man/systemd.network.html#Examples">systemd.network Examples</a><span class="link-target"> [https://www.freedesktop.org/software/systemd/man/systemd.network.html#Examples]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>