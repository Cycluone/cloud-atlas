<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Systemd的rc.local配置</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="systemdrc-local">
<span id="systemd-rc-local"></span><h1>Systemd的rc.local配置</h1>
<p>在早期的操作系统中，系统管理员很喜欢把一些操作系统启动时最后需要运行的脚本写在 <code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> 中，这个执行脚本（ <code class="docutils literal notranslate"><span class="pre">需要具有可执行属性</span></code> ）是操作系统启动时最后执行的启动脚本。</p>
<p>切换到RHEL/CentOS 7之后， <code class="docutils literal notranslate"><span class="pre">systemd</span></code> 接管了 <code class="docutils literal notranslate"><span class="pre">init</span></code> 模式的启动脚本，实际上已经不再适合使用 <code class="docutils literal notranslate"><span class="pre">rc.local</span></code> 启动脚本。但是为了兼容一些老系统习惯，保留了一个称为 <code class="docutils literal notranslate"><span class="pre">rc.lcoal.service</span></code> 的服务来引用 <code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> 。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>实际上 <code class="docutils literal notranslate"><span class="pre">systemd</span></code> 执行的并不是 <code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> ，而是 <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.local</span></code> 脚本，这个执行程序可以通过 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">rc-local</span></code> 指令看到输出如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● rc-local.service - /etc/rc.d/rc.local Compatibility
   Loaded: loaded (/usr/lib/systemd/system/rc-local.service; static; vendor preset: disabled)
   Active: active (exited) since Thu 2017-08-31 10:21:19 CST; 4 days ago
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> 实际上是指向 <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.local</span></code> 的软链接。曾经线上有出现过有人直接通过脚本 <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">/etc/rc.local</span></code> 然后又复制一个启动脚本到 <code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> ，愿意是用让新脚本在系统启动时运行。但是实际上破坏了系统默认的 <code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> 软链接，而系统自动执行的 <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.local</span></code> 并没有正确修改，也就无法执行正确的rc.local内容。</p>
</div>
<section id="rc-local">
<h2>配置 rc.local 服务</h2>
<ul>
<li><p>编辑兼容 <code class="docutils literal notranslate"><span class="pre">rc.local</span></code> 的 <code class="docutils literal notranslate"><span class="pre">systemd</span></code> 配置文件 <code class="docutils literal notranslate"><span class="pre">/usr/lib/systemd/system/rc-local.service</span></code> ，其内容如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span> <span class="n">Compatibility</span>
<span class="n">ConditionFileIsExecutable</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span>
<span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">forking</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span> <span class="n">start</span>
<span class="n">TimeoutSec</span><span class="o">=</span><span class="mi">0</span>
<span class="n">RemainAfterExit</span><span class="o">=</span><span class="n">yes</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以上配置是 Red Hat 的 rc-local.service 配置，因为Red Hat依然向后兼容 rc.local ，所以预先存放了 <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.local</span></code> 配置，只需要上述简单配置就可以。</p>
<p>在 Arch Linux中，默认都没有 <code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> ，则该配置文件 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/rc-local.service</span></code> 还需要做一些调整:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span> <span class="n">compatibility</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span>
<span class="c1"># disable timeout logic</span>
<span class="n">TimeoutSec</span><span class="o">=</span><span class="mi">0</span>
<span class="c1">#StandardOutput=tty</span>
<span class="n">RemainAfterExit</span><span class="o">=</span><span class="n">yes</span>
<span class="n">SysVStartPriority</span><span class="o">=</span><span class="mi">99</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>或者:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span> <span class="n">compatibility</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span>
<span class="n">RemainAfterExit</span><span class="o">=</span><span class="n">yes</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
<ul>
<li><p>激活rc-local服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">rc</span><span class="o">-</span><span class="n">local</span>
</pre></div>
</div>
</li>
<li><p>配置 <code class="docutils literal notranslate"><span class="pre">/etc/rc.d/rc.local</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/bash</span>
<span class="n">XXXXX</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">rc.local</span></code> 开头的第一行必须要指定shell解释器，否则不能正常运行</p>
</div>
<ul>
<li><p>创建软链接，并设置 <code class="docutils literal notranslate"><span class="pre">rc.local</span></code> 可执行属性:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span>
<span class="n">chmod</span> <span class="mi">755</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">rc.local</span></code> 必须具备可执行属性，否则启动系统不会自动执行。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>systemd启动服务默认是并发执行，如果没有在配置中指定先后顺序，则启动脚本顺序可能有随机行，所以不能脚本之间不能有依赖关系，也不要在多个脚本中执行相同或相互影响的内容，否则会出现不可预料的结果。</p>
</div>
<p>详细的一些配置systemd rc-local的经验教训，可以参考我的实践 <a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/redhat/system_administration/systemd/rc_local.md">systemd管理rc.local启动</a><span class="link-target"> [https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/redhat/system_administration/systemd/rc_local.md]</span></p>
</section>
<section id="id2">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.linuxbabe.com/linux-server/how-to-enable-etcrc-local-with-systemd">How to Enable /etc/rc.local with Systemd</a><span class="link-target"> [https://www.linuxbabe.com/linux-server/how-to-enable-etcrc-local-with-systemd]</span></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/User:Herodotus/Rc-Local-Systemd">User:Herodotus/Rc-Local-Systemd</a><span class="link-target"> [https://wiki.archlinux.org/index.php/User:Herodotus/Rc-Local-Systemd]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>