<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>earlyoom OOM服务</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="earlyoom-oom">
<span id="earlyoom"></span><h1>earlyoom OOM服务</h1>
<p>oom-killer对于Linux用户来说是”臭名昭著”的最坏情况，当Linux内存耗尽被迫调用oom-killer，将会导致系统存在潜在的不稳定。在调用oom-killer之前，Linux会尝试清理内存页缓存会清空所有buffer，但是这种危急情况下系统会进入呆滞状态，响应非常缓慢。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>有关oom-killer的讨论:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.reddit.com/r/linux/comments/56r4xj/why_are_low_memory_conditions_handled_so_badly/">Why are low memory conditions handled so badly?</a><span class="link-target"> [https://www.reddit.com/r/linux/comments/56r4xj/why_are_low_memory_conditions_handled_so_badly/]</span></p></li>
<li><p><a class="reference external" href="https://superuser.com/questions/406101/is-it-possible-to-make-the-oom-killer-intervent-earlier">Is it possible to make the OOM killer intervent earlier?</a><span class="link-target"> [https://superuser.com/questions/406101/is-it-possible-to-make-the-oom-killer-intervent-earlier]</span></p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在 Fedora 32 版本中，开始默认激活 EarlyOOM 功能，这代表着主流社区尝试解决OOM的努力，也表明EarlyOOM稳定可靠性得到认可。</p>
</div>
<section id="id1">
<h2>earlyoom工作原理</h2>
<p><a class="reference external" href="https://github.com/rfjakob/earlyoom">earlyoom - The Early OOM Daemon</a><span class="link-target"> [https://github.com/rfjakob/earlyoom]</span> 是帮助我们管理Linux OOM的服务。</p>
<p>当系统内存不足时，earlyoom会检查可用内存并清理swap，最高频度可以达到每秒10次。默认设置当内存和swap同时低于10%时候，earlyoom将杀掉占用内存最大当进程( <code class="docutils literal notranslate"><span class="pre">oom_score</span></code> 最大的 )。这个百分比值可以通过命令行参数调整。</p>
</section>
<section id="id2">
<h2>安装</h2>
<ul class="simple">
<li><p>CentOS 8环境需要先 <a class="reference internal" href="../../redhat_linux/admin/init_centos.xhtml#init-centos"><span class="std std-ref">CentOS系统管理初始化</span></a> ，并且 <a class="reference internal" href="../../../kubernetes/develop/install_golang.xhtml#install-golang"><span class="std std-ref">安装 Go 语言包</span></a> (make test使用go)</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果要生成man，则还需要安装 pandoc</p>
</div>
<ul>
<li><p>编译:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rfjakob</span><span class="o">/</span><span class="n">earlyoom</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">earlyoom</span>
<span class="n">make</span>
</pre></div>
</div>
</li>
<li><p>集成测试:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">test</span>
</pre></div>
</div>
</li>
<li><p>安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>对于Debian 10+ 和 Ubuntu 18.04+ ，则可以通过发行版仓库直接安装，更为简便:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">earlyoom</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">earlyoom</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">earlyoom</span>
</pre></div>
</div>
</div>
<ul>
<li><p>也可以通过EPEL安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span>
<span class="n">sudo</span> <span class="n">dnf</span> <span class="n">install</span> <span class="n">earlyoom</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">earlyoom</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id3">
<h2>使用</h2>
<p>如果是通过源代码编译安装，则直接启动就可以:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">earlyoom</span>
</pre></div>
</div>
<p>会提示使用的内存和swap状态。</p>
<p>如果是通过systemd服务安装，则使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">status</span> <span class="n">earlyoom</span>
</pre></div>
</div>
<p>可以看到当前输出的信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">systemd</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">Started</span> <span class="n">Early</span> <span class="n">OOM</span> <span class="n">Daemon</span><span class="o">.</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span> <span class="n">earlyoom</span> <span class="mf">1.3</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span> <span class="n">mem</span> <span class="n">total</span><span class="p">:</span> <span class="mi">1806</span> <span class="n">MiB</span><span class="p">,</span> <span class="n">swap</span> <span class="n">total</span><span class="p">:</span> <span class="mi">2047</span> <span class="n">MiB</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span> <span class="n">sending</span> <span class="n">SIGTERM</span> <span class="n">when</span> <span class="n">mem</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">%</span> <span class="ow">and</span> <span class="n">swap</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="o">%</span><span class="p">,</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span>         <span class="n">SIGKILL</span> <span class="n">when</span> <span class="n">mem</span> <span class="o">&lt;=</span>  <span class="mi">5</span> <span class="o">%</span> <span class="ow">and</span> <span class="n">swap</span> <span class="o">&lt;=</span>  <span class="mi">5</span> <span class="o">%</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span> <span class="n">mem</span> <span class="n">avail</span><span class="p">:</span>  <span class="mi">1237</span> <span class="n">of</span>  <span class="mi">1806</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">68</span> <span class="o">%</span><span class="p">),</span> <span class="n">swap</span> <span class="n">free</span><span class="p">:</span> <span class="mi">2039</span> <span class="n">of</span> <span class="mi">2047</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">99</span> <span class="o">%</span><span class="p">)</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span> <span class="n">mem</span> <span class="n">avail</span><span class="p">:</span>  <span class="mi">1239</span> <span class="n">of</span>  <span class="mi">1806</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">68</span> <span class="o">%</span><span class="p">),</span> <span class="n">swap</span> <span class="n">free</span><span class="p">:</span> <span class="mi">2039</span> <span class="n">of</span> <span class="mi">2047</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">99</span> <span class="o">%</span><span class="p">)</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span> <span class="n">mem</span> <span class="n">avail</span><span class="p">:</span>  <span class="mi">1239</span> <span class="n">of</span>  <span class="mi">1806</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">68</span> <span class="o">%</span><span class="p">),</span> <span class="n">swap</span> <span class="n">free</span><span class="p">:</span> <span class="mi">2039</span> <span class="n">of</span> <span class="mi">2047</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">99</span> <span class="o">%</span><span class="p">)</span>
<span class="n">Mar</span> <span class="mi">13</span> <span class="mi">17</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">44</span> <span class="n">centos8</span> <span class="n">earlyoom</span><span class="p">[</span><span class="mi">73837</span><span class="p">]:</span> <span class="n">mem</span> <span class="n">avail</span><span class="p">:</span>  <span class="mi">1238</span> <span class="n">of</span>  <span class="mi">1806</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">68</span> <span class="o">%</span><span class="p">),</span> <span class="n">swap</span> <span class="n">free</span><span class="p">:</span> <span class="mi">2039</span> <span class="n">of</span> <span class="mi">2047</span> <span class="n">MiB</span> <span class="p">(</span><span class="mi">99</span> <span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<p>最后10行信息是每分钟的系统当前内存使用情况。</p>
</section>
<section id="id4">
<h2>通知</h2>
<p>命令行参数 <code class="docutils literal notranslate"><span class="pre">-n</span></code> 可以通过 <code class="docutils literal notranslate"><span class="pre">notify-send</span></code> 发送</p>
<p>待实践…</p>
</section>
<section id="id5">
<h2>优先进程</h2>
<p>命令行参数 <code class="docutils literal notranslate"><span class="pre">--prefer</span></code> 可以设置优先 <code class="docutils literal notranslate"><span class="pre">杀掉</span></code> 的进程；相反， <code class="docutils literal notranslate"><span class="pre">--avoid</span></code> 则指定避免杀掉的进程。而且，可以使用正则表达式:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">earlyoom</span> <span class="o">--</span><span class="n">avoid</span> <span class="s1">&#39;^(foo|bar)$&#39;</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2>配置文件</h2>
<p>对于通过系统服务运行的earlyoom，则可以通过修改 <code class="docutils literal notranslate"><span class="pre">/etc/default/earlyoom</span></code> 来配置，例如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EARLYOOM_ARGS</span><span class="o">=</span><span class="s2">&quot;-m 5 -r 60 --avoid &#39;(^|/)(init|Xorg|ssh)$&#39; --prefer &#39;(^|/)(java|chromium)$&#39;&quot;</span>
</pre></div>
</div>
<p>修改配置之后，通过重启服务来修正:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">restart</span> <span class="n">earlyoom</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>命令行参数可以通过 <code class="docutils literal notranslate"><span class="pre">earlyoom</span> <span class="pre">-h</span></code> 查看</p>
</div>
</section>
<section id="id7">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/rfjakob/earlyoom">earlyoom - The Early OOM Daemon</a><span class="link-target"> [https://github.com/rfjakob/earlyoom]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>