<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>kind多节点集群</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="kind">
<span id="kind-multi-node"></span><h1>kind多节点集群</h1>
<p>在 <a class="reference internal" href="kind_cluster.xhtml#kind-cluster"><span class="std std-ref">kind集群(Docker in Docker)</span></a> 可以部署多个集群，不过默认部署的集群都是单个节点的，看上去和 minikube 并没有太大差别，只能验证应用功能，而不能实际演练Kubernetes集群的功能。</p>
<p>kind的真正功能在于部署多节点集群(multi-node clusters)，这种部署提供了完整的集群模拟。</p>
<p>kind官方网站提供了 <a class="reference external" href="https://raw.githubusercontent.com/kubernetes-sigs/kind/master/site/content/docs/user/kind-example-config.yaml">kind-example-config</a><span class="link-target"> [https://raw.githubusercontent.com/kubernetes-sigs/kind/master/site/content/docs/user/kind-example-config.yaml]</span> ，可以通过以下命令创建一个定制的集群:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kind</span> <span class="n">create</span> <span class="n">cluster</span> <span class="o">--</span><span class="n">config</span> <span class="n">kind</span><span class="o">-</span><span class="n">example</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<section id="id1">
<h2>多节点集群实践</h2>
<ul class="simple">
<li><p>配置3个管控节点，5个工作节点的集群配置文件如下：</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">kind-config.yaml</span></div>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># a cluster with 3 control-plane nodes and 5 workers</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Cluster</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kind.x-k8s.io/v1alpha4</span>
<span class="nt">nodes</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">control-plane</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">control-plane</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">control-plane</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="p p-Indicator">-</span> <span class="nt">role</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">worker</span>
</pre></div>
</td></tr></table></div>
</div>
<ul>
<li><p>执行创建集群，集群命名为 <code class="docutils literal notranslate"><span class="pre">dev</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kind</span> <span class="n">create</span> <span class="n">cluster</span> <span class="o">--</span><span class="n">name</span> <span class="n">dev</span> <span class="o">--</span><span class="n">config</span> <span class="n">kind</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</li>
<li><p>完成以后检查集群:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">--</span><span class="n">context</span> <span class="n">kind</span><span class="o">-</span><span class="n">dev</span> <span class="n">get</span> <span class="n">nodes</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到创建的集群节点如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>                 <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>     <span class="n">VERSION</span>
<span class="n">dev</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span>    <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">2</span><span class="n">m15s</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">dev</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane2</span>   <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">99</span><span class="n">s</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">dev</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane3</span>   <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">49</span><span class="n">s</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">dev</span><span class="o">-</span><span class="n">worker</span>           <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">32</span><span class="n">s</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">dev</span><span class="o">-</span><span class="n">worker2</span>          <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">32</span><span class="n">s</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">dev</span><span class="o">-</span><span class="n">worker3</span>          <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">32</span><span class="n">s</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">dev</span><span class="o">-</span><span class="n">worker4</span>          <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">29</span><span class="n">s</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">dev</span><span class="o">-</span><span class="n">worker5</span>          <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">32</span><span class="n">s</span>     <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
</pre></div>
</div>
<p>通过 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> 命令可以看到，kind还多启动了一个容器来运行haproxy，以提供外部访问这个集群的apiserver的负载均衡分发，例如以下案例中端口 <code class="docutils literal notranslate"><span class="pre">33401</span></code> 就是访问该集群的apiserver端口(见第一行):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#docker ps</span>
<span class="n">CONTAINER</span> <span class="n">ID</span>        <span class="n">IMAGE</span>                          <span class="n">COMMAND</span>                  <span class="n">CREATED</span>             <span class="n">STATUS</span>              <span class="n">PORTS</span>                       <span class="n">NAMES</span>
<span class="mi">48309</span><span class="n">bdd8439</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">haproxy</span><span class="p">:</span><span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">alpine</span>   <span class="s2">&quot;/docker-entrypoint.…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>         <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">33401</span><span class="o">-&gt;</span><span class="mi">6443</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">dev</span><span class="o">-</span><span class="n">external</span><span class="o">-</span><span class="n">load</span><span class="o">-</span><span class="n">balancer</span>
<span class="n">b0f8267aa09a</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>                                     <span class="n">dev</span><span class="o">-</span><span class="n">worker2</span>
<span class="mi">524</span><span class="n">c7b50790b</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>                                     <span class="n">dev</span><span class="o">-</span><span class="n">worker</span>
<span class="mi">9790</span><span class="n">bbe67900</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>         <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">21003</span><span class="o">-&gt;</span><span class="mi">6443</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">dev</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span>
<span class="mi">21</span><span class="n">c86c9750dd</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>         <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">32351</span><span class="o">-&gt;</span><span class="mi">6443</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">dev</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane3</span>
<span class="mi">8</span><span class="n">abd58281f54</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>                                     <span class="n">dev</span><span class="o">-</span><span class="n">worker5</span>
<span class="mi">634</span><span class="n">df18e345e</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>                                     <span class="n">dev</span><span class="o">-</span><span class="n">worker4</span>
<span class="mi">06</span><span class="n">d46f9ff05e</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>         <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">14861</span><span class="o">-&gt;</span><span class="mi">6443</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">dev</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane2</span>
<span class="n">a8f88cb59b1b</span>        <span class="n">kindest</span><span class="o">/</span><span class="n">node</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>           <span class="s2">&quot;/usr/local/bin/entr…&quot;</span>   <span class="mi">42</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">42</span> <span class="n">hours</span>                                     <span class="n">dev</span><span class="o">-</span><span class="n">worker3</span>
</pre></div>
</div>
<p>所以，在运行 kind 的服务器上执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</div>
<p>可以看到如下输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Kubernetes</span> <span class="n">master</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">33401</span>
<span class="n">KubeDNS</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">33401</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">:</span><span class="n">dns</span><span class="o">/</span><span class="n">proxy</span>

<span class="n">To</span> <span class="n">further</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">diagnose</span> <span class="n">cluster</span> <span class="n">problems</span><span class="p">,</span> <span class="n">use</span> <span class="s1">&#39;kubectl cluster-info dump&#39;</span><span class="o">.</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>