<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Docker容器中运行ssh服务</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="dockerssh">
<span id="docker-ssh"></span><h1>Docker容器中运行ssh服务</h1>
<p>实际上在Docker容器内不建议运行sshd服务 <a class="reference internal" href="../startup/docker_concept.xhtml#docker-concept"><span class="std std-ref">Docker基本概念</span></a> ：Docker是设计成在每个容器只运行一个单一服务/进程，所以运行应用的容器 中，通常不需要再运行sshd服务。这样自然就避免了运维人员登陆容器内容进行手工操作。</p>
<p>不过，也并非无法在容器中启动sshd服务，一些情况下，例如个人的开发环境，能够在容器内部运行一个ssh服务，还是很方便维护的 。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以下案例在Ubuntu 18.04 官方镜像上建立的容器中安装和运行sshd服务，方便开发测试的案例。</p>
<p>启动容器方法参考 <a class="reference internal" href="container_static_ip.xhtml#container-static-ip"><span class="std std-ref">Docker容器分配静态IP</span></a></p>
</div>
<ul>
<li><p>启动容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">net</span> <span class="n">ceph</span><span class="o">-</span><span class="n">net</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">172.18</span><span class="o">.</span><span class="mf">0.11</span> <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">d</span> \
  <span class="o">--</span><span class="n">hostname</span> <span class="n">ceph</span><span class="o">-</span><span class="n">node1</span> <span class="o">--</span><span class="n">name</span> <span class="n">ceph</span><span class="o">-</span><span class="n">node1</span> <span class="o">-</span><span class="n">v</span> <span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span> <span class="n">ubuntu</span><span class="p">:</span><span class="n">latest</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
</li>
<li><p>登陆容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">attach</span> <span class="n">ceph</span><span class="o">-</span><span class="n">node1</span>
</pre></div>
</div>
</li>
<li><p>在容器内部执行安装sshd服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">openssh</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
<li><p>创建sshd服务使用的的host key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">A</span>
</pre></div>
</div>
</li>
<li><p>创建sshd服务运行目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span>
</pre></div>
</div>
</li>
<li><p>启动ssh服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">sshd</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>注意，这里启动sshd服务是一次性的，下次启动容器，由于容器创建只运行了 <code class="docutils literal notranslate"><span class="pre">/bin/bash</span></code> 所以并没有启动sshd服务。</p>
<p>要保持docker启动时能够启动ssh服务并运行bash，需要先将包含ssh的镜像制作出来，然后基于此镜像启动容器时采用bash来执行多条命令，案例如下：</p>
</div>
<ul>
<li><p>保存镜像:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">commit</span> <span class="n">ceph</span><span class="o">-</span><span class="n">node1</span> <span class="n">local</span><span class="p">:</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span><span class="o">-</span><span class="n">ssh</span>
</pre></div>
</div>
</li>
<li><p>再次创建容器，此时容器运行命令中包含启动sshd服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">rm</span> <span class="n">ceph</span><span class="o">-</span><span class="n">node1</span>

<span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">net</span> <span class="n">ceph</span><span class="o">-</span><span class="n">net</span> <span class="o">--</span><span class="n">ip</span> <span class="mf">172.18</span><span class="o">.</span><span class="mf">0.11</span> <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">d</span> \
  <span class="o">--</span><span class="n">hostname</span> <span class="n">ceph</span><span class="o">-</span><span class="n">node1</span> <span class="o">--</span><span class="n">name</span> <span class="n">ceph</span><span class="o">-</span><span class="n">node1</span> <span class="o">-</span><span class="n">v</span> <span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span> <span class="n">local</span><span class="p">:</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span><span class="o">-</span><span class="n">ssh</span> \
  <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">-</span><span class="n">c</span> <span class="s2">&quot;/usr/sbin/sshd &amp;&amp; /bin/bash&quot;</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>虽然上述通过命令方式一点点积累也能够搞好镜像，并且能让别人能参考这篇文档来完成镜像制作，不过毕竟还是一个重复的手工操作。Docker为了方便系统管理员能够自己定制镜像，提供了一个 <a class="reference internal" href="dockerfile.xhtml#dockerfile"><span class="std std-ref">从Dockerfile构建Docker镜像</span></a></p>
</div>
<section id="id1">
<h2>参考</h2>
<ul class="simple">
<li><p><a class="reference external" href="https://stackoverflow.com/questions/25135897/how-to-automatically-start-a-service-when-running-a-docker-container">How to automatically start a service when running a docker container?</a><span class="link-target"> [https://stackoverflow.com/questions/25135897/how-to-automatically-start-a-service-when-running-a-docker-container]</span></p></li>
<li><p><a class="reference external" href="https://docs.docker.com/engine/examples/running_ssh_service/">Dockerize an SSH service</a><span class="link-target"> [https://docs.docker.com/engine/examples/running_ssh_service/]</span></p></li>
<li><p><a class="reference external" href="https://docs.docker.com/engine/admin/multi-service_container/">Run multiple services in a container</a><span class="link-target"> [https://docs.docker.com/engine/admin/multi-service_container/]</span></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>