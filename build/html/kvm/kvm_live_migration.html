

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>KVM热迁移 &mdash; Cloud Atlas 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="QEMU磁盘镜像" href="qemu_images.html" />
    <link rel="prev" title="Studio环境libvirt静态分配IP" href="libvirt_static_ip_in_studio.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">KVM Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hypervisor.html">hypervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="kvm_architecture.html">KVM虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="libvirt/index.html">Libvirt虚拟机管理器</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance/index.html">KVM 性能优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="hardware_virtual.html">硬件虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="intel_vmcs.html">Intel VMCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_vm.html">Studio环境创建KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy_win_vm.html">部署Windows KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup_vm.html">备份KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="clone_vm.html">复制KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="nested_virtual.html">Studio嵌套虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="add_resize_virtual_disk_to_guest_on_fly.html">KVM虚拟机动态添加、调整磁盘</a></li>
<li class="toctree-l2"><a class="reference internal" href="libvirt_static_ip_in_studio.html">Studio环境libvirt静态分配IP</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">KVM热迁移</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">准备工作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nfs">基于NFS共享存储</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">NFS客户端挂载</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#libvirtvm">配置libvirt的VM存储池</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">测试虚拟机</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">热迁移</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="qemu_images.html">QEMU磁盘镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="kvm_image_access_with_libguestfs.html">使用libguestfs访问KVM镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="memballoon.html">虚拟机内存balloon</a></li>
<li class="toctree-l2"><a class="reference internal" href="pci_passthrough.html">PCI passthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpu_passthrough_with_kvm.html">KVM的GPU直通虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="vt-d_in_kvm.html">KVM的VT-d虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="nvidia_cuda_gpu_in_kvm.html">在KVM中使用NVIDIA CUDA GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="amd_rocm_gpu_in_kvm.html">在KVM中使用AMD ROCm GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="xhyve.html">xhyve - macOS平台的KVM</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">KVM Atlas</a> &raquo;</li>
        
      <li>KVM热迁移</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/kvm/kvm_live_migration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kvm">
<span id="kvm-live-migration"></span><h1>KVM热迁移<a class="headerlink" href="#kvm" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>准备工作<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>KVM虚拟化技术有一个非常有用的杀手锏技术 <a class="reference internal" href="#kvm-live-migration"><span class="std std-ref">KVM热迁移</span></a> ，我们现在已经得到了支持嵌套虚拟化的虚拟机 <code class="docutils literal notranslate"><span class="pre">devstack</span></code> ，我们现在从这个 <code class="docutils literal notranslate"><span class="pre">devstack</span></code> 复制出我们热迁移用的两个虚拟机 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virt</span><span class="o">-</span><span class="n">clone</span> <span class="o">--</span><span class="n">connect</span> <span class="n">qemu</span><span class="p">:</span><span class="o">///</span><span class="n">system</span> <span class="o">--</span><span class="n">original</span> <span class="n">devstack</span> <span class="o">--</span><span class="n">name</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">file</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">devstack</span><span class="o">-</span><span class="mf">1.</span><span class="n">qcow2</span>
<span class="n">sudo</span> <span class="n">virt</span><span class="o">-</span><span class="n">sysprep</span> <span class="o">-</span><span class="n">d</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">hostname</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span><span class="n">root</span><span class="o">-</span><span class="n">password</span> <span class="n">password</span><span class="p">:</span><span class="n">CHANGE_ME</span>

<span class="n">virt</span><span class="o">-</span><span class="n">clone</span> <span class="o">--</span><span class="n">connect</span> <span class="n">qemu</span><span class="p">:</span><span class="o">///</span><span class="n">system</span> <span class="o">--</span><span class="n">original</span> <span class="n">devstack</span> <span class="o">--</span><span class="n">name</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">2</span> <span class="o">--</span><span class="n">file</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">devstack</span><span class="o">-</span><span class="mf">2.</span><span class="n">qcow2</span>
<span class="n">sudo</span> <span class="n">virt</span><span class="o">-</span><span class="n">sysprep</span> <span class="o">-</span><span class="n">d</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">2</span> <span class="o">--</span><span class="n">hostname</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">2</span> <span class="o">--</span><span class="n">root</span><span class="o">-</span><span class="n">password</span> <span class="n">password</span><span class="p">:</span><span class="n">CHANGE_ME</span>
</pre></div>
</div>
<p>这两个支持 Nested Virtualization 的虚拟机 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 不仅是我们测试嵌套虚拟化的虚拟机，也是测试 热迁移技术的虚拟机。我们这里使用 <a class="reference internal" href="../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 中 <a class="reference internal" href="../kubernetes/startup_prepare/install_run_minikube.html#install-run-minikube"><span class="std std-ref">安装和运行minikube</span></a> 来作为”嵌在内部”的虚拟机。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">minikube</span></code> 虚拟机是2c2g配置，我们需要调整 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 的虚拟机配置，修订成 <code class="docutils literal notranslate"><span class="pre">2c4g</span></code> 配置来支持嵌套运行 <code class="docutils literal notranslate"><span class="pre">minikube</span></code></p>
</div>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 虚拟机的内部参考 <a class="reference internal" href="../studio/kvm_docker_in_studio.html#kvm-docker-in-studio"><span class="std std-ref">Studio环境KVM和Docker</span></a> 安装KVM运行环境:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">qemu</span><span class="o">-</span><span class="n">kvm</span> <span class="n">libvirt</span><span class="o">-</span><span class="n">daemon</span><span class="o">-</span><span class="n">system</span> <span class="n">libvirt</span><span class="o">-</span><span class="n">clients</span> <span class="n">bridge</span><span class="o">-</span><span class="n">utils</span> <span class="n">virtinst</span> <span class="n">libguestfs</span><span class="o">-</span><span class="n">tools</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="nfs">
<h2>基于NFS共享存储<a class="headerlink" href="#nfs" title="Permalink to this headline">¶</a></h2>
<p>KVM热迁移实现需要使用共享的存储池，最简便的方法是使用NFS共享。更为复杂且高可用、高性能的是使用共享的分布式文件系统，如Ceph ( 请参考 <a class="reference internal" href="../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> )。</p>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> 物理主机上 <a class="reference internal" href="../linux/storage/filesystem/btrfs_in_studio.html#btrfs-in-studio"><span class="std std-ref">Studio环境的Btrfs存储</span></a> 创建子卷 <code class="docutils literal notranslate"><span class="pre">images</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">btrfs</span> <span class="n">subvolume</span> <span class="n">create</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">images</span>
</pre></div>
</div>
</li>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 添加:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda3</span>    <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span>        <span class="n">btrfs</span>  <span class="n">subvol</span><span class="o">=</span><span class="n">images</span><span class="p">,</span><span class="n">defaults</span><span class="p">,</span><span class="n">noatime</span>    <span class="mi">0</span>   <span class="mi">1</span>
</pre></div>
</div>
</li>
<li><p>挂载目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span>
</pre></div>
</div>
</li>
<li><p>安装NFS服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">nfs</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
<li><p>设置NFS共享，即编辑 <code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span>    <span class="mf">192.168</span><span class="o">.</span><span class="mf">122.0</span><span class="o">/</span><span class="mi">24</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">sync</span><span class="p">,</span><span class="n">no_root_squash</span><span class="p">,</span><span class="n">no_subtree_check</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>服务器端输出NFS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exportfs</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="id2">
<h3>NFS客户端挂载<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>在作为KVM虚拟化运行的主机 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 中使用NFS方式挂载 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> 共享出来的NFS存储，以下命令都在这两个虚拟机中运行:</p>
<ul>
<li><p>安装NFS客户端:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="n">nfs</span><span class="o">-</span><span class="n">common</span>
</pre></div>
</div>
</li>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 添加:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168</span><span class="o">.</span><span class="mf">122.1</span><span class="p">:</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">nfs</span><span class="o">-</span><span class="n">images</span>  <span class="n">nfs</span>  <span class="n">auto</span><span class="p">,</span><span class="n">rw</span><span class="p">,</span><span class="n">vers</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">hard</span><span class="p">,</span><span class="n">intr</span><span class="p">,</span><span class="n">tcp</span><span class="p">,</span><span class="n">rsize</span><span class="o">=</span><span class="mi">32768</span><span class="p">,</span><span class="n">wsize</span><span class="o">=</span><span class="mi">32768</span>      <span class="mi">0</span>   <span class="mi">0</span>
</pre></div>
</div>
</li>
<li><p>客户端挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span>
</pre></div>
</div>
</li>
</ul>
<p>挂载之后，在 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 两个虚拟机内部都会看到共享存储如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168</span><span class="o">.</span><span class="mf">122.1</span><span class="p">:</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span>  <span class="mi">184</span><span class="n">G</span>   <span class="mi">13</span><span class="n">G</span>  <span class="mi">170</span><span class="n">G</span>   <span class="mi">8</span><span class="o">%</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="libvirtvm">
<h2>配置libvirt的VM存储池<a class="headerlink" href="#libvirtvm" title="Permalink to this headline">¶</a></h2>
<p>默认情况下libvirt使用的存储池目录是 <code class="docutils literal notranslate"><span class="pre">/var/lib/libvirt/images</span></code> ，需要修改成热迁移共享存储NFS。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>必须检查 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 上所有虚拟机运行状态，确保所有虚拟机都已经关闭:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="nb">list</span> <span class="o">--</span><span class="nb">all</span>
</pre></div>
</div>
</div>
<ul>
<li><p>检查存储池:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">pool</span><span class="o">-</span><span class="nb">list</span> <span class="o">--</span><span class="nb">all</span>
</pre></div>
</div>
</li>
</ul>
<p>如果没有创建过虚拟机，上述存储池输出可能是空的。如果创建了虚拟机，默认会有一个 <code class="docutils literal notranslate"><span class="pre">images</span></code> 存储池。这里尝试创建一个虚拟机来激活存储池:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virt</span><span class="o">-</span><span class="n">install</span> \
  <span class="o">--</span><span class="n">network</span> <span class="n">bridge</span><span class="p">:</span><span class="n">virbr0</span> \
  <span class="o">--</span><span class="n">name</span> <span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span> \
  <span class="o">--</span><span class="n">ram</span><span class="o">=</span><span class="mi">2048</span> \
  <span class="o">--</span><span class="n">vcpus</span><span class="o">=</span><span class="mi">1</span> \
  <span class="o">--</span><span class="n">os</span><span class="o">-</span><span class="nb">type</span><span class="o">=</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span> \
  <span class="o">--</span><span class="n">disk</span> <span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="n">qcow2</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">virtio</span><span class="p">,</span><span class="n">cache</span><span class="o">=</span><span class="n">none</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span> \
  <span class="o">--</span><span class="n">graphics</span> <span class="n">none</span> \
  <span class="o">--</span><span class="n">location</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="mf">163.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">/</span><span class="n">dists</span><span class="o">/</span><span class="n">bionic</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">installer</span><span class="o">-</span><span class="n">amd64</span><span class="o">/</span> \
  <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">args</span><span class="o">=</span><span class="s2">&quot;console=tty0 console=ttyS0,115200&quot;</span>
</pre></div>
</div>
<p>报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ERROR</span>    <span class="n">Couldn</span><span class="s1">&#39;t create storage volume &#39;</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span><span class="s1">&#39;: &#39;</span><span class="n">internal</span> <span class="n">error</span><span class="p">:</span> <span class="n">Child</span> <span class="n">process</span> <span class="p">(</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">img</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">qcow2</span> <span class="o">-</span><span class="n">o</span> <span class="n">preallocation</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span><span class="n">compat</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span><span class="n">lazy_refcounts</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span> <span class="mi">16777216</span><span class="n">K</span><span class="p">)</span> <span class="n">unexpected</span> <span class="n">exit</span> <span class="n">status</span> <span class="mi">1</span><span class="p">:</span> <span class="n">qemu</span><span class="o">-</span><span class="n">img</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span><span class="p">:</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">lock</span> <span class="n">byte</span> <span class="mi">100</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>参考 <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1547095">Bug 1547095 - QEMU image locking on NFSv3 prevents VMs from getting restarted on different hosts upon an host crash, seen on RHEL 7.5</a></p>
<blockquote>
<div><p>FYI, I’m told by a storage maintainer that this is only really a problem with NFSv3. With NFSv4, locks use an active lease mechanism with the client having to refresh the lease periodically for it to remain valid.  So if you are using NFSv4 and the client dies with locks held, they should be revoked by the server after the lease renewal timeout is reached, allowing another host to acquire them.</p>
<p>Some more info here about NFSv4 locking here:</p>
<p><a class="reference external" href="https://www.ibm.com/support/knowledgecenter/en/SSLTBW_2.1.0/com.ibm.zos.v2r1.idan400/lockv4.htm">https://www.ibm.com/support/knowledgecenter/en/SSLTBW_2.1.0/com.ibm.zos.v2r1.idan400/lockv4.htm</a></p>
<p>Given NFSv3 is a legacy protocol, I don’t think it justifies disabling locking from QEMU side. The nolock mount option seems like a reasonable  workaround for V3, if the sites in question really can’t use V4.</p>
</div></blockquote>
</div>
<p>修改NFS挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168</span><span class="o">.</span><span class="mf">122.1</span><span class="p">:</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span>  <span class="n">nfs4</span>  <span class="n">_netdev</span><span class="p">,</span><span class="n">auto</span> <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>然后重新挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">umount</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span>
</pre></div>
</div>
<p>再次尝试创建虚拟机就可以成功，也就具备了 <code class="docutils literal notranslate"><span class="pre">images</span></code> 这个默认存储池。</p>
<p>如果已经有一个 <code class="docutils literal notranslate"><span class="pre">images</span></code> 存储池，则使用 <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">pool-edit</span> <span class="pre">images</span></code> 编辑配置，其中的存储路径修改成新的NFS共享存储路径 <code class="docutils literal notranslate"><span class="pre">/var/lib/libvirt/nfs-images</span></code> 。</p>
<ul>
<li><p>如果还没有存储池，则创建一个 <code class="docutils literal notranslate"><span class="pre">images.xml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">pool</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;dir&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">images</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">target</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">&lt;/</span><span class="n">path</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">target</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">pool</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
</ul>
<p>然后执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">pool</span><span class="o">-</span><span class="n">create</span> <span class="n">nfs</span><span class="o">-</span><span class="n">images</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>以上通过XML文件创建存储池方法也可用命令行实现:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">pool</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="k">as</span> <span class="o">--</span><span class="n">name</span> <span class="n">images</span> <span class="o">--</span><span class="nb">type</span> <span class="nb">dir</span> <span class="o">--</span><span class="n">target</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span>
</pre></div>
</div>
<p>当然也可以直接创建一个虚拟机来实现存储卷 <code class="docutils literal notranslate"><span class="pre">images</span></code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>详细请参考 <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/sect-managing_guest_virtual_machines_with_virsh-storage_pool_commands">Storage Pool Commands</a></p>
</div>
</div>
<div class="section" id="id3">
<h2>测试虚拟机<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>在 <a class="reference internal" href="create_vm.html#create-vm"><span class="std std-ref">Studio环境创建KVM虚拟机</span></a> 创建过第一个虚拟机名为 <cite>ubuntu18.04</cite> ，我们现在将这个虚拟机从 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> 物理服务器上复制到支持嵌套虚拟化的 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 虚拟机中，存放到 <code class="docutils literal notranslate"><span class="pre">/var/lib/libvirt/images</span></code> 目录下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- 在 ``xcloud`` 上执行::
</pre></div>
</div>
<blockquote>
<div><p>cd /var/lib/libvirt/images
scp ubuntu18.04.qcow2 devstack-1:/var/lib/libvirt/images/nested-ubuntu18.04.qcow2</p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>由于 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 的NFS共享挂载的就是 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> 的 <code class="docutils literal notranslate"><span class="pre">/nfs/images</span></code> 目录，所以上述命令其实也可以在 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> 上直接复制到本地目录 <code class="docutils literal notranslate"><span class="pre">/nfs/images</span></code> 下，同样会被 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span> <span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">nested</span><span class="o">-</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span>
</pre></div>
</div>
</div>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 中检查 <code class="docutils literal notranslate"><span class="pre">/var/lib/libvirt/images</span></code> 目录下应该有如下文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">17</span><span class="n">G</span> <span class="n">Mar</span> <span class="mi">13</span> <span class="mi">16</span><span class="p">:</span><span class="mi">56</span> <span class="n">nested</span><span class="o">-</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span>
</pre></div>
</div>
</li>
</ul>
<p>修改成 <code class="docutils literal notranslate"><span class="pre">libvirt-qemu:kvm</span></code> 属主:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="n">libvirt</span><span class="o">-</span><span class="n">qemu</span><span class="p">:</span><span class="n">kvm</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">nested</span><span class="o">-</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span>
</pre></div>
</div>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 上导入这个虚拟机 (使用 <code class="docutils literal notranslate"><span class="pre">--import</span></code> 参数 ):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virt</span><span class="o">-</span><span class="n">install</span> \
  <span class="o">--</span><span class="n">network</span> <span class="n">bridge</span><span class="p">:</span><span class="n">virbr0</span> \
  <span class="o">--</span><span class="n">name</span> <span class="n">nested</span><span class="o">-</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span> \
  <span class="o">--</span><span class="n">os</span><span class="o">-</span><span class="nb">type</span><span class="o">=</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span> \
  <span class="o">--</span><span class="n">ram</span><span class="o">=</span><span class="mi">2048</span> \
  <span class="o">--</span><span class="n">vcpus</span><span class="o">=</span><span class="mi">1</span> \
  <span class="o">--</span><span class="n">disk</span> <span class="n">path</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">libvirt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">nested</span><span class="o">-</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mf">04.</span><span class="n">qcow2</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="n">qcow2</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">virtio</span><span class="p">,</span><span class="n">cache</span><span class="o">=</span><span class="n">none</span> \
  <span class="o">--</span><span class="n">network</span> <span class="n">bridge</span><span class="o">=</span><span class="n">virbr0</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">virtio</span> \
  <span class="o">--</span><span class="kn">import</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这里还有一点问题，照例说使用了 <code class="docutils literal notranslate"><span class="pre">--import</span></code> 不应该出现安装过程。不过依然可以使用</p>
</div>
</div>
<div class="section" id="id4">
<h2>热迁移<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>在 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 主机间设置好ssh免密码登陆</p></li>
</ul>
<p>以下命令在物理主机 <code class="docutils literal notranslate"><span class="pre">xcloud</span></code> 上执行，将密钥分发到两个测试虚拟机上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">id_rsa</span><span class="o">*</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span>
<span class="n">scp</span> <span class="n">id_rsa</span><span class="o">*</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">huatai</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span>
</pre></div>
</div>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 的 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 中添加主机名解析:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168</span><span class="o">.</span><span class="mf">122.21</span>   <span class="n">devstack</span><span class="o">-</span><span class="mi">1</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">122.22</span>   <span class="n">devstack</span><span class="o">-</span><span class="mi">2</span>
</pre></div>
</div>
</li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">devstack-1</span></code> 和 <code class="docutils literal notranslate"><span class="pre">devstack-2</span></code> 的 <code class="docutils literal notranslate"><span class="pre">~/.ssh/config</span></code> 中添加:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="o">*</span>
    <span class="n">ServerAliveInterval</span> <span class="mi">60</span>
    <span class="n">ControlMaster</span> <span class="n">auto</span>
    <span class="n">ControlPath</span> <span class="o">~/.</span><span class="n">ssh</span><span class="o">/%</span><span class="n">h</span><span class="o">-%</span><span class="n">p</span><span class="o">-%</span><span class="n">r</span>
    <span class="n">ControlPersist</span> <span class="n">yes</span>
</pre></div>
</div>
</li>
</ul>
<p>这样只需要一次ssh登陆，后续复用socks就不需要密码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">devstack</span><span class="o">-</span><span class="mi">2</span> <span class="s2">&quot;virsh list&quot;</span>
</pre></div>
</div>
<ul>
<li><p>热迁移:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">migrate</span> <span class="n">nested</span><span class="o">-</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span> <span class="n">qemu</span><span class="o">+</span><span class="n">ssh</span><span class="p">:</span><span class="o">//</span><span class="n">devstack</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="n">system</span>

<span class="n">virsh</span> <span class="n">migrate</span> <span class="n">nested</span><span class="o">-</span><span class="n">ubuntu18</span><span class="o">.</span><span class="mi">04</span> <span class="n">qemu</span><span class="o">+</span><span class="n">ssh</span><span class="p">:</span><span class="o">//</span><span class="n">devstack</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">system</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="qemu_images.html" class="btn btn-neutral float-right" title="QEMU磁盘镜像" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="libvirt_static_ip_in_studio.html" class="btn btn-neutral float-left" title="Studio环境libvirt静态分配IP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../copyright.html">Copyright</a> 2019, Huatai Huang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>