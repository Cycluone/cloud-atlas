

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xhyve - macOS平台的KVM &mdash; Cloud Atlas 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="Ceph Atlas" href="../../ceph/index.html" />
    <link rel="prev" title="macOS平台的KVM" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">KVM Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../hypervisor.html">hypervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_architecture.html">KVM虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud-init.html">cloud-init</a></li>
<li class="toctree-l2"><a class="reference internal" href="../virtio/index.html">KVM virtio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libvirt/index.html">Libvirt虚拟机管理器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../remote_desktop/index.html">远程桌面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html">KVM 性能优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware_virtual.html">硬件虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intel_vmcs.html">Intel VMCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../create_vm.html">Studio环境创建KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deploy_win_vm.html">部署Windows KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backup_vm.html">备份KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clone_vm.html">复制KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_nested_virtual.html">KVM嵌套虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../add_resize_virtual_disk_to_guest_on_fly.html">KVM虚拟机动态添加、调整磁盘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libvirt_static_ip_in_studio.html">Studio环境libvirt静态分配IP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_live_migration.html">KVM热迁移</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qemu_images.html">QEMU磁盘镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_image_access_with_libguestfs.html">使用libguestfs访问KVM镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memballoon.html">虚拟机内存balloon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pci_passthrough.html">PCI passthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_passthrough_with_kvm.html">KVM的GPU直通虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vt-d_in_kvm.html">KVM的VT-d虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvidia_cuda_gpu_in_kvm.html">在KVM中使用NVIDIA CUDA GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../amd_rocm_gpu_in_kvm.html">在KVM中使用AMD ROCm GPU</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">macOS平台的KVM</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">xhyve - macOS平台的KVM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">xhyve安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#xhyveubuntu">在xhyve中安装Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">在xhyve中运行Ubuntu</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../macos_ios/index.html">macOS &amp; iOS Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">KVM Atlas</a> &raquo;</li>
        
          <li><a href="index.html">macOS平台的KVM</a> &raquo;</li>
        
      <li>xhyve - macOS平台的KVM</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/kvm/macos/xhyve.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="xhyve-macoskvm">
<span id="xhyve"></span><h1>xhyve - macOS平台的KVM<a class="headerlink" href="#xhyve-macoskvm" title="Permalink to this headline">¶</a></h1>
<p>我个人使用MacBook Pro作为工作笔记本，使用的是macOS操作系统。macOS兼具精美方便的图形界面和灵活强大的Unix核心工具，对于开发和运维工作非常友好。macOS虽然没有KVM这样经过大量服务运维验证的虚拟化方案，但是实际上也有基于开源 <a class="reference external" href="http://bhyve.org">bhyve</a> port到OS X的开源项目 <a class="reference external" href="https://github.com/mist64/xhyve">xhyve hypervisor</a> 。</p>
<p>xhyve构建在OS X 10.10的 <a class="reference external" href="https://developer.apple.com/documentation/hypervisor">Hypervisor.framework</a> ，完全运行在用户空间，没有其他依赖。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在macOS上，可以基于系统内建的hypervisor能力 <a class="reference internal" href="../../docker/startup/install_docker_macos.html#install-docker-macos"><span class="std std-ref">macOS安装Docker</span></a> 和 <a class="reference internal" href="../../kubernetes/startup_prepare/install_run_minikube.html#install-run-minikube"><span class="std std-ref">安装和运行minikube</span></a> ，这两个重量级的开源项目在macOS上都使用了基于 xhyve 开发的工具集 <a class="reference internal" href="../../docker/moby/hyperkit/index.html#hyperkit"><span class="std std-ref">hyperkit</span></a> 。</p>
</div>
<div class="section" id="id1">
<h2>xhyve安装<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="homebrewxhyve">
<h3>通过homebrew安装xhyve<a class="headerlink" href="#homebrewxhyve" title="Permalink to this headline">¶</a></h3>
<p>xhyve hypervisor安装有多种方法，最简单的是通过homebrew:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">ruby</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span>

<span class="n">brew</span> <span class="n">update</span>
<span class="n">brew</span> <span class="n">install</span> <span class="o">--</span><span class="n">HEAD</span> <span class="n">xhyve</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://brew.sh/">Homebrew</a> 官方提供了安装指南</p>
<p><code class="docutils literal notranslate"><span class="pre">--HEAD</span></code> 在brew命令中确保总是获得最新修改，即使homebrew数据库还没有更新。</p>
<p>如果重新安装， <code class="docutils literal notranslate"><span class="pre">brew</span></code> 也提供了 <code class="docutils literal notranslate"><span class="pre">reinstall</span></code> 命令，即 <code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">reinstall</span> <span class="pre">xhyve</span></code></p>
</div>
</div>
<div class="section" id="macportsxhyve">
<h3>通过MacPorts安装xhyve<a class="headerlink" href="#macportsxhyve" title="Permalink to this headline">¶</a></h3>
<p>使用MacPorts则简单执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">port</span> <span class="n">selfupdate</span>
<span class="n">sudo</span> <span class="n">port</span> <span class="n">install</span> <span class="n">xhyve</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>通过源代码编译安装xhyve<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>下载源代码进行编译:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">machyve</span><span class="o">/</span><span class="n">xhyve</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">xhyve</span>
<span class="n">xcodebuild</span>
</pre></div>
</div>
<p>编译后执行程序位于 <code class="docutils literal notranslate"><span class="pre">build/Release/xhyve</span></code> 。 在最新的 macOS Mojave 10.14.1 编译成功，运行 <code class="docutils literal notranslate"><span class="pre">xhyve</span> <span class="pre">-h</span></code> 失败，显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Killed</span><span class="p">:</span> <span class="mi">9</span>
</pre></div>
</div>
<p>不过，实际上发现，使用完整的路径运行 <code class="docutils literal notranslate"><span class="pre">buid/xhyve</span></code> 则可以正常工作:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">huatai</span><span class="o">/</span><span class="n">github</span><span class="o">/</span><span class="n">xhyve</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">xhyve</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在我的实践中，采用的是源代码编译安装的xhyve。</p>
</div>
</div>
</div>
<div class="section" id="xhyveubuntu">
<h2>在xhyve中安装Ubuntu<a class="headerlink" href="#xhyveubuntu" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p><a class="reference external" href="https://help.ubuntu.com/community/Installation/MinimalCD">Installation/MinimalCD</a> 提供了通过网络安装的netinstall镜像。</p></li>
<li><p>下载 <a class="reference external" href="http://archive.ubuntu.com/ubuntu/dists/bionic/main/installer-amd64/current/images/netboot/mini.iso">Ubuntu 18.04 “Bionic Beaver”</a> 的网络安装镜像 mini.iso ，使用以下方法复制出安装镜像中的启动内核:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="n">k</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="n">of</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">iso</span>
<span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="n">mini</span><span class="o">.</span><span class="n">iso</span> <span class="n">bs</span><span class="o">=</span><span class="mi">2</span><span class="n">k</span> <span class="n">skip</span><span class="o">=</span><span class="mi">1</span> <span class="o">&gt;&gt;</span> <span class="n">tmp</span><span class="o">.</span><span class="n">iso</span>
<span class="n">hdiutil</span> <span class="n">attach</span> <span class="n">tmp</span><span class="o">.</span><span class="n">iso</span>

<span class="n">mkdir</span> <span class="n">install</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">CDROM</span><span class="o">/</span><span class="n">linux</span> <span class="o">./</span><span class="n">install</span><span class="o">/</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">CDROM</span><span class="o">/</span><span class="n">initrd</span><span class="o">.</span><span class="n">gz</span> <span class="o">./</span><span class="n">install</span><span class="o">/</span>

<span class="c1"># After finish copy</span>
<span class="n">umount</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">CDROM</span>
</pre></div>
</div>
</li>
<li><p>创建磁盘镜像文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">of</span><span class="o">=</span><span class="n">ubuntu18</span><span class="o">.</span><span class="n">img</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span><span class="n">g</span> <span class="n">count</span><span class="o">=</span><span class="mi">16</span>
</pre></div>
</div>
</li>
<li><p>创建安装脚本 <code class="docutils literal notranslate"><span class="pre">install.sh</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
KERNEL=&quot;install/linux&quot;
INITRD=&quot;install/initrd.gz&quot;
CMDLINE=&quot;earlyprintk=serial console=ttyS0&quot;

# Guest Config
CPU=&quot;-c 2&quot;
MEM=&quot;-m 2G&quot;
PCI_DEV=&quot;-s 0:0,hostbridge -s 31,lpc&quot;
NET=&quot;-s 2:0,virtio-net,en0&quot;
IMG_CD=&quot;-s 3:0,ahci-cd,mini.iso&quot;
IMG_HDD=&quot;-s 4:0,virtio-blk,ubuntu18.img&quot;
LPC_DEV=&quot;-l com1,stdio&quot;
ACPI=&quot;-A&quot;

# and now run
sudo /Users/huatai/github/xhyve/build/xhyve $ACPI $CPU $MEM $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&quot;$CMDLINE&quot;
</pre></div>
</div>
</li>
<li><p>运行安装:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">install</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="ubuntu">
<h3>安装Ubuntu的建议<a class="headerlink" href="#ubuntu" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>安装全程采用字符终端交互，通过TAB键切换，主要是选择语言（English）和locate，我都采用默认。在选择安装下载的镜像网站则选择中国。</p></li>
<li><p>磁盘分区需要使用整个磁盘分区并设置为EXT4文件系统。我测试过 <code class="docutils literal notranslate"><span class="pre">/dev/vda2</span></code> 采用btrfs文件系统但是安装后无法启动（虽然在Fedora系统中root文件系统使用btrfs是可以启动的。</p></li>
<li><p>只选择安装OpenSSH server，这样镜像是最基本系统，后续再不断叠加按需安装</p></li>
<li><p>安装最后的 <code class="docutils literal notranslate"><span class="pre">Finish</span> <span class="pre">the</span> <span class="pre">installation</span> <span class="pre">-&gt;</span> <span class="pre">Installation</span> <span class="pre">complete</span></code> 步骤，注意不要直接回车 <code class="docutils literal notranslate"><span class="pre">&lt;Continue&gt;</span></code> ，而是要选择 <code class="docutils literal notranslate"><span class="pre">&lt;Go</span> <span class="pre">Back&gt;</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> ┌───────────────────┤ [!!] Finish the installation ├────────────────────┐
 │                                                                       │
┌│                         Installation complete                         │
││ Installation is complete, so it is time to boot into your new system. │
││ Make sure to remove the installation media (CD-ROM, floppies), so     │
││ that you boot into the new system rather than restarting the          │
││ installation.                                                         │
││                                                                       │
└│     &lt;Go Back&gt;                                          &lt;Continue&gt;     │
 │                                                                       │
 └───────────────────────────────────────────────────────────────────────┘
</pre></div>
</div>
</li>
</ul>
<p>然后选择参考 <code class="docutils literal notranslate"><span class="pre">Execute</span> <span class="pre">a</span> <span class="pre">shell</span></code> ，在交互终端中执行以下命令获取IP地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">addr</span>   <span class="c1"># 检查虚拟机的IP地址，例如 192.168.64.5</span>
</pre></div>
</div>
<p>再执行以下命令，在虚拟机内部启动一个nc命令，准备传输内核启动目录 <code class="docutils literal notranslate"><span class="pre">/boot</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">target</span>
<span class="n">tar</span> <span class="n">c</span> <span class="n">boot</span> <span class="o">|</span> <span class="n">nc</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span><span class="n">p</span> <span class="mi">1234</span>
</pre></div>
</div>
<p>回到macOS中（Host主机），执行以下命令，将虚拟机中 <code class="docutils literal notranslate"><span class="pre">/boot</span></code> 目录传出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nc</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">64.5</span> <span class="mi">1234</span> <span class="o">|</span> <span class="n">tar</span> <span class="n">x</span>
</pre></div>
</div>
<p>此时在物理机macOS目录下就有了一个 <code class="docutils literal notranslate"><span class="pre">boot</span></code> 子目录，这个目录中包含了用于启动虚拟机引导的内核文件。</p>
<ul class="simple">
<li><p>返回xhyve虚拟机内部，选择 <code class="docutils literal notranslate"><span class="pre">Finish</span> <span class="pre">the</span> <span class="pre">installation</span></code> 结束安装。</p></li>
</ul>
</div>
</div>
<div class="section" id="id3">
<h2>在xhyve中运行Ubuntu<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>创建 <code class="docutils literal notranslate"><span class="pre">run.sh</span></code> 脚本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
KERNEL=&quot;boot/vmlinuz-4.15.0-45-generic&quot;
INITRD=&quot;boot/initrd.img-4.15.0-45-generic&quot;
#DON&#39;T use &#39;acpi=off&#39;, refer https://github.com/machyve/xhyve/issues/161
#CMDLINE=&quot;earlyprintk=serial console=ttyS0 acpi=off root=/dev/vda1 ro&quot;
CMDLINE=&quot;earlyprintk=serial console=ttyS0 root=/dev/vda1 ro&quot;
UUID=&quot;-U 8e7af180-c54d-4aa2-9bef-59d94a1ac572&quot; # A UUID will ensure we get a consistent ip address assigned
# Guest Config
CPU=&quot;-c 2&quot;
MEM=&quot;-m 2G&quot;
PCI_DEV=&quot;-s 0:0,hostbridge -s 31,lpc&quot;
NET=&quot;-s 2:0,virtio-net,en0&quot;
IMG_HDD=&quot;-s 4:0,virtio-blk,ubuntu18.img&quot;
LPC_DEV=&quot;-l com1,stdio&quot;
ACPI=&quot;-A&quot;

# and now run
sudo /Users/huatai/github/xhyve/build/xhyve $UUID $ACPI $CPU $MEM $PCI_DEV $LPC_DEV $NET $IMG_HDD -f kexec,$KERNEL,$INITRD,&quot;$CMDLINE&quot;
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这里的关键点是不要使用参数 <code class="docutils literal notranslate"><span class="pre">acpi=off</span></code> 参数，否则会导致虚拟机启动挂起 - <a class="reference external" href="https://github.com/machyve/xhyve/issues/161">Install Ubuntu 18 by netinstall is good, but boot from virtio_blk vda hang #161</a></p>
</div>
<ul>
<li><p>运行虚拟机:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sh</span> <span class="n">run</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</li>
<li><p>在macOS物理主机上运行任何VPN程序，在退出VPN时候会导致虚拟机网路无法连接，则通过如下脚本恢复网络 <code class="docutils literal notranslate"><span class="pre">masq.sh</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
interfaces=( $(netstat -in | egrep &#39;utun\d .*\d+\.\d+\.\d+\.\d+&#39; | cut -d &#39; &#39; -f 1) )
rulefile=&quot;rules.tmp&quot;
echo &quot;&quot; &gt; $rulefile
sudo pfctl -a com.apple/tun -F nat
for i in &quot;${interfaces[@]}&quot;
do
  RULE=&quot;nat on ${i} proto {tcp, udp, icmp} from 192.168.64.0/24 to any -&gt; ${i}&quot;
  echo $RULE &gt;&gt; $rulefile
done
sudo pfctl -a com.apple/tun -f $rulefile
</pre></div>
</div>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../ceph/index.html" class="btn btn-neutral float-right" title="Ceph Atlas" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="macOS平台的KVM" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../../copyright.html">Copyright</a> 2019, Huatai Huang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>