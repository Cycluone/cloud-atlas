<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Open Virtual Machine Firmware(OMVF) &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinxnotes-strike.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="copyright" title="版权所有" href="../../copyright.html" />
    <link rel="next" title="VFIO - Virtual Function I/O" href="vfio.html" />
    <link rel="prev" title="Intel VT-d快速起步" href="intel_vt-d_startup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ansible/index.html">Ansible Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">KVM Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../install/index.html">KVM 环境安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../startup/index.html">KVM 快速起步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hypervisor.html">hypervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_architecture.html">KVM虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.html">KVM 存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../numa/index.html">KVM NUMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libvirt/index.html">Libvirt虚拟机管理器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../remote_desktop/index.html">远程桌面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.html">KVM 性能优化</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">IOMMU</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="iommu_infra.html">IOMMU架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="intel_vt-d_startup.html">Intel VT-d快速起步</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Open Virtual Machine Firmware(OMVF)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">准备工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#iommu">设置IOMMU</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gpu">隔离GPU</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ovmf-guest-vm">设置OVMF guest VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">下一步</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">参考</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="vfio.html">VFIO - Virtual Function I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="compare_iommu_native_nvme.html">比较IOMMU NVMe和原生NVMe存储性能</a></li>
<li class="toctree-l3"><a class="reference internal" href="tunning/index.html">IOMMU性能优化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../sr-iov/index.html">SR-IOV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vgpu/index.html">NVIDIA vGPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intel_gvt-g/index.html">Intel GVT-g GPU虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware_virtual.html">硬件虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intel_vmcs.html">Intel VMCS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_nested_virtual.html">KVM嵌套虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_vdisk_live.html">KVM虚拟机动态添加、调整磁盘</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_live_migration.html">KVM热迁移</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qemu/index.html">使用QEMU管理KVM虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_libguestfs.html">使用libguestfs访问KVM镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memballoon.html">虚拟机内存balloon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpu_passthrough_with_kvm.html">KVM的GPU直通虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvidia_cuda_gpu_in_kvm.html">在KVM中使用NVIDIA CUDA GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../amd_rocm_gpu_in_kvm.html">在KVM中使用AMD ROCm GPU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../macos_xhyve/index.html">macOS平台xhyve</a></li>
<li class="toctree-l2"><a class="reference internal" href="../amd_kvm/index.html">AMD硬件环境KVM虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../arm_kvm/index.html">ARM硬件环境KVM虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_macos/index.html">KVM虚拟化运行macOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debug/index.html">KVM故障排查</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">KVM Atlas</a> &raquo;</li>
          <li><a href="index.html">IOMMU</a> &raquo;</li>
      <li>Open Virtual Machine Firmware(OMVF)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/kvm/iommu/ovmf.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="open-virtual-machine-firmware-omvf">
<span id="ovmf"></span><h1>Open Virtual Machine Firmware(OMVF)<a class="headerlink" href="#open-virtual-machine-firmware-omvf" title="永久链接至标题">¶</a></h1>
<p>Open Virtual Machine Firmware(OMVF)是在虚拟机内部激活UEFI支持的开源项目，从Linux 3.9和最新QEMU开始，可以将图形卡直通给虚拟机，提供VM原生图形性能，对图形性能敏感对任务非常有用。</p>
<section id="id1">
<h2>准备工作<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>显示直通(VGA passthrough)依赖很多比较少见的技术，并且有可能需要你的硬件支持才能实现。要完成直通，需要以下条件：</p>
<ul class="simple">
<li><p>CPU支持硬件虚拟化(kvm)和IOMMU(用于passthrough自身，即把cpu完整透传给虚拟机)</p>
<ul>
<li><p>兼容 <a class="reference external" href="https://ark.intel.com/content/www/us/en/ark/search/featurefilter.html?productType=873&amp;0_VTD=True">Intel VT-d技术的CPU列表</a></p></li>
<li><p>所有从Bulldozer代开始的AMD处理器(包括zen)都兼容</p></li>
</ul>
</li>
<li><p>主板支持IOMMU</p>
<ul>
<li><p>需要主板芯片和BIOS都支持IOMMU: 可以参考 <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_IOMMU-supporting_hardware">Wikipedia:List of IOMMU-supporting hardware</a></p></li>
</ul>
</li>
<li><p>Guest虚拟机GPU ROM必须支持 <code class="docutils literal notranslate"><span class="pre">UEFI</span></code></p>
<ul>
<li><p>可以从 <a class="reference external" href="https://www.techpowerup.com/vgabios/">techpowerup Video BIOS Collection</a> 查询特定GPU是否支持UEFI。不过，从2012年开始所有GPU应该都支持UEFI，因为微软将UEFI作为兼容Windows 8的必要条件。</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>你需要有其他通道来观察系统，例如其他显卡或者带外管理，因为passthrough GPU会导致该GPU在物理主机上不可使用。</p>
</div>
</section>
<section id="iommu">
<h2>设置IOMMU<a class="headerlink" href="#iommu" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<ul class="simple">
<li><p>IOMMU是Intel VT-d 和 AMD-Vi 的通用名称</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VT-d</span></code> 是Intel Virtualization Technology for Directed I/O ，所以不要和 <code class="docutils literal notranslate"><span class="pre">VT-x</span></code> Intel Virtualization Technology混淆。 <code class="docutils literal notranslate"><span class="pre">VT-x</span></code> 允许一个硬件平台功能表现为多个虚拟化平台，而 <code class="docutils literal notranslate"><span class="pre">VT-d</span></code> 则是为了提高安全和系统可靠性并且提升虚拟化环境的I/O设备性能。</p></li>
</ul>
</div>
<p>使用 IOMMU 可以开启新功能，例如 PCI passthrough 和 内存保护。请参考 <a class="reference external" href="https://en.wikipedia.org/wiki/Input-output_memory_management_unit#Advantages">Wikipedia:Input-output memory management unit#Advantages</a> 和 <a class="reference external" href="https://www.quora.com/Memory-Management-computer-programming/Could-you-explain-IOMMU-in-plain-English">Memory Management (computer programming): Could you explain IOMMU in plain English?</a></p>
<section id="id2">
<h3>激活IOMMU<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>AMD-Vi/Intel VT-d 是CPU内置支持，只需要通过BIOS设置激活。通常在BIOS中配置CPU功能部分可找到对应 <code class="docutils literal notranslate"><span class="pre">Virtualization</span> <span class="pre">technology</span></code> 之类配置。</p>
<p>在BIOS激活了 “VT-d” or “AMD-Vi” 之后，需要在内核参数中，根据CPU厂商不同配置内核参数:</p>
<ul class="simple">
<li><p>Intel CPU( <code class="docutils literal notranslate"><span class="pre">VT-d</span></code> )配置 <code class="docutils literal notranslate"><span class="pre">intel_iommu=on</span></code></p></li>
<li><p>AMD CPU( <code class="docutils literal notranslate"><span class="pre">AMD-Vi</span></code> )通常内核检测到BIOS支持  <code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">HW</span></code> 就会激活，为确定激活可配置 <code class="docutils literal notranslate"><span class="pre">iommu=pt</span> <span class="pre">iommu=1</span></code></p></li>
</ul>
<p>重启主机，然后检查 <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> 确保IOMMU正确设置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dmesg</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">e</span> <span class="n">DMAR</span> <span class="o">-</span><span class="n">e</span> <span class="n">IOMMU</span>
</pre></div>
</div>
<p>输出类似:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">ovmf/dmesg_dmar_iommu.txt</span><a class="headerlink" href="#id9" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="o">[</span>    <span class="m">0</span>.000000<span class="o">]</span> Command line: <span class="nv">BOOT_IMAGE</span><span class="o">=</span>/boot/vmlinuz-5.4.0-90-generic <span class="nv">root</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>caa4193b-9222-49fe-a4b3-89f1cb417e6a ro <span class="nv">intel_iommu</span><span class="o">=</span>on
<span class="linenos"> 2</span><span class="o">[</span>    <span class="m">0</span>.009994<span class="o">]</span> ACPI: DMAR 0x000000007B7E7000 <span class="m">000294</span> <span class="o">(</span>v01 HP     ProLiant <span class="m">00000001</span> HP   <span class="m">00000001</span><span class="o">)</span>
<span class="linenos"> 3</span><span class="o">[</span>    <span class="m">0</span>.010030<span class="o">]</span> ACPI: Reserving DMAR table memory at <span class="o">[</span>mem 0x7b7e7000-0x7b7e7293<span class="o">]</span>
<span class="linenos"> 4</span><span class="o">[</span>    <span class="m">0</span>.252650<span class="o">]</span> Kernel <span class="nb">command</span> line: <span class="nv">BOOT_IMAGE</span><span class="o">=</span>/boot/vmlinuz-5.4.0-90-generic <span class="nv">root</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>caa4193b-9222-49fe-a4b3-89f1cb417e6a ro <span class="nv">intel_iommu</span><span class="o">=</span>on
<span class="linenos"> 5</span><span class="o">[</span>    <span class="m">0</span>.252714<span class="o">]</span> DMAR: IOMMU enabled
<span class="linenos"> 6</span><span class="o">[</span>    <span class="m">0</span>.508460<span class="o">]</span> DMAR: Host address width <span class="m">46</span>
<span class="linenos"> 7</span><span class="o">[</span>    <span class="m">0</span>.508462<span class="o">]</span> DMAR: DRHD base: 0x000000fbffc000 flags: 0x0
<span class="linenos"> 8</span><span class="o">[</span>    <span class="m">0</span>.508469<span class="o">]</span> DMAR: dmar0: reg_base_addr fbffc000 ver <span class="m">1</span>:0 cap d2078c106f0466 ecap f020df
<span class="linenos"> 9</span><span class="o">[</span>    <span class="m">0</span>.508471<span class="o">]</span> DMAR: DRHD base: 0x000000c7ffc000 flags: 0x1
<span class="linenos">10</span><span class="o">[</span>    <span class="m">0</span>.508476<span class="o">]</span> DMAR: dmar1: reg_base_addr c7ffc000 ver <span class="m">1</span>:0 cap d2078c106f0466 ecap f020df
<span class="linenos">11</span><span class="o">[</span>    <span class="m">0</span>.508478<span class="o">]</span> DMAR: RMRR base: 0x00000079174000 end: 0x00000079176fff
<span class="linenos">12</span><span class="o">[</span>    <span class="m">0</span>.508481<span class="o">]</span> DMAR: RMRR base: 0x000000791f4000 end: 0x000000791f7fff
<span class="linenos">13</span><span class="o">[</span>    <span class="m">0</span>.508483<span class="o">]</span> DMAR: RMRR base: 0x000000791de000 end: 0x000000791f3fff
<span class="linenos">14</span><span class="o">[</span>    <span class="m">0</span>.508485<span class="o">]</span> DMAR: RMRR base: 0x000000791cb000 end: 0x000000791dbfff
<span class="linenos">15</span><span class="o">[</span>    <span class="m">0</span>.508486<span class="o">]</span> DMAR: RMRR base: 0x000000791dc000 end: 0x000000791ddfff
<span class="linenos">16</span><span class="o">[</span>    <span class="m">0</span>.508490<span class="o">]</span> DMAR-IR: IOAPIC id <span class="m">10</span> under DRHD base  0xfbffc000 IOMMU <span class="m">0</span>
<span class="linenos">17</span><span class="o">[</span>    <span class="m">0</span>.508492<span class="o">]</span> DMAR-IR: IOAPIC id <span class="m">8</span> under DRHD base  0xc7ffc000 IOMMU <span class="m">1</span>
<span class="linenos">18</span><span class="o">[</span>    <span class="m">0</span>.508494<span class="o">]</span> DMAR-IR: IOAPIC id <span class="m">9</span> under DRHD base  0xc7ffc000 IOMMU <span class="m">1</span>
<span class="linenos">19</span><span class="o">[</span>    <span class="m">0</span>.508496<span class="o">]</span> DMAR-IR: HPET id <span class="m">0</span> under DRHD base 0xc7ffc000
<span class="linenos">20</span><span class="o">[</span>    <span class="m">0</span>.508498<span class="o">]</span> DMAR-IR: Queued invalidation will be enabled to support x2apic and Intr-remapping.
<span class="linenos">21</span><span class="o">[</span>    <span class="m">0</span>.509028<span class="o">]</span> DMAR-IR: Enabled IRQ remapping <span class="k">in</span> x2apic mode
<span class="linenos">22</span><span class="o">[</span>    <span class="m">0</span>.815054<span class="o">]</span> iommu: Default domain type: Translated
<span class="linenos">23</span><span class="o">[</span>    <span class="m">1</span>.068333<span class="o">]</span> DMAR: No ATSR found
<span class="linenos">24</span><span class="o">[</span>    <span class="m">1</span>.068769<span class="o">]</span> DMAR: dmar0: Using Queued invalidation
<span class="linenos">25</span><span class="o">[</span>    <span class="m">1</span>.068775<span class="o">]</span> DMAR: dmar1: Using Queued invalidation
<span class="linenos">26</span><span class="o">[</span>    <span class="m">1</span>.069672<span class="o">]</span> pci <span class="m">0000</span>:00:00.0: Adding to iommu group <span class="m">0</span>
<span class="linenos">27</span><span class="o">[</span>    <span class="m">1</span>.070272<span class="o">]</span> pci <span class="m">0000</span>:00:01.0: Adding to iommu group <span class="m">1</span>
<span class="linenos">28</span><span class="o">[</span>    <span class="m">1</span>.070667<span class="o">]</span> pci <span class="m">0000</span>:00:01.1: Adding to iommu group <span class="m">2</span>
<span class="linenos">29</span>...
<span class="linenos">30</span><span class="o">[</span>    <span class="m">1</span>.125619<span class="o">]</span> pci <span class="m">0000</span>:ff:1e.3: Adding to iommu group <span class="m">92</span>
<span class="linenos">31</span><span class="o">[</span>    <span class="m">1</span>.125691<span class="o">]</span> pci <span class="m">0000</span>:ff:1e.4: Adding to iommu group <span class="m">92</span>
<span class="linenos">32</span><span class="o">[</span>    <span class="m">1</span>.126288<span class="o">]</span> pci <span class="m">0000</span>:ff:1f.0: Adding to iommu group <span class="m">93</span>
<span class="linenos">33</span><span class="o">[</span>    <span class="m">1</span>.126363<span class="o">]</span> pci <span class="m">0000</span>:ff:1f.2: Adding to iommu group <span class="m">93</span>
<span class="linenos">34</span><span class="o">[</span>    <span class="m">1</span>.126369<span class="o">]</span> DMAR: Intel<span class="o">(</span>R<span class="o">)</span> Virtualization Technology <span class="k">for</span> Directed I/O
</pre></div>
</div>
</div>
</section>
<section id="groups">
<h3>检查groups是否正确<a class="headerlink" href="#groups" title="永久链接至标题">¶</a></h3>
<p>以下脚本 <code class="docutils literal notranslate"><span class="pre">check_iommu.sh</span></code> 脚本可以查看系统中不同的PCI设备被映射到IOMMU组，如果没有返回任何信息，则表明系统没有激活IOMMU支持或者硬件不支持IOMMU</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">intel_vt-d_startup/check_iommu.sh</span><a class="headerlink" href="#id10" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="ch">#!/bin/bash</span>
<span class="linenos">2</span><span class="nb">shopt</span> -s nullglob
<span class="linenos">3</span><span class="k">for</span> g <span class="k">in</span> <span class="sb">`</span>find /sys/kernel/iommu_groups/* -maxdepth <span class="m">0</span> -type d <span class="p">|</span> sort -V<span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
<span class="linenos">4</span>    <span class="nb">echo</span> <span class="s2">&quot;IOMMU Group </span><span class="si">${</span><span class="nv">g</span><span class="p">##*/</span><span class="si">}</span><span class="s2">:&quot;</span>
<span class="linenos">5</span>    <span class="k">for</span> d <span class="k">in</span> <span class="nv">$g</span>/devices/*<span class="p">;</span> <span class="k">do</span>
<span class="linenos">6</span>        <span class="nb">echo</span> -e <span class="s2">&quot;\t</span><span class="k">$(</span>lspci -nns <span class="si">${</span><span class="nv">d</span><span class="p">##*/</span><span class="si">}</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="linenos">7</span>    <span class="k">done</span><span class="p">;</span>
<span class="linenos">8</span><span class="k">done</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>执行输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">32</span><span class="p">:</span>
        <span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">f</span><span class="mf">.0</span> <span class="n">ISA</span> <span class="n">bridge</span> <span class="p">[</span><span class="mi">0601</span><span class="p">]:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">C610</span><span class="o">/</span><span class="n">X99</span> <span class="n">series</span> <span class="n">chipset</span> <span class="n">LPC</span> <span class="n">Controller</span> <span class="p">[</span><span class="mi">8086</span><span class="p">:</span><span class="mi">8</span><span class="n">d44</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">05</span><span class="p">)</span>
        <span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">f</span><span class="mf">.2</span> <span class="n">SATA</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0106</span><span class="p">]:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">C610</span><span class="o">/</span><span class="n">X99</span> <span class="n">series</span> <span class="n">chipset</span> <span class="mi">6</span><span class="o">-</span><span class="n">Port</span> <span class="n">SATA</span> <span class="n">Controller</span> <span class="p">[</span><span class="n">AHCI</span> <span class="n">mode</span><span class="p">]</span> <span class="p">[</span><span class="mi">8086</span><span class="p">:</span><span class="mi">8</span><span class="n">d02</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">05</span><span class="p">)</span>
        <span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">f</span><span class="mf">.3</span> <span class="n">SMBus</span> <span class="p">[</span><span class="mi">0</span><span class="n">c05</span><span class="p">]:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">C610</span><span class="o">/</span><span class="n">X99</span> <span class="n">series</span> <span class="n">chipset</span> <span class="n">SMBus</span> <span class="n">Controller</span> <span class="p">[</span><span class="mi">8086</span><span class="p">:</span><span class="mi">8</span><span class="n">d22</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">05</span><span class="p">)</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">33</span><span class="p">:</span>
        <span class="mi">01</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">System</span> <span class="n">peripheral</span> <span class="p">[</span><span class="mi">0880</span><span class="p">]:</span> <span class="n">Hewlett</span><span class="o">-</span><span class="n">Packard</span> <span class="n">Company</span> <span class="n">Integrated</span> <span class="n">Lights</span><span class="o">-</span><span class="n">Out</span> <span class="n">Standard</span> <span class="n">Slave</span> <span class="n">Instrumentation</span> <span class="o">&amp;</span> <span class="n">System</span> <span class="n">Support</span> <span class="p">[</span><span class="mi">103</span><span class="n">c</span><span class="p">:</span><span class="mi">3306</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">06</span><span class="p">)</span>
        <span class="mi">01</span><span class="p">:</span><span class="mf">00.1</span> <span class="n">VGA</span> <span class="n">compatible</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0300</span><span class="p">]:</span> <span class="n">Matrox</span> <span class="n">Electronics</span> <span class="n">Systems</span> <span class="n">Ltd</span><span class="o">.</span> <span class="n">MGA</span> <span class="n">G200EH</span> <span class="p">[</span><span class="mi">102</span><span class="n">b</span><span class="p">:</span><span class="mi">0533</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
        <span class="mi">01</span><span class="p">:</span><span class="mf">00.2</span> <span class="n">System</span> <span class="n">peripheral</span> <span class="p">[</span><span class="mi">0880</span><span class="p">]:</span> <span class="n">Hewlett</span><span class="o">-</span><span class="n">Packard</span> <span class="n">Company</span> <span class="n">Integrated</span> <span class="n">Lights</span><span class="o">-</span><span class="n">Out</span> <span class="n">Standard</span> <span class="n">Management</span> <span class="n">Processor</span> <span class="n">Support</span> <span class="ow">and</span> <span class="n">Messaging</span> <span class="p">[</span><span class="mi">103</span><span class="n">c</span><span class="p">:</span><span class="mi">3307</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">06</span><span class="p">)</span>
        <span class="mi">01</span><span class="p">:</span><span class="mf">00.4</span> <span class="n">USB</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0</span><span class="n">c03</span><span class="p">]:</span> <span class="n">Hewlett</span><span class="o">-</span><span class="n">Packard</span> <span class="n">Company</span> <span class="n">Integrated</span> <span class="n">Lights</span><span class="o">-</span><span class="n">Out</span> <span class="n">Standard</span> <span class="n">Virtual</span> <span class="n">USB</span> <span class="n">Controller</span> <span class="p">[</span><span class="mi">103</span><span class="n">c</span><span class="p">:</span><span class="mi">3300</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">03</span><span class="p">)</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">34</span><span class="p">:</span>
        <span class="mi">02</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Broadcom</span> <span class="n">Inc</span><span class="o">.</span> <span class="ow">and</span> <span class="n">subsidiaries</span> <span class="n">NetXtreme</span> <span class="n">BCM5719</span> <span class="n">Gigabit</span> <span class="n">Ethernet</span> <span class="n">PCIe</span> <span class="p">[</span><span class="mf">14e4</span><span class="p">:</span><span class="mi">1657</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
        <span class="mi">02</span><span class="p">:</span><span class="mf">00.1</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Broadcom</span> <span class="n">Inc</span><span class="o">.</span> <span class="ow">and</span> <span class="n">subsidiaries</span> <span class="n">NetXtreme</span> <span class="n">BCM5719</span> <span class="n">Gigabit</span> <span class="n">Ethernet</span> <span class="n">PCIe</span> <span class="p">[</span><span class="mf">14e4</span><span class="p">:</span><span class="mi">1657</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
        <span class="mi">02</span><span class="p">:</span><span class="mf">00.2</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Broadcom</span> <span class="n">Inc</span><span class="o">.</span> <span class="ow">and</span> <span class="n">subsidiaries</span> <span class="n">NetXtreme</span> <span class="n">BCM5719</span> <span class="n">Gigabit</span> <span class="n">Ethernet</span> <span class="n">PCIe</span> <span class="p">[</span><span class="mf">14e4</span><span class="p">:</span><span class="mi">1657</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
        <span class="mi">02</span><span class="p">:</span><span class="mf">00.3</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Broadcom</span> <span class="n">Inc</span><span class="o">.</span> <span class="ow">and</span> <span class="n">subsidiaries</span> <span class="n">NetXtreme</span> <span class="n">BCM5719</span> <span class="n">Gigabit</span> <span class="n">Ethernet</span> <span class="n">PCIe</span> <span class="p">[</span><span class="mf">14e4</span><span class="p">:</span><span class="mi">1657</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">35</span><span class="p">:</span>
        <span class="mi">04</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">[</span><span class="mi">8086</span><span class="p">:</span><span class="mi">1521</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">36</span><span class="p">:</span>
        <span class="mi">04</span><span class="p">:</span><span class="mf">00.1</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">[</span><span class="mi">8086</span><span class="p">:</span><span class="mi">1521</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">37</span><span class="p">:</span>
        <span class="mi">04</span><span class="p">:</span><span class="mf">00.2</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">[</span><span class="mi">8086</span><span class="p">:</span><span class="mi">1521</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">38</span><span class="p">:</span>
        <span class="mi">04</span><span class="p">:</span><span class="mf">00.3</span> <span class="n">Ethernet</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0200</span><span class="p">]:</span> <span class="n">Intel</span> <span class="n">Corporation</span> <span class="n">I350</span> <span class="n">Gigabit</span> <span class="n">Network</span> <span class="n">Connection</span> <span class="p">[</span><span class="mi">8086</span><span class="p">:</span><span class="mi">1521</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="mi">01</span><span class="p">)</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">39</span><span class="p">:</span>
        <span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">40</span><span class="p">:</span>
        <span class="mi">08</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">41</span><span class="p">:</span>
        <span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
<span class="o">...</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">79</span><span class="p">:</span>
        <span class="mi">82</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0302</span><span class="p">]:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
<p>上述输出中有不同的 <code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">Group</span></code> ，这个意义是:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">Group</span></code> 是直通给虚拟机的最小物理设备集合。举例，上述 <code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">Group</span> <span class="pre">32</span></code> 这组设备只能完整分配给一个虚拟机，这个虚拟机将同时获得 <code class="docutils literal notranslate"><span class="pre">ISA</span> <span class="pre">bridge</span> <span class="pre">[0601]</span></code> <code class="docutils literal notranslate"><span class="pre">SATA</span> <span class="pre">controller</span> <span class="pre">[0106]</span></code> 和 <code class="docutils literal notranslate"><span class="pre">SMBus</span> <span class="pre">[0c05]</span></code> ；同理， <code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">Group</span> <span class="pre">34</span></code> 包含了4个Broadcom 以太网接口(实际上就是主板集成4网口)也只能同时分配给一个虚拟机；而独立添加的Intel 4网口千兆网卡则是完全独立的4个 <code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">Group</span></code> ，意味着可以独立分配个4个虚拟机</p></li>
<li><p>我在 <a class="reference internal" href="../../linux/server/hardware/hpe/hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 上通过 <a class="reference internal" href="../../linux/server/hardware/hpe/pcie_bifurcation.html#pcie-bifurcation"><span class="std std-ref">PCIe bifurcation</span></a> 将PCIe 3.0 Slot 1(x16)划分成2个独立的x8通道，安装了2块 <a class="reference internal" href="../../linux/storage/nvme/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a> ，加上在 Slot 2(x8) 上安装的第3块 <a class="reference internal" href="../../linux/storage/nvme/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a> ，所以服务器上一共有3块 NVMe 存储。在这里可以看到有3个 <code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">Group</span></code> 分别是 <code class="docutils literal notranslate"><span class="pre">39-40</span></code> 对应了3个NVMe控制器，可以分别分配给3个虚拟机</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOMMU</span> <span class="pre">Group</span> <span class="pre">79</span></code> 是安装在PCIe 3.0 Slot 3(x16)上的 <a class="reference internal" href="../../machine_learning/hardware/tesla_p10.html#tesla-p10"><span class="std std-ref">Nvidia Tesla P10 GPU运算卡</span></a> ，可以直接透传给一个虚拟机。我仅做技术实践，最终我希望采用 <a class="reference internal" href="../vgpu/index.html#vgpu"><span class="std std-ref">NVIDIA vGPU</span></a> 划分为更多GPU设备分配给虚拟化集群，来模拟大规模云计算</p></li>
</ul>
</section>
</section>
<section id="gpu">
<h2>隔离GPU<a class="headerlink" href="#gpu" title="永久链接至标题">¶</a></h2>
<p>要实现将一个设备指定给虚拟机，这个设备以及所有在相同IOMMU组的设备必须将它们的驱动替换成 <code class="docutils literal notranslate"><span class="pre">stub</span></code> 驱动 或者 <code class="docutils literal notranslate"><span class="pre">VFIO</span></code> 驱动，这样才能避免物理主机访问设备。并且需要注意，大多数设备需要在VM启动前完成这个替换。</p>
<p>但是，GPU驱动往往不倾向于支持动态绑定，所以可能难以实现一些用于物理主机的GPU被透明直通给虚拟机，因为这样的两种驱动相互冲突。通常建议手工绑定这些驱动，然后再启动虚拟机。</p>
<p>从Linux内核4.1开始，内核包含了 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> ，这个VFIO驱动可以完全替代 <code class="docutils literal notranslate"><span class="pre">pci-stub</span></code> 而且提供了控制设备的扩展，例如在不使用设备时将设备切换到 <code class="docutils literal notranslate"><span class="pre">D3</span></code> 状态。</p>
<section id="id-vfio-pci">
<h3>通过设备ID来绑定 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code><a class="headerlink" href="#id-vfio-pci" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 通常使用ID来找寻PCI设备，也就是只需要指定passthrough的设备ID。举例，前面显示的我的服务器上设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">39</span><span class="p">:</span>
        <span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">79</span><span class="p">:</span>
        <span class="mi">82</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0302</span><span class="p">]:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
<p>只需要使用 <code class="docutils literal notranslate"><span class="pre">144d:a80a</span></code> 和 <code class="docutils literal notranslate"><span class="pre">10de:1b39</span></code> 这两个设备ID来绑定 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code></p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>要同时输出设备ID和 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 绑定ID，可以使用 <code class="docutils literal notranslate"><span class="pre">lspci</span> <span class="pre">-nn</span></code> 命令，可以显示详细信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lspci</span> <span class="o">-</span><span class="n">nn</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">samsung</span>
</pre></div>
</div>
<p>就可以看到详细信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
<span class="mi">08</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
<span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
</pre></div>
</div>
<p>可以直接知道内核需要传递的 <code class="docutils literal notranslate"><span class="pre">vfio-pci.ids</span></code> 就是 <code class="docutils literal notranslate"><span class="pre">144d:a80a</span></code> ，同时也能够知道如何配置设备 <code class="docutils literal notranslate"><span class="pre">.xml</span></code> 文件用于 <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">attach-device</span></code></p>
</div>
<p>有两种方式将设备 remove 或者 break :</p>
<ul>
<li><p>使用启动内核参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vfio</span><span class="o">-</span><span class="n">pci</span><span class="o">.</span><span class="n">ids</span><span class="o">=</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">,</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span>
</pre></div>
</div>
</li>
<li><p>另一种方式是使用 modprobe 配置，添加一个 <code class="docutils literal notranslate"><span class="pre">/etc/modprobe.d/vfio.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">options</span> <span class="n">vfio</span><span class="o">-</span><span class="n">pci</span> <span class="n">ids</span><span class="o">=</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">,</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="vfio-pci">
<h3>提前加载 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code><a class="headerlink" href="#vfio-pci" title="永久链接至标题">¶</a></h3>
<p>需要分辨 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 是作为内核直接编译的还是作为内核模块加载的:</p>
<ul class="simple">
<li><p>如果是直接静态编译到内核，则只需要内核启动参数中传递参数阻止host主机使用PCI设备: 如 Red Hat Enterprise Linux 和 Ubuntu 都是直接内核静态编译 <code class="docutils literal notranslate"><span class="pre">vfio</span></code></p></li>
<li><p>如果是内核模块加载 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 则还需要重建 <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> 确保提前加载模块: 如 arch linux就是模块方式加载 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 等模块</p></li>
</ul>
<p>检查方法是查看 <code class="docutils literal notranslate"><span class="pre">/boot</span></code> 目录下对应内核版本 <code class="docutils literal notranslate"><span class="pre">config-xxx-xxx</span></code> 配置，例如 Ubuntu 20.04.3 LTS 当前使用内核 使用 <code class="docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-r</span></code> 查看是 <code class="docutils literal notranslate"><span class="pre">5.4.0-90-generic</span></code> ，则检查 <code class="docutils literal notranslate"><span class="pre">/boot/config-5.4.0-90-generic</span></code> 文件，可以看到各个 <code class="docutils literal notranslate"><span class="pre">vfio</span></code> 相关模块都是静态编译(对应值都是 <code class="docutils literal notranslate"><span class="pre">Y</span></code> ):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONFIG_VFIO_IOMMU_TYPE1</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO_VIRQFD</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO_NOIOMMU</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO_PCI</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO_PCI_VGA</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO_PCI_MMAP</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO_PCI_INTX</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_VFIO_PCI_IGD</span><span class="o">=</span><span class="n">y</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>参考 Red Hat Virtualization 文档，通过内核传递参数 <code class="docutils literal notranslate"><span class="pre">pci-stub.ids=144d:a80a,10de:1b39</span> <span class="pre">rdblacklist=nouveau</span></code> 就可以阻止host主机使用GPU设备(并拒绝加载显卡驱动) ，然后只需要重新生成引导装载程序:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grub2</span><span class="o">-</span><span class="n">mkconfig</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">grub2</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>然后重启系统就可以从 <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/proc/cmdline</span></code> 确认主机设备被添加到 pci-stub.ids 列表中，Nouveau 已列入黑名单</p>
</div>
<p>对于内核模块方式加载 <code class="docutils literal notranslate"><span class="pre">VFIO</span></code> 相关模块(arch linux就是如此)，则采用以下3个方法之一来定制 <code class="docutils literal notranslate"><span class="pre">intiramfs</span></code> 确保内核首先加载 VFIO 模块，这样才能屏蔽掉host主机使用需要分配给虚拟机的PCI设备:</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">dracut</span></code> 是一个制作 提前加载需要访问根文件系统的块设备模块(例如IDE，SCSI，RAID等) 初始化镜像 <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> 工具。 <code class="docutils literal notranslate"><span class="pre">mkinitcpio</span></code> 是相同功能的工具。目前，大多数发行版，如Fedora, RHEL, Gentoo, Debian都使用 <code class="docutils literal notranslate"><span class="pre">dracut</span></code> ，不过 <a class="reference internal" href="../../linux/arch_linux/index.html#arch-linux"><span class="std std-ref">Arch Linux</span></a> 默认使用 <code class="docutils literal notranslate"><span class="pre">mkinitcpio</span></code> 。</p>
<p>由于我的实践是在Ubuntu上完成， <code class="docutils literal notranslate"><span class="pre">VFIO</span></code> 相关支持都是直接静态编译进内核，所以并不需要执行以下内核模块加入 <code class="docutils literal notranslate"><span class="pre">initiramfs</span></code> 的需求，我并没有执行以下3个方法的任意一个。不过，对于arch linux需要执行。</p>
</div>
<section id="mkinitcpio">
<h4>mkinitcpio(方法一)<a class="headerlink" href="#mkinitcpio" title="永久链接至标题">¶</a></h4>
<p>由于操作系统使用 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 内核模块，需要确保 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 模块提前加载，这样才能避免图形驱动绑定到这个GPU卡上。要实现这点，需要使用 <code class="docutils literal notranslate"><span class="pre">mkinitcpio</span></code> 帮助把 <code class="docutils literal notranslate"><span class="pre">vfio_cpi</span></code> 等相关内核模块加入到 <code class="docutils literal notranslate"><span class="pre">initramfs</span></code> 中</p>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/etc/mkinitcpio.conf</span></code> 配置文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MODULES</span><span class="o">=</span><span class="p">(</span><span class="o">...</span> <span class="n">vfio_pci</span> <span class="n">vfio</span> <span class="n">vfio_iommu_type1</span> <span class="n">vfio_virqfd</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>并且确认 <code class="docutils literal notranslate"><span class="pre">mkinitcpio.conf</span></code> 已经包含了 <code class="docutils literal notranslate"><span class="pre">modconf</span></code> hook:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HOOKS</span><span class="o">=</span><span class="p">(</span><span class="o">...</span> <span class="n">modconf</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<ul>
<li><p>然后执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkinitcpio</span> <span class="o">-</span><span class="n">P</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="booster">
<h4>booster(方法二)<a class="headerlink" href="#booster" title="永久链接至标题">¶</a></h4>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/etc/booster.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modules_force_load</span><span class="p">:</span> <span class="n">vfio_pci</span><span class="p">,</span><span class="n">vfio</span><span class="p">,</span><span class="n">vfio_iommu_type1</span><span class="p">,</span><span class="n">vfio_virqfd</span>
</pre></div>
</div>
</li>
<li><p>重新生成initramfs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">booster</span><span class="o">/</span><span class="n">regenerate_images</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="dracut">
<h4>dracut(方法三)<a class="headerlink" href="#dracut" title="永久链接至标题">¶</a></h4>
<p>dracut的早期加载机制是通过内核参数。</p>
<ul>
<li><p>要提前加载 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> ，在内核参数上添加设备ID以及 <code class="docutils literal notranslate"><span class="pre">rd.driver.pre</span></code> 配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vfio</span><span class="o">-</span><span class="n">pci</span><span class="o">.</span><span class="n">ids</span><span class="o">=</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">,</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span> <span class="n">rd</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">pre</span><span class="o">=</span><span class="n">vfio_pci</span>
</pre></div>
</div>
</li>
<li><p>同样也需要将所有vfio驱动加入到initramfs，所以在 <code class="docutils literal notranslate"><span class="pre">/etc/dracut.conf.d</span></code> 目录下添加配置文件 <code class="docutils literal notranslate"><span class="pre">10-vfio.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add_drivers</span><span class="o">+=</span><span class="s2">&quot; vfio_pci vfio vfio_iommu_type1 vfio_virqfd &quot;</span>
</pre></div>
</div>
</li>
<li><p>为当前运行内核生成initramfs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dracut</span> <span class="o">--</span><span class="n">hostonly</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">hostonly</span><span class="o">-</span><span class="n">cmdline</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="host-pcie">
<h3>我的屏蔽host pcie实践<a class="headerlink" href="#host-pcie" title="永久链接至标题">¶</a></h3>
<p>这段是我实际操作实践:</p>
<ul>
<li><p>实践是在 <a class="reference internal" href="../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 20.04.3 LTS上完成，配置 <a class="reference internal" href="../../linux/ubuntu_linux/admin/ubuntu_grub.html#ubuntu-grub"><span class="std std-ref">Ubuntu修订Grub内核启动参数</span></a> - 修改 <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;intel_iommu=on pci-stub.ids=144d:a80a,10de:1b39 rdblacklist=nouveau&quot;</span>
</pre></div>
</div>
</li>
<li><p>然后执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">grub</span>
</pre></div>
</div>
</li>
<li><p>重启操作系统，然后执行以下命令检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">cmdline</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id3">
<h3>验证是否实现提前加载 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code><a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>重启系统</p></li>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 是否正确加载，并且绑定到正确设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dmesg</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">vfio</span>
</pre></div>
</div>
</li>
</ul>
<p>我的实践看到输出内容是:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>    <span class="mf">1.434041</span> <span class="p">]</span> <span class="n">VFIO</span> <span class="o">-</span> <span class="n">User</span> <span class="n">Level</span> <span class="n">meta</span><span class="o">-</span><span class="n">driver</span> <span class="n">version</span><span class="p">:</span> <span class="mf">0.3</span>
</pre></div>
</div>
<p>并没有看到设备</p>
<ul>
<li><p>在host主机上检查设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lspci</span> <span class="o">-</span><span class="n">nnk</span> <span class="o">-</span><span class="n">d</span> <span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span>
</pre></div>
</div>
</li>
</ul>
<p>很不幸，物理主机依然能够访问:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a801</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">nvme</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvme</span>
<span class="mi">08</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a801</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">nvme</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvme</span>
<span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a801</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">nvme</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvme</span>
</pre></div>
</div>
<p>检查GPU设备也是如此:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lspci</span> <span class="o">-</span><span class="n">nnk</span> <span class="o">-</span><span class="n">d</span> <span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span>
</pre></div>
</div>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">82</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0302</span><span class="p">]:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1217</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">nouveau</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvidiafb</span><span class="p">,</span> <span class="n">nouveau</span>
</pre></div>
</div>
<ul>
<li><p>我发现错误了，内核配置应该是 <code class="docutils literal notranslate"><span class="pre">vfio-pci.ids=144d:a80a,10de:1b39</span></code> ，而不是以前旧格式配置 <code class="docutils literal notranslate"><span class="pre">pci-stub.ids=144d:a80a,10de:1b39</span></code> ，所以重新修订 <code class="docutils literal notranslate"><span class="pre">/etc/default/grub</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;intel_iommu=on vfio-pci.ids=144d:a80a,10de:1b39&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p>然后重新生成grub:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">grub</span>
</pre></div>
</div>
<p>然后再次重启系统，并检查 <code class="docutils literal notranslate"><span class="pre">dmesg</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">vfio</span></code> 输出，这次正常了，可以看到 <code class="docutils literal notranslate"><span class="pre">vfio_pci</span></code> 正确绑定了指定PCIe设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[    0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-5.4.0-90-generic root=UUID=caa4193b-9222-49fe-a4b3-89f1cb417e6a ro intel_iommu=on vfio-pci.ids=144d:a80a,10de:1b39
[    0.252622] Kernel command line: BOOT_IMAGE=/boot/vmlinuz-5.4.0-90-generic root=UUID=caa4193b-9222-49fe-a4b3-89f1cb417e6a ro intel_iommu=on vfio-pci.ids=144d:a80a,10de:1b39
[    1.457708] VFIO - User Level meta-driver version: 0.3
[    1.516284] vfio_pci: add [144d:a80a[ffffffff:ffffffff]] class 0x000000/00000000
[    1.536263] vfio_pci: add [10de:1b39[ffffffff:ffffffff]] class 0x000000/00000000
</pre></div>
</div>
<ul>
<li><p>此时根据设备ID检查PCIe设备，可以看到已经被 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 驱动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lspci</span> <span class="o">-</span><span class="n">nnk</span> <span class="o">-</span><span class="n">d</span> <span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a801</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">vfio</span><span class="o">-</span><span class="n">pci</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvme</span>
<span class="mi">08</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a801</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">vfio</span><span class="o">-</span><span class="n">pci</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvme</span>
<span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a801</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">vfio</span><span class="o">-</span><span class="n">pci</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvme</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>请注意， <code class="docutils literal notranslate"><span class="pre">vfio-pci.ids=144d:a80a</span></code> 是对同一种类设备进行屏蔽，所有在这个服务器上安装的 <a class="reference internal" href="../../linux/storage/nvme/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a> 都是相同的设备ID，也就是会同时被屏蔽掉。目前看，不能单独只屏蔽一块NVMe存储，因为都是相同的三星NVMe，会一起被 <code class="docutils literal notranslate"><span class="pre">vfio-pci</span></code> 接管。可以看到上面 <code class="docutils literal notranslate"><span class="pre">lspci</span> <span class="pre">-nnk</span> <span class="pre">-d</span> <span class="pre">144d:a80a</span></code> 显示3块三星NVMe。</p>
</div>
<p>检查GPU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lspci</span> <span class="o">-</span><span class="n">nnk</span> <span class="o">-</span><span class="n">d</span> <span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span>
</pre></div>
</div>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">82</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0302</span><span class="p">]:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
     <span class="n">Subsystem</span><span class="p">:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1217</span><span class="p">]</span>
     <span class="n">Kernel</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span> <span class="n">vfio</span><span class="o">-</span><span class="n">pci</span>
     <span class="n">Kernel</span> <span class="n">modules</span><span class="p">:</span> <span class="n">nvidiafb</span><span class="p">,</span> <span class="n">nouveau</span>
</pre></div>
</div>
</section>
</section>
<section id="ovmf-guest-vm">
<h2>设置OVMF guest VM<a class="headerlink" href="#ovmf-guest-vm" title="永久链接至标题">¶</a></h2>
<p>OVMF是开源UEFI firmware，用于QEMU虚拟机。</p>
<section id="libvirt">
<h3>配置libvirt<a class="headerlink" href="#libvirt" title="永久链接至标题">¶</a></h3>
<p><a class="reference internal" href="../libvirt/index.html#libvirt"><span class="std std-ref">Libvirt虚拟机管理器</span></a> 是一系列虚拟化工具包装，可以大幅简化配置和部署过程。在KVM和QEMU案例中，使用libvirt可以避免我们处理QEMU权限并容易添加和移除虚拟机设备。不过，由于libvirt是包装器，所以也有部分qemu功能不能支持，需要使用定制脚本来提供QEMU的扩展参数。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>arch linux 文档 <a class="reference external" href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF">arch linux: PCI passthrough via OVMF</a> 只介绍了使用图形化工具 <code class="docutils literal notranslate"><span class="pre">virt-manager</span></code> 设置 UEFI 虚拟机。不过，可以从 Red Hat Enterprise Linux 虚拟化文档以及SUSE虚拟化文档提供了命令行方式操作。我的实践以命令行为主。</p>
</div>
</section>
<section id="virt-install">
<h3>virt-install<a class="headerlink" href="#virt-install" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">virt-install</span></code> 命令添加 <code class="docutils literal notranslate"><span class="pre">--boot</span> <span class="pre">uefi</span></code> 和 <code class="docutils literal notranslate"><span class="pre">--cpu</span> <span class="pre">host-passthrough</span></code> 参数安装操作系统。注意，虚拟机系统磁盘采用 <a class="reference internal" href="../libvirt/storage/libvirt_lvm_pool.html#libvirt-lvm-pool"><span class="std std-ref">libvirt LVM卷管理存储池</span></a> ，所以首先创建LVM卷:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">vol</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="k">as</span> <span class="n">images_lvm</span> <span class="n">z</span><span class="o">-</span><span class="n">fedora35</span> <span class="mi">6</span><span class="n">G</span>
</pre></div>
</div>
</li>
<li><p>创建虚拟机:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virt</span><span class="o">-</span><span class="n">install</span> \
  <span class="o">--</span><span class="n">network</span> <span class="n">bridge</span><span class="p">:</span><span class="n">virbr0</span> \
  <span class="o">--</span><span class="n">name</span> <span class="n">z</span><span class="o">-</span><span class="n">fedora35</span> \
  <span class="o">--</span><span class="n">ram</span><span class="o">=</span><span class="mi">2048</span> \
  <span class="o">--</span><span class="n">vcpus</span><span class="o">=</span><span class="mi">1</span> \
  <span class="o">--</span><span class="n">os</span><span class="o">-</span><span class="nb">type</span><span class="o">=</span><span class="n">Linux</span> <span class="o">--</span><span class="n">os</span><span class="o">-</span><span class="n">variant</span><span class="o">=</span><span class="n">fedora31</span> \
  <span class="o">--</span><span class="n">boot</span> <span class="n">uefi</span> <span class="o">--</span><span class="n">cpu</span> <span class="n">host</span><span class="o">-</span><span class="n">passthrough</span> \
  <span class="o">--</span><span class="n">disk</span> <span class="n">path</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">vg</span><span class="o">-</span><span class="n">libvirt</span><span class="o">/</span><span class="n">fedora35</span><span class="p">,</span><span class="n">sparse</span><span class="o">=</span><span class="n">false</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span><span class="n">bus</span><span class="o">=</span><span class="n">virtio</span><span class="p">,</span><span class="n">cache</span><span class="o">=</span><span class="n">none</span><span class="p">,</span><span class="n">io</span><span class="o">=</span><span class="n">native</span> \
  <span class="o">--</span><span class="n">graphics</span> <span class="n">none</span> \
  <span class="o">--</span><span class="n">location</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="mf">.163</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">fedora</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="mi">35</span><span class="o">/</span><span class="n">Server</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">os</span><span class="o">/</span> \
  <span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">args</span><span class="o">=</span><span class="s2">&quot;console=tty0 console=ttyS0,115200&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p>Fedora Workstation版本只能从iso安装</p>
<p>安装注意点:</p>
<ul>
<li><p>安装过程启用VNC使用图形界面安装，这样可以选择文件系统分区等高级配置，方便安装</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vda</span></code> 需要分配一个独立UEFI分区挂载为 <code class="docutils literal notranslate"><span class="pre">/boot/efi</span></code> ，这个分区不需指定文件系统类型，系统会自动选择 <code class="docutils literal notranslate"><span class="pre">vfat</span></code> 类型，我分配了 256MB；其余磁盘全部分配给 <code class="docutils literal notranslate"><span class="pre">/</span></code> ，设置为 <code class="docutils literal notranslate"><span class="pre">xfs</span></code> 文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Filesystem</span>      <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="n">devtmpfs</span>        <span class="mi">964</span><span class="n">M</span>     <span class="mi">0</span>  <span class="mi">964</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span>
<span class="n">tmpfs</span>           <span class="mi">983</span><span class="n">M</span>     <span class="mi">0</span>  <span class="mi">983</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
<span class="n">tmpfs</span>           <span class="mi">393</span><span class="n">M</span>  <span class="mi">952</span><span class="n">K</span>  <span class="mi">392</span><span class="n">M</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">run</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda2</span>       <span class="mf">5.8</span><span class="n">G</span>  <span class="mf">1.8</span><span class="n">G</span>  <span class="mf">4.0</span><span class="n">G</span>  <span class="mi">31</span><span class="o">%</span> <span class="o">/</span>
<span class="n">tmpfs</span>           <span class="mi">983</span><span class="n">M</span>  <span class="mf">4.0</span><span class="n">K</span>  <span class="mi">983</span><span class="n">M</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">tmp</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda1</span>       <span class="mi">256</span><span class="n">M</span>  <span class="mf">6.1</span><span class="n">M</span>  <span class="mi">250</span><span class="n">M</span>   <span class="mi">3</span><span class="o">%</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span>
<span class="n">tmpfs</span>           <span class="mi">197</span><span class="n">M</span>     <span class="mi">0</span>  <span class="mi">197</span><span class="n">M</span>   <span class="mi">0</span><span class="o">%</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="mi">0</span>
</pre></div>
</div>
</li>
<li><p>安装完成后，重启系统，继续可以通过控制台维护，首次启动后就可以通过 <code class="docutils literal notranslate"><span class="pre">dnf</span> <span class="pre">upgrade</span></code> 更新系统</p></li>
<li><p>按照 <a class="reference internal" href="../../real/private_cloud/priv_cloud_infra.html#priv-cloud-infra"><span class="std std-ref">私有云架构</span></a> 规划配置主机IP，然后clone出测试服务器 ( <a class="reference internal" href="../libvirt/storage/libvirt_lvm_pool.html#libvirt-lvm-pool"><span class="std std-ref">libvirt LVM卷管理存储池</span></a> ):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virt</span><span class="o">-</span><span class="n">clone</span> <span class="o">--</span><span class="n">original</span> <span class="n">z</span><span class="o">-</span><span class="n">fedora35</span> <span class="o">--</span><span class="n">name</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span> <span class="o">--</span><span class="n">auto</span><span class="o">-</span><span class="n">clone</span>
</pre></div>
</div>
</li>
<li><p>clone之后，对容器内部进行配置修订: Fedora Server使用 <a class="reference internal" href="../../linux/ubuntu_linux/network/networkmanager.html#networkmanager"><span class="std std-ref">NetworkManager</span></a> 管理网络，所以通过以下命令修订静态IP地址和主机名:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nmcli</span> <span class="n">general</span> <span class="n">hostname</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span>
<span class="n">nmcli</span> <span class="n">connection</span> <span class="n">modify</span> <span class="s2">&quot;enp1s0&quot;</span> <span class="n">ipv4</span><span class="o">.</span><span class="n">method</span> <span class="n">manual</span> <span class="n">ipv4</span><span class="o">.</span><span class="n">address</span> <span class="mf">192.168.6.242</span><span class="o">/</span><span class="mi">24</span> <span class="n">ipv4</span><span class="o">.</span><span class="n">gateway</span> <span class="mf">192.168.6.200</span> <span class="n">ipv4</span><span class="o">.</span><span class="n">dns</span> <span class="s2">&quot;192.168.6.200,192.168.6.11&quot;</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id4">
<h3>虚拟机添加设备<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<section id="xml">
<h4>设备xml配置文件<a class="headerlink" href="#xml" title="永久链接至标题">¶</a></h4>
<p>我们前面已经通过 <code class="docutils literal notranslate"><span class="pre">check_iommu.sh</span></code> 脚本找出了需要指派给虚拟机的PCIe设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">39</span><span class="p">:</span>
        <span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0108</span><span class="p">]:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">144</span><span class="n">d</span><span class="p">:</span><span class="n">a80a</span><span class="p">]</span>
<span class="n">IOMMU</span> <span class="n">Group</span> <span class="mi">79</span><span class="p">:</span>
        <span class="mi">82</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span> <span class="p">[</span><span class="mi">0302</span><span class="p">]:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="p">[</span><span class="mi">10</span><span class="n">de</span><span class="p">:</span><span class="mi">1</span><span class="n">b39</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
<p>并通过内核启动参数 <code class="docutils literal notranslate"><span class="pre">vfio-pci.ids=144d:a80a,10de:1b39</span></code> 屏蔽了HOST物理主机使用这两个设备，现在我们可以将这两个设备attach到虚拟机。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>我被Red Hat的文档绕糊涂了，实际上只需要执行 <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">nodedev-list</span> <span class="pre">--cap</span> <span class="pre">pci</span></code> 没有必要执行 <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">nodedev-dumpxml</span></code> :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">lspci</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">Samsung</span></code> 和 <code class="docutils literal notranslate"><span class="pre">lspci</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">nvidia</span></code> 实际上已经获得了16进制设备的完整id了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="n">a80a</span>
<span class="mi">08</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="n">a80a</span>
<span class="mi">0</span><span class="n">b</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="n">a80a</span>

<span class="mi">82</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span><span class="p">:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="mi">1</span><span class="n">b39</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>第一列就是设备十六进制的ID，可以直接用来配置设备的 <code class="docutils literal notranslate"><span class="pre">.xml</span></code> 文件，3个数字字段分别对应了 <code class="docutils literal notranslate"><span class="pre">bus=</span> <span class="pre">slot=</span> <span class="pre">function=</span></code> 举例第三个NVMe设备 <code class="docutils literal notranslate"><span class="pre">0b:00.0</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">hostdev</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;subsystem&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;pci&#39;</span> <span class="n">managed</span><span class="o">=</span><span class="s1">&#39;yes&#39;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">source</span><span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="n">address</span> <span class="n">domain</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span> <span class="n">bus</span><span class="o">=</span><span class="s1">&#39;0xb&#39;</span> <span class="n">slot</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;0x0&#39;</span><span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="n">source</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">hostdev</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>后面我写的这段实践可以省略</p>
</div>
<ul>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">lspci</span></code> 命令检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># lspci | grep -i Samsung</span>
<span class="mi">05</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">Device</span> <span class="n">a80a</span>
<span class="c1"># lspci | grep -i nvidia</span>
<span class="mi">82</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span><span class="p">:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">Device</span> <span class="mi">1</span><span class="n">b39</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">nodedev-list</span></code> 命令检查 <code class="docutils literal notranslate"><span class="pre">pci</span></code> 类型设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">nodedev</span><span class="o">-</span><span class="nb">list</span> <span class="o">--</span><span class="n">cap</span> <span class="n">pci</span>
</pre></div>
</div>
</li>
</ul>
<p>此时设备显示会将 <code class="docutils literal notranslate"><span class="pre">lspci</span></code> 输出的分隔符号 <code class="docutils literal notranslate"><span class="pre">:</span></code> 和 <code class="docutils literal notranslate"><span class="pre">.</span></code> 替换成 <code class="docutils literal notranslate"><span class="pre">_</span></code> ，所以列出设备是:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pci_0000_05_00_0</span>
<span class="n">pci_0000_82_00_0</span>
</pre></div>
</div>
<ul class="simple">
<li><p>再次检查设备信息</p></li>
</ul>
<p>NVMe设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">nodedev</span><span class="o">-</span><span class="n">dumpxml</span> <span class="n">pci_0000_05_00_0</span>
</pre></div>
</div>
<p>输出显示:</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">Samsung PM9A1</span><a class="headerlink" href="#id11" title="永久链接至代码">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">&lt;device&gt;</span>
<span class="linenos"> 2</span>  <span class="nt">&lt;name&gt;</span>pci_0000_05_00_0<span class="nt">&lt;/name&gt;</span>
<span class="linenos"> 3</span>  <span class="nt">&lt;path&gt;</span>/sys/devices/pci0000:00/0000:00:02.0/0000:05:00.0<span class="nt">&lt;/path&gt;</span>
<span class="linenos"> 4</span>  <span class="nt">&lt;parent&gt;</span>pci_0000_00_02_0<span class="nt">&lt;/parent&gt;</span>
<span class="linenos"> 5</span>  <span class="nt">&lt;driver&gt;</span>
<span class="linenos"> 6</span>    <span class="nt">&lt;name&gt;</span>vfio-pci<span class="nt">&lt;/name&gt;</span>
<span class="linenos"> 7</span>  <span class="nt">&lt;/driver&gt;</span>
<span class="linenos"> 8</span>  <span class="nt">&lt;capability</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span><span class="nt">&gt;</span>
<span class="linenos"> 9</span>    <span class="nt">&lt;class&gt;</span>0x010802<span class="nt">&lt;/class&gt;</span>
<span class="linenos">10</span>    <span class="nt">&lt;domain&gt;</span>0<span class="nt">&lt;/domain&gt;</span>
<span class="hll"><span class="linenos">11</span>    <span class="nt">&lt;bus&gt;</span>5<span class="nt">&lt;/bus&gt;</span>
</span><span class="hll"><span class="linenos">12</span>    <span class="nt">&lt;slot&gt;</span>0<span class="nt">&lt;/slot&gt;</span>
</span><span class="hll"><span class="linenos">13</span>    <span class="nt">&lt;function&gt;</span>0<span class="nt">&lt;/function&gt;</span>
</span><span class="linenos">14</span>    <span class="nt">&lt;product</span> <span class="na">id=</span><span class="s">&#39;0xa80a&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">15</span>    <span class="nt">&lt;vendor</span> <span class="na">id=</span><span class="s">&#39;0x144d&#39;</span><span class="nt">&gt;</span>Samsung Electronics Co Ltd<span class="nt">&lt;/vendor&gt;</span>
<span class="linenos">16</span>    <span class="nt">&lt;iommuGroup</span> <span class="na">number=</span><span class="s">&#39;39&#39;</span><span class="nt">&gt;</span>
<span class="linenos">17</span>      <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x05&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">18</span>    <span class="nt">&lt;/iommuGroup&gt;</span>
<span class="linenos">19</span>    <span class="nt">&lt;numa</span> <span class="na">node=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">20</span>    <span class="nt">&lt;pci-express&gt;</span>
<span class="linenos">21</span>      <span class="nt">&lt;link</span> <span class="na">validity=</span><span class="s">&#39;cap&#39;</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span> <span class="na">speed=</span><span class="s">&#39;16&#39;</span> <span class="na">width=</span><span class="s">&#39;4&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">22</span>      <span class="nt">&lt;link</span> <span class="na">validity=</span><span class="s">&#39;sta&#39;</span> <span class="na">speed=</span><span class="s">&#39;8&#39;</span> <span class="na">width=</span><span class="s">&#39;4&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">23</span>    <span class="nt">&lt;/pci-express&gt;</span>
<span class="linenos">24</span>  <span class="nt">&lt;/capability&gt;</span>
<span class="linenos">25</span><span class="nt">&lt;/device&gt;</span>
</pre></div>
</div>
</div>
<p>GPU设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">nodedev</span><span class="o">-</span><span class="n">dumpxml</span> <span class="n">pci_0000_82_00_0</span>
</pre></div>
</div>
<p>输出显示:</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">NVIDIA Tesla P10</span><a class="headerlink" href="#id12" title="永久链接至代码">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">&lt;device&gt;</span>
<span class="linenos"> 2</span>  <span class="nt">&lt;name&gt;</span>pci_0000_82_00_0<span class="nt">&lt;/name&gt;</span>
<span class="linenos"> 3</span>  <span class="nt">&lt;path&gt;</span>/sys/devices/pci0000:80/0000:80:02.0/0000:82:00.0<span class="nt">&lt;/path&gt;</span>
<span class="linenos"> 4</span>  <span class="nt">&lt;parent&gt;</span>pci_0000_80_02_0<span class="nt">&lt;/parent&gt;</span>
<span class="linenos"> 5</span>  <span class="nt">&lt;driver&gt;</span>
<span class="linenos"> 6</span>    <span class="nt">&lt;name&gt;</span>vfio-pci<span class="nt">&lt;/name&gt;</span>
<span class="linenos"> 7</span>  <span class="nt">&lt;/driver&gt;</span>
<span class="linenos"> 8</span>  <span class="nt">&lt;capability</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span><span class="nt">&gt;</span>
<span class="linenos"> 9</span>    <span class="nt">&lt;class&gt;</span>0x030200<span class="nt">&lt;/class&gt;</span>
<span class="linenos">10</span>    <span class="nt">&lt;domain&gt;</span>0<span class="nt">&lt;/domain&gt;</span>
<span class="hll"><span class="linenos">11</span>    <span class="nt">&lt;bus&gt;</span>130<span class="nt">&lt;/bus&gt;</span>
</span><span class="hll"><span class="linenos">12</span>    <span class="nt">&lt;slot&gt;</span>0<span class="nt">&lt;/slot&gt;</span>
</span><span class="hll"><span class="linenos">13</span>    <span class="nt">&lt;function&gt;</span>0<span class="nt">&lt;/function&gt;</span>
</span><span class="linenos">14</span>    <span class="nt">&lt;product</span> <span class="na">id=</span><span class="s">&#39;0x1b39&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">15</span>    <span class="nt">&lt;vendor</span> <span class="na">id=</span><span class="s">&#39;0x10de&#39;</span><span class="nt">&gt;</span>NVIDIA Corporation<span class="nt">&lt;/vendor&gt;</span>
<span class="linenos">16</span>    <span class="nt">&lt;iommuGroup</span> <span class="na">number=</span><span class="s">&#39;79&#39;</span><span class="nt">&gt;</span>
<span class="linenos">17</span>      <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x82&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">18</span>    <span class="nt">&lt;/iommuGroup&gt;</span>
<span class="linenos">19</span>    <span class="nt">&lt;numa</span> <span class="na">node=</span><span class="s">&#39;1&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">20</span>    <span class="nt">&lt;pci-express&gt;</span>
<span class="linenos">21</span>      <span class="nt">&lt;link</span> <span class="na">validity=</span><span class="s">&#39;cap&#39;</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span> <span class="na">speed=</span><span class="s">&#39;8&#39;</span> <span class="na">width=</span><span class="s">&#39;16&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">22</span>      <span class="nt">&lt;link</span> <span class="na">validity=</span><span class="s">&#39;sta&#39;</span> <span class="na">speed=</span><span class="s">&#39;8&#39;</span> <span class="na">width=</span><span class="s">&#39;16&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">23</span>    <span class="nt">&lt;/pci-express&gt;</span>
<span class="linenos">24</span>  <span class="nt">&lt;/capability&gt;</span>
<span class="linenos">25</span><span class="nt">&lt;/device&gt;</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>转换设备配置参数:</p></li>
</ul>
<p>在上述 <code class="docutils literal notranslate"><span class="pre">nodedev-dumpxml</span></code> 中高亮的3行参数配置是10进制，需要转换成16进制配置到设备添加xml配置中</p>
<p>NVMe设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">bus</span><span class="o">&gt;</span><span class="mi">5</span><span class="o">&lt;/</span><span class="n">bus</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">slot</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">slot</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">function</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">function</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>执行以下命令得到对应16进制值:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ printf %x 5
5
$ printf %x 0
0
$ printf %x 0
0
</pre></div>
</div>
<p>则对应配置 <code class="docutils literal notranslate"><span class="pre">samsung_pm9a1_1.xml</span></code> :</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">Samsung PM9A1 #1</span><a class="headerlink" href="#id13" title="永久链接至代码">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">&#39;subsystem&#39;</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">managed=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span>
<span class="linenos">2</span>  <span class="nt">&lt;source&gt;</span>
<span class="linenos">3</span>     <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">&#39;0x0&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x5&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x0&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">4</span>  <span class="nt">&lt;/source&gt;</span>
<span class="linenos">5</span><span class="nt">&lt;/hostdev&gt;</span>
</pre></div>
</div>
</div>
<p>GPU设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">bus</span><span class="o">&gt;</span><span class="mi">130</span><span class="o">&lt;/</span><span class="n">bus</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">slot</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">slot</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">function</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">function</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>执行以下命令得到对应16进制值:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ printf %x 130
82
$ printf %x 0
0
$ printf %x 0
0
</pre></div>
</div>
<p>则对应配置 <code class="docutils literal notranslate"><span class="pre">tesla_p10.xml</span></code> :</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">NVIDIA Tesla P10</span><a class="headerlink" href="#id14" title="永久链接至代码">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">&#39;subsystem&#39;</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">managed=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span>
<span class="linenos">2</span>  <span class="nt">&lt;source&gt;</span>
<span class="linenos">3</span>     <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">&#39;0x0&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x82&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x0&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
<span class="linenos">4</span>  <span class="nt">&lt;/source&gt;</span>
<span class="linenos">5</span><span class="nt">&lt;/hostdev&gt;</span>
</pre></div>
</div>
</div>
</section>
<section id="nvme">
<h4>添加NVMe设备<a class="headerlink" href="#nvme" title="永久链接至标题">¶</a></h4>
<ul>
<li><p>执行以下命令将第一个NVMe Samsung PM9A1 添加到虚拟机 <code class="docutils literal notranslate"><span class="pre">z-iommu</span></code> 上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">attach</span><span class="o">-</span><span class="n">device</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span> <span class="n">samsung_pm9a1_1</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
</li>
</ul>
<p>此时在物理主机上提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Device</span> <span class="n">attached</span> <span class="n">successfully</span>
</pre></div>
</div>
<p>在虚拟机 <code class="docutils literal notranslate"><span class="pre">z-iommu</span></code> 终端控制台可以看到信息:</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">Samsung PM9A1 #1</span><a class="headerlink" href="#id15" title="永久链接至代码">¶</a></div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>[ 6621.990244] pcieport 0000:00:01.6: pciehp: Slot(0-6) Powering on due to button press
<span class="linenos"> 2</span>[ 6621.993421] pcieport 0000:00:01.6: pciehp: Slot(0-6): Card present
<span class="linenos"> 3</span>[ 6621.995719] pcieport 0000:00:01.6: pciehp: Slot(0-6): Link Up
<span class="linenos"> 4</span>[ 6622.124045] pci 0000:07:00.0: [144d:a80a] type 00 class 0x010802
<span class="linenos"> 5</span>[ 6622.126753] pci 0000:07:00.0: reg 0x10: [mem 0x00000000-0x00003fff 64bit]
<span class="linenos"> 6</span>[ 6622.130056] pci 0000:07:00.0: Max Payload Size set to 128 (was 256, max 256)
<span class="linenos"> 7</span>[ 6622.134642] pci 0000:07:00.0: 31.504 Gb/s available PCIe bandwidth, limited by 8.0 GT/s PCIe x4 link at 0000:00:01.6 (capable of 63.012 Gb/s with 16.0 GT/s PCIe x4 link)
<span class="linenos"> 8</span>[ 6622.138779] pci 0000:07:00.0: BAR 0: assigned [mem 0xc0000000-0xc0003fff 64bit]
<span class="linenos"> 9</span>[ 6622.140297] pcieport 0000:00:01.6: PCI bridge to [bus 07]
<span class="linenos">10</span>[ 6622.141349] pcieport 0000:00:01.6:   bridge window [io  0x6000-0x6fff]
<span class="linenos">11</span>[ 6622.145734] pcieport 0000:00:01.6:   bridge window [mem 0xc0000000-0xc01fffff]
<span class="linenos">12</span>[ 6622.148817] pcieport 0000:00:01.6:   bridge window [mem 0x800700000-0x8008fffff 64bit pref]
<span class="linenos">13</span>[ 6622.195537] nvme nvme0: pci function 0000:07:00.0
<span class="linenos">14</span>[ 6622.196524] nvme 0000:07:00.0: enabling device (0140 -&gt; 0142)
<span class="linenos">15</span>[ 6622.233264] nvme nvme0: Shutdown timeout set to 10 seconds
<span class="linenos">16</span>[ 6622.256580] nvme nvme0: 1/0/0 default/read/poll queues
</pre></div>
</div>
</div>
<p>此时在虚拟机 <code class="docutils literal notranslate"><span class="pre">z-iommmu</span></code> 中检查磁盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fdisk</span> <span class="o">-</span><span class="n">l</span>
</pre></div>
</div>
<p>可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mf">953.87</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024209543168</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000409264</span> <span class="n">sectors</span>
<span class="n">Disk</span> <span class="n">model</span><span class="p">:</span> <span class="n">SAMSUNG</span> <span class="n">MZVL21T0HCLR</span><span class="o">-</span><span class="mi">00</span><span class="n">B00</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这种live方式添加nvme磁盘所在的pci设备可以立即使用存储，无需重启虚拟机。但是虚拟机重启后，该磁盘未自动添加。所以我后来还是采用 <code class="docutils literal notranslate"><span class="pre">--config</span></code> 参数运行 <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">attach-device</span></code> ，然后重启虚拟机。重启以后可以保持使用NVMe设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">attach</span><span class="o">-</span><span class="n">device</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span> <span class="n">samsung_pm9a1_1</span><span class="o">.</span><span class="n">xml</span> <span class="o">--</span><span class="n">config</span>
</pre></div>
</div>
</div>
<ul>
<li><p>删除设备是反向操作:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">detach</span><span class="o">-</span><span class="n">device</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span> <span class="n">samsung_pm9a1_1</span><span class="o">.</span><span class="n">xml</span> <span class="o">--</span><span class="n">config</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id5">
<h4>添加GPU设备<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<ul>
<li><p>执行以下命令将NVIDIA Tesla P10 GPU运算卡 添加到虚拟机 <code class="docutils literal notranslate"><span class="pre">z-iommu</span></code> 上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">attach</span><span class="o">-</span><span class="n">device</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span> <span class="n">tesla_p10</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
</li>
</ul>
<p>这里出现一个报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">error</span><span class="p">:</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">attach</span> <span class="n">device</span> <span class="kn">from</span> <span class="nn">tesla_p10.xml</span>
<span class="n">error</span><span class="p">:</span> <span class="n">internal</span> <span class="n">error</span><span class="p">:</span> <span class="n">No</span> <span class="n">more</span> <span class="n">available</span> <span class="n">PCI</span> <span class="n">slots</span>
</pre></div>
</div>
<p>这个问题在 <a class="reference external" href="https://unix.stackexchange.com/questions/570166/libvirtd-no-more-available-pci-slots">libvirtd: No more available PCI slots</a> 提到了解决方法: 添加一个 <code class="docutils literal notranslate"><span class="pre">--config</span></code> 参数，让libvirt来自动添加需要的 <code class="docutils literal notranslate"><span class="pre">pcie-root-port</span></code> 配置。然后就需要shutdown虚拟机，并再次启动虚拟机。这个设备就会正确添加。</p>
<p>所以改为执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">attach</span><span class="o">-</span><span class="n">device</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span> <span class="n">tesla_p10</span><span class="o">.</span><span class="n">xml</span> <span class="o">--</span><span class="n">config</span>

<span class="n">virsh</span> <span class="n">destory</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span>
<span class="n">virsh</span> <span class="n">start</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span>
</pre></div>
</div>
<ul>
<li><p>重启完虚拟机，登录虚拟机中执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lspci</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到GPU设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">07</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span><span class="p">:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">GP102GL</span> <span class="p">[</span><span class="n">Tesla</span> <span class="n">P10</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
<p>但是没有找到前面live方式添加的NVMe设备，所以使用 <code class="docutils literal notranslate"><span class="pre">--config</span></code> 参数再重新添加一次NVMe设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">virsh</span> <span class="n">attach</span><span class="o">-</span><span class="n">device</span> <span class="n">z</span><span class="o">-</span><span class="n">iommu</span> <span class="n">samsung_pm9a1_1</span><span class="o">.</span><span class="n">xml</span> <span class="o">--</span><span class="n">config</span>
</pre></div>
</div>
<p>重启以后再次检查可以看到添加的2个pci设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">07</span><span class="p">:</span><span class="mf">00.0</span> <span class="mi">3</span><span class="n">D</span> <span class="n">controller</span><span class="p">:</span> <span class="n">NVIDIA</span> <span class="n">Corporation</span> <span class="n">GP102GL</span> <span class="p">[</span><span class="n">Tesla</span> <span class="n">P10</span><span class="p">]</span> <span class="p">(</span><span class="n">rev</span> <span class="n">a1</span><span class="p">)</span>
<span class="mi">08</span><span class="p">:</span><span class="mf">00.0</span> <span class="n">Non</span><span class="o">-</span><span class="n">Volatile</span> <span class="n">memory</span> <span class="n">controller</span><span class="p">:</span> <span class="n">Samsung</span> <span class="n">Electronics</span> <span class="n">Co</span> <span class="n">Ltd</span> <span class="n">NVMe</span> <span class="n">SSD</span> <span class="n">Controller</span> <span class="n">PM9A1</span><span class="o">/</span><span class="n">PM9A3</span><span class="o">/</span><span class="mi">980</span><span class="n">PRO</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id6">
<h2>下一步<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>现在上述两个PCIe设备已经属于虚拟机独占使用，和常规的设备使用一致，接下来就是:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../machine_learning/cuda/install_cuda_ubuntu.html#install-cuda-ubuntu"><span class="std std-ref">在Ubuntu安装NVIDIA CUDA</span></a> - 对于pass-through的gpu设备，在虚拟机内部如同物理主机一样，需要安装GPU驱动以及CUDA环境</p></li>
<li><p><a class="reference internal" href="compare_iommu_native_nvme.html#compare-iommu-native-nvme"><span class="std std-ref">比较IOMMU NVMe和原生NVMe存储性能</span></a> - 在虚拟机内部和物理主机上，分别对NVMe测试存储性能</p></li>
</ul>
</section>
<section id="id7">
<h2>参考<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="http://www.linux-kvm.org/downloads/lersek/ovmf-whitepaper-c770f8c.txt">Open Virtual Machine Firmware (OVMF) Status Report</a></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF">arch linux: PCI passthrough via OVMF</a></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/title/libvirt">arch linux: libvirt</a></p></li>
<li><p><a class="reference external" href="https://fedoraproject.org/wiki/Using_UEFI_with_QEMU">Using UEFI with QEMU</a></p></li>
<li><p><a class="reference external" href="https://wiki.ubuntu.com/UEFI/OVMF">ubuntu wiki: OVMF</a> 如果要自制OVMF镜像，可以参考 <a class="reference external" href="https://wiki.ubuntu.com/UEFI/EDK2">ubuntu wiki: EDK2</a></p></li>
<li><p><a class="reference external" href="https://frdmtoplay.com/virtualizing-windows-7-or-linux-on-a-nvme-drive-with-vfio/">Virtualizing Windows 7 (or Linux) on a NVMe drive with VFIO</a></p></li>
<li><p><a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.4/html/setting_up_an_nvidia_gpu_for_a_virtual_machine_in_red_hat_virtualization/index">SETTING UP AN NVIDIA GPU FOR A VIRTUAL MACHINE IN RED HAT VIRTUALIZATION</a> 设置GPU的直通和vgpu，本文参考前半部分</p></li>
<li><p><a class="reference external" href="https://developer.ibm.com/tutorials/enabling-pci-pass-through-using-libvirt/">Enabling PCI pass-through in guest</a> 这篇blog提供了添加pci设备的xml案例，可以直接使用virsh命令动态添加设备</p></li>
<li><p><a class="reference external" href="https://docs.fedoraproject.org/en-US/Fedora/18/html/Virtualization_Administration_Guide/sect-Attaching_and_updating_a_device_with_virsh.html">Attaching and updating a device with virsh</a> Fedora文档，提供xml案例添加CDROM设备</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="intel_vt-d_startup.html" class="btn btn-neutral float-left" title="Intel VT-d快速起步" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vfio.html" class="btn btn-neutral float-right" title="VFIO - Virtual Function I/O" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>