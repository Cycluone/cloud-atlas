

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>kubeadm &mdash; Cloud Atlas 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" />
    <link rel="next" title="创建单一控制平面(单master)集群" href="single_master_k8s.html" />
    <link rel="prev" title="Kubernetes集群引导" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Kubernetes Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../kubernetes_overview.html">Kubernetes概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup_prepare/index.html">Kubernetes起步准备</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup/index.html">Kubernetes快速起步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html">Kubernetes概念辨析</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Kubernetes部署</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../k8s_hosts.html">Kubernetes部署服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../container_runtimes.html">容器运行环境</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Kubernetes集群引导</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">kubeadm</a></li>
<li class="toctree-l4"><a class="reference internal" href="single_master_k8s.html">创建单一控制平面(单master)集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="change_master_ip.html">修改Kubernetes Master IP</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s.html">高可用(HA)Kubernetes集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s_lb.html">高可用k8s的Master负载均衡</a></li>
<li class="toctree-l4"><a class="reference internal" href="create_ha_k8s.html">使用kubeadm创建高可用集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s_stacked.html">堆叠型管控/etcd节点高可用集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_etcd.html">高可用etcd集群部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s_external.html">扩展etcd节点高可用集群</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../stateless_application/index.html">Kubernetes部署无状态应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operator/index.html">Kubernetes应用部署方法Operator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../etcd/index.html">部署etcd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nginx_ingress.html">部署Nginx Ingress Controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../docker_registry.html">在Kubernetes中部署私有Docker镜像仓库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../helm.html">Helm - Kubernetes包管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../draft.html">Draft - Kubernetes应用部署工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kustomize.html">kustomize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kuberbuilder.html">Kubebuilder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../terraform.html">Terraform基础架构管理平台</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../administer/index.html">Kubernetes管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/index.html">Kubernetes网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../production/index.html">Kubernetes生产环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../service_mesh/index.html">Service Mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ci_cd/index.html">Kubernetes持续集成和持续部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../monitor/index.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debug/index.html">Kubernetes排查</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">Kubernetes安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtual/index.html">Kubernetes结合虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cloud/index.html">Kubernetes云厂商</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kali_linux/index.html">Kali Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Kubernetes Atlas</a> &raquo;</li>
        
          <li><a href="../index.html">Kubernetes部署</a> &raquo;</li>
        
          <li><a href="index.html">Kubernetes集群引导</a> &raquo;</li>
        
      <li>kubeadm</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/kubernetes/deployment/bootstrap_kubernetes/kubeadm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kubeadm">
<span id="id1"></span><h1>kubeadm<a class="headerlink" href="#kubeadm" title="Permalink to this headline">¶</a></h1>
<p>kubeadm是用于自举kubernetes集群的工具，我们将使用kubeadm结合kubelet/kubectl来构建一个Kubernetes集群。</p>
<div class="section" id="id2">
<h2>准备工作<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>硬件: 2CPU / 2GB内存 ，并且服务器必须 <code class="docutils literal notranslate"><span class="pre">禁用</span></code> swap，否则kubelet可能工作不正常（kubeadm初始化系统时会检查swap，如存在swap会报错）</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>批量关闭所有Kubernetes服务器上swap:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s1">&#39;sudo swapoff -a&#39;</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s2">&quot;sudo sed -i -e &#39;/swap/s/^UUID=/#UUID=/g&#39; /etc/fstab&quot;</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>网络：每个主机具有唯一主机名，MAC地址以及 <code class="docutils literal notranslate"><span class="pre">product_uuid</span></code> ，并且开放必要管控端口(见下文)</li>
<li>操作系统：采用符合要求OS，通常 Ubuntu 16.04+, CentOS 7, Fedora 25/26</li>
</ul>
<div class="section" id="macproduct-uuid">
<h3>验证MAC地址和product_uuid<a class="headerlink" href="#macproduct-uuid" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">检查MAC地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">link</span>
</pre></div>
</div>
</li>
<li><p class="first">检查 <code class="docutils literal notranslate"><span class="pre">product_uuid</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">dmi</span><span class="o">/</span><span class="nb">id</span><span class="o">/</span><span class="n">product_uuid</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">务必确保服务器具有唯一地址，特别是一些虚拟机可能会使用重复的标识值，会导致Kubernetes的安装过程失败。我在 <a class="reference internal" href="../k8s_hosts.html#k8s-hosts"><span class="std std-ref">Kubernetes部署服务器</span></a> 采用KVM虚拟机是通过 <code class="docutils literal notranslate"><span class="pre">virt-clone</span></code> 和 <code class="docutils literal notranslate"><span class="pre">virt-sysprep</span></code> 构建的，会自动初始化不同的 <code class="docutils literal notranslate"><span class="pre">product_uuid</span></code> 和 MAC地址。</p>
</div>
</div>
<div class="section" id="id3">
<h3>检查网络<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>对于多网卡环境，特别是Kubernetes组件不是通过默认路由访问，建议添加IP路由以便Kubernetes集群地址能够通过相应网卡互访</li>
</ul>
<div class="section" id="id4">
<h4>网络端口<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>管控平台节点:</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="9%" />
<col width="16%" />
<col width="34%" />
<col width="32%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">协议</th>
<th class="head">方向</th>
<th class="head">端口范围</th>
<th class="head">用途</th>
<th class="head">使用方</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>TCP</td>
<td>入</td>
<td>6443*</td>
<td>Kubernetes API服务器</td>
<td>All</td>
</tr>
<tr class="row-odd"><td>TCP</td>
<td>入</td>
<td>2379-2380</td>
<td>etcd服务器客户端访问API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr class="row-even"><td>TCP</td>
<td>入</td>
<td>10250</td>
<td>Kubelet API</td>
<td>自身，管控平台</td>
</tr>
<tr class="row-odd"><td>TCP</td>
<td>入</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>自身</td>
</tr>
<tr class="row-even"><td>TCP</td>
<td>入</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>自身</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>工作节点:</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="9%" />
<col width="16%" />
<col width="34%" />
<col width="32%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">协议</th>
<th class="head">方向</th>
<th class="head">端口范围</th>
<th class="head">用途</th>
<th class="head">使用方</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>TCP</td>
<td>入</td>
<td>10250</td>
<td>Kubelet API</td>
<td>自身，管控平台</td>
</tr>
<tr class="row-odd"><td>TCP</td>
<td>入</td>
<td>30000-32767</td>
<td>节点端口服务</td>
<td>All</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>由于虚拟机安装默认开启了firewalld服务，所以我批量通过以下命令来开启端口:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kubemaster</span> <span class="s1">&#39;sudo firewall-cmd --zone=public --add-port=6443/tcp --permanent&#39;</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kubemaster</span> <span class="s1">&#39;sudo firewall-cmd --zone=public --add-port=2379-2380/tcp --permanent&#39;</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kubemaster</span> <span class="s1">&#39;sudo firewall-cmd --zone=public --add-port=10250-10252/tcp --permanent&#39;</span>

<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kubenode</span> <span class="s1">&#39;sudo firewall-cmd --zone=public --add-port=10250/tcp --permanent&#39;</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kubenode</span> <span class="s1">&#39;sudo firewall-cmd --zone=public --add-port=30000-32767/tcp --permanent&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="runtime">
<h2>安装runtime<a class="headerlink" href="#runtime" title="Permalink to this headline">¶</a></h2>
<p>从 v1.6.0 开始，Kuberneetes激活默认使用CRI, Container Runtime</p>
<p>从 v1.14.0 开始， kubeadm 将自动检测Linux节点的容器运行环境，这个检测是基于总所周知的domain sockets。</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Runtime</th>
<th class="head">Domain Socket</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Docker</td>
<td>/var/run/docker.sock</td>
</tr>
<tr class="row-odd"><td>contained</td>
<td>/run/containerd/containerd.sock</td>
</tr>
<tr class="row-even"><td>CRI0-O</td>
<td>/var/run/crio/crio.sock</td>
</tr>
</tbody>
</table>
<p>如果同时检测到 Docker 和 containerd ，则优先采用Docker。因为Docker 18.09同时提供了containerd，所以两者都会被检测到。</p>
<p>对于非Linux节点，则默认runtime是Docker。</p>
</div>
<div class="section" id="kubeadm-kubelet-kubectl">
<h2>安装kubeadm, kubelet 和 kubectl<a class="headerlink" href="#kubeadm-kubelet-kubectl" title="Permalink to this headline">¶</a></h2>
<p>在所有节点上需要安装以下软件包:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> 启动cluster的命令工具</li>
<li><code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 运行在集群所有服务器节点的组件，用于启动pod和容器</li>
<li><code class="docutils literal notranslate"><span class="pre">kubectl</span></code> 和集群通讯的工具</li>
</ul>
<p>由于 kubeadm <code class="docutils literal notranslate"><span class="pre">不会</span></code> 安装和管理 <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 或 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> ，所以要确保你需要kubeadm为你安装的正确版本。</p>
<div class="section" id="id5">
<h3>安装前准备<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>请参考 <a class="reference internal" href="../../../studio/openconnect_vpn.html#openconnect-vpn"><span class="std std-ref">OpenConnect VPN</span></a> 准备好梯子，安装Kubernetes软件包需要访问Google的软件仓库。</li>
</ul>
<p>注意：请不要直接在Kubernetes集群服务器上部署VPN客户端来翻墙，我遇到的问题是，VPN客户端运行时会在服务器上添加 <code class="docutils literal notranslate"><span class="pre">tun0</span></code> 网络设备，并且设置了默认路由。这会导致 <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> 初始化时以 <code class="docutils literal notranslate"><span class="pre">tun0</span></code> 接口的IP地址作为API服务接口。这样一旦关闭VPN接口就会引起异常。</p>
<p>解决的方法时采用VPN网关方式，在外部的服务器上构建VPN转发，这样局域网内部的服务器就不需要单独运行VPN，也就不再为这个网卡无识别困扰了。</p>
<ul>
<li><p class="first">节点上的 SELinux 需要设置成 <code class="docutils literal notranslate"><span class="pre">permissive</span></code> 模式:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setenforce</span> <span class="mi">0</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">selinux</span><span class="o">/</span><span class="n">config</span>
</pre></div>
</div>
</li>
</ul>
<p>这样容器才可以访问主机的文件系统，这个特性是pod网络锁需要的特性。目前kubelet还不能支持SELinux，所以需要禁用SELinux。</p>
<ul>
<li><p class="first">一些RHEL/CentOS 7用户报告流量路由错误，因为iptables被绕过。所以需要确保 <code class="docutils literal notranslate"><span class="pre">net.bridge.bridge-nf-call-iptables</span></code> 设置成 <code class="docutils literal notranslate"><span class="pre">1</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span>  <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">conf</span>
<span class="n">net</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">ip6tables</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">iptables</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">EOF</span>
<span class="n">sysctl</span> <span class="o">--</span><span class="n">system</span>
</pre></div>
</div>
</li>
</ul>
<p>该步骤必须执行，否则 <code class="docutils literal notranslate"><span class="pre">kubedam</span> <span class="pre">init</span></code> 时报错。</p>
<ul>
<li><p class="first">确保先加载 <code class="docutils literal notranslate"><span class="pre">br_netfilter</span></code> 模块已经加载，通过 <code class="docutils literal notranslate"><span class="pre">lsmod</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">br_netfilter</span></code> 确保，如果没有加载，则执行以下命令加载该内核模块:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modprobe</span> <span class="n">br_netfilter</span>
</pre></div>
</div>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 会不断重启，以等待kubeadm的crashloop告知其执行。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>批量处理方式:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s2">&quot;sudo setenforce 0;sudo sed -i &#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39; /etc/selinux/config&quot;</span>

<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="n">k8s</span><span class="o">.</span><span class="n">_onf</span>
<span class="n">net</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">ip6tables</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">iptables</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">EOF</span>

<span class="n">pscp</span><span class="o">.</span><span class="n">pssh</span> <span class="o">-</span><span class="n">h</span> <span class="n">kube</span> <span class="n">k8s</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">conf</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s2">&quot;sudo cp /tmp/k8s.conf /etc/sysctl.d/k8s.conf&quot;</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s2">&quot;sudo sysctl --system&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ubuntu-debian">
<h3>Ubuntu, Debian<a class="headerlink" href="#ubuntu-debian" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span> <span class="n">curl</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">apt</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span> <span class="o">|</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">-</span>
<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">list</span>
<span class="n">deb</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">apt</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="n">main</span>
<span class="n">EOF</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">kubelet</span> <span class="n">kubeadm</span> <span class="n">kubectl</span>
<span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubelet</span> <span class="n">kubeadm</span> <span class="n">kubectl</span>
</pre></div>
</div>
</div>
<div class="section" id="centos-rhel-fedora">
<h3>CentOS, RHEL, Fedora<a class="headerlink" href="#centos-rhel-fedora" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">repo</span>
<span class="p">[</span><span class="n">kubernetes</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">Kubernetes</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">el7</span><span class="o">-</span><span class="n">x86_64</span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">repo_gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgkey</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">yum</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">rpm</span><span class="o">-</span><span class="n">package</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span>
<span class="n">EOF</span>

<span class="c1"># Set SELinux in permissive mode (effectively disabling it)</span>
<span class="n">setenforce</span> <span class="mi">0</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">selinux</span><span class="o">/</span><span class="n">config</span>

<span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">kubelet</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="o">--</span><span class="n">disableexcludes</span><span class="o">=</span><span class="n">kubernetes</span>

<span class="n">systemctl</span> <span class="n">enable</span> <span class="o">--</span><span class="n">now</span> <span class="n">kubelet</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>由于Kubernetes软件仓库由 “不存在公司” Google提供，所以需要 <strong>翻墙</strong> <a class="reference external" href="https://movie.douban.com/subject/1292224/">飞越疯人院</a> ，请参考 <a class="reference internal" href="../../../studio/openconnect_vpn.html#openconnect-vpn"><span class="std std-ref">OpenConnect VPN</span></a> 安装。</p>
<p class="last">对于采用NAT模式的KVM虚拟机集群，只需要在Host物理主机上启用VPN客户端就可以使得各节点获得正常的Internet访问。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>批量处理命令:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">repo</span>
<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">repo</span>
<span class="p">[</span><span class="n">kubernetes</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">Kubernetes</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">el7</span><span class="o">-</span><span class="n">x86_64</span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">repo_gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgkey</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">yum</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packages</span><span class="o">.</span><span class="n">cloud</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">rpm</span><span class="o">-</span><span class="n">package</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">gpg</span>
<span class="n">EOF</span>

<span class="n">pscp</span><span class="o">.</span><span class="n">pssh</span> <span class="o">-</span><span class="n">h</span> <span class="n">kube</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">repo</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">repo</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s1">&#39;sudo cp /tmp/kubernetes.repo /etc/yum.repos.d/kubernetes.repo&#39;</span>

<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s1">&#39;sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes&#39;</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s1">&#39;sudo systemctl enable --now kubelet&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="kubeletcgroup-driver">
<h2>在管控平台节点配置kubelet使用cgroup driver<a class="headerlink" href="#kubeletcgroup-driver" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这个步骤暂时不需要执行，因为在下一步 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 时会初始化环境并自动配置并启动kubelet。</p>
</div>
<p>当在使用Docker的环境中，kubeadm可以为kubelet自动检测到cgroup driver，并在运行时设到 <code class="docutils literal notranslate"><span class="pre">/var/lib/kubelet/kubeadm-flags.env</span></code> 。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>在使用Docker环境中，kubelet设置 <code class="docutils literal notranslate"><span class="pre">/var/lib/kubelet/kubeadm-flags.env</span></code> 如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KUBELET_KUBEADM_ARGS</span><span class="o">=</span><span class="s2">&quot;--cgroup-driver=systemd --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.1&quot;</span>
</pre></div>
</div>
<p class="last">这个文件是 <code class="docutils literal notranslate"><span class="pre">kubeadmin</span> <span class="pre">init</span></code> 和 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span></code> 时使用。</p>
</div>
<p>不过对于其他CRI，则需要修改 <code class="docutils literal notranslate"><span class="pre">/etc/default/kubelet</span></code> 设置 <code class="docutils literal notranslate"><span class="pre">cgroup-driver</span></code> 值，类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KUBELET_EXTRA_ARGS</span><span class="o">=--</span><span class="n">cgroup</span><span class="o">-</span><span class="n">driver</span><span class="o">=&lt;</span><span class="n">value</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>这个文件在 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 和 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span></code> 到kubelet的用户定义参数扩展时使用。注意， <strong>只有</strong> CRI不是 <code class="docutils literal notranslate"><span class="pre">cgroupfs</span></code> 时才需要定义 cgroup driver。</p>
<p>然后重启 kubelet</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">kubelet</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>这里还没有初始化集群，无法启动kubelet，出现报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jul</span> <span class="mi">29</span> <span class="mi">17</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">11</span> <span class="n">devstack</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">10529</span><span class="p">]:</span> <span class="n">F0729</span> <span class="mi">17</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mf">11.339363</span>   <span class="mi">10529</span> <span class="n">server</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">198</span><span class="p">]</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">load</span> <span class="n">Kubelet</span> <span class="n">config</span> <span class="n">file</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubelet</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span><span class="p">,</span> <span class="n">error</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">read</span> <span class="n">kubelet</span> <span class="n">config</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="nb">open</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">kubelet</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">yaml</span><span class="p">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</pre></div>
</div>
<p class="last">通过 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span> <span class="pre">--pod-network-cidr=10.244.0.0/16</span></code> 初始化集群。 见 <a class="reference internal" href="single_master_k8s.html#single-master-k8s"><span class="std std-ref">创建单一控制平面(单master)集群</span></a></p>
</div>
</div>
<div class="section" id="kubelet">
<h2>kubelet排查(待续)<a class="headerlink" href="#kubelet" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>目前这个 <code class="docutils literal notranslate"><span class="pre">cpu</span> <span class="pre">and</span> <span class="pre">memory</span> <span class="pre">cgroup</span> <span class="pre">hierarchy</span> <span class="pre">not</span> <span class="pre">unified</span></code> 问题尚未解决，不过我仅在 <a class="reference external" href="https://github.com/huataihuang/cloud-atlas-draft/blob/master/os/linux/redhat/package/convert_alios_to_centos.md">AliOS 转换CentOS</a> 的系统中遇到，而纯净的CentOS部署Kubernetes则完全没有问题。虽然看上去两种操作系统的cgroup没有太大差别，但是我怀疑或许在转换中我有某些软件包转换问题或者AliOS原先的cgroup配置有什么坑在里面尚未发觉。</p>
<p class="last">这个问题留待后续再排查，目前我改为在纯净版CentOS中部署原生Kubernetes集群。</p>
</div>
<p>由于我使用标准的Docker，所以kubeadm会自动检测cgroup driver，并设置环境 <code class="docutils literal notranslate"><span class="pre">/var/lib/kubelet/kubeadm-flags.env</span></code> 所以我没有设置 <code class="docutils literal notranslate"><span class="pre">KUBELET_EXTRA_ARGS</span></code> 直接启动 <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 。但是启动失败，排查如下：</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">kubelet</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)
  Drop-In: /usr/lib/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: activating (auto-restart) (Result: exit-code) since Thu 2019-07-25 09:04:17 CST; 1s ago
     Docs: https://kubernetes.io/docs/
  Process: 86474 ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS (code=exited, status=255)
 Main PID: 86474 (code=exited, status=255)
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-xeu</span> <span class="pre">kubelet</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jul</span> <span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">46</span> <span class="n">worker1</span><span class="o">.</span><span class="n">sqa</span><span class="o">.</span><span class="n">ztt</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">92407</span><span class="p">]:</span> <span class="n">I0725</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mf">46.981191</span>   <span class="mi">92407</span> <span class="n">server</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">791</span><span class="p">]</span> <span class="n">Client</span> <span class="n">rotation</span> <span class="ow">is</span> <span class="n">on</span><span class="p">,</span> <span class="n">will</span> <span class="n">bootstrap</span> <span class="ow">in</span> <span class="n">background</span>
<span class="n">Jul</span> <span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">46</span> <span class="n">worker1</span><span class="o">.</span><span class="n">sqa</span><span class="o">.</span><span class="n">ztt</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">92407</span><span class="p">]:</span> <span class="n">I0725</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mf">46.984895</span>   <span class="mi">92407</span> <span class="n">certificate_store</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">129</span><span class="p">]</span> <span class="n">Loading</span> <span class="n">cert</span><span class="o">/</span><span class="n">key</span> <span class="n">pair</span> <span class="kn">from</span> <span class="s2">&quot;/var/lib/kubelet/pki/kubelet-client-current.pem&quot;</span><span class="o">.</span>
<span class="n">Jul</span> <span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">46</span> <span class="n">worker1</span><span class="o">.</span><span class="n">sqa</span><span class="o">.</span><span class="n">ztt</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">92407</span><span class="p">]:</span> <span class="n">F0725</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mf">46.988391</span>   <span class="mi">92407</span> <span class="n">server</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">273</span><span class="p">]</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">run</span> <span class="n">Kubelet</span><span class="p">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">get</span> <span class="n">the</span> <span class="n">kubelet</span><span class="s1">&#39;s cgroup: cpu and memory cgroup hierarchy not unified.  cpu: /, memory: /system.slice/kubelet.service</span>
<span class="n">Jul</span> <span class="mi">25</span> <span class="mi">09</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">46</span> <span class="n">worker1</span><span class="o">.</span><span class="n">sqa</span><span class="o">.</span><span class="n">ztt</span> <span class="n">systemd</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">service</span><span class="p">:</span> <span class="n">main</span> <span class="n">process</span> <span class="n">exited</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">exited</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">255</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="n">a</span>
</pre></div>
</div>
</li>
</ul>
<p>这里提示 cpu 和 memory 的 cgroup层次结构不统一。从 CentOS 来看 <code class="docutils literal notranslate"><span class="pre">/sys/fs/cgroup</span></code> 目录下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">18</span> <span class="n">Jul</span> <span class="mi">24</span> <span class="mi">01</span><span class="p">:</span><span class="mi">02</span> <span class="n">cpu</span> <span class="o">-&gt;</span> <span class="n">cpuset</span><span class="p">,</span><span class="n">cpu</span><span class="p">,</span><span class="n">cpuacct</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">18</span> <span class="n">Jul</span> <span class="mi">24</span> <span class="mi">01</span><span class="p">:</span><span class="mi">02</span> <span class="n">cpuacct</span> <span class="o">-&gt;</span> <span class="n">cpuset</span><span class="p">,</span><span class="n">cpu</span><span class="p">,</span><span class="n">cpuacct</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">18</span> <span class="n">Jul</span> <span class="mi">24</span> <span class="mi">01</span><span class="p">:</span><span class="mi">02</span> <span class="n">cpuset</span> <span class="o">-&gt;</span> <span class="n">cpuset</span><span class="p">,</span><span class="n">cpu</span><span class="p">,</span><span class="n">cpuacct</span>
<span class="o">...</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">5</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">0</span> <span class="n">Jul</span> <span class="mi">24</span> <span class="mi">01</span><span class="p">:</span><span class="mi">02</span> <span class="n">memory</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">参考 <a class="reference external" href="https://stupefied-goodall-e282f7.netlify.com/contributors/design-proposals/node/kubelet-systemd/">社区设计文档：design-proposals &gt; kubelet-systemd</a>  和 <a class="reference external" href="https://www.lijiaocn.com/%E9%97%AE%E9%A2%98/2019/01/25/kubernetes-failed-to-get-cgroup-stats.html">Kubernetes问题调查：failed to get cgroup stats for /systemd/system.slice</a> 思路排查。</p>
</div>
<p>在 <code class="docutils literal notranslate"><span class="pre">pkg/kubelet/cm/container_manager_linux.go</span></code> 中</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// getContainer returns the cgroup associated with the specified pid.</span>
<span class="c1">// It enforces a unified hierarchy for memory and cpu cgroups.</span>
<span class="c1">// On systemd environments, it uses the name=systemd cgroup for the specified pid.</span>
<span class="kd">func</span> <span class="nx">getContainer</span><span class="p">(</span><span class="nx">pid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">cgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nx">ParseCgroupFile</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;/proc/%d/cgroup&quot;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">))</span>
     <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
             <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">err</span>
     <span class="p">}</span>

     <span class="nx">cpu</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">cgs</span><span class="p">[</span><span class="s">&quot;cpu&quot;</span><span class="p">]</span>
     <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
             <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nx">NewNotFoundError</span><span class="p">(</span><span class="s">&quot;cpu&quot;</span><span class="p">)</span>
     <span class="p">}</span>
     <span class="nx">memory</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">cgs</span><span class="p">[</span><span class="s">&quot;memory&quot;</span><span class="p">]</span>
     <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
             <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nx">NewNotFoundError</span><span class="p">(</span><span class="s">&quot;memory&quot;</span><span class="p">)</span>
     <span class="p">}</span>

     <span class="c1">// since we use this container for accounting, we need to ensure its a unified hierarchy.</span>
     <span class="k">if</span> <span class="nx">cpu</span> <span class="o">!=</span> <span class="nx">memory</span> <span class="p">{</span>
             <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;cpu and memory cgroup hierarchy not unified.  cpu: %s, memory: %s&quot;</span><span class="p">,</span> <span class="nx">cpu</span><span class="p">,</span> <span class="nx">memory</span><span class="p">)</span>
     <span class="p">}</span>

     <span class="c1">// on systemd, every pid is in a unified cgroup hierarchy (name=systemd as seen in systemd-cgls)</span>
     <span class="c1">// cpu and memory accounting is off by default, users may choose to enable it per unit or globally.</span>
     <span class="c1">// users could enable CPU and memory accounting globally via /etc/systemd/system.conf (DefaultCPUAccounting=true DefaultMemoryAccounting=true).</span>
     <span class="c1">// users could also enable CPU and memory accounting per unit via CPUAccounting=true and MemoryAccounting=true</span>
     <span class="c1">// we only warn if accounting is not enabled for CPU or memory so as to not break local development flows where kubelet is launched in a terminal.</span>
     <span class="c1">// for example, the cgroup for the user session will be something like /user.slice/user-X.slice/session-X.scope, but the cpu and memory</span>
     <span class="c1">// cgroup will be the closest ancestor where accounting is performed (most likely /) on systems that launch docker containers.</span>
     <span class="c1">// as a result, on those systems, you will not get cpu or memory accounting statistics for kubelet.</span>
     <span class="c1">// in addition, you would not get memory or cpu accounting for the runtime unless accounting was enabled on its unit (or globally).</span>
     <span class="k">if</span> <span class="nx">systemd</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">cgs</span><span class="p">[</span><span class="s">&quot;name=systemd&quot;</span><span class="p">];</span> <span class="nx">found</span> <span class="p">{</span>
             <span class="k">if</span> <span class="nx">systemd</span> <span class="o">!=</span> <span class="nx">cpu</span> <span class="p">{</span>
                     <span class="nx">klog</span><span class="p">.</span><span class="nx">Warningf</span><span class="p">(</span><span class="s">&quot;CPUAccounting not enabled for pid: %d&quot;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
             <span class="p">}</span>
             <span class="k">if</span> <span class="nx">systemd</span> <span class="o">!=</span> <span class="nx">memory</span> <span class="p">{</span>
                     <span class="nx">klog</span><span class="p">.</span><span class="nx">Warningf</span><span class="p">(</span><span class="s">&quot;MemoryAccounting not enabled for pid: %d&quot;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
             <span class="p">}</span>
             <span class="k">return</span> <span class="nx">systemd</span><span class="p">,</span> <span class="kc">nil</span>
     <span class="p">}</span>

     <span class="k">return</span> <span class="nx">cpu</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</div>
<p>从上述代码分析，如果使用 <code class="docutils literal notranslate"><span class="pre">systemd</span></code> 来管理cgroup，每个pid都有一个唯一cgroup树结构。默认情况下，cpu和memory记账是关闭的，可以通过针对每个单元或者全局启用。例如全局启用，则修改 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DefaultCPUAccounting</span><span class="o">=</span><span class="n">true</span>
<span class="n">DefaultMemoryAccounting</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>如果针对某个应用，例如 kubelet ，则配置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CPUAccounting</span><span class="o">=</span><span class="n">true</span>
<span class="n">MemoryAccounting</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>上述cgroup记账功能不影响kubelet运行，但是启动时会WARNING。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>参考 <a class="reference external" href="https://github.com/kontena/pharos-cluster/issues/440">CentOS kubelet complains about systemd slices #440</a> :</p>
<p>The correct fix for this issue is to configure systemd to create the desired per-service CPU/Memory cgroups for the kubelet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">CPUAccounting</span><span class="o">=</span><span class="n">true</span>
<span class="n">MemoryAccounting</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>这个建议参考 <a class="reference external" href="https://github.com/kubernetes/kops/issues/4049">Kubelet ‘failed to get cgroup stats for “/system.slice/kubelet.service”’ error messages #4049</a> 是修订 <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/kubelet.service.d/11-cgroups.conf</span></code></p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">CPUAccounting</span><span class="o">=</span><span class="n">true</span>
<span class="n">MemoryAccounting</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
</div>
<p>如果cpu的cgroup hierarchy 和 memory的cgroup hierarchy 不一致，则报错退出。</p>
<p>验证可以检查任何一个系统进程 <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/proc/&lt;pid&gt;/cgroup</span></code> 都可以看到 cpu 和 memory 的cgroup hierarchy不同:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cat /proc/46006/cgroup</span>
<span class="o">...</span>
<span class="mi">9</span><span class="p">:</span><span class="n">memory</span><span class="p">:</span><span class="o">/</span><span class="n">system</span><span class="o">.</span><span class="n">slice</span><span class="o">/</span><span class="n">sshd</span><span class="o">.</span><span class="n">service</span>
<span class="o">...</span>
<span class="mi">5</span><span class="p">:</span><span class="n">cpuacct</span><span class="p">,</span><span class="n">cpu</span><span class="p">,</span><span class="n">cpuset</span><span class="p">:</span><span class="o">/</span>
<span class="o">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="https://lwn.net/Articles/601923/">unified-hierarchy</a> 是下一代cgrooup v2接口的特性，请参考 <a class="reference external" href="https://qconlondon.com/system/files/presentation-slides/cgroupv2-qcon.pdf">cgroupv2: Linux’s new unified control group system</a> 介绍。目前看，内核 4.6以上结合systemd v226以上能够实现这个特性。</p>
</div>
</div>
<div class="section" id="id7">
<h2>参考<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Installing kubeadm</a></li>
<li><a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/">Troubleshooting kubeadm</a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="single_master_k8s.html" class="btn btn-neutral float-right" title="创建单一控制平面(单master)集群" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Kubernetes集群引导" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../../../copyright.html">Copyright</a> 2019, Huatai Huang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>