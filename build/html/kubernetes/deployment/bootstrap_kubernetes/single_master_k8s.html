

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>创建单一控制平面(单master)集群 &mdash; Cloud Atlas 0.1 文档</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../copyright.html" />
    <link rel="next" title="修改Kubernetes Master IP" href="change_master_ip.html" />
    <link rel="prev" title="kubeadm" href="kubeadm.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Kubernetes Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../kubernetes_overview.html">Kubernetes概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup_prepare/index.html">Kubernetes起步准备</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup/index.html">Kubernetes快速起步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html">Kubernetes概念辨析</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Kubernetes部署</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../k8s_hosts.html">Kubernetes部署服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../container_runtimes.html">容器运行环境</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Kubernetes集群引导</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="kubeadm.html">kubeadm</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">创建单一控制平面(单master)集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="change_master_ip.html">修改Kubernetes Master IP</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s.html">高可用(HA)Kubernetes集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s_lb/index.html">基于负载均衡的高可用Kubernetes集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s_dnsrr/index.html">基于DNSRR的高可用Kubernetes集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="create_ha_k8s.html">使用kubeadm创建高可用集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s_stacked.html">堆叠型管控/etcd节点高可用集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_etcd.html">高可用etcd集群部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="ha_k8s_external.html">扩展etcd节点高可用集群</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../stateless_application/index.html">Kubernetes部署无状态应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operator/index.html">Kubernetes应用部署方法Operator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../etcd/index.html">部署etcd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nginx_ingress.html">部署Nginx Ingress Controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../docker_registry.html">在Kubernetes中部署私有Docker镜像仓库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../helm.html">Helm - Kubernetes包管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../draft.html">Draft - Kubernetes应用部署工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kustomize.html">kustomize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kuberbuilder.html">Kubebuilder</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../manage_object/index.html">Kubernetes管理对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../administer/index.html">Kubernetes管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../access_application/index.html">Kubernetes访问应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configure/index.html">Kubernetes 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/index.html">Kubernetes网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../in_action/index.html">Kubernetes实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rook/index.html">Rook - 云原生存储调度器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../production/index.html">Kubernetes生产环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../service_mesh/index.html">Service Mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../istio/index.html">Istio服务网格</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../serverless/index.html">Kubernetes Severless</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ci_cd/index.html">Kubernetes持续集成和持续部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../monitor/index.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../self_healing/index.html">Kubernetes 自愈</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debug/index.html">Kubernetes排查</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../knative/index.html">Knative - Serverless计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">Kubernetes安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtual/index.html">Kubernetes结合虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arm/index.html">ARM架构Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cloud/index.html">Kubernetes云厂商</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../develop/index.html">Kubernetes开发</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Kubernetes Atlas</a> &raquo;</li>
        
          <li><a href="../index.html">Kubernetes部署</a> &raquo;</li>
        
          <li><a href="index.html">Kubernetes集群引导</a> &raquo;</li>
        
      <li>创建单一控制平面(单master)集群</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/kubernetes/deployment/bootstrap_kubernetes/single_master_k8s.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="master">
<span id="single-master-k8s"></span><h1>创建单一控制平面(单master)集群<a class="headerlink" href="#master" title="永久链接至标题">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>请注意本章节是部署单个Master节点方法，仅适合测试环境。生产环境需要部署高可用集群，请参考 <a class="reference internal" href="ha_k8s.html#ha-k8s"><span class="std std-ref">高可用(HA)Kubernetes集群</span></a> 架构，并直接按照 <a class="reference internal" href="ha_k8s_stacked.html#ha-k8s-stacked"><span class="std std-ref">堆叠型管控/etcd节点高可用集群</span></a> 或 <a class="reference internal" href="ha_k8s_external.html#ha-k8s-external"><span class="std std-ref">扩展etcd节点高可用集群</span></a> 部署步骤直接部署，不用执行本章节操作步骤。</p>
</div>
<div class="section" id="control-plane-node">
<h2>初始化控制平面节点(control-plane node)<a class="headerlink" href="#control-plane-node" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>本段落为背景说明，实际操作命令只需要执行下一段落 <a class="reference internal" href="#kubeadm-init"><span class="std std-ref">初始化命令执行</span></a></p>
</div>
<p>管控平面节点(control-plane node)是指控制平面组件运行的主机节点，包括 <code class="docutils literal notranslate"><span class="pre">etcd</span></code> (集群数据库) 和 API 服务器(kubectl命令行工具通讯的服务器组件)。</p>
<ul class="simple">
<li><p>规划并选择一个pod network add-on，请注意所选择CNI是否需要的任何参数传递给kubeadm初始化</p></li>
</ul>
<p>我这里选择 Flannel 作为CNI，以便采用精简的网络配置和获得较好的性能。根据Flannel CNI的安装要求，是需要想 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 传递参数 <code class="docutils literal notranslate"><span class="pre">--pod-network-cidr=10.244.0.0/16</span></code> 。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>必须安装一个 pod network add-on 这样你的pod才能彼此通讯。</p>
<p>在部署任何应用程序之前需要部署网络，并且网络安装之前不能启动 CoreDNS。 kubeadm 只支持 Container Network Interface (CNI) 网络(并且不支持kubenet)。</p>
<p>由于有多种CNI容器网络接口，对比选择很重要，可以参考 <a class="reference external" href="https://chrislovecnm.com/kubernetes/cni/choosing-a-cni-provider/">Choosing a CNI Network Provider for Kubernetes</a> 和 <a class="reference external" href="https://feisky.gitbooks.io/kubernetes/network/network.html">Kubernetes 网络模型</a></p>
<p><a class="reference external" href="https://tonybai.com/2019/04/18/benchmark-result-of-k8s-network-plugin-cni/">Kubernetes网络插件（CNI）基准测试的最新结果</a> 一文对比测试了不同CNI的性能、易用性和高级加密特性，推荐如下:</p>
<ul class="simple">
<li><p>服务器硬件资源有限并且不需要安全功能，推荐 Flannel ：最精简和易用的CNI，兼容x86和ARM，自动检测MTU，无需配置。</p></li>
<li><p>如果需要加密网络则使用WeaveNet，但是徐亚注意MTU设置，并且性能较差（加密的代价）</p></li>
<li><p>其他常用场景推荐 Calico ，是广泛用于Kubernetes部署工具(Kops, Kubespray, Rancher等)的CNI，在资源消耗、性能和安全性有较好平衡。需要注意ConfigMap中设置MTU以适配巨型帧。</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>kubeadm默认设置了一个较为安全的集群并且使用 RBAC ，所以需要确保你选择的网络框架支持 RBAC 。</p>
<p>使用的 Pod network 必须不覆盖任何主机网络，否则会导致故障。如果你发现网络插件的Pod neetowrk和物理主机网络冲突，则需要选择合适的CIDR，并且采用 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 的 <code class="docutils literal notranslate"><span class="pre">--pod-network-cidr</span></code> 来指定</p>
</div>
<ul class="simple">
<li><p>(可选)从v1.14开始，kubeadm可以自动检测Linux所使用的container runtime。如果使用不同的container runtime，则指定 <code class="docutils literal notranslate"><span class="pre">--cri-socket</span></code> 参数传递给 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code></p></li>
<li><p>(可选)除非指定，否则kubeadm将使用默认网关相关的网络接口来公告master的IP。如果要使用不同的网络接口，则传递 <code class="docutils literal notranslate"><span class="pre">--apiserver-advertise-address=&lt;ip-address&gt;</span></code> 参数给 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code></p></li>
<li><p>(可选)可运行 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">config</span> <span class="pre">images</span> <span class="pre">pull</span></code> 使得 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 验证到 <code class="docutils literal notranslate"><span class="pre">gcr.io</span></code> 仓库的网络连接</p></li>
</ul>
<div class="section" id="kubeadm-init">
<span id="id1"></span><h3>初始化命令执行<a class="headerlink" href="#kubeadm-init" title="永久链接至标题">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>部署Kubernetes的服务需要能够解析所安装服务器的域名，通常这个工作由DNS来提供，建议在局域网内部部署一个DNSmasq服务。在初始阶段，也可以在每个主机上部署 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 提供静态地址解析（例如，我在Host物理主机上的 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> 就包含了这个测试集群所有主机的域名解析，可以分发到各个虚拟机上提供基本解析）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pscp</span><span class="o">.</span><span class="n">pssh</span> <span class="o">-</span><span class="n">h</span> <span class="n">kube</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hosts</span>
<span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s1">&#39;sudo cp /tmp/hosts /etc/hosts&#39;</span>
</pre></div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">cidr</span><span class="o">=</span><span class="mf">10.244</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">16</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>上述 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 要求主机已经正确安装了kubelet，否则会出现报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">check</span><span class="p">]</span> <span class="n">It</span> <span class="n">seems</span> <span class="n">like</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">isn</span><span class="s1">&#39;t running or healthy.</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">check</span><span class="p">]</span> <span class="n">The</span> <span class="n">HTTP</span> <span class="n">call</span> <span class="n">equal</span> <span class="n">to</span> <span class="s1">&#39;curl -sSL http://localhost:10248/healthz&#39;</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">error</span><span class="p">:</span> <span class="n">Get</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">10248</span><span class="o">/</span><span class="n">healthz</span><span class="p">:</span> <span class="n">dial</span> <span class="n">tcp</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">10248</span><span class="p">:</span> <span class="n">connect</span><span class="p">:</span> <span class="n">connection</span> <span class="n">refused</span><span class="o">.</span>

<span class="n">Unfortunately</span><span class="p">,</span> <span class="n">an</span> <span class="n">error</span> <span class="n">has</span> <span class="n">occurred</span><span class="p">:</span>
        <span class="n">timed</span> <span class="n">out</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">condition</span>
</pre></div>
</div>
<p>可通过以下方法检查 <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 问题:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">status</span> <span class="n">kubelet</span>
<span class="n">journalctl</span> <span class="o">-</span><span class="n">xeu</span> <span class="n">kubelet</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>集群初始化过程<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>在执行了 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 指令之后，可以看到执行了一系列操作</p>
<ul>
<li><p>下载镜像:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">preflight</span><span class="p">]</span> <span class="n">Pulling</span> <span class="n">images</span> <span class="n">required</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">a</span> <span class="n">Kubernetes</span> <span class="n">cluster</span>
<span class="o">...</span>
<span class="p">[</span><span class="n">preflight</span><span class="p">]</span> <span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">perform</span> <span class="n">this</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">beforehand</span> <span class="n">using</span> <span class="s1">&#39;kubeadm config images pull&#39;</span>
</pre></div>
</div>
</li>
<li><p>kubeadm会把kubelet运行环境写入配置文件，然后启动 <code class="docutils literal notranslate"><span class="pre">kubelet</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">environment</span> <span class="n">file</span> <span class="k">with</span> <span class="n">flags</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">start</span><span class="p">]</span> <span class="n">Writing</span> <span class="n">kubelet</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">file</span> <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">start</span><span class="p">]</span> <span class="n">Activating</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">service</span>
</pre></div>
</div>
</li>
<li><p>创建Kubernetes证书:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Using</span> <span class="n">certificateDir</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/pki&quot;</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-ca&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;front-proxy-client&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/ca&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/server&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">etcd</span><span class="o">/</span><span class="n">server</span> <span class="n">serving</span> <span class="n">cert</span> <span class="ow">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span> <span class="n">localhost</span><span class="p">]</span> <span class="ow">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/peer&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">etcd</span><span class="o">/</span><span class="n">peer</span> <span class="n">serving</span> <span class="n">cert</span> <span class="ow">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span> <span class="n">localhost</span><span class="p">]</span> <span class="ow">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="p">::</span><span class="mi">1</span><span class="p">]</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;etcd/healthcheck-client&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-etcd-client&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;ca&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver-kubelet-client&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;apiserver&quot;</span> <span class="n">certificate</span> <span class="ow">and</span> <span class="n">key</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">apiserver</span> <span class="n">serving</span> <span class="n">cert</span> <span class="ow">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubernetes</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">]</span> <span class="ow">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="mf">10.96</span><span class="o">.</span><span class="mf">0.1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span><span class="p">]</span>
<span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">Generating</span> <span class="s2">&quot;sa&quot;</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">public</span> <span class="n">key</span>
</pre></div>
</div>
</li>
<li><p>创建Kubernetes配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">kubeconfig</span><span class="p">]</span> <span class="n">Using</span> <span class="n">kubeconfig</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes&quot;</span>
<span class="p">[</span><span class="n">kubeconfig</span><span class="p">]</span> <span class="n">Writing</span> <span class="s2">&quot;admin.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="p">[</span><span class="n">kubeconfig</span><span class="p">]</span> <span class="n">Writing</span> <span class="s2">&quot;kubelet.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="p">[</span><span class="n">kubeconfig</span><span class="p">]</span> <span class="n">Writing</span> <span class="s2">&quot;controller-manager.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
<span class="p">[</span><span class="n">kubeconfig</span><span class="p">]</span> <span class="n">Writing</span> <span class="s2">&quot;scheduler.conf&quot;</span> <span class="n">kubeconfig</span> <span class="n">file</span>
</pre></div>
</div>
</li>
<li><p>启动Kubernetes control plane控制平面(管控三大件):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Using</span> <span class="n">manifest</span> <span class="n">folder</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-apiserver&quot;</span>
<span class="p">[</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-controller-manager&quot;</span>
<span class="p">[</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="s2">&quot;kube-scheduler&quot;</span>
</pre></div>
</div>
</li>
<li><p>创建etcd，然后等待control plane的三大组件正常运行(需要依赖etcd服务):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">etcd</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">static</span> <span class="n">Pod</span> <span class="n">manifest</span> <span class="k">for</span> <span class="n">local</span> <span class="n">etcd</span> <span class="ow">in</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="p">[</span><span class="n">wait</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">to</span> <span class="n">boot</span> <span class="n">up</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="k">as</span> <span class="n">static</span> <span class="n">Pods</span> <span class="kn">from</span> <span class="nn">directory</span> <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span><span class="o">.</span> <span class="n">This</span> <span class="n">can</span> <span class="n">take</span> <span class="n">up</span> <span class="n">to</span> <span class="mi">4</span><span class="n">m0s</span>
<span class="p">[</span><span class="n">apiclient</span><span class="p">]</span> <span class="n">All</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">components</span> <span class="n">are</span> <span class="n">healthy</span> <span class="n">after</span> <span class="mf">23.506119</span> <span class="n">seconds</span>
</pre></div>
</div>
</li>
<li><p>在集群的 <code class="docutils literal notranslate"><span class="pre">kube-system</span></code> 名字空间存储 <code class="docutils literal notranslate"><span class="pre">kubeadm-config</span></code> 配置映射:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">upload</span><span class="o">-</span><span class="n">config</span><span class="p">]</span> <span class="n">Storing</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubeadm-config&quot;</span> <span class="ow">in</span> <span class="n">the</span> <span class="s2">&quot;kube-system&quot;</span> <span class="n">Namespace</span>
</pre></div>
</div>
</li>
<li><p>同样客户端kubelet的配置映射也需要存储到 <code class="docutils literal notranslate"><span class="pre">kube-system</span></code> 中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">kubelet</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">a</span> <span class="n">ConfigMap</span> <span class="s2">&quot;kubelet-config-1.15&quot;</span> <span class="ow">in</span> <span class="n">namespace</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="k">with</span> <span class="n">the</span> <span class="n">configuration</span> <span class="k">for</span> <span class="n">the</span> <span class="n">kubelets</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">cluster</span>
</pre></div>
</div>
</li>
<li><p>跳过了上传certs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">upload</span><span class="o">-</span><span class="n">certs</span><span class="p">]</span> <span class="n">Skipping</span> <span class="n">phase</span><span class="o">.</span> <span class="n">Please</span> <span class="n">see</span> <span class="o">--</span><span class="n">upload</span><span class="o">-</span><span class="n">certs</span>
</pre></div>
</div>
</li>
<li><p>由于control plane已经就绪，现在把第一个master节点 <code class="docutils literal notranslate"><span class="pre">kubemaster-1</span></code> 标记为master节点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">mark</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span> <span class="k">as</span> <span class="n">control</span><span class="o">-</span><span class="n">plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">label</span> <span class="s2">&quot;node-role.kubernetes.io/master=&#39;&#39;&quot;</span>
<span class="p">[</span><span class="n">mark</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="p">]</span> <span class="n">Marking</span> <span class="n">the</span> <span class="n">node</span> <span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span> <span class="k">as</span> <span class="n">control</span><span class="o">-</span><span class="n">plane</span> <span class="n">by</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">taints</span> <span class="p">[</span><span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="p">:</span><span class="n">NoSchedule</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>配置集群的RBAC角色:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">token</span><span class="p">]</span> <span class="n">Using</span> <span class="n">token</span><span class="p">:</span> <span class="n">fm9k1o</span><span class="o">.</span><span class="n">vhxmun0sriombljn</span>
<span class="p">[</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">token</span><span class="p">]</span> <span class="n">Configuring</span> <span class="n">bootstrap</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span> <span class="n">ConfigMap</span><span class="p">,</span> <span class="n">RBAC</span> <span class="n">Roles</span>
<span class="p">[</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">tokens</span> <span class="n">to</span> <span class="n">post</span> <span class="n">CSRs</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">for</span> <span class="n">nodes</span> <span class="n">to</span> <span class="n">get</span> <span class="n">long</span> <span class="n">term</span> <span class="n">certificate</span> <span class="n">credentials</span>
<span class="p">[</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">the</span> <span class="n">csrapprover</span> <span class="n">controller</span> <span class="n">automatically</span> <span class="n">approve</span> <span class="n">CSRs</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">Node</span> <span class="n">Bootstrap</span> <span class="n">Token</span>
<span class="p">[</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">token</span><span class="p">]</span> <span class="n">configured</span> <span class="n">RBAC</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">certificate</span> <span class="n">rotation</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">node</span> <span class="n">client</span> <span class="n">certificates</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">cluster</span>
<span class="p">[</span><span class="n">bootstrap</span><span class="o">-</span><span class="n">token</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">the</span> <span class="s2">&quot;cluster-info&quot;</span> <span class="n">ConfigMap</span> <span class="ow">in</span> <span class="n">the</span> <span class="s2">&quot;kube-public&quot;</span> <span class="n">namespace</span>
</pre></div>
</div>
</li>
<li><p>最后执行基础addon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">addons</span><span class="p">]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">CoreDNS</span>
<span class="p">[</span><span class="n">addons</span><span class="p">]</span> <span class="n">Applied</span> <span class="n">essential</span> <span class="n">addon</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>
</pre></div>
</div>
</li>
<li><p>最后提示Kubernetes control plane初始化成功:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join &lt;master-ip&gt;:&lt;master-port&gt; --token &lt;token&gt; \
    --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>请注意，上述 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 输出信息是我在测试虚拟机集群的演示输出，隐去了token信息。</p>
<p><strong>警告！</strong> 这里输出的token信息和安全紧密相关，请勿将token信息泄漏。否则获得token的任何人都可以在集群添加授权节点，并且可以展示，创建和删除节点。</p>
</div>
</div>
<div class="section" id="id3">
<h3>准备管理员工作环境<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span></code> 可以用非root用户身份执行，即按照上述 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 输出准备管理员工作环境:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</pre></div>
</div>
<p>当然，如果你使用 <code class="docutils literal notranslate"><span class="pre">root</span></code> 用户身份就可以直接访问Kubernetes管理配置文件，就只需要设置环境变量:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">KUBECONFIG</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pod">
<h2>安装Pod网络插件<a class="headerlink" href="#pod" title="永久链接至标题">¶</a></h2>
<p>在Kubernetes集群中，必须安装一个po network add-on 才能使得pods彼此通讯。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>必须在所有应用部署之前部署好网络。并且，CoreDNS只有在网络安装以后才能启动。Kubeadm只支持基于容器网络接口(Container Network Interface, CNI)的网络（并且不支持kubenet）。</p>
</div>
<p>注意，kubeadm设置了一个默认较为安全的集群并且增强使用RBAC，所以需要确保你选择的网络框架支持RBAC。</p>
<p>并且需要注意的是，Pod network必须不覆盖任何主机网络(host network)，否则会导致问题。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>上文我参考 <a class="reference external" href="https://tonybai.com/2019/04/18/benchmark-result-of-k8s-network-plugin-cni/">Kubernetes网络插件（CNI）基准测试的最新结果</a> 一文选择了 Flannel 网络，所以这里记录的是安装 Flannel 网络插件的实践记录。</p>
</div>
<ul>
<li><p>安装 Flannel 网络插件之前，请先检查以下设置必须是 1 ，这可以是的IPv4流量被传递给iptables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">bridge</span><span class="o">/</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">iptables</span>
</pre></div>
</div>
</li>
</ul>
<p>如果值不是1，则执行 <code class="docutils literal notranslate"><span class="pre">sysctl</span> <span class="pre">net.bridge.bridge-nf-call-iptables=1</span></code> 修改，并参考前文设置内核sysctl。</p>
<ul class="simple">
<li><p>允许报所有主机的网络允许 UDP端口 8285 到 8472 流量</p></li>
</ul>
<p>由于我采用CentOS 7操作系统，需要设置 firewalld ，方法如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">8285</span><span class="o">-</span><span class="mi">8472</span><span class="o">/</span><span class="n">udp</span> <span class="o">--</span><span class="n">permanent</span>
</pre></div>
</div>
<p>对于我在 <a class="reference internal" href="../k8s_hosts.html#k8s-hosts"><span class="std std-ref">Kubernetes部署服务器</span></a> 使用pssh，则执行命令如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pssh</span> <span class="o">-</span><span class="n">ih</span> <span class="n">kube</span> <span class="s1">&#39;sudo firewall-cmd --zone=public --add-port=8285-8472/udp --permanent&#39;</span>
</pre></div>
</div>
<ul>
<li><p>安装套件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">coreos</span><span class="o">/</span><span class="n">flannel</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">Documentation</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</li>
</ul>
<p>输出提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">podsecuritypolicy</span><span class="o">.</span><span class="n">policy</span><span class="o">/</span><span class="n">psp</span><span class="o">.</span><span class="n">flannel</span><span class="o">.</span><span class="n">unprivileged</span> <span class="n">created</span>
<span class="n">clusterrole</span><span class="o">.</span><span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">clusterrolebinding</span><span class="o">.</span><span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">serviceaccount</span><span class="o">/</span><span class="n">flannel</span> <span class="n">created</span>
<span class="n">configmap</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">cfg</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">amd64</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">arm64</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">arm</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">ppc64le</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">s390x</span> <span class="n">created</span>
</pre></div>
</div>
<p>一旦安装网络成功，可以通过检查 CoreDNS pod是否运行来确认:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span>
</pre></div>
</div>
<div class="section" id="kube-flannel-pod">
<h3>kube-flannel pod无法启动排查<a class="headerlink" href="#kube-flannel-pod" title="永久链接至标题">¶</a></h3>
<p>执行安装了 kube-flannel 之后，遇到coredns的pod始终创建中的问题:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAMESPACE</span>     <span class="n">NAME</span>                                   <span class="n">READY</span>   <span class="n">STATUS</span>              <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>   <span class="n">coredns</span><span class="o">-</span><span class="mi">5</span><span class="n">c98db65d4</span><span class="o">-</span><span class="n">shg69</span>               <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>   <span class="n">coredns</span><span class="o">-</span><span class="mi">5</span><span class="n">c98db65d4</span><span class="o">-</span><span class="n">x5lz4</span>               <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>
</pre></div>
</div>
<p>检查节点无法running原因:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">coredns</span><span class="o">-</span><span class="mi">5</span><span class="n">c98db65d4</span><span class="o">-</span><span class="n">shg69</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
<p>错误原因如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ne">Warning</span>  <span class="n">FailedCreatePodSandBox</span>  <span class="mi">2</span><span class="n">m41s</span> <span class="p">(</span><span class="n">x12436</span> <span class="n">over</span> <span class="mi">8</span><span class="n">h</span><span class="p">)</span>  <span class="n">kubelet</span><span class="p">,</span> <span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span>  <span class="p">(</span><span class="n">combined</span> <span class="kn">from</span> <span class="nn">similar</span> <span class="n">events</span><span class="p">):</span> <span class="n">Failed</span> <span class="n">create</span> <span class="n">pod</span> <span class="n">sandbox</span><span class="p">:</span> <span class="n">rpc</span> <span class="n">error</span><span class="p">:</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Unknown</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">failed</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">sandbox</span> <span class="n">container</span> <span class="s2">&quot;f1dbd3dc5c66b15165ec2d183d75a5c50deb4d642bf00b55d161cc081f3d779b&quot;</span> <span class="n">network</span> <span class="k">for</span> <span class="n">pod</span> <span class="s2">&quot;coredns-5c98db65d4-shg69&quot;</span><span class="p">:</span> <span class="n">NetworkPlugin</span> <span class="n">cni</span> <span class="n">failed</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">pod</span> <span class="s2">&quot;coredns-5c98db65d4-shg69_kube-system&quot;</span> <span class="n">network</span><span class="p">:</span> <span class="nb">open</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">flannel</span><span class="o">/</span><span class="n">subnet</span><span class="o">.</span><span class="n">env</span><span class="p">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</pre></div>
</div>
<p>检查发现 <code class="docutils literal notranslate"><span class="pre">kube-flannel</span></code> 不断出现Crash现象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kube</span><span class="o">-</span><span class="n">system</span>   <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">amd64</span><span class="o">-</span><span class="n">vv6pv</span>            <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">CrashLoopBackOff</span>    <span class="mi">96</span>         <span class="mi">8</span><span class="n">h</span>
</pre></div>
</div>
<p>但是 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">describe</span> <span class="pre">pod</span> <span class="pre">kube-flannel-ds-amd64-vv6pv</span> <span class="pre">-n</span> <span class="pre">kube-system</span></code> 仅显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ne">Warning</span>  <span class="n">BackOff</span>  <span class="mi">72</span><span class="n">s</span> <span class="p">(</span><span class="n">x2169</span> <span class="n">over</span> <span class="mi">8</span><span class="n">h</span><span class="p">)</span>  <span class="n">kubelet</span><span class="p">,</span> <span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span>  <span class="n">Back</span><span class="o">-</span><span class="n">off</span> <span class="n">restarting</span> <span class="n">failed</span> <span class="n">container</span>
</pre></div>
</div>
<p>检查pod kube-flannel-ds-amd64-vv6pv日志:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">logs</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">amd64</span><span class="o">-</span><span class="n">vv6pv</span>
</pre></div>
</div>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E0802</span> <span class="mi">02</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">32.961097</span>       <span class="mi">1</span> <span class="n">main</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">241</span><span class="p">]</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">create</span> <span class="n">SubnetManager</span><span class="p">:</span> <span class="n">error</span> <span class="n">retrieving</span> <span class="n">pod</span> <span class="n">spec</span> <span class="k">for</span> <span class="s1">&#39;kube-system/kube-flannel-ds-amd64-vv6pv&#39;</span><span class="p">:</span> <span class="n">Get</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">10.96</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">443</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">pods</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">amd64</span><span class="o">-</span><span class="n">vv6pv</span><span class="p">:</span> <span class="n">dial</span> <span class="n">tcp</span> <span class="mf">10.96</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">443</span><span class="p">:</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span> <span class="n">timeout</span>
</pre></div>
</div>
<p>我比较疑惑，为何需要访问 <code class="docutils literal notranslate"><span class="pre">https://10.96.0.1:443</span></code> ，想到最初初始化阶段 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 确实输出有提示创建接口:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">single_master_k8s</span><span class="o">.</span><span class="n">rst</span><span class="p">:</span>   <span class="p">[</span><span class="n">certs</span><span class="p">]</span> <span class="n">apiserver</span> <span class="n">serving</span> <span class="n">cert</span> <span class="ow">is</span> <span class="n">signed</span> <span class="k">for</span> <span class="n">DNS</span> <span class="n">names</span> <span class="p">[</span><span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubernetes</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">]</span> <span class="ow">and</span> <span class="n">IPs</span> <span class="p">[</span><span class="mf">10.96</span><span class="o">.</span><span class="mf">0.1</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">101.81</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>IP <code class="docutils literal notranslate"><span class="pre">192.168.101.81</span></code> 是我在部署 Kubernetes 时启用了 <a class="reference internal" href="../../../linux/security/vpn/openconnect_vpn.html#openconnect-vpn"><span class="std std-ref">OpenConnect VPN</span></a> 使用的 <code class="docutils literal notranslate"><span class="pre">tun0</span></code> 接口上IP地址，在关闭VPN之后，我通过 <a class="reference internal" href="change_master_ip.html#change-master-ip"><span class="std std-ref">修改Kubernetes Master IP</span></a> 重新初始化了Kubernetes集群，所以 <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes</span></code> 配置目录中所有apiserver访问入口IP地址都修订为 <code class="docutils literal notranslate"><span class="pre">192.168.122.11</span></code> 。</p>
<p><code class="docutils literal notranslate"><span class="pre">10.96.0.1</span></code> 地址是kubernetes的内部集群IP地(在Kubernetes集群内部有一个服务CIRD网络，子网网段是 <code class="docutils literal notranslate"><span class="pre">10.96.0.0/12</span></code> ，分配的第一个地址就是 <code class="docutils literal notranslate"><span class="pre">10.96.0.1</span></code> ，这个地址是集群的Master服务求第一个IP)。这里访问端口 <code class="docutils literal notranslate"><span class="pre">443</span></code> 是Kubernetes的 <a class="reference internal" href="../../administer/kubernetes_dashboard.html#kubernetes-dashboard"><span class="std std-ref">Kubernetes仪表盘</span></a> 服务的端口。这说明在Kubernetes集群中缺少了Dashboard pod运行。</p>
</div>
<ul>
<li><p>创建Dashboard:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">dashboard</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mf">10.1</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">recommended</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</li>
</ul>
<p>此时发现新创建的Dashboard也是因为Flannel的网络插件无法启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span><span class="o">-</span><span class="mi">7</span><span class="n">d75c474bb</span><span class="o">-</span><span class="n">x5ntd</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ne">Warning</span>  <span class="n">FailedCreatePodSandBox</span>  <span class="mi">88</span><span class="n">s</span> <span class="p">(</span><span class="n">x4</span> <span class="n">over</span> <span class="mi">97</span><span class="n">s</span><span class="p">)</span>    <span class="n">kubelet</span><span class="p">,</span> <span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span>  <span class="p">(</span><span class="n">combined</span> <span class="kn">from</span> <span class="nn">similar</span> <span class="n">events</span><span class="p">):</span> <span class="n">Failed</span> <span class="n">create</span> <span class="n">pod</span> <span class="n">sandbox</span><span class="p">:</span> <span class="n">rpc</span> <span class="n">error</span><span class="p">:</span> <span class="n">code</span> <span class="o">=</span> <span class="n">Unknown</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">failed</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">sandbox</span> <span class="n">container</span> <span class="s2">&quot;7465e1499f916318d6079f25b5230a36d4c55d2ae2284bfd0cb2cf6d81d4bc18&quot;</span> <span class="n">network</span> <span class="k">for</span> <span class="n">pod</span> <span class="s2">&quot;kubernetes-dashboard-7d75c474bb-x5ntd&quot;</span><span class="p">:</span> <span class="n">NetworkPlugin</span> <span class="n">cni</span> <span class="n">failed</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">pod</span> <span class="s2">&quot;kubernetes-dashboard-7d75c474bb-x5ntd_kube-system&quot;</span> <span class="n">network</span><span class="p">:</span> <span class="nb">open</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">flannel</span><span class="o">/</span><span class="n">subnet</span><span class="o">.</span><span class="n">env</span><span class="p">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</pre></div>
</div>
<p>参考 <a class="reference external" href="https://github.com/kubernetes/kubernetes/issues/70202">Flannel (NetworkPlugin cni) error: /run/flannel/subnet.env: no such file or directory #70202</a> 和 <a class="reference external" href="https://www.jianshu.com/p/9819a9f5dda0">Kubernetes 报错：”open /run/flannel/subnet.env: no such file or directory”</a> ，看起来Node主机上缺少 <code class="docutils literal notranslate"><span class="pre">/run/flannel/subnet.env</span></code> ，有人建议可以手工创建该文件，内容如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FLANNEL_NETWORK</span><span class="o">=</span><span class="mf">10.244</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">16</span>
<span class="n">FLANNEL_SUBNET</span><span class="o">=</span><span class="mf">10.244</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">24</span>
<span class="n">FLANNEL_MTU</span><span class="o">=</span><span class="mi">1450</span>
<span class="n">FLANNEL_IPMASQ</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>但是我参考 <a class="reference external" href="https://github.com/kubernetes/kubernetes/issues/36575">kube-dns ContainerCreating /run/flannel/subnet.env no such file #36575</a> 其中提到了和我类似的情况 (修改过Master IP <a class="reference external" href="ChangingmasterIPaddress#338">Changing master IP address #338</a> ) 。我发现是我 <a class="reference internal" href="change_master_ip.html#change-master-ip"><span class="std std-ref">修改Kubernetes Master IP</span></a> 再次 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 时遗忘了传递参数 <code class="docutils literal notranslate"><span class="pre">--pod-network-cidr=10.244.0.0/16</span></code> 导致上述错误。</p>
<p>再次按照正确方法重新初始化，修复后就可以正常启动所有 pod</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods --all-namespaces
NAMESPACE     NAME                                    READY   STATUS    RESTARTS   AGE
kube-system   coredns-5c98db65d4-shg69                1/1     Running   51         28h
kube-system   coredns-5c98db65d4-x5lz4                1/1     Running   51         28h
kube-system   etcd-kubemaster-1                       1/1     Running   2          25h
kube-system   kube-apiserver-kubemaster-1             1/1     Running   3          27h
kube-system   kube-controller-manager-kubemaster-1    1/1     Running   0          4m11s
kube-system   kube-flannel-ds-amd64-vv6pv             1/1     Running   160        14h
kube-system   kube-proxy-qtbs9                        1/1     Running   2          28h
kube-system   kube-scheduler-kubemaster-1             1/1     Running   4          28h
kube-system   kubernetes-dashboard-7d75c474bb-x5ntd   1/1     Running   51         4h14m
</pre></div>
</div>
</div>
</div>
<div class="section" id="kubernetes-dashboard">
<h2>Kubernetes Dashboard<a class="headerlink" href="#kubernetes-dashboard" title="永久链接至标题">¶</a></h2>
<p>如上文所述，在KVM虚拟机 <a class="reference internal" href="../k8s_hosts.html#k8s-hosts"><span class="std std-ref">Kubernetes部署服务器</span></a> ，其虚拟机网络默认是NAT网络。所以对于远程访问虚拟机端口需要映射才行。对于Kubernetes集群，内部服务网络子网网段是 <code class="docutils literal notranslate"><span class="pre">10.96.0.0/12</span></code> ，需要使用 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">proxy</span></code> 建立代理才可以在外部访问。</p>
<p>综上所述，对于远程的管理主机桌面，如果要访问虚拟机集群组建的Kubernetes Dashboard，先采用ssh端口映射命令登陆到 <code class="docutils literal notranslate"><span class="pre">worker4</span></code> (上面运行KVM虚拟机)物理主机上，再从物理服务器到KVM虚拟机 <code class="docutils literal notranslate"><span class="pre">kubemaster-1</span></code> 的端口映射，再通过 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">proxy</span></code> 映射到Kubernetes集群内部Dashboard:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">L</span> <span class="mi">8001</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8001</span> <span class="n">worker4</span>
<span class="n">ssh</span> <span class="o">-</span><span class="n">L</span> <span class="mi">8001</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8001</span> <span class="n">kubemaster</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>登陆到 <code class="docutils literal notranslate"><span class="pre">kubemaster-1</span></code> 虚拟机之后，执行以下命令启用kubernetes代理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">proxy</span>
</pre></div>
</div>
<p>现在就可以在自己个人电脑上使用浏览器访问:  <a class="reference external" href="http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/http:kubernetes-dashboard:/proxy/">http://127.0.0.1:8001/api/v1/namespaces/kube-system/services/http:kubernetes-dashboard:/proxy/</a> 查看集群的Dashboard。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里还有一个页面报错提示待解决:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span><span class="p">:</span> <span class="s1">&#39;net/http: HTTP/1.x transport connection broken: malformed HTTP response &quot;</span><span class="se">\x15\x03\x01\x00\x02\x02</span><span class="s1">&quot;&#39;</span>
<span class="n">Trying</span> <span class="n">to</span> <span class="n">reach</span><span class="p">:</span> <span class="s1">&#39;http://10.244.0.7:8443/&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>管控平面节点隔离<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>默认情况下，由于安全原因，集群不会在管控平面节点(control-plane node)上调度pod(schedule pods)，即管控平面节点不会运行业务相关pod(调度器不会调度pod到管控服务器)。</p>
<p>如果你希望在管控平面节点上运行schedule pods，例如，作为开发工作使用的单主机Kubernetes集群，或者测试集群为了节约服务器资源，想让管控服务器也能够分担一部分业务pod，可以运行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="o">--</span><span class="nb">all</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>
</pre></div>
</div>
<p>此时输出类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="s2">&quot;test-01&quot;</span> <span class="n">untainted</span>
<span class="n">taint</span> <span class="s2">&quot;node-role.kubernetes.io/master:&quot;</span> <span class="ow">not</span> <span class="n">found</span>
<span class="n">taint</span> <span class="s2">&quot;node-role.kubernetes.io/master:&quot;</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p>上述命令将从集群的所有节点上移除 <code class="docutils literal notranslate"><span class="pre">node-role.kubernetes.io/master</span></code> taint，包括control-plane节点。这意味着调度器可以调度pods到任何node上，也包括管控平面节点，例如 <code class="docutils literal notranslate"><span class="pre">kubemaster-1</span></code> 服务器。</p>
</div>
<div class="section" id="id6">
<h2>集群加入节点<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>按照之前 <a class="reference internal" href="kubeadm.html#kubeadm"><span class="std std-ref">kubeadm</span></a> 部署，我们已经在集群所有节点都部署了 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">kubeadm</span> <span class="pre">kubectl</span> <span class="pre">kubelet</span></code> 软件包（对于 kubenode 节点，可以不部署 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> )。</p>
<p>添加节点到Kubernetes集群的命令在 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 时输出提示中就有:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">join</span> <span class="o">--</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">token</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">master</span><span class="o">-</span><span class="n">ip</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">master</span><span class="o">-</span><span class="n">port</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="nb">hash</span> <span class="n">sha256</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">hash</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>如果你当时记录了提示信息，可以直接复制使用(执行时候请先登陆到node节点上，并切换到root身份)。</p>
<ul class="simple">
<li><p>添加节点的标准方法是先创建一个临时token，然后使用这个24小时有效的token结合pki的sha256值添加服务器节点</p></li>
</ul>
<p>默认情况下，token有效期是24小时:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">token</span> <span class="n">create</span>
</pre></div>
</div>
<p>如果token过期，可以通过运行上述命令再创建一个token，上述命令输出类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">5</span><span class="n">didvk</span><span class="o">.</span><span class="n">d09sbcov8ph2amjw</span>
</pre></div>
</div>
<p>此时你再次使用 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">token</span> <span class="pre">list</span></code> 检查可以看到上述命令创建的新token，有效期24小时，并且可以通过以下命令获得control-plane的命令链有关 <code class="docutils literal notranslate"><span class="pre">--discovery-token-ca-cert-hash</span></code> 内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="n">pubkey</span> <span class="o">-</span><span class="ow">in</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span> <span class="o">|</span> <span class="n">openssl</span> <span class="n">rsa</span> <span class="o">-</span><span class="n">pubin</span> <span class="o">-</span><span class="n">outform</span> <span class="n">der</span> <span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="o">|</span> \
  <span class="n">openssl</span> <span class="n">dgst</span> <span class="o">-</span><span class="n">sha256</span> <span class="o">-</span><span class="nb">hex</span> <span class="o">|</span> <span class="n">sed</span> <span class="s1">&#39;s/^.* //&#39;</span>
</pre></div>
</div>
<p>输出内容类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">8</span><span class="n">cb2de97839780a412b93877f8507ad6c94f73add17d5d7058e91741c9d5ec78</span>
</pre></div>
</div>
<p>则结合新生成的token和sha256字符串，就可以添加新的节点到集群:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">join</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">122.11</span><span class="p">:</span><span class="mi">6443</span> <span class="o">--</span><span class="n">token</span> <span class="mi">5</span><span class="n">didvk</span><span class="o">.</span><span class="n">d09sbcov8ph2amjw</span> <span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="nb">hash</span> \
  <span class="n">sha256</span><span class="p">:</span><span class="mi">8</span><span class="n">cb2de97839780a412b93877f8507ad6c94f73add17d5d7058e91741c9d5ec78</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>上述方法分两步命令执行，并且使用 <code class="docutils literal notranslate"><span class="pre">openssl</span></code> 原始命令比较繁琐（虽然更直接和底层），所以 <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> 还提供了一个直接打印输出最终 <code class="docutils literal notranslate"><span class="pre">join</span></code> 命令的方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">token</span> <span class="n">create</span> <span class="o">--</span><span class="nb">print</span><span class="o">-</span><span class="n">join</span><span class="o">-</span><span class="n">command</span>
</pre></div>
</div>
<p>此时会提示你正确的添加命令方法（包含token和sha256哈希值）。这样只需要复制粘贴就可以添加节点。</p>
</div>
</div>
<div class="section" id="control-plane">
<h2>从非control-plane节点管理集群<a class="headerlink" href="#control-plane" title="永久链接至标题">¶</a></h2>
<p>将control-plane节点的 <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/admin.conf</span></code> 配置文件分发到安装了 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> 工具的主机上，则该主机就具有管理集群的权限:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">root</span><span class="o">@&lt;</span><span class="n">master</span> <span class="n">ip</span><span class="o">&gt;</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span> <span class="o">.</span>
<span class="n">kubectl</span> <span class="o">--</span><span class="n">kubeconfig</span> <span class="o">./</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span> <span class="n">get</span> <span class="n">nodes</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>请注意 <code class="docutils literal notranslate"><span class="pre">admin.conf</span></code> 文件包含了集群的超级用户首选，所以需要谨慎使用。对于普通用户，建议生成一个唯一信任证书，然后再将这个证书加入白名单权限（whitelist privileges）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">alpha</span> <span class="n">kubeconfig</span> <span class="n">user</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">name</span> <span class="o">&lt;</span><span class="n">CN</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>上述命令输出的kubeconfig文件到标准输出，可以保存为一个文件分发给用户。然后通过 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">create</span> <span class="pre">(cluster)rolebind</span></code> 命令添加白名单权限。</p>
</div>
</div>
<div class="section" id="api-server">
<h2>本地主机代理API Server<a class="headerlink" href="#api-server" title="永久链接至标题">¶</a></h2>
<p>如果想在集群之外连接API Server，可以使用 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">proxy</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="n">root</span><span class="o">@&lt;</span><span class="n">master</span> <span class="n">ip</span><span class="o">&gt;</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span> <span class="o">.</span>
<span class="n">kubectl</span> <span class="o">--</span><span class="n">kubeconfig</span> <span class="o">./</span><span class="n">admin</span><span class="o">.</span><span class="n">conf</span> <span class="n">proxy</span>
</pre></div>
</div>
</div>
<div class="section" id="tear-down">
<h2>拆除节点(Tear down)<a class="headerlink" href="#tear-down" title="永久链接至标题">¶</a></h2>
<p>要去除节点（消除所有kubeadm的操作），需要先清理节点(drain the node)，并确保节点完全清理干净之后才可以关闭节点。</p>
<p>执行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">drain</span> <span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">delete</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">data</span> <span class="o">--</span><span class="n">force</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">daemonsets</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="n">node</span> <span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>然后在节点移除之后，再reset所有kubeadmin的已经安装状态:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">reset</span>
</pre></div>
</div>
<p>注意，这个reset国晨并不会清理掉iptables规则或者IPVS表，如果需要reset iptables，需要手工执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iptables</span> <span class="o">-</span><span class="n">F</span> <span class="o">&amp;&amp;</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">F</span> <span class="o">&amp;&amp;</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">mangle</span> <span class="o">-</span><span class="n">F</span> <span class="o">&amp;&amp;</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">X</span>
</pre></div>
</div>
<p>如果需要reset IPVS表，必须运行以下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipvsadm</span> <span class="o">-</span><span class="n">C</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2>参考<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">Creating a single control-plane cluster with kubeadm</a></p></li>
<li><p><a class="reference external" href="https://www.jianshu.com/p/d5ce8a9ecbbf">使用kubeadm部署k8s集群</a></p></li>
<li><p><a class="reference external" href="https://segmentfault.com/a/1190000016304924">k8s与网络–Flannel解读</a></p></li>
<li><p><a class="reference external" href="https://chrislovecnm.com/kubernetes/cni/choosing-a-cni-provider/">Choosing a CNI Network Provider for Kubernetes</a></p></li>
<li><p><a class="reference external" href="https://feisky.gitbooks.io/kubernetes/network/network.html">Kubernetes 网络模型</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="change_master_ip.html" class="btn btn-neutral float-right" title="修改Kubernetes Master IP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="kubeadm.html" class="btn btn-neutral float-left" title="kubeadm" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; <a href="../../../copyright.html"> 版权所有</a> 2019, Huatai Huang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>