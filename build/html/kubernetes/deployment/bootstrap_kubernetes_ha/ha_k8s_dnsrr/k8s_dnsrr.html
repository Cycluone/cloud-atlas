<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>基于DNS轮询构建高可用Kubernetes &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/sphinxnotes-strike.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/translations.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../../copyright.html" />
    <link rel="next" title="kubeadm集群重置" href="kubeadm_reset.html" />
    <link rel="prev" title="高可用Kubernetes集群kubeadm" href="ha_k8s_kubeadm.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ansible/index.html">Ansible Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Kubernetes Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../kubernetes_overview.html">Kubernetes概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup_prepare/index.html">Kubernetes起步准备</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/index.html">Kubernetes快速起步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../concepts/index.html">Kubernetes概念辨析</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Kubernetes部署</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../bootstrap_kubernetes_single/index.html">Kubernetes集群引导(单master)</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Kubernetes集群引导(高可用)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../prepare_z-k8s.html">z-k8s高可用Kubernetes集群准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ha_etcd.html">高可用etcd集群部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ha_k8s.html">高可用(HA)Kubernetes集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ha_k8s_stacked.html">堆叠型管控/etcd节点高可用集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ha_k8s_external.html">扩展etcd节点高可用集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="../create_ha_k8s.html">使用kubeadm创建高可用集群</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">基于DNSRR的高可用Kubernetes集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="../ha_k8s_lb/index.html">基于负载均衡的高可用Kubernetes集群</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../stateless_application/index.html">Kubernetes部署无状态应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operator/index.html">Kubernetes应用部署方法Operator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../etcd/index.html">部署etcd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../deploy_pod/index.html">Kubernetes部署Pod</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../nginx_ingress.html">部署Nginx Ingress Controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../docker_registry.html">在Kubernetes中部署私有Docker镜像仓库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../helm.html">Helm - Kubernetes包管理器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../draft.html">Draft - Kubernetes应用部署工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../kustomize.html">kustomize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../kuberbuilder.html">Kubebuilder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../kubebox/index.html">Kubernetes终端服务kubebox</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../k8s_hosts_in_mbp/index.html">在单台MBP笔记本上部署Kubernetes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../manage_object/index.html">Kubernetes管理对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../administer/index.html">Kubernetes管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../access_application/index.html">Kubernetes访问应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../container_runtimes/index.html">Kubernetes 容器运行时(Container Runtimes)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../configure/index.html">Kubernetes 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../network/index.html">Kubernetes网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../in_action/index.html">Kubernetes实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../numa/index.html">Kubernetes NUMA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../backup/index.html">Kubernetes备份与恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../storage/index.html">Kubernetes存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../production/index.html">Kubernetes生产环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../service_mesh/index.html">Service Mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../istio/index.html">Istio服务网格</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../serverless/index.html">Kubernetes Severless</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ci_cd/index.html">Kubernetes持续集成和持续部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../monitor/index.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../self_healing/index.html">Kubernetes 自愈</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../debug/index.html">Kubernetes排查</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../knative/index.html">Knative - Serverless计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../security/index.html">Kubernetes安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../virtual/index.html">Kubernetes结合虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../arm/index.html">ARM架构Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../k8s_android/index.html">Kubernetes运行Android</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../k3s/index.html">K3s - 轻量级Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cloud/index.html">Kubernetes云厂商</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../develop/index.html">Kubernetes开发</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes_from_scratch/index.html">Kubernetes From Scratch (KFS) Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rancher/index.html">Rancher Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sqlite/index.html">SQLite Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nosql/index.html">NoSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infra_search/index.html">Search Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../info_service/index.html">Info-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../donate.html">捐赠</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../appendix/index.html">附录</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Kubernetes Atlas</a> &raquo;</li>
          <li><a href="../../index.html">Kubernetes部署</a> &raquo;</li>
          <li><a href="../index.html">Kubernetes集群引导(高可用)</a> &raquo;</li>
          <li><a href="index.html">基于DNSRR的高可用Kubernetes集群</a> &raquo;</li>
      <li>基于DNS轮询构建高可用Kubernetes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/kubernetes/deployment/bootstrap_kubernetes_ha/ha_k8s_dnsrr/k8s_dnsrr.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="dnskubernetes">
<span id="k8s-dnsrr"></span><h1>基于DNS轮询构建高可用Kubernetes<a class="headerlink" href="#dnskubernetes" title="Permalink to this heading">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>我在重新部署 <a class="reference internal" href="../../../../real/priv_cloud/priv_cloud_infra.html#priv-cloud-infra"><span class="std std-ref">私有云架构</span></a> 的Kubernetes集群，采用最新的 1.24 版本。虽然之前已经有一些部署经验，但是这次从头开始部署还是遇到不少挫折，走了不少弯路，所以本文记述比较杂乱(因为我断断续续进行，前后记述有所重复)。如果你希望有一个便捷精简且可重复正确完成的参考手册，请阅读 <a class="reference internal" href="../../../../real/priv_cloud/z-k8s.html#z-k8s"><span class="std std-ref">部署Kubernetes集群(z-k8s)</span></a> ，我将在这篇文档中去芜存菁，系统整理如何快速完成高可用Kubernetes部署。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 <a class="reference internal" href="../ha_k8s_lb/index.html#ha-k8s-lb"><span class="std std-ref">基于负载均衡的高可用Kubernetes集群</span></a> 部署中，负载均衡采用的是 <a class="reference internal" href="../../../../web/load_balancer/haproxy/index.html#haproxy"><span class="std std-ref">HAProxy</span></a> 结合keeplived实现VIP自动漂移。可以在部署基础上改造DNSRR到负载均衡模式</p>
</div>
<p>在完成 <a class="reference internal" href="../../etcd/priv_deploy_etcd_cluster_with_tls_auth.html#priv-deploy-etcd-cluster-with-tls-auth"><span class="std std-ref">私有云部署TLS认证的etcd集群</span></a> ，具备了扩展etcd架构，就可以开始部署本文 <code class="docutils literal notranslate"><span class="pre">基于DNS轮询构建高可用Kubernetes</span></code> 。后续再补充 <a class="reference internal" href="../../../../web/load_balancer/haproxy/index.html#haproxy"><span class="std std-ref">HAProxy</span></a> 这样的负载均衡，就可以进一步改造成 <a class="reference internal" href="../ha_k8s_lb/index.html#ha-k8s-lb"><span class="std std-ref">基于负载均衡的高可用Kubernetes集群</span></a> 架构。</p>
<section id="etcd">
<h2>准备etcd访问证书<a class="headerlink" href="#etcd" title="Permalink to this heading">¶</a></h2>
<p>由于是访问外部扩展etcd集群，所以首先需要将etcd证书复制到管控服务器节点，以便管控服务器服务(如apiserver)启动后能够正常读写etcd:</p>
<ul class="simple">
<li><p>在管控服务器 <code class="docutils literal notranslate"><span class="pre">z-k8s-m-1</span></code> / <code class="docutils literal notranslate"><span class="pre">z-k8s-m-2</span></code> / <code class="docutils literal notranslate"><span class="pre">z-k8s-m-3</span></code> 上创建 <code class="docutils literal notranslate"><span class="pre">etcd</span></code> 访问证书目录，并将 <a class="reference internal" href="../../etcd/priv_deploy_etcd_cluster_with_tls_auth.html#priv-deploy-etcd-cluster-with-tls-auth"><span class="std std-ref">私有云部署TLS认证的etcd集群</span></a> 准备好的证书复制过来:</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">etcd</span></code> 客户端所需要的证书可以从 <a class="reference internal" href="../../etcd/priv_deploy_etcd_cluster_with_tls_auth.html#priv-deploy-etcd-cluster-with-tls-auth"><span class="std std-ref">私有云部署TLS认证的etcd集群</span></a> 配置的 <code class="docutils literal notranslate"><span class="pre">etctctl</span></code> 客户端配置找到对应文件</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">etcd客户端配置:使用证书</span><a class="headerlink" href="#id8" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span>
<span class="c1">#export ETCDCTL_ENDPOINTS=&#39;https://etcd.staging.huatai.me:2379&#39;</span>
<span class="nb">export</span> <span class="nv">ETCDCTL_ENDPOINTS</span><span class="o">=</span>https://192.168.6.204:2379,https://192.168.6.205:2379,https://192.168.6.206:2379
<span class="hll"><span class="nb">export</span> <span class="nv">ETCDCTL_CACERT</span><span class="o">=</span>/etc/etcd/ca.pem
</span><span class="hll"><span class="nb">export</span> <span class="nv">ETCDCTL_CERT</span><span class="o">=</span>/etc/etcd/client.pem
</span><span class="hll"><span class="nb">export</span> <span class="nv">ETCDCTL_KEY</span><span class="o">=</span>/etc/etcd/client-key.pem
</span></pre></div>
</div>
</div>
<p>将上述 <code class="docutils literal notranslate"><span class="pre">etcdctl</span></code> 客户端配置文件和Kubernetes访问etcd配置文件一一对应如下:</p>
<table class="docutils align-default" id="id9">
<caption><span class="caption-text">kubernetes apiserver访问etcd证书对应关系</span><a class="headerlink" href="#id9" title="永久链接至表格">¶</a></caption>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>cfssl生成etcd客户端密钥</p></th>
<th class="head"><p>对应k8s访问etcd密钥文件</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ca.pem</p></td>
<td><p>ca.crt</p></td>
</tr>
<tr class="row-odd"><td><p>client.pem</p></td>
<td><p>apiserver-etcd-client.crt</p></td>
</tr>
<tr class="row-even"><td><p>client-key.pem</p></td>
<td><p>apiserver-etcd-client.key</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>分发kubernetes的apiserver使用的etcd证书:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">分发kubernetes的apiserver使用的etcd证书</span><a class="headerlink" href="#id10" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> host <span class="k">in</span> z-k8s-m-1 z-k8s-m-2 z-k8s-m-3<span class="p">;</span><span class="k">do</span>
   scp /etc/etcd/ca.pem <span class="nv">$host</span>:/tmp/ca.crt
   scp /etc/etcd/client.pem <span class="nv">$host</span>:/tmp/apiserver-etcd-client.crt
   scp /etc/etcd/client-key.pem <span class="nv">$host</span>:/tmp/apiserver-etcd-client.key
   
   ssh <span class="nv">$host</span> <span class="s1">&#39;sudo mkdir -p /etc/kubernetes/pki/etcd&#39;</span> 
   ssh <span class="nv">$host</span> <span class="s1">&#39;sudo mv /tmp/ca.crt /etc/kubernetes/pki/etcd/ca.crt&#39;</span>
   ssh <span class="nv">$host</span> <span class="s1">&#39;sudo mv /tmp/apiserver-etcd-client.crt /etc/kubernetes/pki/apiserver-etcd-client.crt&#39;</span>
   ssh <span class="nv">$host</span> <span class="s1">&#39;sudo mv /tmp/apiserver-etcd-client.key /etc/kubernetes/pki/apiserver-etcd-client.key&#39;</span>
<span class="k">done</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我是在具备密钥认证管理主机 <code class="docutils literal notranslate"><span class="pre">z-b-data-1</span></code> 上作为客户端，通过ssh远程登录到 <code class="docutils literal notranslate"><span class="pre">z-k8s-m-1</span></code> / <code class="docutils literal notranslate"><span class="pre">z-k8s-m-2</span></code> / <code class="docutils literal notranslate"><span class="pre">z-k8s-m-3</span></code> ，执行上述 <code class="docutils literal notranslate"><span class="pre">deploy_k8s_etcd_key.sh</span></code> 分发密钥</p>
</div>
</section>
<section id="control-plane-ndoe">
<span id="kubeadm-config"></span><h2>配置第一个管控节点(control plane ndoe)<a class="headerlink" href="#control-plane-ndoe" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>创建 <code class="docutils literal notranslate"><span class="pre">create_kubeadm-config.sh</span></code> 脚本 :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">创建第一个管控节点配置 kubeadm-config.yaml</span><a class="headerlink" href="#id11" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">K8S_API_ENDPOINT</span><span class="o">=</span>z-k8s-api.staging.huatai.me
<span class="nv">K8S_API_ENDPOINT_PORT</span><span class="o">=</span><span class="m">6443</span>
<span class="nv">K8S_CLUSTER_NAME</span><span class="o">=</span>z-k8s

<span class="nv">ETCD_0_IP</span><span class="o">=</span><span class="m">192</span>.168.6.204
<span class="nv">ETCD_1_IP</span><span class="o">=</span><span class="m">192</span>.168.6.205
<span class="nv">ETCD_2_IP</span><span class="o">=</span><span class="m">192</span>.168.6.206

cat <span class="s">&lt;&lt; EOF &gt; kubeadm-config.yaml</span>
<span class="s">---</span>
<span class="s">apiVersion: kubeadm.k8s.io/v1beta3</span>
<span class="s">kind: ClusterConfiguration</span>
<span class="s">kubernetesVersion: stable</span>
<span class="s">clusterName: ${K8S_CLUSTER_NAME}</span>
<span class="s">controlPlaneEndpoint: &quot;${K8S_API_ENDPOINT}:${K8S_API_ENDPOINT_PORT}&quot;</span>
<span class="s">etcd:</span>
<span class="s">  external:</span>
<span class="s">    endpoints:</span>
<span class="s">      - https://${ETCD_0_IP}:2379</span>
<span class="s">      - https://${ETCD_1_IP}:2379</span>
<span class="s">      - https://${ETCD_2_IP}:2379</span>
<span class="s">    caFile: /etc/kubernetes/pki/etcd/ca.crt</span>
<span class="s">    certFile: /etc/kubernetes/pki/apiserver-etcd-client.crt</span>
<span class="s">    keyFile: /etc/kubernetes/pki/apiserver-etcd-client.key</span>
<span class="s">EOF</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 <a class="reference internal" href="../../../container_runtimes/containerd/install_containerd_official_binaries.html#containerd-systemdcgroup-true"><span class="std std-ref">配置 systemd cgroup驱动</span></a> <a class="reference internal" href="../../../container_runtimes/containerd/index.html#containerd"><span class="std std-ref">containerd运行时(runtime)</span></a> 就会使用 <code class="docutils literal notranslate"><span class="pre">systemd</span> <span class="pre">cgroup</span> <span class="pre">driver</span></code> 。对应 <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 也需要使用 <code class="docutils literal notranslate"><span class="pre">systemd</span> <span class="pre">cgroup</span> <span class="pre">driver</span></code> : 在Kubernetes官方文档 <a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/">Configuring a cgroup driver</a> 指明了:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 可以通过 <code class="docutils literal notranslate"><span class="pre">kubeadm-config.yaml</span></code> 中指定 <code class="docutils literal notranslate"><span class="pre">cgroupDriver:</span> <span class="pre">systemd</span></code> 明确配置 <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 使用 <code class="docutils literal notranslate"><span class="pre">systemd</span> <span class="pre">cgroup</span> <span class="pre">driver</span></code> ，这样 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 创建的集群中 <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 就会正确使用 <code class="docutils literal notranslate"><span class="pre">systemd</span> <span class="pre">cgroup</span> <span class="pre">driver</span></code></p></li>
<li><p>从 Kubernetes 1.22 开始，即使没有明确配置 <code class="docutils literal notranslate"><span class="pre">cgroupDriver:</span> <span class="pre">systemd</span></code> ， <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 也是默认使用 <code class="docutils literal notranslate"><span class="pre">systemd</span> <span class="pre">cgroup</span> <span class="pre">driver</span></code></p></li>
<li><p>如果集群创建时没有指定 <code class="docutils literal notranslate"><span class="pre">systemd</span> <span class="pre">cgroup</span> <span class="pre">driver</span></code> (且版本低于1.22)，则可以通过 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">edit</span> <span class="pre">cm</span> <span class="pre">kubelet-config</span> <span class="pre">-n</span> <span class="pre">kube-system</span></code> 修订 <code class="docutils literal notranslate"><span class="pre">cgroupDriver:</span> <span class="pre">systemd</span></code></p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference external" href="https://medium.com/&#64;kosta709/kubernetes-by-kubeadm-config-yamls-94e2ee11244">Kubernetes by kubeadm config yamls</a> 提供了 <code class="docutils literal notranslate"><span class="pre">kubeadm-config.yaml</span></code> 配置案例，例如如何修订集群名，网段等。实际上可以进一步参考官方文档定制 apiserver / controller / scheduler 的配置，在这篇文档中也有介绍和引用。非常好</p>
</div>
<ul class="simple">
<li><p>执行 <code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">create_kubeadm-config.sh</span></code> 生成 <code class="docutils literal notranslate"><span class="pre">kubeadm-config.yaml</span></code> 配置文件</p></li>
<li><p>创建第一个管控节点:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">初始化第一个管控节点 kubeadm init</span><a class="headerlink" href="#id12" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo kubeadm init --config kubeadm-config.yaml --upload-certs
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>实际上只要保证网络畅通(翻墙)，并且做好前置准备工作， <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 初始化会非常丝滑地完成。此时终端会提示一些非常有用地信息，例如如何启动集群，如何配置管理环境。</p>
</div>
<p>如果一切顺利，会有如下提示信息:</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">初始化第一个管控节点 kubeadm init 输出信息</span><a class="headerlink" href="#id13" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>init<span class="o">]</span> Using Kubernetes version: v1.24.2
<span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
        <span class="o">[</span>WARNING SystemVerification<span class="o">]</span>: missing optional cgroups: hugetlb blkio
<span class="o">[</span>preflight<span class="o">]</span> Pulling images required <span class="k">for</span> setting up a Kubernetes cluster
<span class="o">[</span>preflight<span class="o">]</span> This might take a minute or two, depending on the speed of your internet connection
<span class="o">[</span>preflight<span class="o">]</span> You can also perform this action <span class="k">in</span> beforehand using <span class="s1">&#39;kubeadm config images pull&#39;</span>
<span class="o">[</span>certs<span class="o">]</span> Using certificateDir folder <span class="s2">&quot;/etc/kubernetes/pki&quot;</span>
<span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&quot;ca&quot;</span> certificate and key
<span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&quot;apiserver&quot;</span> certificate and key
<span class="o">[</span>certs<span class="o">]</span> apiserver serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>apiserver.staging.huatai.me kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local z-k8s-m-1<span class="o">]</span> and IPs <span class="o">[</span><span class="m">10</span>.96.0.1 <span class="m">192</span>.168.6.101<span class="o">]</span>
<span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&quot;apiserver-kubelet-client&quot;</span> certificate and key
<span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&quot;front-proxy-ca&quot;</span> certificate and key
<span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&quot;front-proxy-client&quot;</span> certificate and key
<span class="o">[</span>certs<span class="o">]</span> External etcd mode: Skipping etcd/ca certificate authority generation
<span class="o">[</span>certs<span class="o">]</span> External etcd mode: Skipping etcd/server certificate generation
<span class="o">[</span>certs<span class="o">]</span> External etcd mode: Skipping etcd/peer certificate generation
<span class="o">[</span>certs<span class="o">]</span> External etcd mode: Skipping etcd/healthcheck-client certificate generation
<span class="o">[</span>certs<span class="o">]</span> External etcd mode: Skipping apiserver-etcd-client certificate generation
<span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&quot;sa&quot;</span> key and public key
<span class="o">[</span>kubeconfig<span class="o">]</span> Using kubeconfig folder <span class="s2">&quot;/etc/kubernetes&quot;</span>
<span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&quot;admin.conf&quot;</span> kubeconfig file
<span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&quot;kubelet.conf&quot;</span> kubeconfig file
<span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&quot;controller-manager.conf&quot;</span> kubeconfig file
<span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&quot;scheduler.conf&quot;</span> kubeconfig file
<span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet environment file with flags to file <span class="s2">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="o">[</span>kubelet-start<span class="o">]</span> Starting the kubelet
<span class="o">[</span>control-plane<span class="o">]</span> Using manifest folder <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>
<span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&quot;kube-apiserver&quot;</span>
<span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&quot;kube-controller-manager&quot;</span>
<span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&quot;kube-scheduler&quot;</span>
<span class="o">[</span>wait-control-plane<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="s2">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to 4m0s
<span class="o">[</span>apiclient<span class="o">]</span> All control plane components are healthy after <span class="m">16</span>.010266 seconds
<span class="o">[</span>upload-config<span class="o">]</span> Storing the configuration used <span class="k">in</span> ConfigMap <span class="s2">&quot;kubeadm-config&quot;</span> <span class="k">in</span> the <span class="s2">&quot;kube-system&quot;</span> Namespace
<span class="o">[</span>kubelet<span class="o">]</span> Creating a ConfigMap <span class="s2">&quot;kubelet-config&quot;</span> <span class="k">in</span> namespace kube-system with the configuration <span class="k">for</span> the kubelets <span class="k">in</span> the cluster
<span class="o">[</span>upload-certs<span class="o">]</span> Storing the certificates <span class="k">in</span> Secret <span class="s2">&quot;kubeadm-certs&quot;</span> <span class="k">in</span> the <span class="s2">&quot;kube-system&quot;</span> Namespace
<span class="o">[</span>upload-certs<span class="o">]</span> Using certificate key:
&lt;CERTIFICATE KEY&gt;
<span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node z-k8s-m-1 as control-plane by adding the labels: <span class="o">[</span>node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers<span class="o">]</span>
<span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node z-k8s-m-1 as control-plane by adding the taints <span class="o">[</span>node-role.kubernetes.io/master:NoSchedule node-role.kubernetes.io/control-plane:NoSchedule<span class="o">]</span>
<span class="o">[</span>bootstrap-token<span class="o">]</span> Using token: &lt;TOKEN&gt;
<span class="o">[</span>bootstrap-token<span class="o">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
<span class="o">[</span>bootstrap-token<span class="o">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
<span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow Node Bootstrap tokens to get nodes
<span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="k">in</span> order <span class="k">for</span> nodes to get long term certificate credentials
<span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<span class="o">[</span>bootstrap-token<span class="o">]</span> Configured RBAC rules to allow certificate rotation <span class="k">for</span> all node client certificates <span class="k">in</span> the cluster
<span class="o">[</span>bootstrap-token<span class="o">]</span> Creating the <span class="s2">&quot;cluster-info&quot;</span> ConfigMap <span class="k">in</span> the <span class="s2">&quot;kube-public&quot;</span> namespace
<span class="o">[</span>kubelet-finalize<span class="o">]</span> Updating <span class="s2">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key
<span class="o">[</span>addons<span class="o">]</span> Applied essential addon: CoreDNS
<span class="o">[</span>kubelet-check<span class="o">]</span> Initial timeout of 40s passed.
<span class="o">[</span>addons<span class="o">]</span> Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!
</pre></div>
</div>
</div>
<p>表明集群第一个管控节点初始化成功!</p>
<ul class="simple">
<li><p>此时根据提示，执行以下命令为自己的账户准备好管理配置</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">配置个人账户的管理k8s环境</span><a class="headerlink" href="#id14" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p <span class="nv">$HOME</span>/.kube
sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</pre></div>
</div>
</div>
<p>并且提供了如何添加管控平面节点的操作命令(包含密钥，所以必须保密)，以及添加工作节点的命令(包含密钥，所以必须保密)</p>
</section>
<section id="id1">
<h2>容器没有启动问题<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h2>
<p>我这里遇到一个问题，就是 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 显示初始化成功，但是我使用 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> 居然看不到任何容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</pre></div>
</div>
<p>这怎么回事？</p>
<ul>
<li><p>检查端口:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span> <span class="n">grep</span> <span class="mi">6443</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到端口已经监听:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">39868</span>     <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="n">ESTABLISHED</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">38514</span>     <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="n">ESTABLISHED</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">40006</span>     <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="n">TIME_WAIT</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">39982</span>     <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="n">TIME_WAIT</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">39926</span>     <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="n">ESTABLISHED</span>
<span class="n">tcp</span>        <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">40070</span>     <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="n">TIME_WAIT</span>
<span class="n">tcp6</span>       <span class="mi">0</span>      <span class="mi">0</span> <span class="p">:::</span><span class="mi">6443</span>                 <span class="p">:::</span><span class="o">*</span>                    <span class="n">LISTEN</span>
<span class="n">tcp6</span>       <span class="mi">0</span>      <span class="mi">0</span> <span class="p">::</span><span class="mi">1</span><span class="p">:</span><span class="mi">51780</span>               <span class="p">::</span><span class="mi">1</span><span class="p">:</span><span class="mi">6443</span>                <span class="n">ESTABLISHED</span>
<span class="n">tcp6</span>       <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">39868</span>     <span class="n">ESTABLISHED</span>
<span class="n">tcp6</span>       <span class="mi">0</span>      <span class="mi">0</span> <span class="p">::</span><span class="mi">1</span><span class="p">:</span><span class="mi">6443</span>                <span class="p">::</span><span class="mi">1</span><span class="p">:</span><span class="mi">51780</span>               <span class="n">ESTABLISHED</span>
<span class="n">tcp6</span>       <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">38514</span>     <span class="n">ESTABLISHED</span>
<span class="n">tcp6</span>       <span class="mi">0</span>      <span class="mi">0</span> <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">6443</span>      <span class="mf">192.168.6.101</span><span class="p">:</span><span class="mi">39926</span>     <span class="n">ESTABLISHED</span>
</pre></div>
</div>
<p>难道现在真的已经不再使用docker，直接使用 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 这样的 <a class="reference internal" href="../../../container_runtimes/index.html#container-runtimes"><span class="std std-ref">Kubernetes 容器运行时(Container Runtimes)</span></a></p>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">top</span></code> 输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Tasks</span><span class="p">:</span> <span class="mi">149</span> <span class="n">total</span><span class="p">,</span>   <span class="mi">1</span> <span class="n">running</span><span class="p">,</span> <span class="mi">148</span> <span class="n">sleeping</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">stopped</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">zombie</span>
<span class="o">%</span><span class="n">Cpu</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="mf">3.0</span> <span class="n">us</span><span class="p">,</span>  <span class="mf">1.8</span> <span class="n">sy</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">ni</span><span class="p">,</span> <span class="mf">92.7</span> <span class="nb">id</span><span class="p">,</span>  <span class="mf">2.2</span> <span class="n">wa</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">hi</span><span class="p">,</span>  <span class="mf">0.2</span> <span class="n">si</span><span class="p">,</span>  <span class="mf">0.2</span> <span class="n">st</span>
<span class="n">MiB</span> <span class="n">Mem</span> <span class="p">:</span>   <span class="mf">3929.8</span> <span class="n">total</span><span class="p">,</span>   <span class="mf">2579.8</span> <span class="n">free</span><span class="p">,</span>    <span class="mf">531.7</span> <span class="n">used</span><span class="p">,</span>    <span class="mf">818.4</span> <span class="n">buff</span><span class="o">/</span><span class="n">cache</span>
<span class="n">MiB</span> <span class="n">Swap</span><span class="p">:</span>      <span class="mf">0.0</span> <span class="n">total</span><span class="p">,</span>      <span class="mf">0.0</span> <span class="n">free</span><span class="p">,</span>      <span class="mf">0.0</span> <span class="n">used</span><span class="o">.</span>   <span class="mf">3179.4</span> <span class="n">avail</span> <span class="n">Mem</span>

    <span class="n">PID</span> <span class="n">USER</span>      <span class="n">PR</span>  <span class="n">NI</span>    <span class="n">VIRT</span>    <span class="n">RES</span>    <span class="n">SHR</span> <span class="n">S</span>  <span class="o">%</span><span class="n">CPU</span>  <span class="o">%</span><span class="n">MEM</span>     <span class="n">TIME</span><span class="o">+</span> <span class="n">COMMAND</span>
  <span class="mi">18408</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span> <span class="mi">1173260</span> <span class="mi">336344</span>  <span class="mi">71252</span> <span class="n">S</span>   <span class="mf">4.6</span>   <span class="mf">8.4</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">32.39</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>
    <span class="mi">437</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span> <span class="mi">1855336</span>  <span class="mi">97924</span>  <span class="mi">63844</span> <span class="n">S</span>   <span class="mf">2.0</span>   <span class="mf">2.4</span>   <span class="mi">2</span><span class="p">:</span><span class="mf">49.35</span> <span class="n">kubelet</span>
  <span class="mi">19247</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>  <span class="mi">818924</span>  <span class="mi">89480</span>  <span class="mi">59096</span> <span class="n">S</span>   <span class="mf">2.0</span>   <span class="mf">2.2</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">02.62</span> <span class="n">kube</span><span class="o">-</span><span class="n">controller</span>
    <span class="mi">422</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span> <span class="mi">1296700</span>  <span class="mi">60624</span>  <span class="mi">30648</span> <span class="n">S</span>   <span class="mf">0.7</span>   <span class="mf">1.5</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">51.12</span> <span class="n">containerd</span>
    <span class="mi">262</span> <span class="n">root</span>      <span class="mi">19</span>  <span class="o">-</span><span class="mi">1</span>   <span class="mi">93020</span>  <span class="mi">37364</span>  <span class="mi">36260</span> <span class="n">S</span>   <span class="mf">0.3</span>   <span class="mf">0.9</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">07.20</span> <span class="n">systemd</span><span class="o">-</span><span class="n">journal</span>
  <span class="mi">18028</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">I</span>   <span class="mf">0.3</span>   <span class="mf">0.0</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.05</span> <span class="n">kworker</span><span class="o">/</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="o">-</span><span class="n">events</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到系统已经运行了 <code class="docutils literal notranslate"><span class="pre">kube-apiserver</span></code> 和 <code class="docutils literal notranslate"><span class="pre">kube-controller</span></code> ，说明Kubernetes相关容器已经运行，否则也不会有这些进程。</p>
<ul>
<li><p>检查节点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">nodes</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Unable</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">server</span><span class="p">:</span> <span class="n">Forbidden</span>
</pre></div>
</div>
<p>why?</p>
<p>想到我部署采用DNSRR，也就是解析 <code class="docutils literal notranslate"><span class="pre">apiserver.staging.huatai.me</span></code> 域名可能是访问目前尚未加入管控的另外2个服务器，所以我尝试把DNS解析修改成只解析到节点1，也就是第一个加入管控的节点IP。但是依然没有解决</p>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">kubelet.service</span></code> 日志:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">service</span> <span class="o">|</span> <span class="n">less</span>
</pre></div>
</div>
</li>
</ul>
<p>看到启动kubelet之后有报错信息，首先就是有关网络没有就绪的错误:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">40</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">E0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">40.420728</span>     <span class="mi">437</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">2424</span><span class="p">]</span> <span class="s2">&quot;Error getting node&quot;</span> <span class="n">err</span><span class="o">=</span><span class="s2">&quot;node </span><span class="se">\&quot;</span><span class="s2">z-k8s-m-1</span><span class="se">\&quot;</span><span class="s2"> not found&quot;</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">40</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">E0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">40.521709</span>     <span class="mi">437</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">2424</span><span class="p">]</span> <span class="s2">&quot;Error getting node&quot;</span> <span class="n">err</span><span class="o">=</span><span class="s2">&quot;node </span><span class="se">\&quot;</span><span class="s2">z-k8s-m-1</span><span class="se">\&quot;</span><span class="s2"> not found&quot;</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">40</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">E0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">40.581769</span>     <span class="mi">437</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">2349</span><span class="p">]</span> <span class="s2">&quot;Container runtime network not ready&quot;</span> <span class="n">networkReady</span><span class="o">=</span><span class="s2">&quot;NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&quot;</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">40</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">E0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">40.622654</span>     <span class="mi">437</span> <span class="n">kubelet</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">2424</span><span class="p">]</span> <span class="s2">&quot;Error getting node&quot;</span> <span class="n">err</span><span class="o">=</span><span class="s2">&quot;node </span><span class="se">\&quot;</span><span class="s2">z-k8s-m-1</span><span class="se">\&quot;</span><span class="s2"> not found&quot;</span>
<span class="o">...</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">41</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">I0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">41.796597</span>     <span class="mi">437</span> <span class="n">kubelet_node_status</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">70</span><span class="p">]</span> <span class="s2">&quot;Attempting to register node&quot;</span> <span class="n">node</span><span class="o">=</span><span class="s2">&quot;z-k8s-m-1&quot;</span>
<span class="o">...</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">43</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">I0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">43.232192</span>     <span class="mi">437</span> <span class="n">kubelet_node_status</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">108</span><span class="p">]</span> <span class="s2">&quot;Node was previously registered&quot;</span> <span class="n">node</span><span class="o">=</span><span class="s2">&quot;z-k8s-m-1&quot;</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">43</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">I0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">43.232303</span>     <span class="mi">437</span> <span class="n">kubelet_node_status</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">73</span><span class="p">]</span> <span class="s2">&quot;Successfully registered node&quot;</span> <span class="n">node</span><span class="o">=</span><span class="s2">&quot;z-k8s-m-1&quot;</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">43</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">I0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">43.427832</span>     <span class="mi">437</span> <span class="n">apiserver</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span> <span class="s2">&quot;Watching apiserver&quot;</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">43</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">I0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">43.438830</span>     <span class="mi">437</span> <span class="n">topology_manager</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">200</span><span class="p">]</span> <span class="s2">&quot;Topology Admit Handler&quot;</span>
<span class="o">...</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">43</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">E0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">43.440795</span>     <span class="mi">437</span> <span class="n">pod_workers</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">951</span><span class="p">]</span> <span class="s2">&quot;Error syncing pod, skipping&quot;</span> <span class="n">err</span><span class="o">=</span><span class="s2">&quot;network is not ready: container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&quot;</span> <span class="n">pod</span><span class="o">=</span><span class="s2">&quot;kube-system/cor</span>
<span class="n">edns</span><span class="o">-</span><span class="mi">6</span><span class="n">d4b75cb6d</span><span class="o">-</span><span class="n">pf7bs</span><span class="s2">&quot; podUID=79bc049c-0f1a-4387-aeed-ccfb04dfe7ca</span>
<span class="n">Jul</span> <span class="mi">11</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">43</span> <span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span> <span class="n">kubelet</span><span class="p">[</span><span class="mi">437</span><span class="p">]:</span> <span class="n">E0711</span> <span class="mi">09</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mf">43.440978</span>     <span class="mi">437</span> <span class="n">pod_workers</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">951</span><span class="p">]</span> <span class="s2">&quot;Error syncing pod, skipping&quot;</span> <span class="n">err</span><span class="o">=</span><span class="s2">&quot;network is not ready: container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&quot;</span> <span class="n">pod</span><span class="o">=</span><span class="s2">&quot;kube-system/cor</span>
<span class="n">edns</span><span class="o">-</span><span class="mi">6</span><span class="n">d4b75cb6d</span><span class="o">-</span><span class="n">m2hf6</span><span class="s2">&quot; podUID=b2d40bb9-f431-4c53-a164-215bfcd4da47</span>
<span class="o">...</span>
</pre></div>
</div>
<p>可以看到访问 apiserver 失败，并且网络 cni plugin 没有初始化。想起来当时在官方文档中看到过必须初始化网络之后才能正常工作。(虽然我之前在 <a class="reference internal" href="../../bootstrap_kubernetes_single/single_master_k8s.html#single-master-k8s"><span class="std std-ref">创建单一控制平面(单master)集群</span></a> 经验是无需cni也至少能够看到pod运行，并且能够使用 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> )</p>
<p>此外，在 <a class="reference internal" href="../../../container_runtimes/index.html#container-runtimes"><span class="std std-ref">Kubernetes 容器运行时(Container Runtimes)</span></a> 从官方文档查到 kubernetes 1.24 之后移除了docker支持，是否不再支持使用docker ?  我检查了 <a class="reference internal" href="../../../container_runtimes/index.html#container-runtimes"><span class="std std-ref">Kubernetes 容器运行时(Container Runtimes)</span></a> 中对运行时检查 <code class="docutils literal notranslate"><span class="pre">sockets</span></code> 方法，确认系统只有 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 的sockets文件</p>
<p>仔细检查了 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 输出信息，可以看到提示安装cni的方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">You</span> <span class="n">should</span> <span class="n">now</span> <span class="n">deploy</span> <span class="n">a</span> <span class="n">pod</span> <span class="n">network</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span><span class="o">.</span>
<span class="n">Run</span> <span class="s2">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> <span class="k">with</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">options</span> <span class="n">listed</span> <span class="n">at</span><span class="p">:</span>
  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">concepts</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">administration</span><span class="o">/</span><span class="n">addons</span><span class="o">/</span>
</pre></div>
</div>
<p>参考 <a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/migrating-from-dockershim/troubleshooting-cni-plugin-related-errors/">Troubleshooting CNI plugin-related errors</a> 提供了排查CNI插件的建议。其中在文档开始就提出:</p>
<ul class="simple">
<li><p>为避免CNI plugin相关错误，首先应该将 <a class="reference internal" href="../../../container_runtimes/index.html#container-runtimes"><span class="std std-ref">Kubernetes 容器运行时(Container Runtimes)</span></a> 升级到对应Kubernetes版本的已经验证正常工作的CNI plugins版本。例如，对于 Kubernetes 1.24 需要满足:</p>
<ul>
<li><p>containerd v1.6.4 或更高版本， v1.5.11 或更高版本</p></li>
<li><p>CRI-O v1.24.0 或更新版本</p></li>
</ul>
</li>
</ul>
<p>我检查了一下我的 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 版本，发现是采用发行版安装的 <code class="docutils literal notranslate"><span class="pre">docker.io</span></code> ，所以版本不是最新， <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 的版本只是 <code class="docutils literal notranslate"><span class="pre">1.5.9</span></code> ，所以很可能是版本过低无法适配。该文档还提示:</p>
<p>在Kubernetes， <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 运行时哦人添加一个回环接口 <code class="docutils literal notranslate"><span class="pre">lo</span></code> 给pods作为默认特性。containerd运行时配置通过一个 CNI plugin <code class="docutils literal notranslate"><span class="pre">loopback</span></code> 来实现，这是 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 发行包默认分发的一部分，例如 <code class="docutils literal notranslate"><span class="pre">containerd</span></code>  v1.6.0 以及更高版本就将一个CNI v1.0.0兼容loopback插件作为默认CNI plugins。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>根据上文排查，无法正常启动 <code class="docutils literal notranslate"><span class="pre">kubeadmin</span> <span class="pre">init</span></code> 容器是因为Kubernetes 1.24，也就是我安装的最新K8s已经移除了CNI plugin，将这部分工作移交给容器运行时自带的CNI plugin来完成。这就要求配套使用最新版本(或满足版本要求)的 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 运行时。最新版本的 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 运行时默认启动 <code class="docutils literal notranslate"><span class="pre">loopback</span></code> 就提供了kubernetes管控平面pods运行的条件，这样从开始就可以拉起 Kubernetes 的管控pods，为下一步安装不同的 <a class="reference internal" href="../../../network/index.html#kubernetes-network"><span class="std std-ref">Kubernetes网络</span></a> 提供初始运行条件。当Kubernetes集群正常运行后，通过 <a class="reference internal" href="../../../network/cilium/cilium_install_with_external_etcd.html#cilium-install-with-external-etcd"><span class="std std-ref">在扩展etcd环境安装cilium</span></a> 就可以直接在运行起来的kubernetes集群上完成网络定制。</p>
<p><a class="reference external" href="https://containerd.io/releases/">containerd versioning and release</a> 提供了支持 Kubernetes 不同版本所对应当 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 版本，确实明确指出 Kubernetes 1.24 需要 <code class="docutils literal notranslate"><span class="pre">containerd</span> <span class="pre">1.64+，1.5.11+</span></code></p>
</div>
</section>
<section id="id2">
<h2>再次排查启动问题<a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<p>我采用以下方式重新开始部署</p>
<ul class="simple">
<li><p>执行 <a class="reference internal" href="kubeadm_reset.html#kubeadm-reset"><span class="std std-ref">kubeadm集群重置</span></a> 删除掉存在异常的k8s集群</p></li>
<li><p>重试通过 <a class="reference internal" href="../../../container_runtimes/containerd/install_containerd_official_binaries.html#install-containerd-official-binaries"><span class="std std-ref">安装containerd官方执行程序</span></a> 将发行版 <code class="docutils literal notranslate"><span class="pre">containerd</span></code> 升级到 1.64+ ，每个节点都执行一遍，确保采用最新 <code class="docutils literal notranslate"><span class="pre">containerd</span></code></p></li>
<li><p>改进 <code class="docutils literal notranslate"><span class="pre">kubeadm-config.yaml</span></code> 自定义集群名(见上文，已经修订到配置中)</p></li>
</ul>
<p>重新执行了 <code class="docutils literal notranslate"><span class="pre">kubeadmin</span> <span class="pre">init</span></code> 但是发现 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span></code> 依然出现报错 <code class="docutils literal notranslate"><span class="pre">Unable</span> <span class="pre">to</span> <span class="pre">connect</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">server:</span> <span class="pre">Forbidden</span></code></p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>我没有想到从熟悉的 <a class="reference internal" href="../../../../docker/index.html#docker"><span class="std std-ref">Docker Atlas</span></a> 切换到 <a class="reference internal" href="../../../container_runtimes/containerd/index.html#containerd"><span class="std std-ref">containerd运行时(runtime)</span></a> 遇到这么多麻烦:</p>
<ul class="simple">
<li><p>Kubernetes 1.24 中无法使用 <code class="docutils literal notranslate"><span class="pre">docker</span></code> 命令，而 <code class="docutils literal notranslate"><span class="pre">ctr</span></code> 命令实践下来也是存在问题的(实际容器已经启动，但是没有任何管理输出)</p></li>
<li><p>需要完整切换到Kubernetes 1.24所使用的标准 cri 接口命令 <a class="reference internal" href="../../../debug/crictl.html#crictl"><span class="std std-ref">crictl</span></a> 才能观察容器运行情况</p></li>
</ul>
</div>
<ul class="simple">
<li><p>按照 <a class="reference internal" href="../../../debug/crictl.html#crictl"><span class="std std-ref">crictl</span></a> 配置好 <code class="docutils literal notranslate"><span class="pre">/etc/crictl.conf</span></code> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">crictl配置文件 /etc/crictl.yaml</span><a class="headerlink" href="#id15" title="永久链接至代码">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">runtime-endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unix:///var/run/containerd/containerd.sock</span><span class="w"></span>
<span class="nt">image-endpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unix:///var/run/containerd/containerd.sock</span><span class="w"></span>
<span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="c1">#debug: true</span><span class="w"></span>
<span class="nt">debug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
</pre></div>
</div>
</div>
<ul>
<li><p>执行pods检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crictl</span> <span class="n">pods</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>POD ID              CREATED             STATE               NAME                                NAMESPACE           ATTEMPT             RUNTIME
173ffdaeefab9       <span class="m">13</span> hours ago        Ready               kube-proxy-vwqsn                    kube-system         <span class="m">0</span>                   <span class="o">(</span>default<span class="o">)</span>
0952e1399e340       <span class="m">13</span> hours ago        Ready               kube-scheduler-z-k8s-m-1            kube-system         <span class="m">0</span>                   <span class="o">(</span>default<span class="o">)</span>
424cc7a5a9bfc       <span class="m">13</span> hours ago        Ready               kube-controller-manager-z-k8s-m-1   kube-system         <span class="m">0</span>                   <span class="o">(</span>default<span class="o">)</span>
7249ac0122d31       <span class="m">13</span> hours ago        Ready               kube-apiserver-z-k8s-m-1            kube-system         <span class="m">0</span>                   <span class="o">(</span>default<span class="o">)</span>
</pre></div>
</div>
<ul>
<li><p>检查镜像:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crictl</span> <span class="n">images</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IMAGE</span>                                <span class="n">TAG</span>                 <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">SIZE</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">coredns</span><span class="o">/</span><span class="n">coredns</span>           <span class="n">v1</span><span class="mf">.8.6</span>              <span class="n">a4ca41631cc7a</span>       <span class="mf">13.6</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>            <span class="n">v1</span><span class="mf">.24.2</span>             <span class="n">d3377ffb7177c</span>       <span class="mf">33.8</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>            <span class="n">v1</span><span class="mf">.24.3</span>             <span class="n">d521dd763e2e3</span>       <span class="mf">33.8</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span>   <span class="n">v1</span><span class="mf">.24.2</span>             <span class="mi">34</span><span class="n">cdf99b1bb3b</span>       <span class="mi">31</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span>   <span class="n">v1</span><span class="mf">.24.3</span>             <span class="mi">586</span><span class="n">c112956dfc</span>       <span class="mi">31</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>                <span class="n">v1</span><span class="mf">.24.2</span>             <span class="n">a634548d10b03</span>       <span class="mf">39.5</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>                <span class="n">v1</span><span class="mf">.24.3</span>             <span class="mi">2</span><span class="n">ae1ba6417cbc</span>       <span class="mf">39.5</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span>            <span class="n">v1</span><span class="mf">.24.2</span>             <span class="mi">5</span><span class="n">d725196c1f47</span>       <span class="mf">15.5</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span>            <span class="n">v1</span><span class="mf">.24.3</span>             <span class="mi">3</span><span class="n">a5aa3a515f5d</span>       <span class="mf">15.5</span><span class="n">MB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">pause</span>                     <span class="mf">3.5</span>                 <span class="n">ed210e3e4a5ba</span>       <span class="mi">301</span><span class="n">kB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">pause</span>                     <span class="mf">3.6</span>                 <span class="mi">6270</span><span class="n">bb605e12e</span>       <span class="mi">302</span><span class="n">kB</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">pause</span>                     <span class="mf">3.7</span>                 <span class="mi">221177</span><span class="n">c6082a8</span>       <span class="mi">311</span><span class="n">kB</span>
</pre></div>
</div>
<ul>
<li><p>检查容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crictl</span> <span class="n">ps</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
</li>
</ul>
<p>显示主机上运行的容器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONTAINER</span>           <span class="n">IMAGE</span>               <span class="n">CREATED</span>             <span class="n">STATE</span>               <span class="n">NAME</span>                      <span class="n">ATTEMPT</span>             <span class="n">POD</span> <span class="n">ID</span>              <span class="n">POD</span>
<span class="n">fd65e2a037600</span>       <span class="mi">2</span><span class="n">ae1ba6417cbc</span>       <span class="mi">16</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Running</span>             <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>                <span class="mi">0</span>                   <span class="mi">173</span><span class="n">ffdaeefab9</span>       <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">vwqsn</span>
<span class="mi">5922644848149</span>       <span class="mi">3</span><span class="n">a5aa3a515f5d</span>       <span class="mi">16</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Running</span>             <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span>            <span class="mi">0</span>                   <span class="mf">0952e1399</span><span class="n">e340</span>       <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span>
<span class="mf">58e48</span><span class="n">e8bc6861</span>       <span class="mi">586</span><span class="n">c112956dfc</span>       <span class="mi">16</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Running</span>             <span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span>   <span class="mi">0</span>                   <span class="mi">424</span><span class="n">cc7a5a9bfc</span>       <span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span>
<span class="mi">901</span><span class="n">b1dc06eed1</span>       <span class="n">d521dd763e2e3</span>       <span class="mi">16</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="n">Running</span>             <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>            <span class="mi">0</span>                   <span class="mi">7249</span><span class="n">ac0122d31</span>       <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>以上的排查可以看到 <code class="docutils literal notranslate"><span class="pre">z-k8s-m-1</span></code> 服务器上各个容器以及pods是运行正常的</p>
<ul>
<li><p>检查容器日志，例如检查 apiserver 容器日志:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">crictl</span> <span class="n">logs</span> <span class="mi">901</span><span class="n">b1dc06eed1</span>
</pre></div>
</div>
</li>
</ul>
<p>未发现报错，看起来 apiserver 运行正常</p>
<p>万般无奈，我再次 google 了一下，终于 <code class="docutils literal notranslate"><span class="pre">蚌埠住了</span></code> :</p>
<figure class="align-default">
<img alt="../../../../_images/marmot.gif" src="../../../../_images/marmot.gif" />
</figure>
<p><code class="docutils literal notranslate"><span class="pre">Unable</span> <span class="pre">to</span> <span class="pre">connect</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">server:</span> <span class="pre">Forbidden</span></code> 报错原因很简单:  <code class="docutils literal notranslate"><span class="pre">z-k8s-m-1</span></code> <strong>设置了http代理</strong></p>
<p>原来，在最初为了翻墙下载google仓库文件，我配置了 <a class="reference internal" href="../../../../web/curl/curl_proxy.html#curl-proxy"><span class="std std-ref">curl代理</span></a> ，原来报错信息是因为代理服务器拒绝导致的。多么可笑的失误啊!!!</p>
<p>简单注释掉代理配置的环境变量就顺利可以执行 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> 了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unset</span> <span class="n">http_proxy</span>
<span class="n">unset</span> <span class="n">https_proxy</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>不过，也别灰心…</p>
<p>这一周的折腾，至少对Kubernetes的 <a class="reference internal" href="../../../container_runtimes/index.html#container-runtimes"><span class="std std-ref">Kubernetes 容器运行时(Container Runtimes)</span></a> 等新技术有了进一步了解，也顺带学习了一些相关技术…不放弃</p>
</div>
<ul>
<li><p>现在终于能够通过 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> 管理新部署的集群了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">nodes</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>        <span class="n">STATUS</span>     <span class="n">ROLES</span>           <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">z</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span>   <span class="n">NotReady</span>   <span class="n">control</span><span class="o">-</span><span class="n">plane</span>   <span class="mi">18</span><span class="n">h</span>   <span class="n">v1</span><span class="mf">.24.2</span>
</pre></div>
</div>
<ul>
<li><p>检查 pods</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
</li>
</ul>
<p>此时输出:</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">没有安装网络前无法启动coredns，此时 kubectl get pods 输出</span><a class="headerlink" href="#id16" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>NAME                                READY   STATUS    RESTARTS   AGE   IP              NODE        NOMINATED NODE   READINESS GATES
coredns-6d4b75cb6d-jnfmj            <span class="m">0</span>/1     Pending   <span class="m">0</span>          18h   &lt;none&gt;          &lt;none&gt;      &lt;none&gt;           &lt;none&gt;
coredns-6d4b75cb6d-nm5fz            <span class="m">0</span>/1     Pending   <span class="m">0</span>          18h   &lt;none&gt;          &lt;none&gt;      &lt;none&gt;           &lt;none&gt;
kube-apiserver-z-k8s-m-1            <span class="m">1</span>/1     Running   <span class="m">0</span>          18h   <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-controller-manager-z-k8s-m-1   <span class="m">1</span>/1     Running   <span class="m">0</span>          18h   <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-proxy-vwqsn                    <span class="m">1</span>/1     Running   <span class="m">0</span>          18h   <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-scheduler-z-k8s-m-1            <span class="m">1</span>/1     Running   <span class="m">0</span>          18h   <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>目前还有2个问题没有解决:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">z-k8s-m-1</span></code> 节点状态是 <code class="docutils literal notranslate"><span class="pre">NotReady</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">coredns</span></code> 管控pods无法启动(网络没有配置)</p>
<ul>
<li><p>这个问题我之前在 <a class="reference internal" href="../../bootstrap_kubernetes_single/single_master_k8s.html#single-master-k8s"><span class="std std-ref">创建单一控制平面(单master)集群</span></a> 已经有经验，只要为Kubernetes集群安装正确的网络接口即可启动容器</p></li>
<li><p>请注意，Kubernetes集群的3大组件 <code class="docutils literal notranslate"><span class="pre">apiserver</span></code> / <code class="docutils literal notranslate"><span class="pre">scheduler</span></code> / <code class="docutils literal notranslate"><span class="pre">controller-manager</span></code> 都是使用物理主机的IP地址 <code class="docutils literal notranslate"><span class="pre">192.168.6.101</span></code> ，也就是说，即使没有安装网络接口组件这3个管控组件也是能够启动的；这也是为何在 <code class="docutils literal notranslate"><span class="pre">kubeadm-config.yaml</span></code> 配置的 <code class="docutils literal notranslate"><span class="pre">controlPlaneEndpoint</span></code> 项域名 <code class="docutils literal notranslate"><span class="pre">z-k8s-api.staging.huatai.me</span></code> 就是指向物理主机IP地址的解析</p></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="cilium">
<h2>安装 <a class="reference internal" href="../../../network/cilium/index.html#cilium"><span class="std std-ref">Cilium网络</span></a><a class="headerlink" href="#cilium" title="Permalink to this heading">¶</a></h2>
<p>需要注意，针对 <a class="reference internal" href="../../etcd/priv_deploy_etcd_cluster_with_tls_auth.html#priv-deploy-etcd-cluster-with-tls-auth"><span class="std std-ref">私有云部署TLS认证的etcd集群</span></a> (扩展外部etcd)需要采用 <a class="reference internal" href="../../../network/cilium/cilium_install_with_external_etcd.html#cilium-install-with-external-etcd"><span class="std std-ref">在扩展etcd环境安装cilium</span></a> :</p>
<ul class="simple">
<li><p>首先在节点安装 <a class="reference internal" href="../../helm.html#helm"><span class="std std-ref">Helm - Kubernetes包管理器</span></a> :</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">在Linux平台安装helm</span><a class="headerlink" href="#id17" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://get.helm.sh/helm-v3.9.1-linux-amd64.tar.gz
tar -zxvf helm-v3.9.1-linux-amd64.tar.gz
sudo mv linux-amd64/helm /usr/local/bin/helm
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>设置cilium Helm仓库:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">设置cilium Helm仓库</span><a class="headerlink" href="#id18" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm repo add cilium https://helm.cilium.io/
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>通过 <a class="reference internal" href="../../helm.html#helm"><span class="std std-ref">Helm - Kubernetes包管理器</span></a> 部署Cilium:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">为cilium配置访问etcd的Kubernetes secret，安装cilium采用SSL模式访问etcd</span><a class="headerlink" href="#id19" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">VERSION</span><span class="o">=</span><span class="m">1</span>.11.7

<span class="nv">ETCD_0_IP</span><span class="o">=</span><span class="m">192</span>.168.6.204
<span class="nv">ETCD_1_IP</span><span class="o">=</span><span class="m">192</span>.168.6.205
<span class="nv">ETCD_2_IP</span><span class="o">=</span><span class="m">192</span>.168.6.206

kubectl create secret generic -n kube-system cilium-etcd-secrets <span class="se">\</span>
    --from-file<span class="o">=</span>etcd-client-ca.crt<span class="o">=</span>/etc/kubernetes/pki/etcd/ca.crt <span class="se">\</span>
    --from-file<span class="o">=</span>etcd-client.key<span class="o">=</span>/etc/kubernetes/pki/apiserver-etcd-client.key <span class="se">\</span>
    --from-file<span class="o">=</span>etcd-client.crt<span class="o">=</span>/etc/kubernetes/pki/apiserver-etcd-client.crt

helm install cilium cilium/cilium --version <span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span> <span class="se">\</span>
  --namespace kube-system <span class="se">\</span>
  --set etcd.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  --set etcd.ssl<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  --set <span class="s2">&quot;etcd.endpoints[0]=https://</span><span class="si">${</span><span class="nv">ETCD_0_IP</span><span class="si">}</span><span class="s2">:2379&quot;</span> <span class="se">\</span>
  --set <span class="s2">&quot;etcd.endpoints[1]=https://</span><span class="si">${</span><span class="nv">ETCD_1_IP</span><span class="si">}</span><span class="s2">:2379&quot;</span> <span class="se">\</span>
  --set <span class="s2">&quot;etcd.endpoints[2]=https://</span><span class="si">${</span><span class="nv">ETCD_2_IP</span><span class="si">}</span><span class="s2">:2379&quot;</span>
</pre></div>
</div>
</div>
<ul>
<li><p>此时，在安装了 cilium 这样的 CNI 之后，之前部署过程中没有运行起来的coredns容器就能够分配IP地址并运行起来:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">安装cilium CNI网络之后coredns就可以运行，此时 kubectl get pods 输出可以看到所有pods已分配IP并运行</span><a class="headerlink" href="#id20" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>NAME                                READY   STATUS    RESTARTS   AGE     IP              NODE        NOMINATED NODE   READINESS GATES
cilium-7c5nv                        <span class="m">1</span>/1     Running   <span class="m">0</span>          8m40s   <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
cilium-operator-68dffdc9f7-cqvqr    <span class="m">1</span>/1     Running   <span class="m">0</span>          8m40s   <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
cilium-operator-68dffdc9f7-rph4w    <span class="m">0</span>/1     Pending   <span class="m">0</span>          8m40s   &lt;none&gt;          &lt;none&gt;      &lt;none&gt;           &lt;none&gt;
coredns-6d4b75cb6d-jnfmj            <span class="m">1</span>/1     Running   <span class="m">0</span>          25h     <span class="m">10</span>.0.0.241      z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
coredns-6d4b75cb6d-nm5fz            <span class="m">1</span>/1     Running   <span class="m">0</span>          25h     <span class="m">10</span>.0.0.141      z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-apiserver-z-k8s-m-1            <span class="m">1</span>/1     Running   <span class="m">0</span>          25h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-controller-manager-z-k8s-m-1   <span class="m">1</span>/1     Running   <span class="m">0</span>          25h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-proxy-vwqsn                    <span class="m">1</span>/1     Running   <span class="m">0</span>          25h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-scheduler-z-k8s-m-1            <span class="m">1</span>/1     Running   <span class="m">0</span>          25h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
</pre></div>
</div>
</div>
<ul class="simple">
<li><p>安装cilium客户端:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">安装cilium CLI</span><a class="headerlink" href="#id21" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
sha256sum --check cilium-linux-amd64.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
rm cilium-linux-amd64.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
</pre></div>
</div>
</div>
<ul>
<li><p>检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cilium</span> <span class="n">status</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>至此，已初步完成了管控节点安装，接下来就是添加更多管控节点，以及增加工作节点。这个操作可以从最初 <code class="docutils literal notranslate"><span class="pre">kubeadmin</span> <span class="pre">init</span></code> 输出的提示信息中获取(如果你当时保存了输出信息)</p>
</div>
</section>
<section id="id3">
<h2>添加第二个管控节点<a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>按照 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 输出信息，在第二个管控节点 <code class="docutils literal notranslate"><span class="pre">z-k8s-m-2</span></code> 上执行节点添加:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">kubeadm join添加control-plane节点</span><a class="headerlink" href="#id22" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm join z-k8s-api.staging.huatai.me:6443 --token &lt;token&gt; <span class="se">\</span>
      --discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span class="se">\</span>
      --control-plane --certificate-key &lt;hash&gt;
</pre></div>
</div>
</div>
<section id="id4">
<h3>管控节点添加排查<a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> 初始化集群时候生成的 <code class="docutils literal notranslate"><span class="pre">certificate</span></code> 和 <code class="docutils literal notranslate"><span class="pre">token</span></code> (24小时) 都是有一定有效期限。所以如果在初始化之后，再经过较长时间才添加管控节点和工作节点，就会遇到 <code class="docutils literal notranslate"><span class="pre">token</span></code> 和 <code class="docutils literal notranslate"><span class="pre">certificate</span></code> 相关错误。此时，需要重新上传certifiate和重新生成token。并且，对于使用 external etcd，还需要通过 <code class="docutils literal notranslate"><span class="pre">kubeadm-config.yaml</span></code> 传递etcd参数。</p>
</div>
<p>我在执行 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span></code> 管控节点添加遇到报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">error</span> <span class="n">execution</span> <span class="n">phase</span> <span class="n">preflight</span><span class="p">:</span> <span class="n">couldn</span><span class="s1">&#39;t validate the identity of the API Server: could not find a JWS signature in the cluster-info ConfigMap for token ID &quot;XXXXXXX&quot;</span>
<span class="n">To</span> <span class="n">see</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">trace</span> <span class="n">of</span> <span class="n">this</span> <span class="n">error</span> <span class="n">execute</span> <span class="k">with</span> <span class="o">--</span><span class="n">v</span><span class="o">=</span><span class="mi">5</span> <span class="ow">or</span> <span class="n">higher</span>
</pre></div>
</div>
<p>上述报错是因为原有的token已经过期，所以需要重新生成:</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">kubeadm token create命令重新生成token(解决初始化集群时token过期问题)</span><a class="headerlink" href="#id23" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm token create --print-join-command
</pre></div>
</div>
</div>
<ul>
<li><p>然后再次执行 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 命令，但是把tokern替换成新生成的有效token(依然保留之前的 <code class="docutils literal notranslate"><span class="pre">--certificate-key</span></code> )，此时会提示 <code class="docutils literal notranslate"><span class="pre">kubeadm-certs</span></code> 没有找到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
[download-certs] Downloading the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace
error execution phase control-plane-prepare/download-certs: error downloading certs: error downloading the secret: Secret &quot;kubeadm-certs&quot; was not found in the &quot;kube-system&quot; Namespace. This Secret might have expired. Please, run `kubeadm init phase upload-certs --upload-certs` on a control plane to generate a new one
To see the stack trace of this error execute with --v=5 or higher
</pre></div>
</div>
</li>
</ul>
<p>根据提示，实际上 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">token</span> <span class="pre">create</span></code> 只是针对worker节点，对于管控节点，还需要重新上传certificates( 参考 <a class="reference external" href="https://stackoverflow.com/questions/51126164/how-do-i-find-the-join-command-for-kubeadm-on-the-master">How do I find the join command for kubeadm on the master?</a> )。也就是对于token失效的时候，新加入管控节点需要有2步:</p>
<ul class="simple">
<li><p>在已经工作的管控节点上重新上传certifiates:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">kubeadm init 重新上传证书</span><a class="headerlink" href="#id24" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo kubeadm init phase upload-certs --upload-certs
</pre></div>
</div>
</div>
<p>此时提示重新生成了证书:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">upload</span><span class="o">-</span><span class="n">certs</span><span class="p">]</span> <span class="n">Storing</span> <span class="n">the</span> <span class="n">certificates</span> <span class="ow">in</span> <span class="n">Secret</span> <span class="s2">&quot;kubeadm-certs&quot;</span> <span class="ow">in</span> <span class="n">the</span> <span class="s2">&quot;kube-system&quot;</span> <span class="n">Namespace</span>
<span class="p">[</span><span class="n">upload</span><span class="o">-</span><span class="n">certs</span><span class="p">]</span> <span class="n">Using</span> <span class="n">certificate</span> <span class="n">key</span><span class="p">:</span>
<span class="n">XXXXXXXXXX</span>
</pre></div>
</div>
<ul class="simple">
<li><p>然后执行重建toke命令(前面执行过可以不用重复):</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">kubeadm token create命令重新生成token(解决初始化集群时token过期问题)</span><a class="headerlink" href="#id25" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm token create --print-join-command
</pre></div>
</div>
</div>
<ul>
<li><p>可以执行检查token命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">token</span> <span class="nb">list</span>
</pre></div>
</div>
</li>
</ul>
<p>就显示出刚才重新生成的token</p>
<ul>
<li><p>将生成的 <code class="docutils literal notranslate"><span class="pre">certificate</span></code> 拼接到 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span></code> 命令(使用新生成的token)再次添加管控节点。然而还是报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">download</span><span class="o">-</span><span class="n">certs</span><span class="p">]</span> <span class="n">Downloading</span> <span class="n">the</span> <span class="n">certificates</span> <span class="ow">in</span> <span class="n">Secret</span> <span class="s2">&quot;kubeadm-certs&quot;</span> <span class="ow">in</span> <span class="n">the</span> <span class="s2">&quot;kube-system&quot;</span> <span class="n">Namespace</span>
<span class="n">error</span> <span class="n">execution</span> <span class="n">phase</span> <span class="n">control</span><span class="o">-</span><span class="n">plane</span><span class="o">-</span><span class="n">prepare</span><span class="o">/</span><span class="n">download</span><span class="o">-</span><span class="n">certs</span><span class="p">:</span> <span class="n">error</span> <span class="n">downloading</span> <span class="n">certs</span><span class="p">:</span> <span class="n">the</span> <span class="n">Secret</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">include</span> <span class="n">the</span> <span class="n">required</span> <span class="n">certificate</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">external</span><span class="o">-</span><span class="n">etcd</span><span class="o">.</span><span class="n">crt</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">etcd</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">crt</span>
<span class="n">To</span> <span class="n">see</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">trace</span> <span class="n">of</span> <span class="n">this</span> <span class="n">error</span> <span class="n">execute</span> <span class="k">with</span> <span class="o">--</span><span class="n">v</span><span class="o">=</span><span class="mi">5</span> <span class="ow">or</span> <span class="n">higher</span>
</pre></div>
</div>
</li>
</ul>
<p>原来重新生成 <code class="docutils literal notranslate"><span class="pre">cartificate</span></code> 的默认命令是针对内部etcd的， <code class="docutils literal notranslate"><span class="pre">对于外部etcd，重新初始化证书还是要使用</span> <span class="pre">&quot;包含&quot;</span> <span class="pre">etcd配置信息的</span> <span class="pre">kubeadm-config.yaml</span></code> ( 参考 <a class="reference external" href="https://github.com/kubernetes/kubeadm/issues/1886">Control plane certs not working with external etcd #1886</a> )，即:</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">使用external etcd时，kubeadm init 重新上传证书需要使用 kubeadm-config.yaml</span><a class="headerlink" href="#id26" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo kubeadm init phase upload-certs --upload-certs --config kubeadm-config.yaml
</pre></div>
</div>
</div>
</section>
</section>
<section id="id5">
<h2>添加工作节点<a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>按照 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> 输出信息，在工作节点 <code class="docutils literal notranslate"><span class="pre">z-k8s-n-1</span></code> 等上执行:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">kubeadm join添加worker节点</span><a class="headerlink" href="#id27" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubeadm join z-k8s-api.staging.huatai.me:6443 --token &lt;token&gt; <span class="se">\</span>
        --discovery-token-ca-cert-hash &lt;hash&gt;
</pre></div>
</div>
</div>
</section>
<section id="id6">
<h2>完成检查<a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>最终完成后检查 <code class="docutils literal notranslate"><span class="pre">nodes</span></code> 和 <code class="docutils literal notranslate"><span class="pre">podes</span></code> 得到完整列表:</p></li>
</ul>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">完成扩展etcd的K8s集群后检查kubectl get nodes</span><a class="headerlink" href="#id28" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get nodes -o wide
NAME        STATUS   ROLES           AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
z-k8s-m-1   Ready    control-plane   35h     v1.24.2   <span class="m">192</span>.168.6.101   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-121-generic   containerd://1.6.6
z-k8s-m-2   Ready    control-plane   26m     v1.24.2   <span class="m">192</span>.168.6.102   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-121-generic   containerd://1.6.6
z-k8s-m-3   Ready    control-plane   21m     v1.24.2   <span class="m">192</span>.168.6.103   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-121-generic   containerd://1.6.6
z-k8s-n-1   Ready    &lt;none&gt;          6m10s   v1.24.2   <span class="m">192</span>.168.6.111   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-110-generic   containerd://1.6.6
z-k8s-n-2   Ready    &lt;none&gt;          4m10s   v1.24.2   <span class="m">192</span>.168.6.112   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-110-generic   containerd://1.6.6
z-k8s-n-3   Ready    &lt;none&gt;          4m1s    v1.24.2   <span class="m">192</span>.168.6.113   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-110-generic   containerd://1.6.6
z-k8s-n-4   Ready    &lt;none&gt;          3m55s   v1.24.2   <span class="m">192</span>.168.6.114   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-110-generic   containerd://1.6.6
z-k8s-n-5   Ready    &lt;none&gt;          3m51s   v1.24.2   <span class="m">192</span>.168.6.115   &lt;none&gt;        Ubuntu <span class="m">20</span>.04.4 LTS   <span class="m">5</span>.4.0-110-generic   containerd://1.6.6
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">完成扩展etcd的K8s集群后检查kubectl get pods</span><a class="headerlink" href="#id29" title="永久链接至代码">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -n kube-system -o wide
NAME                                READY   STATUS    RESTARTS   AGE     IP              NODE        NOMINATED NODE   READINESS GATES
cilium-4mrgm                        <span class="m">1</span>/1     Running   <span class="m">0</span>          5m53s   <span class="m">192</span>.168.6.114   z-k8s-n-4   &lt;none&gt;           &lt;none&gt;
cilium-5v6sn                        <span class="m">1</span>/1     Running   <span class="m">0</span>          5m49s   <span class="m">192</span>.168.6.115   z-k8s-n-5   &lt;none&gt;           &lt;none&gt;
cilium-7c5nv                        <span class="m">1</span>/1     Running   <span class="m">0</span>          10h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
cilium-dx68f                        <span class="m">1</span>/1     Running   <span class="m">0</span>          8m8s    <span class="m">192</span>.168.6.111   z-k8s-n-1   &lt;none&gt;           &lt;none&gt;
cilium-ln686                        <span class="m">1</span>/1     Running   <span class="m">0</span>          5m59s   <span class="m">192</span>.168.6.113   z-k8s-n-3   &lt;none&gt;           &lt;none&gt;
cilium-operator-68dffdc9f7-cqvqr    <span class="m">1</span>/1     Running   <span class="m">0</span>          10h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
cilium-operator-68dffdc9f7-rph4w    <span class="m">1</span>/1     Running   <span class="m">0</span>          10h     <span class="m">192</span>.168.6.102   z-k8s-m-2   &lt;none&gt;           &lt;none&gt;
cilium-p9jtz                        <span class="m">1</span>/1     Running   <span class="m">0</span>          27m     <span class="m">192</span>.168.6.102   z-k8s-m-2   &lt;none&gt;           &lt;none&gt;
cilium-pkqfj                        <span class="m">1</span>/1     Running   <span class="m">0</span>          23m     <span class="m">192</span>.168.6.103   z-k8s-m-3   &lt;none&gt;           &lt;none&gt;
cilium-xn4gf                        <span class="m">1</span>/1     Running   <span class="m">0</span>          6m8s    <span class="m">192</span>.168.6.112   z-k8s-n-2   &lt;none&gt;           &lt;none&gt;
coredns-6d4b75cb6d-jnfmj            <span class="m">1</span>/1     Running   <span class="m">0</span>          35h     <span class="m">10</span>.0.0.241      z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
coredns-6d4b75cb6d-nm5fz            <span class="m">1</span>/1     Running   <span class="m">0</span>          35h     <span class="m">10</span>.0.0.141      z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-apiserver-z-k8s-m-1            <span class="m">1</span>/1     Running   <span class="m">0</span>          35h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-apiserver-z-k8s-m-2            <span class="m">1</span>/1     Running   <span class="m">0</span>          27m     <span class="m">192</span>.168.6.102   z-k8s-m-2   &lt;none&gt;           &lt;none&gt;
kube-apiserver-z-k8s-m-3            <span class="m">1</span>/1     Running   <span class="m">0</span>          23m     <span class="m">192</span>.168.6.103   z-k8s-m-3   &lt;none&gt;           &lt;none&gt;
kube-controller-manager-z-k8s-m-1   <span class="m">1</span>/1     Running   <span class="m">0</span>          35h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-controller-manager-z-k8s-m-2   <span class="m">1</span>/1     Running   <span class="m">0</span>          27m     <span class="m">192</span>.168.6.102   z-k8s-m-2   &lt;none&gt;           &lt;none&gt;
kube-controller-manager-z-k8s-m-3   <span class="m">1</span>/1     Running   <span class="m">0</span>          23m     <span class="m">192</span>.168.6.103   z-k8s-m-3   &lt;none&gt;           &lt;none&gt;
kube-proxy-2njjl                    <span class="m">1</span>/1     Running   <span class="m">0</span>          5m59s   <span class="m">192</span>.168.6.113   z-k8s-n-3   &lt;none&gt;           &lt;none&gt;
kube-proxy-fzrz7                    <span class="m">1</span>/1     Running   <span class="m">0</span>          8m8s    <span class="m">192</span>.168.6.111   z-k8s-n-1   &lt;none&gt;           &lt;none&gt;
kube-proxy-gvlwt                    <span class="m">1</span>/1     Running   <span class="m">0</span>          6m8s    <span class="m">192</span>.168.6.112   z-k8s-n-2   &lt;none&gt;           &lt;none&gt;
kube-proxy-nr5wd                    <span class="m">1</span>/1     Running   <span class="m">0</span>          5m53s   <span class="m">192</span>.168.6.114   z-k8s-n-4   &lt;none&gt;           &lt;none&gt;
kube-proxy-tg794                    <span class="m">1</span>/1     Running   <span class="m">0</span>          5m49s   <span class="m">192</span>.168.6.115   z-k8s-n-5   &lt;none&gt;           &lt;none&gt;
kube-proxy-tv4sx                    <span class="m">1</span>/1     Running   <span class="m">0</span>          27m     <span class="m">192</span>.168.6.102   z-k8s-m-2   &lt;none&gt;           &lt;none&gt;
kube-proxy-vwqsn                    <span class="m">1</span>/1     Running   <span class="m">0</span>          35h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-proxy-z8xj7                    <span class="m">1</span>/1     Running   <span class="m">0</span>          23m     <span class="m">192</span>.168.6.103   z-k8s-m-3   &lt;none&gt;           &lt;none&gt;
kube-scheduler-z-k8s-m-1            <span class="m">1</span>/1     Running   <span class="m">0</span>          35h     <span class="m">192</span>.168.6.101   z-k8s-m-1   &lt;none&gt;           &lt;none&gt;
kube-scheduler-z-k8s-m-2            <span class="m">1</span>/1     Running   <span class="m">0</span>          27m     <span class="m">192</span>.168.6.102   z-k8s-m-2   &lt;none&gt;           &lt;none&gt;
kube-scheduler-z-k8s-m-3            <span class="m">1</span>/1     Running   <span class="m">0</span>          23m     <span class="m">192</span>.168.6.103   z-k8s-m-3   &lt;none&gt;           &lt;none&gt;
</pre></div>
</div>
</div>
<p>集群创建成功!!!</p>
</section>
<section id="id7">
<h2>参考<a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/">Creating Highly Available Clusters with kubeadm</a> 官方文档综合了 <a class="reference internal" href="../ha_k8s_stacked.html#ha-k8s-stacked"><span class="std std-ref">堆叠型管控/etcd节点高可用集群</span></a> 和 <a class="reference internal" href="../ha_k8s_external.html#ha-k8s-external"><span class="std std-ref">扩展etcd节点高可用集群</span></a> ，我在本文实践中拆解了 <a class="reference internal" href="../ha_k8s_external.html#ha-k8s-external"><span class="std std-ref">扩展etcd节点高可用集群</span></a></p></li>
<li><p><a class="reference external" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/#network-plugin-requirements">Network Plugins</a></p></li>
<li><p><a class="reference external" href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/">cilium Quick Installation</a></p></li>
<li><p><a class="reference external" href="https://kubesphere.com.cn/forum/d/5945-kubespherekubectlunable-to-connect-to-the-server-forbidden">kubesphere主节点执行kubectl命令提示Unable to connect to the server: Forbidden</a> 感谢这位网友提供的信息: <code class="docutils literal notranslate"><span class="pre">找到问题了，是设置了http代理的问题...unset</span> <span class="pre">http_proxy...通过master节点30880端口访问是没有问题的，只是执行在master节点执行kubectl命令报错，在worker节点上执行kubectl命令没有任何问题</span></code></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ha_k8s_kubeadm.html" class="btn btn-neutral float-left" title="高可用Kubernetes集群kubeadm" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="kubeadm_reset.html" class="btn btn-neutral float-right" title="kubeadm集群重置" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>