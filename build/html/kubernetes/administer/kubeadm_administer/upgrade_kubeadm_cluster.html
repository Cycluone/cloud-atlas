

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>升级kubeadm集群 &mdash; Cloud Atlas 0.1 文档</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../copyright.html" />
    <link rel="next" title="删除kubeadm构建的Kubernetes集群" href="delete_kubeadm_cluster.html" />
    <link rel="prev" title="使用kubeadm管理Kubernetes" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Kubernetes Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../kubernetes_overview.html">Kubernetes概览</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup_prepare/index.html">Kubernetes起步准备</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../startup/index.html">Kubernetes快速起步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/index.html">Kubernetes概念辨析</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment/index.html">Kubernetes部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../manage_object/index.html">Kubernetes管理对象</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Kubernetes管理</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../kubernetes_dashboard.html">Kubernetes仪表盘</a></li>
<li class="toctree-l3"><a class="reference internal" href="../configure_pods_and_containers.html">配置pod和容器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../delete_cluster.html">删除Kubernetes集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drain_node.html">安全地清空一个Kubernetes节点</a></li>
<li class="toctree-l3"><a class="reference internal" href="../remove_node.html">从Kubernetes集群删除节点</a></li>
<li class="toctree-l3"><a class="reference internal" href="../set_k8s_worker_internal_ip.html">指定Kubernetes工作节点内网IP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">使用kubeadm管理Kubernetes</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">升级kubeadm集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="delete_kubeadm_cluster.html">删除kubeadm构建的Kubernetes集群</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../etcd/index.html">Kubernetes Etcd管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../federation/index.html">Kubernetes Federation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../access_application/index.html">Kubernetes访问应用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../configure/index.html">Kubernetes 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../network/index.html">Kubernetes网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../in_action/index.html">Kubernetes实践</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../backup/index.html">Kubernetes备份与恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../storage/index.html">Kubernetes存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../production/index.html">Kubernetes生产环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../service_mesh/index.html">Service Mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../istio/index.html">Istio服务网格</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../serverless/index.html">Kubernetes Severless</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ci_cd/index.html">Kubernetes持续集成和持续部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../monitor/index.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../self_healing/index.html">Kubernetes 自愈</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debug/index.html">Kubernetes排查</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../knative/index.html">Knative - Serverless计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">Kubernetes安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../virtual/index.html">Kubernetes结合虚拟化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arm/index.html">ARM架构Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../k8s_android/index.html">Kubernetes运行Android</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../k3s/index.html">K3s - 轻量级Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cloud/index.html">Kubernetes云厂商</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../develop/index.html">Kubernetes开发</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postgresql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Kubernetes Atlas</a> &raquo;</li>
        
          <li><a href="../index.html">Kubernetes管理</a> &raquo;</li>
        
          <li><a href="index.html">使用kubeadm管理Kubernetes</a> &raquo;</li>
        
      <li>升级kubeadm集群</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/kubernetes/administer/kubeadm_administer/upgrade_kubeadm_cluster.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="kubeadm">
<span id="upgrade-kubeadm-cluster"></span><h1>升级kubeadm集群<a class="headerlink" href="#kubeadm" title="永久链接至标题">¶</a></h1>
<p>在 <a class="reference internal" href="../../arm/arm_k8s_deploy.html#arm-k8s-deploy"><span class="std std-ref">部署ARM架构Kubernetes</span></a> ，想要将最新安装的 <a class="reference internal" href="../../../machine_learning/jetson/jetson_nano.html#jetson-nano"><span class="std std-ref">Jetson Nano开发套件概览</span></a> 系统加入到ARM Kubernetes集群，结果发现，之前构建的Kubernetes集群版本还停留在 v1.19.4 上，最新的kubeadm已不支持加入低版本集群:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">error</span> <span class="n">execution</span> <span class="n">phase</span> <span class="n">preflight</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">the</span> <span class="n">kubeadm</span><span class="o">-</span><span class="n">config</span> <span class="n">ConfigMap</span><span class="p">:</span>
<span class="n">this</span> <span class="n">version</span> <span class="n">of</span> <span class="n">kubeadm</span> <span class="n">only</span> <span class="n">supports</span> <span class="n">deploying</span> <span class="n">clusters</span> <span class="k">with</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="mf">1.20</span><span class="o">.</span><span class="mf">0.</span>
<span class="n">Current</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>
<span class="n">To</span> <span class="n">see</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">trace</span> <span class="n">of</span> <span class="n">this</span> <span class="n">error</span> <span class="n">execute</span> <span class="k">with</span> <span class="o">--</span><span class="n">v</span><span class="o">=</span><span class="mi">5</span> <span class="ow">or</span> <span class="n">higher</span>
</pre></div>
</div>
<p>我们需要升级集群的管控平面版本。</p>
<section id="id1">
<h2>准备工作<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>检查集群信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</div>
</li>
</ul>
<p>输出信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Kubernetes</span> <span class="n">control</span> <span class="n">plane</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">6443</span>
<span class="n">KubeDNS</span> <span class="ow">is</span> <span class="n">running</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">6443</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">:</span><span class="n">dns</span><span class="o">/</span><span class="n">proxy</span>
</pre></div>
</div>
<ul>
<li><p>dump集群详细信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span> <span class="n">dump</span>
</pre></div>
</div>
</li>
</ul>
<section id="id2">
<h3>重要信息<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>务必备份所有重要组件: <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">upgrade</span></code> 不会影响工作负载，只会涉及kubernetes内部组件，为防止万一，请完成 <a class="reference internal" href="../../backup/index.html#k8s-backup"><span class="std std-ref">Kubernetes备份与恢复</span></a> (演练)</p></li>
<li><p>对kubelet做版本升级需要 <a class="reference internal" href="../drain_node.html#drain-node"><span class="std std-ref">安全地清空一个Kubernetes节点</span></a> ，对于管控面节点，可能运行 CoreDNS Pods或者其他非常重要的负载</p></li>
<li><p>升级后，因为容器spec的哈希值已经更改，所以 <code class="docutils literal notranslate"><span class="pre">所有容器都会被重新启动</span></code></p></li>
</ul>
</section>
</section>
<section id="id3">
<h2>升级控制平面节点<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">控制平面节点升级过程应该每次处理一个节点</span></code></p>
<p>选择要升级的控制面节点，该节点上必须拥有 <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/admin.conf</span></code> 文件</p>
<section id="kubeadm-upgrade">
<h3>执行 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">upgrade</span></code><a class="headerlink" href="#kubeadm-upgrade" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>升级 <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">unhold</span> <span class="n">kubeadm</span> <span class="o">&amp;&amp;</span> \
<span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.21</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="mi">00</span> <span class="o">&amp;&amp;</span> \
<span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubeadm</span>
</pre></div>
</div>
</li>
</ul>
<p>或者:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> \
<span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">change</span><span class="o">-</span><span class="n">held</span><span class="o">-</span><span class="n">packages</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.21</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="mi">00</span>
</pre></div>
</div>
<ul>
<li><p>验证 <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> 版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">version</span>
</pre></div>
</div>
</li>
<li><p>验证升级计划:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">plan</span>
</pre></div>
</div>
</li>
</ul>
<p>上述命令检查集群是否可以升级，并取回要升级的目标版本</p>
</section>
</section>
<section id="id4">
<h2>版本差异困境<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>锁定kubernetes软件版本 <a class="reference internal" href="../../deployment/bootstrap_kubernetes/index.html#bootstrap-kubernetes"><span class="std std-ref">Kubernetes集群引导</span></a> 和 <a class="reference internal" href="../../arm/arm_k8s_deploy.html#arm-k8s-deploy"><span class="std std-ref">部署ARM架构Kubernetes</span></a> 有一步不起眼的步骤，锁定kubernetes软件版本</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">unhold</span> <span class="n">kubelet</span> <span class="n">kubeadm</span> <span class="n">kubectl</span>
</pre></div>
</div>
<p>这个步骤实际上非常重要，如果不锁定版本，在不断的系统更新中，kubernetes软件版本会不断升级，但是由于没有对应自动化升级管控平面软件功能，导致管控平面运行的软件版本始终停留在最初版本，逐渐和后续安装软件包形成较大的无法兼容的版本差异。就会导致很多意想不到的错误，例如，无法管理节点。</p>
<p>我在开发测试 <a class="reference internal" href="../../arm/arm_k8s_deploy.html#arm-k8s-deploy"><span class="std std-ref">部署ARM架构Kubernetes</span></a> 时解除了 <code class="docutils literal notranslate"><span class="pre">hold</span></code> ，原本以为开发测试环境无需太关注稳定性，但是，实践发现Kubernetes每个 <code class="docutils literal notranslate"><span class="pre">Minor</span></code> 版本之间是不兼容的，需要人工做版本升级才能维持稳定。</p>
<ul>
<li><p>检查版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">version</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到输出信息显示，服务器端版本是低版本 <code class="docutils literal notranslate"><span class="pre">1.19.4</span></code> 而客户端版本是高版本 <code class="docutils literal notranslate"><span class="pre">1.21.3</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Client</span> <span class="n">Version</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;21&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.21.3&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;ca643a4d1f7bfe34773c74f79527be4afd95bf39&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2021-07-15T21:04:39Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.16.6&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/arm64&quot;</span><span class="p">}</span>
<span class="n">Server</span> <span class="n">Version</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;19&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.19.4&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;d360454c9bcd1634cf4cc52d1867af5491dc9c5f&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2020-11-11T13:09:17Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.15.2&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/arm64&quot;</span><span class="p">}</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">version</span> <span class="n">difference</span> <span class="n">between</span> <span class="n">client</span> <span class="p">(</span><span class="mf">1.21</span><span class="p">)</span> <span class="ow">and</span> <span class="n">server</span> <span class="p">(</span><span class="mf">1.19</span><span class="p">)</span> <span class="n">exceeds</span> <span class="n">the</span> <span class="n">supported</span> <span class="n">minor</span> <span class="n">version</span> <span class="n">skew</span> <span class="n">of</span> <span class="o">+/-</span><span class="mi">1</span>
</pre></div>
</div>
<ul>
<li><p>此时，在服务器上输出加入节点命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">token</span> <span class="n">create</span> <span class="o">--</span><span class="nb">print</span><span class="o">-</span><span class="n">join</span><span class="o">-</span><span class="n">command</span>
</pre></div>
</div>
</li>
</ul>
<p>但是在加入节点上执行上述命令输出的 <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span> <span class="pre">192.168.6.11:6443</span> <span class="pre">--token</span> <span class="pre">XXXX</span> <span class="pre">--discovery-token-ca-cert-hash</span> <span class="pre">sha256:YYYY</span></code> 会出现如下报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">error</span> <span class="n">execution</span> <span class="n">phase</span> <span class="n">preflight</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">the</span> <span class="n">kubeadm</span><span class="o">-</span><span class="n">config</span> <span class="n">ConfigMap</span><span class="p">:</span>
<span class="n">this</span> <span class="n">version</span> <span class="n">of</span> <span class="n">kubeadm</span> <span class="n">only</span> <span class="n">supports</span> <span class="n">deploying</span> <span class="n">clusters</span> <span class="k">with</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="mf">1.20</span><span class="o">.</span><span class="mf">0.</span> <span class="n">Current</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>
<span class="n">To</span> <span class="n">see</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">trace</span> <span class="n">of</span> <span class="n">this</span> <span class="n">error</span> <span class="n">execute</span> <span class="k">with</span> <span class="o">--</span><span class="n">v</span><span class="o">=</span><span class="mi">5</span> <span class="ow">or</span> <span class="n">higher</span>
</pre></div>
</div>
<p>每个 <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> 版本只支持对上一版本的升级，而不能跨版本升级。例如，现在的客户端是 <code class="docutils literal notranslate"><span class="pre">1.21.x</span></code> 就只能升级 <code class="docutils literal notranslate"><span class="pre">1.20.x</span></code> 的服务器，而不能跨版本升级 <code class="docutils literal notranslate"><span class="pre">1.19.x</span></code> 的服务器。</p>
<p>为了解决这个困境，需要将整个集群 Kubernetes 软件版本回滚到 <code class="docutils literal notranslate"><span class="pre">1.20.x</span></code> ，然后升级 <code class="docutils literal notranslate"><span class="pre">1.19.x</span></code> 管控平面版本到同样的 <code class="docutils literal notranslate"><span class="pre">1.20.x</span></code> ，再滚动升级kubernetes软件包版本到 <code class="docutils literal notranslate"><span class="pre">1.21.x</span></code> ，最后再升级服务器版本。</p>
</section>
<section id="id5">
<h2>回滚版本<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>检查版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="nb">list</span> <span class="n">kubeadm</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span><span class="p">,</span><span class="n">now</span> <span class="mf">1.21</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span> <span class="p">[</span><span class="n">installed</span><span class="p">]</span>
<span class="n">N</span><span class="p">:</span> <span class="n">There</span> <span class="n">are</span> <span class="mi">214</span> <span class="n">additional</span> <span class="n">versions</span><span class="o">.</span> <span class="n">Please</span> <span class="n">use</span> <span class="n">the</span> <span class="s1">&#39;-a&#39;</span> <span class="n">switch</span> <span class="n">to</span> <span class="n">see</span> <span class="n">them</span><span class="o">.</span>
</pre></div>
</div>
<p>我们可以通过 <code class="docutils literal notranslate"><span class="pre">-a</span></code> 参数查看到所有可用版本(以便选择):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="nb">list</span> <span class="n">kubeadm</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
<p>输出如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span><span class="p">,</span><span class="n">now</span> <span class="mf">1.21</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span> <span class="p">[</span><span class="n">installed</span><span class="p">]</span>
<span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="mf">1.21</span><span class="o">.</span><span class="mi">2</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span>
<span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="mf">1.21</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span>
<span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="mf">1.21</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span>
<span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="mf">1.20</span><span class="o">.</span><span class="mi">9</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span>
<span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="mf">1.20</span><span class="o">.</span><span class="mi">8</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span>
<span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="mf">1.20</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span>
<span class="n">kubeadm</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">xenial</span> <span class="mf">1.20</span><span class="o">.</span><span class="mi">6</span><span class="o">-</span><span class="mi">00</span> <span class="n">arm64</span>
<span class="o">...</span>
</pre></div>
</div>
<ul>
<li><p>(根据需求)首先unhold软件版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">unhold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>
</pre></div>
</div>
</li>
<li><p>更新索引然后安装指定版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">update</span>
<span class="n">apt</span> <span class="n">install</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.20</span><span class="o">.</span><span class="mi">9</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubectl</span><span class="o">=</span><span class="mf">1.20</span><span class="o">.</span><span class="mi">9</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubelet</span><span class="o">=</span><span class="mf">1.20</span><span class="o">.</span><span class="mi">9</span><span class="o">-</span><span class="mi">00</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">downgrades</span>
<span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>
</pre></div>
</div>
</li>
<li><p>完成后检查节点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get nodes
NAME         STATUS     ROLES    AGE    VERSION
pi-master1   Ready      master   237d   v1.20.9
pi-worker1   Ready      &lt;none&gt;   234d   v1.21.3
pi-worker2   NotReady   &lt;none&gt;   234d   v1.21.3
zcloud       Ready      &lt;none&gt;   124d   v1.21.3
</pre></div>
</div>
</li>
</ul>
<p>可以看到 <code class="docutils literal notranslate"><span class="pre">pi-master1</span></code> 已经回滚到 <code class="docutils literal notranslate"><span class="pre">1.20.9</span></code> 版本</p>
<ul class="simple">
<li><p>同样我们回滚worker节点到 <code class="docutils literal notranslate"><span class="pre">1.20.9</span></code></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里管控节点回滚到 <code class="docutils literal notranslate"><span class="pre">1.20.9</span></code> 是因为当前服务器版本是 <code class="docutils literal notranslate"><span class="pre">1.19.3</span></code> ，可以通过管控节点的 <code class="docutils literal notranslate"><span class="pre">1.20.x</span></code> 来升级管控平面服务器端软件</p>
</div>
</section>
<section id="id6">
<h2>kubeadm upgrade<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>现在满足升级条件，我们开始进行管控平面节点升级</p>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code> 工作情况:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">version</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">version</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">version</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;20&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.20.9&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;7a576bc3935a6b555e33346fd73ad77c925e9e4a&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2021-07-15T21:00:30Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.15.14&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/arm64&quot;</span><span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>验证升级计划:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">plan</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">config</span><span class="p">]</span> <span class="n">Making</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">configuration</span> <span class="ow">is</span> <span class="n">correct</span><span class="p">:</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">config</span><span class="p">]</span> <span class="n">Reading</span> <span class="n">configuration</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">cluster</span><span class="o">...</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">config</span><span class="p">]</span> <span class="n">FYI</span><span class="p">:</span> <span class="n">You</span> <span class="n">can</span> <span class="n">look</span> <span class="n">at</span> <span class="n">this</span> <span class="n">config</span> <span class="n">file</span> <span class="k">with</span> <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
<span class="p">[</span><span class="n">preflight</span><span class="p">]</span> <span class="n">Running</span> <span class="n">pre</span><span class="o">-</span><span class="n">flight</span> <span class="n">checks</span><span class="o">.</span>
<span class="p">[</span><span class="n">upgrade</span><span class="p">]</span> <span class="n">Running</span> <span class="n">cluster</span> <span class="n">health</span> <span class="n">checks</span>
<span class="p">[</span><span class="n">upgrade</span><span class="p">]</span> <span class="n">Fetching</span> <span class="n">available</span> <span class="n">versions</span> <span class="n">to</span> <span class="n">upgrade</span> <span class="n">to</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">versions</span><span class="p">]</span> <span class="n">Cluster</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">versions</span><span class="p">]</span> <span class="n">kubeadm</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="n">I0725</span> <span class="mi">20</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">14.029402</span> <span class="mi">1222778</span> <span class="n">version</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">254</span><span class="p">]</span> <span class="n">remote</span> <span class="n">version</span> <span class="ow">is</span> <span class="n">much</span> <span class="n">newer</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">21.3</span><span class="p">;</span> <span class="n">falling</span> <span class="n">back</span> <span class="n">to</span><span class="p">:</span> <span class="n">stable</span><span class="o">-</span><span class="mf">1.20</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">versions</span><span class="p">]</span> <span class="n">Latest</span> <span class="n">stable</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">versions</span><span class="p">]</span> <span class="n">Latest</span> <span class="n">stable</span> <span class="n">version</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">versions</span><span class="p">]</span> <span class="n">Latest</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">v1</span><span class="o">.</span><span class="mi">19</span> <span class="n">series</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">versions</span><span class="p">]</span> <span class="n">Latest</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">v1</span><span class="o">.</span><span class="mi">19</span> <span class="n">series</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>

<span class="n">Components</span> <span class="n">that</span> <span class="n">must</span> <span class="n">be</span> <span class="n">upgraded</span> <span class="n">manually</span> <span class="n">after</span> <span class="n">you</span> <span class="n">have</span> <span class="n">upgraded</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="k">with</span> <span class="s1">&#39;kubeadm upgrade apply&#39;</span><span class="p">:</span>
<span class="n">COMPONENT</span>   <span class="n">CURRENT</span>       <span class="n">AVAILABLE</span>
<span class="n">kubelet</span>     <span class="mi">2</span> <span class="n">x</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>
            <span class="mi">2</span> <span class="n">x</span> <span class="n">v1</span><span class="o">.</span><span class="mf">21.3</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>

<span class="n">Upgrade</span> <span class="n">to</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">v1</span><span class="o">.</span><span class="mi">19</span> <span class="n">series</span><span class="p">:</span>

<span class="n">COMPONENT</span>                 <span class="n">CURRENT</span>    <span class="n">AVAILABLE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>            <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>
<span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>
<span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span>            <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>
<span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>                <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>
<span class="n">CoreDNS</span>                   <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span>      <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span>
<span class="n">etcd</span>                      <span class="mf">3.4</span><span class="o">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">0</span>   <span class="mf">3.4</span><span class="o">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">0</span>

<span class="n">You</span> <span class="n">can</span> <span class="n">now</span> <span class="n">apply</span> <span class="n">the</span> <span class="n">upgrade</span> <span class="n">by</span> <span class="n">executing</span> <span class="n">the</span> <span class="n">following</span> <span class="n">command</span><span class="p">:</span>

	<span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">apply</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>

<span class="n">_____________________________________________________________________</span>

<span class="n">Components</span> <span class="n">that</span> <span class="n">must</span> <span class="n">be</span> <span class="n">upgraded</span> <span class="n">manually</span> <span class="n">after</span> <span class="n">you</span> <span class="n">have</span> <span class="n">upgraded</span> <span class="n">the</span> <span class="n">control</span> <span class="n">plane</span> <span class="k">with</span> <span class="s1">&#39;kubeadm upgrade apply&#39;</span><span class="p">:</span>
<span class="n">COMPONENT</span>   <span class="n">CURRENT</span>       <span class="n">AVAILABLE</span>
<span class="n">kubelet</span>     <span class="mi">2</span> <span class="n">x</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
            <span class="mi">2</span> <span class="n">x</span> <span class="n">v1</span><span class="o">.</span><span class="mf">21.3</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>

<span class="n">Upgrade</span> <span class="n">to</span> <span class="n">the</span> <span class="n">latest</span> <span class="n">stable</span> <span class="n">version</span><span class="p">:</span>

<span class="n">COMPONENT</span>                 <span class="n">CURRENT</span>    <span class="n">AVAILABLE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>            <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span>            <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>                <span class="n">v1</span><span class="o">.</span><span class="mf">19.4</span>    <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="n">CoreDNS</span>                   <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span>      <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span>
<span class="n">etcd</span>                      <span class="mf">3.4</span><span class="o">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">0</span>   <span class="mf">3.4</span><span class="o">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">0</span>

<span class="n">You</span> <span class="n">can</span> <span class="n">now</span> <span class="n">apply</span> <span class="n">the</span> <span class="n">upgrade</span> <span class="n">by</span> <span class="n">executing</span> <span class="n">the</span> <span class="n">following</span> <span class="n">command</span><span class="p">:</span>

	<span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">apply</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>

<span class="n">_____________________________________________________________________</span>


<span class="n">The</span> <span class="n">table</span> <span class="n">below</span> <span class="n">shows</span> <span class="n">the</span> <span class="n">current</span> <span class="n">state</span> <span class="n">of</span> <span class="n">component</span> <span class="n">configs</span> <span class="k">as</span> <span class="n">understood</span> <span class="n">by</span> <span class="n">this</span> <span class="n">version</span> <span class="n">of</span> <span class="n">kubeadm</span><span class="o">.</span>
<span class="n">Configs</span> <span class="n">that</span> <span class="n">have</span> <span class="n">a</span> <span class="s2">&quot;yes&quot;</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">the</span> <span class="s2">&quot;MANUAL UPGRADE REQUIRED&quot;</span> <span class="n">column</span> <span class="n">require</span> <span class="n">manual</span> <span class="n">config</span> <span class="n">upgrade</span> <span class="ow">or</span>
<span class="n">resetting</span> <span class="n">to</span> <span class="n">kubeadm</span> <span class="n">defaults</span> <span class="n">before</span> <span class="n">a</span> <span class="n">successful</span> <span class="n">upgrade</span> <span class="n">can</span> <span class="n">be</span> <span class="n">performed</span><span class="o">.</span> <span class="n">The</span> <span class="n">version</span> <span class="n">to</span> <span class="n">manually</span>
<span class="n">upgrade</span> <span class="n">to</span> <span class="ow">is</span> <span class="n">denoted</span> <span class="ow">in</span> <span class="n">the</span> <span class="s2">&quot;PREFERRED VERSION&quot;</span> <span class="n">column</span><span class="o">.</span>

<span class="n">API</span> <span class="n">GROUP</span>                 <span class="n">CURRENT</span> <span class="n">VERSION</span>   <span class="n">PREFERRED</span> <span class="n">VERSION</span>   <span class="n">MANUAL</span> <span class="n">UPGRADE</span> <span class="n">REQUIRED</span>
<span class="n">kubeproxy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>   <span class="n">v1alpha1</span>          <span class="n">v1alpha1</span>            <span class="n">no</span>
<span class="n">kubelet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>     <span class="n">v1beta1</span>           <span class="n">v1beta1</span>             <span class="n">no</span>
<span class="n">_____________________________________________________________________</span>
</pre></div>
</td></tr></table></div>
<p>上述命令检查集群可以升级的版本，例如上面案例显示输出支持升级到2个版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">apply</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.13</span>
<span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">apply</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
</pre></div>
</div>
<ul>
<li><p>现在我们实际操作，升级到支持的 <code class="docutils literal notranslate"><span class="pre">1.20.x</span></code> 最新版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">apply</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
</pre></div>
</div>
</li>
</ul>
<p>提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with &#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;
[preflight] Running pre-flight checks.
[upgrade] Running cluster health checks
[upgrade/version] You have chosen to change the cluster version to &quot;v1.20.9&quot;
[upgrade/versions] Cluster version: v1.19.4
[upgrade/versions] kubeadm version: v1.20.9
[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]:
</pre></div>
</div>
<p>输入 <code class="docutils literal notranslate"><span class="pre">y</span></code> 开始升级</p>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">prepull</span><span class="p">]</span> <span class="n">Pulling</span> <span class="n">images</span> <span class="n">required</span> <span class="k">for</span> <span class="n">setting</span> <span class="n">up</span> <span class="n">a</span> <span class="n">Kubernetes</span> <span class="n">cluster</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">prepull</span><span class="p">]</span> <span class="n">This</span> <span class="n">might</span> <span class="n">take</span> <span class="n">a</span> <span class="n">minute</span> <span class="ow">or</span> <span class="n">two</span><span class="p">,</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">the</span> <span class="n">speed</span> <span class="n">of</span> <span class="n">your</span> <span class="n">internet</span> <span class="n">connection</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">prepull</span><span class="p">]</span> <span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">perform</span> <span class="n">this</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">beforehand</span> <span class="n">using</span> <span class="s1">&#39;kubeadm config images pull&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里有一个跨GFW的网络要求，所以网络畅通非常重要</p>
</div>
<p>提示信息报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="p">]</span> <span class="n">Upgrading</span> <span class="n">your</span> <span class="n">Static</span> <span class="n">Pod</span><span class="o">-</span><span class="n">hosted</span> <span class="n">control</span> <span class="n">plane</span> <span class="n">to</span> <span class="n">version</span> <span class="s2">&quot;v1.20.9&quot;</span><span class="o">...</span>
<span class="n">Static</span> <span class="n">pod</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span> <span class="nb">hash</span><span class="p">:</span> <span class="mi">1403</span><span class="n">dda53affdfee1130475a6d9609da</span>
<span class="n">Static</span> <span class="n">pod</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span> <span class="nb">hash</span><span class="p">:</span> <span class="n">f967039ea08836f2188442530d3d465a</span>
<span class="n">Static</span> <span class="n">pod</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span> <span class="nb">hash</span><span class="p">:</span> <span class="mi">02</span><span class="n">dab51e35a1d6fc74e5283db75230f5</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="p">]</span> <span class="n">FATAL</span><span class="p">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">create</span> <span class="n">etcd</span> <span class="n">client</span><span class="p">:</span> <span class="n">error</span> <span class="n">syncing</span> <span class="n">endpoints</span> <span class="k">with</span> <span class="n">etcd</span><span class="p">:</span> <span class="n">context</span> <span class="n">deadline</span> <span class="n">exceeded</span>
<span class="n">To</span> <span class="n">see</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">trace</span> <span class="n">of</span> <span class="n">this</span> <span class="n">error</span> <span class="n">execute</span> <span class="k">with</span> <span class="o">--</span><span class="n">v</span><span class="o">=</span><span class="mi">5</span> <span class="ow">or</span> <span class="n">higher</span>
</pre></div>
</div>
<ul class="simple">
<li><p>重新执行，并添加 <code class="docutils literal notranslate"><span class="pre">--v=5</span></code> 参数观察详细日志:</p></li>
</ul>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">I0725</span> <span class="mi">22</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mf">21.102670</span> <span class="mi">1289345</span> <span class="n">etcd</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">177</span><span class="p">]</span> <span class="n">retrieving</span> <span class="n">etcd</span> <span class="n">endpoints</span> <span class="kn">from</span> <span class="s2">&quot;kubeadm.kubernetes.io/etcd</span>
<span class="o">.</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span><span class="s2">&quot; annotation in etcd Pods</span>
<span class="n">I0725</span> <span class="mi">22</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mf">21.116370</span> <span class="mi">1289345</span> <span class="n">etcd</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">101</span><span class="p">]</span> <span class="n">etcd</span> <span class="n">endpoints</span> <span class="n">read</span> <span class="kn">from</span> <span class="nn">pods</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2379</span>
<span class="n">context</span> <span class="n">deadline</span> <span class="n">exceeded</span>
<span class="n">error</span> <span class="n">syncing</span> <span class="n">endpoints</span> <span class="k">with</span> <span class="n">etcd</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">util</span><span class="o">/</span><span class="n">etcd</span><span class="o">.</span><span class="n">NewFromCluster</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span>
<span class="n">util</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">etcd</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">117</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">StaticPodControlPlane</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span>
<span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">staticpods</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">439</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">PerformStaticPodUpgrade</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span>
<span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">staticpods</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">612</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">PerformControlPlaneUpgrade</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span>
<span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">229</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">runApply</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span>
<span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">163</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">newCmdApply</span><span class="o">.</span><span class="n">func1</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span>
<span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">77</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">co</span>
<span class="n">m</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">850</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">ExecuteC</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">co</span>
<span class="n">m</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">958</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">Execute</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">co</span>
<span class="n">m</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">895</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">Run</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span>
<span class="n">kubeadm</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">50</span>
<span class="n">main</span><span class="o">.</span><span class="n">main</span>
        <span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">25</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">main</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">proc</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">204</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">goexit</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">asm_arm64</span><span class="o">.</span><span class="n">s</span><span class="p">:</span><span class="mi">1136</span>
<span class="n">failed</span> <span class="n">to</span> <span class="n">create</span> <span class="n">etcd</span> <span class="n">client</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">StaticPodControlPlane</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">staticpods</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">441</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">PerformStaticPodUpgrade</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">phases</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">staticpods</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">612</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">PerformControlPlaneUpgrade</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">229</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">runApply</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">163</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">newCmdApply</span><span class="o">.</span><span class="n">func1</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">77</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">850</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">ExecuteC</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">958</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">Execute</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">895</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">Run</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">50</span>
<span class="n">main</span><span class="o">.</span><span class="n">main</span>
        <span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">25</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">main</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">proc</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">204</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">goexit</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">asm_arm64</span><span class="o">.</span><span class="n">s</span><span class="p">:</span><span class="mi">1136</span>
<span class="p">[</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="p">]</span> <span class="n">FATAL</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">runApply</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">164</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">.</span><span class="n">newCmdApply</span><span class="o">.</span><span class="n">func1</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">upgrade</span><span class="o">/</span><span class="n">apply</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">77</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">850</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">ExecuteC</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">958</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Command</span><span class="p">)</span><span class="o">.</span><span class="n">Execute</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">spf13</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">command</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">895</span>
<span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">Run</span>
        <span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">50</span>
<span class="n">main</span><span class="o">.</span><span class="n">main</span>
        <span class="n">_output</span><span class="o">/</span><span class="n">dockerized</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">cmd</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">/</span><span class="n">kubeadm</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">25</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">main</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">proc</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">204</span>
<span class="n">runtime</span><span class="o">.</span><span class="n">goexit</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">asm_arm64</span><span class="o">.</span><span class="n">s</span><span class="p">:</span><span class="mi">1136</span>
</pre></div>
</td></tr></table></div>
<p>报错依旧，我推测是跨版本升级可能不能从较低的 <code class="docutils literal notranslate"><span class="pre">1.19.x</span></code> 升级到较高到 <code class="docutils literal notranslate"><span class="pre">1.20.x</span></code> ，所以转为先升级到 <code class="docutils literal notranslate"><span class="pre">1.19.13</span></code> ，然后再尝试升级到 <code class="docutils literal notranslate"><span class="pre">1.20.9</span></code> 。</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">kubeadm-1.20.9</span></code> 工具不支持升级 <code class="docutils literal notranslate"><span class="pre">1.19.x</span></code> ，所以还需要回滚版本到 <code class="docutils literal notranslate"><span class="pre">1.19.13</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">unhold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>
<span class="n">apt</span> <span class="n">update</span>
<span class="n">apt</span> <span class="n">install</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubectl</span><span class="o">=</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubelet</span><span class="o">=</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">00</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">downgrades</span>
<span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>
</pre></div>
</div>
</li>
<li><p>再次执行升级报错依旧</p></li>
<li><p>参考 <a class="reference external" href="https://github.com/kubernetes/kubeadm/issues/1432">kubeadm join is not fault tolerant to etcd endpoint failures #1432</a> 我推测etcd版本是否存在兼容性bug？</p></li>
</ul>
<section id="etcd">
<h3>etcd排查<a class="headerlink" href="#etcd" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">etcd</span></code> 日志:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">logs</span> <span class="n">etcd</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到报错信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">27</span> <span class="mi">08</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mf">14.208723</span> <span class="n">I</span> <span class="o">|</span> <span class="n">embed</span><span class="p">:</span> <span class="n">rejected</span> <span class="n">connection</span> <span class="kn">from</span> <span class="s2">&quot;192.168.6.11:55660&quot;</span> <span class="p">(</span><span class="n">error</span> <span class="s2">&quot;remote error: tls: bad certificate&quot;</span><span class="p">,</span> <span class="n">ServerName</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">27</span> <span class="mi">08</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mf">17.326582</span> <span class="n">I</span> <span class="o">|</span> <span class="n">embed</span><span class="p">:</span> <span class="n">rejected</span> <span class="n">connection</span> <span class="kn">from</span> <span class="s2">&quot;192.168.6.11:55694&quot;</span> <span class="p">(</span><span class="n">error</span> <span class="s2">&quot;remote error: tls: bad certificate&quot;</span><span class="p">,</span> <span class="n">ServerName</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">27</span> <span class="mi">08</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mf">17.911939</span> <span class="n">I</span> <span class="o">|</span> <span class="n">etcdserver</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">etcdhttp</span><span class="p">:</span> <span class="o">/</span><span class="n">health</span> <span class="n">OK</span> <span class="p">(</span><span class="n">status</span> <span class="n">code</span> <span class="mi">200</span><span class="p">)</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">27</span> <span class="mi">08</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mf">18.476309</span> <span class="n">I</span> <span class="o">|</span> <span class="n">embed</span><span class="p">:</span> <span class="n">rejected</span> <span class="n">connection</span> <span class="kn">from</span> <span class="s2">&quot;192.168.6.11:55704&quot;</span> <span class="p">(</span><span class="n">error</span> <span class="s2">&quot;remote error: tls: bad certificate&quot;</span><span class="p">,</span> <span class="n">ServerName</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>在 <a class="reference external" href="https://github.com/kubernetes/kubeadm/issues/910">etcd 3.2.x upgrade fails with tls: bad certificate”; please retry. #910</a> 说明:</p>
<p>etcd配置了从内建的grpc gateway尝试按照客户端在和etcd交互时候使用服务器证书</p>
<p>在 <a class="reference external" href="https://github.com/etcd-io/etcd/issues/9785">ETCD with TLS showing warning “transport: authentication handshake failed: remote error: tls: bad certificate” #9785</a> 说明:</p>
<p>这是由于服务器配置没有输出证书，导致客户端认证失败，参考 <a class="reference external" href="https://github.com/cloudflare/cfssl/blob/master/doc/cmd/cfssl.txt">cfssl.txt</a> ，解决的方法(参考 KIVagant 的解决方法)，即:</p>
<ul class="simple">
<li><p>重新生成etcd证书(包含server和client的profile)</p></li>
<li><p>设置 <code class="docutils literal notranslate"><span class="pre">client_cert_auth=ture</span></code> 运行参数(使用etcd启动环境变量指定)</p></li>
<li><p>运行 <code class="docutils literal notranslate"><span class="pre">etcd</span></code> 时参数 <code class="docutils literal notranslate"><span class="pre">--peer-auto-tls=true</span></code></p></li>
</ul>
<p>不过，这个方法由于较为复杂(主要时证书我还没有搞清楚)，所以我采用上述issue中 JinsYin 的解决方法，即传递给etcd运行参数 <code class="docutils literal notranslate"><span class="pre">--client-cert-auth=false</span></code> ，见下文排查和解决方法</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>目前我对kubernetes和etcd的证书了解不够，后续准备参考 <a class="reference external" href="https://github.com/kelseyhightower/kubernetes-the-hard-way">kubernetes-the-hard-way</a> 的文档 <a class="reference external" href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/04-certificate-authority.md">Provisioning a CA and Generating TLS Certificates</a> 具体实践证书制作。</p>
</div>
</section>
<section id="id7">
<h3>尝试仅升级小版本<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>由于当前服务器版本是 <code class="docutils literal notranslate"><span class="pre">1.19.4</span></code> ，所以尝试仅升级到 <code class="docutils literal notranslate"><span class="pre">1.19.5</span></code> 看看是否可以绕开这个问题:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">unhold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>
<span class="n">apt</span> <span class="n">update</span>
<span class="n">apt</span> <span class="n">install</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubectl</span><span class="o">=</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubelet</span><span class="o">=</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="mi">00</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">downgrades</span>
<span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>
</pre></div>
</div>
<ul>
<li><p>此时检查服务器版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">version</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Client</span> <span class="n">Version</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;19&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.19.5&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;e338cf2c6d297aa603b50ad3a301f761b4173aa6&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2020-12-09T11:18:51Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.15.2&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/arm64&quot;</span><span class="p">}</span>
<span class="n">Server</span> <span class="n">Version</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">Info</span><span class="p">{</span><span class="n">Major</span><span class="p">:</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">Minor</span><span class="p">:</span><span class="s2">&quot;19&quot;</span><span class="p">,</span> <span class="n">GitVersion</span><span class="p">:</span><span class="s2">&quot;v1.19.4&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;d360454c9bcd1634cf4cc52d1867af5491dc9c5f&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">BuildDate</span><span class="p">:</span><span class="s2">&quot;2020-11-11T13:09:17Z&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.15.2&quot;</span><span class="p">,</span> <span class="n">Compiler</span><span class="p">:</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="n">Platform</span><span class="p">:</span><span class="s2">&quot;linux/arm64&quot;</span><span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p>检查节点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">nodes</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span>         <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>    <span class="n">VERSION</span>
<span class="n">pi</span><span class="o">-</span><span class="n">master1</span>   <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">240</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.5</span>
<span class="n">pi</span><span class="o">-</span><span class="n">worker1</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">237</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
<span class="n">pi</span><span class="o">-</span><span class="n">worker2</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">237</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">21.3</span>
<span class="n">zcloud</span>       <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">127</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">21.3</span>
</pre></div>
</div>
<ul>
<li><p>再次尝试小版本升级:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">apply</span> <span class="n">v1</span><span class="o">.</span><span class="mf">19.5</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>很不幸，尝试失败，基本可以确定是etcd证书问题，解决方法也要从证书入手。不过，证书还没失效，因为etcd能够启动，并且apiserver连接有效</p>
</div>
</section>
<section id="id8">
<h3>尝试修订参数<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>我检查了 <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/manifests</span></code> 目录下配置 <code class="docutils literal notranslate"><span class="pre">etcd.yaml</span></code> 都是2020-12-01创建配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mf">2.1</span><span class="n">K</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2020</span> <span class="n">etcd</span><span class="o">.</span><span class="n">yaml</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mf">3.8</span><span class="n">K</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2020</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">.</span><span class="n">yaml</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mf">3.5</span><span class="n">K</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2020</span> <span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">yaml</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mf">1.4</span><span class="n">K</span> <span class="n">Dec</span>  <span class="mi">1</span>  <span class="mi">2020</span> <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>考虑修订 <code class="docutils literal notranslate"><span class="pre">etcd.yaml</span></code> 配置，强制将客户端证书忽略，见上文</p>
<ul>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/manifests/etcd.yaml</span></code> ，将启动运行参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">command</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">etcd</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2379</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">true</span>
<span class="o">...</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">peer</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
</li>
</ul>
<p>最后一行修订成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">false</span>
<span class="o">...</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">peer</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<ul>
<li><p>重启 pod</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">delete</span> <span class="n">pods</span> <span class="n">etcd</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
</pre></div>
</div>
</li>
</ul>
<p>然后检查启动情况:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">etcd</span>
</pre></div>
</div>
<p>可以看到重启后pods配置没有改变( <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">etcd</span></code> )</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">etcd</span> <span class="o">--</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2379</span> <span class="o">...</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">true</span> <span class="o">...</span> <span class="o">--</span><span class="n">peer</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">true</span> <span class="o">...</span>
</pre></div>
</div>
<ul>
<li><p>直接修改pod配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">edit</span> <span class="n">pods</span> <span class="n">etcd</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
</pre></div>
</div>
</li>
</ul>
<p>但是这个pod是不能直接修改(没有deployment?)</p>
</section>
<section id="id9">
<h3>修订etcd证书<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>检查 <code class="docutils literal notranslate"><span class="pre">etcd</span></code> 如何使用证书目录挂载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">get</span> <span class="n">pods</span> <span class="n">etcd</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span>
</pre></div>
</div>
</li>
</ul>
<p>可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volumes</span><span class="p">:</span>
<span class="o">-</span> <span class="n">hostPath</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">DirectoryOrCreate</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">etcd</span><span class="o">-</span><span class="n">certs</span>
<span class="o">-</span> <span class="n">hostPath</span><span class="p">:</span>
    <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">etcd</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">DirectoryOrCreate</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">etcd</span><span class="o">-</span><span class="n">data</span>
</pre></div>
</div>
<p>上述主机目录 <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/pki/etcd</span></code> 挂载到容器内部作为证书，所以需要修订物理主机该目录</p>
<ul>
<li><p>检查 etcd 运行进程参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">etcd</span> <span class="o">--</span><span class="n">advertise</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2379</span> <span class="o">--</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">crt</span> <span class="o">--</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">true</span> <span class="o">--</span><span class="n">data</span><span class="o">-</span><span class="nb">dir</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">etcd</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">advertise</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2380</span> <span class="o">--</span><span class="n">initial</span><span class="o">-</span><span class="n">cluster</span><span class="o">=</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2380</span> <span class="o">--</span><span class="n">key</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">urls</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">2379</span><span class="p">,</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2379</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">urls</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">2381</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">peer</span><span class="o">-</span><span class="n">urls</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">6.11</span><span class="p">:</span><span class="mi">2380</span> <span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span> <span class="o">--</span><span class="n">peer</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">peer</span><span class="o">.</span><span class="n">crt</span> <span class="o">--</span><span class="n">peer</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">auth</span><span class="o">=</span><span class="n">true</span> <span class="o">--</span><span class="n">peer</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">peer</span><span class="o">.</span><span class="n">key</span> <span class="o">--</span><span class="n">peer</span><span class="o">-</span><span class="n">trusted</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span> <span class="o">--</span><span class="n">snapshot</span><span class="o">-</span><span class="n">count</span><span class="o">=</span><span class="mi">10000</span> <span class="o">--</span><span class="n">trusted</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span>
</pre></div>
</div>
</li>
</ul>
<p>需要重新生成 <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/pki/etcd/server.crt</span></code> ( <code class="docutils literal notranslate"><span class="pre">--cert-file=/etc/kubernetes/pki/etcd/server.crt</span></code> )</p>
<ul>
<li><p>安装 <code class="docutils literal notranslate"><span class="pre">cfssl</span></code> 工具:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">golang</span><span class="o">-</span><span class="n">cfssl</span>
</pre></div>
</div>
</li>
<li><p>备份证书目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">.</span><span class="n">bak</span>
</pre></div>
</div>
</li>
<li><p>编辑配置文件 <code class="docutils literal notranslate"><span class="pre">ca-config.json</span></code></p></li>
</ul>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;signing&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000h&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;profiles&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;usages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;signing&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;key encipherment&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;server auth&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;client auth&quot;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;usages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;signing&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;key encipherment&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;client auth&quot;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s2">&quot;peer&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="s2">&quot;43800h&quot;</span><span class="p">,</span>
                <span class="s2">&quot;usages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;signing&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;key encipherment&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;server auth&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;client auth&quot;</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<ul>
<li><p>执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cfssl</span> <span class="n">gencert</span> <span class="o">-</span><span class="n">ca</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span> <span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">key</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">key</span> <span class="o">-</span><span class="n">config</span><span class="o">=</span><span class="n">ca</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">json</span> <span class="o">-</span><span class="n">profile</span><span class="o">=</span><span class="n">server</span> <span class="n">ca</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">json</span> <span class="o">|</span> <span class="n">cfssljson</span> <span class="o">-</span><span class="n">bare</span> <span class="n">server</span>
</pre></div>
</div>
</li>
</ul>
<p>则在当前目录下会生成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">server</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">pem</span>    <span class="n">server</span><span class="o">.</span><span class="n">csr</span>   <span class="n">server</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>复制 <code class="docutils literal notranslate"><span class="pre">server-key.pem</span></code> ( <code class="docutils literal notranslate"><span class="pre">ETCD_KEY_FILE</span></code> ) 即可:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">server</span><span class="o">-</span><span class="n">key</span><span class="o">.</span><span class="n">pem</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">etcd</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">key</span>
</pre></div>
</div>
<ul>
<li><p>然后重启etce:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">delete</span> <span class="n">pods</span> <span class="n">etcd</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
</pre></div>
</div>
</li>
<li><p>检查运行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">etcd</span>
</pre></div>
</div>
</li>
<li><p>重新升级系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">unhold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>
<span class="n">apt</span> <span class="n">update</span>
<span class="n">apt</span> <span class="n">install</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.20</span><span class="o">.</span><span class="mi">9</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubectl</span><span class="o">=</span><span class="mf">1.20</span><span class="o">.</span><span class="mi">9</span><span class="o">-</span><span class="mi">00</span> <span class="n">kubelet</span><span class="o">=</span><span class="mf">1.20</span><span class="o">.</span><span class="mi">9</span><span class="o">-</span><span class="mi">00</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">downgrades</span>
<span class="n">apt</span><span class="o">-</span><span class="n">mark</span> <span class="n">hold</span> <span class="n">kubeadm</span> <span class="n">kubectl</span> <span class="n">kubelet</span>

<span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">plan</span>
<span class="n">kubeadm</span> <span class="n">upgrade</span> <span class="n">apply</span> <span class="n">v1</span><span class="o">.</span><span class="mf">20.9</span>
</pre></div>
</div>
</li>
<li><p>注意，这次 etcd 日志报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2021</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">28</span> <span class="mi">15</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">19.691882</span> <span class="n">I</span> <span class="o">|</span> <span class="n">embed</span><span class="p">:</span> <span class="n">rejected</span> <span class="n">connection</span> <span class="kn">from</span> <span class="s2">&quot;192.168.6.11:36982&quot;</span> <span class="p">(</span><span class="n">error</span> <span class="s2">&quot;tls: private key type does not match public key type&quot;</span><span class="p">,</span> <span class="n">ServerName</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>重启一次apiserver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">delete</span> <span class="n">pods</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
<span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">delete</span> <span class="n">pods</span> <span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
<span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">delete</span> <span class="n">pods</span> <span class="n">coredns</span><span class="o">-</span><span class="n">f9fd979d6</span><span class="o">-</span><span class="n">dlv9c</span>
<span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">delete</span> <span class="n">pods</span> <span class="n">coredns</span><span class="o">-</span><span class="n">f9fd979d6</span><span class="o">-</span><span class="n">wvfvc</span>
<span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">delete</span> <span class="n">pods</span> <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="n">pi</span><span class="o">-</span><span class="n">master1</span>
</pre></div>
</div>
</li>
</ul>
<p>失败，应该还是没有掌握证书原理和关系，有待重新实践</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>这次升级失败，目前推测是早期部署集群的证书问题在版本升级中可能有什么兼容性问题，目前无法恢复。所以，我改为 <span class="xref std std-ref">delete_k8s_cluster</span> 然后重建</p>
</div>
</section>
</section>
<section id="id10">
<h2>参考<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://kubernetes.io/zh/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">升级 kubeadm 集群</a></p></li>
<li><p><a class="reference external" href="https://computingforgeeks.com/how-to-install-cloudflare-cfssl-on-linux-macos/">How To Install CloudFlare CFSSL on Linux | macOS</a></p></li>
</ul>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="delete_kubeadm_cluster.html" class="btn btn-neutral float-right" title="删除kubeadm构建的Kubernetes集群" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="使用kubeadm管理Kubernetes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; <a href="../../../copyright.html"> 版权所有</a> 2021, Huatai Huang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>