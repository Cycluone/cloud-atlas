

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>树莓派4 USB存储启动Ubuntu Server 20.04 &mdash; Cloud Atlas 0.1 文档</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../copyright.html" />
    <link rel="next" title="树莓派4 USB存储启动Kali Linux" href="usb_boot_kali_pi_4.html" />
    <link rel="prev" title="debug: 树莓派4 USB存储启动Ubuntu Server 20.04" href="usb_boot_ubuntu_pi_4_debug.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ansible/index.html">Ansible Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postgresql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">ARM Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../hardware/index.html">ARM 硬件概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/index.html">ARM 架构随想</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power_manage/index.html">ARM电源管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../blackberry/index.html">BlackBerry(黑莓)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Raspberry Pi</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../startup/index.html">树莓派起步</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin/index.html">树莓派系统管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../network/index.html">树莓派网络</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Raspberry Pi 存储</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="choice_pi_storage.html">树莓派存储设备选择</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_3.html">USB标准3.x</a></li>
<li class="toctree-l4"><a class="reference internal" href="wd_passport_ssd.html">西部数据Passport SSD移动硬盘</a></li>
<li class="toctree-l4"><a class="reference internal" href="wd_digital_dashboard.html">西部数据SSD存储管理工具: Western Digital Dashboard</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_boot_pi_3.html">USB移动存储启动和运行树莓派3</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_boot_ubuntu_pi_4_debug.html">debug: 树莓派4 USB存储启动Ubuntu Server 20.04</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">树莓派4 USB存储启动Ubuntu Server 20.04</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_boot_kali_pi_4.html">树莓派4 USB存储启动Kali Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="chroot_raspbian.html">chroot Raspbian维护更新</a></li>
<li class="toctree-l4"><a class="reference internal" href="disable_auto_resize.html">关闭自动resize根文件系统</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../debug/index.html">树莓派异常排查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pi_cluster/index.html">Raspberry Pi Cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../android/index.html">树莓派运行Android</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../pine/index.html">Pine64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../openwrt/index.html">OpenWrt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../build/index.html">ARM编译</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">ARM Atlas</a> &raquo;</li>
        
          <li><a href="../index.html">Raspberry Pi</a> &raquo;</li>
        
          <li><a href="index.html">Raspberry Pi 存储</a> &raquo;</li>
        
      <li>树莓派4 USB存储启动Ubuntu Server 20.04</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/arm/raspberry_pi/storage/usb_boot_ubuntu_pi_4.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="usbubuntu-server-20-04">
<span id="usb-boot-ubuntu-pi-4"></span><h1>树莓派4 USB存储启动Ubuntu Server 20.04<a class="headerlink" href="#usbubuntu-server-20-04" title="永久链接至标题">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>为了实现USB移动硬盘启动树莓派，我做了多次 <a class="reference internal" href="#usb-boot-ubuntu-pi-4"><span class="std std-ref">树莓派4 USB存储启动Ubuntu Server 20.04</span></a> ，所以虽然有了非常详细的排查过程，但是步骤上有些重复和散乱。所以，我重新整理一份操作手册，从我的实践经验来探索USB启动的最佳实践。</p>
</div>
<section id="raspbianfirmware">
<h2>Raspbian和firmware<a class="headerlink" href="#raspbianfirmware" title="永久链接至标题">¶</a></h2>
<p>树莓派的USB启动需要更新和设置树莓派firmware，不过，我安装和使用的是 <a class="reference internal" href="../../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> for Raspberry Pi，所以在Ubuntu 20.0.4  LTS操作系统中并没有包含树莓派firmware更新工具。</p>
<p>解决的方法是，在SD卡中安装树莓派官方提供的Raspbian操作系统，利用raspbian中的firmware更新工具进行更新:</p>
<ul class="simple">
<li><p>如本文下述，先用Raspbian OS启动树莓派，更新firmware</p></li>
<li><p>再将Ubuntu for Raspberry Pi复制到移动硬盘中，最后通过修改启动配置从移动硬盘启动</p></li>
</ul>
<p>本文是我在Ubuntu for Raspberry Pi上实践，同样，我在 <a class="reference internal" href="usb_boot_kali_pi_4.html#usb-boot-kali-pi-4"><span class="std std-ref">树莓派4 USB存储启动Kali Linux</span></a> 将结合 chroot 和</p>
<section id="firmware">
<h3>更新firmware<a class="headerlink" href="#firmware" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>采用 <a class="reference internal" href="../startup/pi_quick_start.html#pi-quick-start"><span class="std std-ref">树莓派(Raspberry Pi)快速起步</span></a> 中方法，我们先下载镜像并通过dd命令写入TF卡:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="mi">2020</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">20</span><span class="o">-</span><span class="n">raspios</span><span class="o">-</span><span class="n">buster</span><span class="o">-</span><span class="n">armhf</span><span class="o">-</span><span class="n">lite</span><span class="o">.</span><span class="n">img</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb</span> <span class="n">bs</span><span class="o">=</span><span class="mi">100</span><span class="n">M</span>
</pre></div>
</div>
</li>
<li><p>然后将这个就绪的TF卡通过USB读卡连接到Linux主机上，执行以下命令，通过chroot切换到raspberry系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mount /dev/sdb2 /mnt
mount /dev/sdb1 /mnt/boot
for f in dev dev/pts proc sys; do mount --bind /$f /mnt/$f;done
export PS1=&quot;(chroot) $PS1&quot;
chroot /mnt/
</pre></div>
</div>
</li>
<li><p>更新最新的Raspbian系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">update</span>
<span class="n">apt</span> <span class="n">upgrade</span>
</pre></div>
</div>
</li>
<li><p>将Raspbian系统配置一个静态IP地址，这样就可以不需要外接显示器，直接通过ssh就可以登录树莓派操作，注意IP地址不要冲突，请参考 <a class="reference internal" href="../../../studio/studio_ip.html#studio-ip"><span class="std std-ref">Studio测试环境IP分配</span></a> 设置 <code class="docutils literal notranslate"><span class="pre">192.168.6.110</span> <span class="pre">raspberrypi</span></code></p></li>
</ul>
<p>在raspbian中，默认启动dhcpcd会自动配置IP地址，可以指定网卡接口使用静态IP地址，即修改 <code class="docutils literal notranslate"><span class="pre">/etc/dhcpcd.conf</span></code> 配置添加:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span> <span class="n">eth0</span>
<span class="n">static</span> <span class="n">ip_address</span><span class="o">=</span><span class="mf">192.168.6.110</span><span class="o">/</span><span class="mi">24</span>
<span class="n">static</span> <span class="n">routers</span><span class="o">=</span><span class="mf">192.168.6.9</span>
<span class="n">static</span> <span class="n">domain_name_servers</span><span class="o">=</span><span class="mf">202.96.209.133</span>
</pre></div>
</div>
<p>注意，必须确保 <code class="docutils literal notranslate"><span class="pre">dhcpcd.service</span></code> 服务默认启动，上述配置才能生效:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">dhcpcd</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<ul class="simple">
<li><p>然后卸载挂载的raspbian的TF卡，插入到树莓派中启动，然后测试是否能够按照上述静态IP地址访问ssh服务。</p></li>
</ul>
<p>完成上述通过raspbian的TF卡启动树莓派之后，进入Raspberry Pi OS(即Raspbian)，我们可以通过ssh登陆到系统中，就不需要外接显示器，方便操作。</p>
</section>
</section>
<section id="firmwareusb">
<h2>更新树莓派firmware支持USB启动<a class="headerlink" href="#firmwareusb" title="永久链接至标题">¶</a></h2>
<p>现在依然还是Raspberry Pi OS系统，我们需要用官方系统来更新firmware。</p>
<ul>
<li><p>设置正确的本地时间(将默认伦敦时间修改成上海时间):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unlink</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zoneinfo</span><span class="o">/</span><span class="n">Asia</span><span class="o">/</span><span class="n">Shanghai</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span>
</pre></div>
</div>
</li>
<li><p>检查firmware更新配置 <code class="docutils literal notranslate"><span class="pre">/etc/default/rpi-eeprom-update</span></code> ，确保采用 <code class="docutils literal notranslate"><span class="pre">stable</span></code> 版本，如果是 <code class="docutils literal notranslate"><span class="pre">cirtical</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">beta</span></code> 版本，都需要修改成 <code class="docutils literal notranslate"><span class="pre">stable</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FIRMWARE_RELEASE_STATUS</span><span class="o">=</span><span class="s2">&quot;stable&quot;</span>
</pre></div>
</div>
</li>
<li><p>进行系统更新:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">upgrade</span>
<span class="n">sudo</span> <span class="n">rpi</span><span class="o">-</span><span class="n">update</span>
<span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
</li>
<li><p>更新了系统和firmware之后，执行以下命令更新bootloader(具体需要根据实际当时提供的软件版本来定):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">bootloader</span><span class="o">/</span><span class="n">stable</span><span class="o">/</span><span class="n">pieeprom</span><span class="o">-</span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mf">03.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BCM2711</span> <span class="n">detected</span>
<span class="n">VL805</span> <span class="n">firmware</span> <span class="ow">in</span> <span class="n">bootloader</span> <span class="n">EEPROM</span>
<span class="o">***</span> <span class="n">INSTALLING</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">bootloader</span><span class="o">/</span><span class="n">stable</span><span class="o">/</span><span class="n">pieeprom</span><span class="o">-</span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mf">03.</span><span class="n">bin</span>  <span class="o">***</span>
<span class="n">BOOTFS</span> <span class="o">/</span><span class="n">boot</span>
<span class="n">EEPROM</span> <span class="n">update</span> <span class="n">pending</span><span class="o">.</span> <span class="n">Please</span> <span class="n">reboot</span> <span class="n">to</span> <span class="n">apply</span> <span class="n">the</span> <span class="n">update</span><span class="o">.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>更新firmware和bootloader前后检查bootlader版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vcgencmd</span> <span class="n">bootloader_version</span>
</pre></div>
</div>
<p>更新前后输出内容相同，也就是表明更新之前已经是最新版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sep</span>  <span class="mi">3</span> <span class="mi">2020</span> <span class="mi">13</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">43</span>
<span class="n">version</span> <span class="n">c305221a6d7e532693cc7ff57fddfc8649def167</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
<span class="n">timestamp</span> <span class="mi">1599135103</span>
<span class="n">update</span><span class="o">-</span><span class="n">time</span> <span class="mi">0</span>
<span class="n">capabilities</span> <span class="mh">0x00000000</span>
</pre></div>
</div>
</div>
<ul>
<li><p>检查 bootloader 配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vcgencmd</span> <span class="n">bootloader_config</span>
</pre></div>
</div>
</li>
</ul>
<p>输出信息显示启动顺序是先TF卡，后USB存储:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0xf41</span>
</pre></div>
</div>
</section>
<section id="id1">
<h2>修改树莓派启动顺序<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>将最新都EEPROM镜像复制到临时目录下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">tmp</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">bootloader</span><span class="o">/</span><span class="n">stable</span><span class="o">/</span><span class="n">pieeprom</span><span class="o">-</span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mf">03.</span><span class="n">bin</span> <span class="o">./</span><span class="n">pieeprom</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
<li><p>导出配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">config</span> <span class="n">pieeprom</span><span class="o">.</span><span class="n">bin</span> <span class="o">&gt;</span> <span class="n">bootconf</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</li>
<li><p>修改 <code class="docutils literal notranslate"><span class="pre">bootconf.txt</span></code> 的最后一行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0xf41</span>
</pre></div>
</div>
</li>
</ul>
<p>将启动顺序改成从外接USB存储启动(如果包含TF卡启动的顺序目前发现会有D进程):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0x4</span>
</pre></div>
</div>
<ul>
<li><p>然后将修改的配置加入到EEPROM镜像文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">config</span> <span class="o">--</span><span class="n">out</span> <span class="n">pieeprom</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">bin</span> <span class="o">--</span><span class="n">config</span> <span class="n">bootconf</span><span class="o">.</span><span class="n">txt</span> <span class="n">pieeprom</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
<li><p>然后刷入修改过bootloader顺序的 EEPROM:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">f</span> <span class="o">./</span><span class="n">pieeprom</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="ubuntu-for-raspberry-pi">
<h2>Ubuntu for Raspberry Pi<a class="headerlink" href="#ubuntu-for-raspberry-pi" title="永久链接至标题">¶</a></h2>
<p>我们的目标是在USB外接SSD移动硬盘上运行Ubuntu for Raspberry Pi，当前采用的是 Ubuntu 20.04.1 LTS Server版本。直接将下载的镜像文件dd到移动硬盘上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="n">ubuntu</span><span class="o">-</span><span class="mf">20.04.1</span><span class="o">-</span><span class="n">preinstalled</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">arm64</span><span class="o">+</span><span class="n">raspi</span><span class="o">.</span><span class="n">img</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span> <span class="n">bs</span><span class="o">=</span><span class="mi">100</span><span class="n">M</span>
</pre></div>
</div>
<p>完成上述操作后，整个Ubuntu系统已经复制到移动硬盘上，使用 <code class="docutils literal notranslate"><span class="pre">fdisk</span> <span class="pre">-l</span></code> 命令可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span><span class="p">:</span> <span class="mf">953.9</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024175636480</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000343040</span> <span class="n">sectors</span>
<span class="n">Disk</span> <span class="n">model</span><span class="p">:</span> <span class="n">My</span> <span class="n">Passport</span> <span class="mi">25</span><span class="n">F3</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">4096</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">4096</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">1048576</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">dos</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="mh">0xab86aefd</span>

<span class="n">Device</span>     <span class="n">Boot</span>  <span class="n">Start</span>     <span class="n">End</span> <span class="n">Sectors</span>  <span class="n">Size</span> <span class="n">Id</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span>  <span class="o">*</span>      <span class="mi">2048</span>  <span class="mi">526335</span>  <span class="mi">524288</span>  <span class="mi">256</span><span class="n">M</span>  <span class="n">c</span> <span class="n">W95</span> <span class="n">FAT32</span> <span class="p">(</span><span class="n">LBA</span><span class="p">)</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>       <span class="mi">526336</span> <span class="mi">6349231</span> <span class="mi">5822896</span>  <span class="mf">2.8</span><span class="n">G</span> <span class="mi">83</span> <span class="n">Linux</span>
</pre></div>
</div>
<p>可以看到外接SSD磁盘1T空间，当前系统目录仅使用里2.8G。通常首次启动系统时会自动展开根文件系统，占据整块磁盘。但是，我希望的部署方式是仅让根目录使用30G空间，以便将剩余磁盘空间用于 <a class="reference internal" href="../../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> 和 <a class="reference internal" href="../../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a> 以及部署 <a class="reference internal" href="../../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> ，所以采用 <a class="reference internal" href="../../../linux/storage/filesystem/resize_ext4_rootfs.html#resize-ext4-rootfs"><span class="std std-ref">调整ext4根文件系统大小</span></a> 修改根目录空间。</p>
<ul>
<li><p>删除 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> 分区，然后重建分区，确保起始扇区和原先一致，然后将结束位置扩展到30G大小:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># fdisk /dev/sda

Welcome to fdisk (util-linux 2.33.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): p   这里输入p打印当前磁盘分区信息
Disk /dev/sda: 953.9 GiB, 1024175636480 bytes, 2000343040 sectors
Disk model: My Passport 25F3
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 1048576 bytes
Disklabel type: dos
Disk identifier: 0xab86aefd

Device     Boot  Start     End Sectors  Size Id Type
/dev/sda1  *      2048  526335  524288  256M  c W95 FAT32 (LBA)
/dev/sda2       526336 6349231 5822896  2.8G 83 Linux

Command (m for help): d  这里输入d，删除分区
Partition number (1,2, default 2): 2  这里输入2，删除分区2，也就是根目录所在分区

Partition 2 has been deleted.

Command (m for help): p  再次输入p打印当前分区信息，可以看到分区2已经删除
Disk /dev/sda: 953.9 GiB, 1024175636480 bytes, 2000343040 sectors
Disk model: My Passport 25F3
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 1048576 bytes
Disklabel type: dos
Disk identifier: 0xab86aefd

Device     Boot Start    End Sectors  Size Id Type
/dev/sda1  *     2048 526335  524288  256M  c W95 FAT32 (LBA)

Command (m for help): n  这里输入n，添加新分区
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p): p  这里输入p，表示添加primary分区
Partition number (2-4, default 2):  这里输入回车，表示接受默认值2，创建分区2
First sector (526336-2000343039, default 526336):  这里输入回车，表示接受默认值，也就是之前分区的起始扇区
Last sector, +/-sectors or +/-size{K,M,G,T,P} (526336-2000343039, default 2000343039): +32G  这里输入+32G，表示新创建分区32G

Created a new partition 2 of type &#39;Linux&#39; and of size 32 GiB.
Partition #2 contains a ext4 signature. 系统提示分区2包含一个ext4标志，并询问是否要删除这个标志

Do you want to remove the signature? [Y]es/[N]o: n  这里输入n，表示不删除原先的分区ext4标志

Command (m for help): p  这里输入p，再次打印当前分区信息

Disk /dev/sda: 953.9 GiB, 1024175636480 bytes, 2000343040 sectors
Disk model: My Passport 25F3
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 4096 bytes
I/O size (minimum/optimal): 4096 bytes / 1048576 bytes
Disklabel type: dos
Disk identifier: 0xab86aefd

Device     Boot  Start      End  Sectors  Size Id Type
/dev/sda1  *      2048   526335   524288  256M  c W95 FAT32 (LBA)
/dev/sda2       526336 67635199 67108864   32G 83 Linux

Command (m for help): w  可以看到分区2起始位置和之前完全一致，只是空间增大到32G，确认无误输入w保存修改
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
</pre></div>
</div>
</li>
<li><p>执行 <code class="docutils literal notranslate"><span class="pre">resize2fs</span></code> 命令，不指定大小则会自动扩展文件系统占据整个 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> 分区，也就是我们扩展的32G空间:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息输出如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="mf">1.44.5</span> <span class="p">(</span><span class="mi">15</span><span class="o">-</span><span class="n">Dec</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">Resizing</span> <span class="n">the</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="n">to</span> <span class="mi">8388608</span> <span class="p">(</span><span class="mi">4</span><span class="n">k</span><span class="p">)</span> <span class="n">blocks</span><span class="o">.</span>
<span class="n">The</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="ow">is</span> <span class="n">now</span> <span class="mi">8388608</span> <span class="p">(</span><span class="mi">4</span><span class="n">k</span><span class="p">)</span> <span class="n">blocks</span> <span class="n">long</span><span class="o">.</span>
</pre></div>
</div>
<ul>
<li><p>挂载sda磁盘分区，检查是否工作正常:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
</ul>
<p>然后执行 <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">-h</span></code> 命令检查，可以看到sda磁盘文件系统如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>        <span class="mi">32</span><span class="n">G</span>  <span class="mf">1.8</span><span class="n">G</span>   <span class="mi">29</span><span class="n">G</span>   <span class="mi">6</span><span class="o">%</span> <span class="o">/</span><span class="n">mnt</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span>       <span class="mi">253</span><span class="n">M</span>   <span class="mi">61</span><span class="n">M</span>  <span class="mi">193</span><span class="n">M</span>  <span class="mi">24</span><span class="o">%</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
<section id="cloud-init">
<span id="disable-cloud-init"></span><h3>关闭cloud-init<a class="headerlink" href="#cloud-init" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>注意，默认首次启动Ubuntu是会扩展根文件系统的，所以我们需要禁用这个自动扩展功能</p></li>
</ul>
<p>对于 Raspbian 镜像，参考 <a class="reference external" href="https://raspberrypi.stackexchange.com/questions/47773/disable-auto-file-system-expansion-in-new-jessie-image-2016-05-10">Disable auto file system expansion in new Jessie image 2016-05-10</a> 是修改启动命令行配置文件 <code class="docutils literal notranslate"><span class="pre">cmdline.txt</span></code> 将:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwc_otg</span><span class="o">.</span><span class="n">lpm_enable</span><span class="o">=</span><span class="mi">0</span> <span class="n">console</span><span class="o">=</span><span class="n">serial0</span><span class="p">,</span><span class="mi">115200</span> <span class="n">console</span><span class="o">=</span><span class="n">tty1</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span> <span class="n">rootfstype</span><span class="o">=</span><span class="n">ext4</span> <span class="n">elevator</span><span class="o">=</span><span class="n">deadline</span> <span class="n">fsck</span><span class="o">.</span><span class="n">repair</span><span class="o">=</span><span class="n">yes</span> <span class="n">rootwait</span> <span class="n">quiet</span> <span class="n">init</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">raspi</span><span class="o">-</span><span class="n">config</span><span class="o">/</span><span class="n">init_resize</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>修改成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dwc_otg</span><span class="o">.</span><span class="n">lpm_enable</span><span class="o">=</span><span class="mi">0</span> <span class="n">console</span><span class="o">=</span><span class="n">serial0</span><span class="p">,</span><span class="mi">115200</span> <span class="n">console</span><span class="o">=</span><span class="n">tty1</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span> <span class="n">rootfstype</span><span class="o">=</span><span class="n">ext4</span> <span class="n">elevator</span><span class="o">=</span><span class="n">deadline</span> <span class="n">fsck</span><span class="o">.</span><span class="n">repair</span><span class="o">=</span><span class="n">yes</span> <span class="n">rootwait</span> <span class="n">quiet</span>
</pre></div>
</div>
<p>不过，我发现上述配置当前并不存在，但是可以参考上述问答中提到Ubuntu采用了不同的方法，Ubuntu是使用 <code class="docutils literal notranslate"><span class="pre">cloud-init</span></code> 软件来实现系统初始化，包括磁盘resizefs。具体配置见 <code class="docutils literal notranslate"><span class="pre">/etc/cloud/cloud.cfg</span></code> ，可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cloud_init_modules</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">migrator</span>
 <span class="o">-</span> <span class="n">seed_random</span>
 <span class="o">-</span> <span class="n">bootcmd</span>
 <span class="o">-</span> <span class="n">write</span><span class="o">-</span><span class="n">files</span>
 <span class="o">-</span> <span class="n">growpart</span>
 <span class="o">-</span> <span class="n">resizefs</span>
 <span class="o">-</span> <span class="n">disk_setup</span>
 <span class="o">-</span> <span class="n">mounts</span>
 <span class="o">-</span> <span class="n">set_hostname</span>
 <span class="o">-</span> <span class="n">update_hostname</span>
 <span class="o">-</span> <span class="n">update_etc_hosts</span>
 <span class="o">-</span> <span class="n">ca</span><span class="o">-</span><span class="n">certs</span>
 <span class="o">-</span> <span class="n">rsyslog</span>
 <span class="o">-</span> <span class="n">users</span><span class="o">-</span><span class="n">groups</span>
 <span class="o">-</span> <span class="n">ssh</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">growpart</span></code> 就是分区扩展， <code class="docutils literal notranslate"><span class="pre">resizefs</span></code> 模块就是用来修改根文件系统大小，要禁止这2个功能模块，只需要删除上述 <code class="docutils literal notranslate"><span class="pre">/etc/cloud/cloud.cfg</span></code> 中的  <code class="docutils literal notranslate"><span class="pre">-growpart</span></code> 和 <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">resizefs</span></code> 就可以了。如果要完全禁止 <code class="docutils literal notranslate"><span class="pre">cloud-init</span></code> ，则只需要:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cloud</span><span class="o">/</span><span class="n">cloud</span><span class="o">-</span><span class="n">init</span><span class="o">.</span><span class="n">disabled</span>
</pre></div>
</div>
<p>或者内核启动参数加上 <code class="docutils literal notranslate"><span class="pre">cloud-init=disabled</span></code> 。</p>
</section>
</section>
<section id="ubuntu">
<h2>配置Ubuntu的网络<a class="headerlink" href="#ubuntu" title="永久链接至标题">¶</a></h2>
<p>现在还没有切换到USB外接移动硬盘上的Ubuntu for Raspberry Pi，但是我们可以先配置好这个硬盘系统上的操作系统所使用网络，例如设置静态IP地址，方便后续通过ssh登陆维护。</p>
<ul>
<li><p>挂载 <code class="docutils literal notranslate"><span class="pre">/dev/sda</span></code> 磁盘上分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
<li><p>切换chroot，进入外接SSD移动硬盘中的Ubuntu系统，这样方便后续我们对操作系统进行全面修订:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>for f in dev dev/pts proc sys; do mount --bind /$f /mnt/$f;done
chroot /mnt/
export PS1=&quot;(chroot) $PS1&quot;
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>请注意：从这里开始，我们已经chroot方式切换到移动硬盘的Ubuntu系统上，所有后面所有操作都是直接作用于移动硬盘文件系统。即操作 <code class="docutils literal notranslate"><span class="pre">/etc/netplan/01-netcfg.yaml</span></code> 实际上相当于没有chroot之前的Raspbian系统目录 <code class="docutils literal notranslate"><span class="pre">/mnt/etc/netplan/01-netcfg.yaml</span></code> 。</p>
<p><code class="docutils literal notranslate"><span class="pre">请一定要注意这个差别!!!</span></code></p>
</div>
<ul class="simple">
<li><p>在移动硬盘的Ubuntu系统的 <code class="docutils literal notranslate"><span class="pre">/etc/netplan</span></code> 目录下添加配置文件</p></li>
</ul>
<p>01-netcfg.yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="p">:</span>
  <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>
  <span class="n">renderer</span><span class="p">:</span> <span class="n">networkd</span>
  <span class="n">ethernets</span><span class="p">:</span>
    <span class="n">eth0</span><span class="p">:</span>
      <span class="n">optional</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">dhcp4</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">dhcp6</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">192.168.6.16</span><span class="o">/</span><span class="mi">24</span><span class="p">,</span> <span class="p">]</span>
      <span class="c1">#addresses: [192.168.6.8/24,192.168.1.8/24 ]</span>
      <span class="c1">#gateway4: 192.168.1.1</span>
      <span class="n">nameservers</span><span class="p">:</span>
        <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">202.96.209.133</span><span class="p">,</span> <span class="p">]</span>
</pre></div>
</div>
<p>并删除掉 <code class="docutils literal notranslate"><span class="pre">50-cloud-init.yaml</span></code> 配置文件，然后执行生效配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netplan</span> <span class="n">apply</span>
</pre></div>
</div>
<p>很神奇，netplan工具完全支持chroot，可以跳过不必要步骤，提示如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="ow">in</span> <span class="n">chroot</span><span class="p">,</span> <span class="n">ignoring</span> <span class="n">request</span><span class="p">:</span> <span class="ow">is</span><span class="o">-</span><span class="n">active</span>
<span class="n">Running</span> <span class="ow">in</span> <span class="n">chroot</span><span class="p">,</span> <span class="n">ignoring</span> <span class="n">request</span><span class="p">:</span> <span class="n">stop</span>
<span class="n">Running</span> <span class="ow">in</span> <span class="n">chroot</span><span class="p">,</span> <span class="n">ignoring</span> <span class="n">request</span><span class="o">.</span>
<span class="n">Running</span> <span class="ow">in</span> <span class="n">chroot</span><span class="p">,</span> <span class="n">ignoring</span> <span class="n">request</span><span class="p">:</span> <span class="n">start</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>修订ubuntu帐号密码<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>ubuntu帐号初始密码在首次登录时会强制修改，但是由于为了避免连接显示器使用(因为我是将树莓派作为服务器)，所以通过ssh首次登录修订密码会失败。(每次ssh登录都提示修订密码，但是输入新密码后ssh连接立即被断开，导致没有更新 <code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code> 配置文件中帐号密码失效规则，就会每次登录都要求修改密码每次都失败)</p>
<p>解决方法是在 ubuntu 帐号的 <code class="docutils literal notranslate"><span class="pre">/home/ubuntu/.ssh</span></code> 目录下增加帐号公钥，这样登录ubuntu系统可以绕开密码认证，通过密钥认证ssh登录服务器后，再修订ubuntu帐号密码，就不会导致ssh断开触发密码修改失败。</p>
</section>
<section id="id3">
<h2>解压缩内核(重要关键)<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>每次Ubuntu更新内核都需要重复执行这个步骤，否则会导致系统无法启动!!!</p>
</div>
<p>当前Ubuntu不支持压缩版本的64位arm内核启动，所以我们需要将 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> 解压成 <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> 。</p>
<ul>
<li><p>找出移动硬盘中Ubuntu启动镜像中gzip压缩的内容起点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
<span class="n">od</span> <span class="o">-</span><span class="n">A</span> <span class="n">d</span> <span class="o">-</span><span class="n">t</span> <span class="n">x1</span> <span class="n">vmlinuz</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;1f 8b 08 00&#39;</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0000000</span> <span class="mi">1</span><span class="n">f</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">08</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">02</span> <span class="mi">03</span> <span class="n">ec</span> <span class="mi">5</span><span class="n">b</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">54</span> <span class="mi">54</span> <span class="mi">67</span>
</pre></div>
</div>
<ul>
<li><p>这里 <code class="docutils literal notranslate"><span class="pre">0000000</span></code> 就是内核开始位置，我们要从这个位置开始解压缩内核:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="n">vmlinuz</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0000000</span> <span class="o">|</span> <span class="n">zcat</span> <span class="o">&gt;</span> <span class="n">vmlinux</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="config-txt">
<h2>更新启动config.txt<a class="headerlink" href="#config-txt" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>配置 <code class="docutils literal notranslate"><span class="pre">config.txt</span></code> 文件告知树莓派如何启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</li>
</ul>
<p>注释掉所有 <code class="docutils literal notranslate"><span class="pre">[pi*]</span></code> 段落，然后添加 <code class="docutils literal notranslate"><span class="pre">kernel=vmlinux</span></code> 和 <code class="docutils literal notranslate"><span class="pre">initramfs</span> <span class="pre">initrd.img</span> <span class="pre">followkernel</span></code> 到 <code class="docutils literal notranslate"><span class="pre">[all]</span></code> 段落:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#[pi4]</span>
<span class="c1">#kernel=uboot_rpi_4.bin</span>
<span class="c1">#max_framebuffers=2</span>

<span class="c1">#[pi2]</span>
<span class="c1">#kernel=uboot_rpi_2.bin</span>

<span class="c1">#[pi3]</span>
<span class="c1">#kernel=uboot_rpi_3.bin</span>

<span class="p">[</span><span class="nb">all</span><span class="p">]</span>
<span class="n">arm_64bit</span><span class="o">=</span><span class="mi">1</span>
<span class="n">device_tree_address</span><span class="o">=</span><span class="mh">0x03000000</span>
<span class="n">kernel</span><span class="o">=</span><span class="n">vmlinux</span>
<span class="n">initramfs</span> <span class="n">initrd</span><span class="o">.</span><span class="n">img</span> <span class="n">followkernel</span>
</pre></div>
</div>
</section>
<section id="dat-elf">
<h2>更新 .dat 和 .elf 文件<a class="headerlink" href="#dat-elf" title="永久链接至标题">¶</a></h2>
<p>Ubuntu发行版的firmware版本不如树莓派官方版本新，所以需要使用树莓派官方版本更新。</p>
<ul>
<li><p>请采用 <a class="reference internal" href="usb_boot_ubuntu_pi_4_debug.html#gitzip"><span class="std std-ref">更新 .dat 和 .elf 文件</span></a> 方法下载最新的 <code class="docutils literal notranslate"><span class="pre">raspberrypi/firmware</span></code> ，或者采用我前面通过 Raspberry Pi OS更新过整个操作系统和firmware之后，直接复制本地系统已经升级过的firmware文件(我采用这个方法):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">boot</span><span class="o">/*.</span><span class="n">dat</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">boot</span><span class="o">/*.</span><span class="n">elf</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id4">
<h2>重启<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>完成Ubuntu的内核解压缩和更新Ubuntu的firmware之后，就可以关闭树莓派，然后再次加电启动。此时观察可以看到树莓派从移动硬盘的Ubuntu for Raspberry Pi 20.04.1 LTS启动。</p>
</section>
<section id="id5">
<h2>参考<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://eugenegrechko.com/blog/USB-Boot-Ubuntu-Server-20.04-on-Raspberry-Pi-4">USB Boot Ubuntu Server 20.04 on Raspberry Pi 4</a></p></li>
<li><p><a class="reference external" href="https://gist.github.com/zoilomora/f862f76335f5f53644a1b8e55fe98320">How to disable cloud-init in Ubuntu</a></p></li>
</ul>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="usb_boot_kali_pi_4.html" class="btn btn-neutral float-right" title="树莓派4 USB存储启动Kali Linux" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="usb_boot_ubuntu_pi_4_debug.html" class="btn btn-neutral float-left" title="debug: 树莓派4 USB存储启动Ubuntu Server 20.04" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; <a href="../../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>