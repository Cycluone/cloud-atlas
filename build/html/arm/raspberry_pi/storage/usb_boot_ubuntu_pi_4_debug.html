<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>debug: 树莓派4 USB存储启动Ubuntu Server 20.04 &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sphinxnotes-strike.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../copyright.html" />
    <link rel="next" title="树莓派4 USB存储启动Ubuntu Server 20.04" href="usb_boot_ubuntu_pi_4.html" />
    <link rel="prev" title="USB移动存储启动和运行树莓派3" href="usb_boot_pi_3.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ansible/index.html">Ansible Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sqlite/index.html">SQLite Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nosql/index.html">NoSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_search/index.html">Search Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../info_service/index.html">Info-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">ARM Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../hardware/index.html">ARM 硬件概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../architecture/index.html">ARM 架构随想</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../power_manage/index.html">ARM电源管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../blackberry/index.html">BlackBerry(黑莓)</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Raspberry Pi</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../hardware/index.html">树莓派硬件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../startup/index.html">树莓派起步</a></li>
<li class="toctree-l3"><a class="reference internal" href="../admin/index.html">树莓派系统管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../network/index.html">树莓派网络</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Raspberry Pi 存储</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="choice_pi_storage.html">树莓派存储设备选择</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_3.html">USB标准3.x</a></li>
<li class="toctree-l4"><a class="reference internal" href="wd_passport_ssd.html">西部数据Passport SSD移动硬盘</a></li>
<li class="toctree-l4"><a class="reference internal" href="wd_digital_dashboard.html">西部数据SSD存储管理工具: Western Digital Dashboard</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_boot_pi_3.html">USB移动存储启动和运行树莓派3</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">debug: 树莓派4 USB存储启动Ubuntu Server 20.04</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_boot_ubuntu_pi_4.html">树莓派4 USB存储启动Ubuntu Server 20.04</a></li>
<li class="toctree-l4"><a class="reference internal" href="usb_boot_kali_pi_4.html">树莓派4 USB存储启动Kali Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="chroot_raspbian.html">chroot Raspbian维护更新</a></li>
<li class="toctree-l4"><a class="reference internal" href="disable_auto_resize.html">关闭自动resize根文件系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="radxa_taco.html">Radxa Taco - 树莓派PCIe存储设备</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../uart/index.html">树莓派UART串口通讯</a></li>
<li class="toctree-l3"><a class="reference internal" href="../performance/index.html">树莓派性能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debug/index.html">树莓派异常排查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pi_cluster/index.html">Raspberry Pi Cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="../android/index.html">树莓派运行Android</a></li>
<li class="toctree-l3"><a class="reference internal" href="../machine_learning/index.html">树莓派机器学习</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../pine/index.html">Pine64</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../openwrt/index.html">OpenWrt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../build/index.html">ARM编译</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">ARM Atlas</a> &raquo;</li>
          <li><a href="../index.html">Raspberry Pi</a> &raquo;</li>
          <li><a href="index.html">Raspberry Pi 存储</a> &raquo;</li>
      <li>debug: 树莓派4 USB存储启动Ubuntu Server 20.04</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/arm/raspberry_pi/storage/usb_boot_ubuntu_pi_4_debug.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="debug-4-usbubuntu-server-20-04">
<span id="usb-boot-ubuntu-pi-4-debug"></span><h1>debug: 树莓派4 USB存储启动Ubuntu Server 20.04<a class="headerlink" href="#debug-4-usbubuntu-server-20-04" title="永久链接至标题">¶</a></h1>
<p>我在折腾 <a class="reference internal" href="usb_boot_pi_3.html#usb-boot-pi-3"><span class="std std-ref">USB移动存储启动和运行树莓派3</span></a> 时发现Ubuntu Server 20.04 for Raspberry Pi版本在树莓派上启动特性和标准的树莓派不同，设置USB存储启动步骤比较复杂。</p>
<section id="firmwareusb">
<h2>更新firmware以支持USB启动<a class="headerlink" href="#firmwareusb" title="永久链接至标题">¶</a></h2>
<p>首先需要确保Raspberry Pi 4支持从USB启动，就是需要将Raspbian (树莓派官方操作系统) 安装到SD卡并更新firmware。</p>
<p>可以参考 <a class="reference external" href="https://www.youtube.com/watch?v=tUrX9wzhygc">YouTube上视频 “Stable Raspberry Pi 4 USB boot (HOW-TO)”</a> 升级树莓派的boot loader，完成后再进入下一步。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>树莓派官方提供的raspbian系统包含了 <code class="docutils literal notranslate"><span class="pre">rpi-eeprom</span></code> 和 <code class="docutils literal notranslate"><span class="pre">rpi-eeprom-images</span></code> ，用于更新树莓派firmware。可以直接使用官方提供的32位Raspbian系统就可以，我们只是使用官方镜像来更新firmware，完成后，我们依然安装Ubuntu 64位Server版本。</p>
</div>
<p>如果你的firmware是beta版本，则需要修改 <code class="docutils literal notranslate"><span class="pre">/etc/default/rpi-eeprom-update</span></code> 配置文件，将:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FIRMWARE_RELEASE_STATUS</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span>
</pre></div>
</div>
<p>修改成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FIRMWARE_RELEASE_STATUS</span><span class="o">=</span><span class="s2">&quot;stable&quot;</span>
</pre></div>
</div>
<p>如果你的firmware是beta版本，则修改上述 <code class="docutils literal notranslate"><span class="pre">/etc/default/rpi-eeprom-update</span></code> ，从 <code class="docutils literal notranslate"><span class="pre">beta</span></code> 参数 修改成 <code class="docutils literal notranslate"><span class="pre">stable</span></code> ，也是一样的方法。</p>
<p>使用树莓派官方镜像启动系统后，进入操作系统，执行以下命令进行系统更新:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">upgrade</span>
<span class="n">sudo</span> <span class="n">rpi</span><span class="o">-</span><span class="n">update</span>
<span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
<p>然后执行以下命令更新bootloader(具体需要根据实际当时提供的软件版本来定):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">bootloader</span><span class="o">/</span><span class="n">stable</span><span class="o">/</span><span class="n">pieeprom</span><span class="o">-</span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mf">03.</span><span class="n">bin</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>目前GPU的firmware还是beta版本，今后可能还需要刷新。</p>
</div>
<p>完成bootloader更新之后，再次重启:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
<p>重启以后确保能够正常进入系统，然后我们需要验证firmware是否更新成功:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vcgencmd</span> <span class="n">bootloader_version</span>
</pre></div>
</div>
<p>需要确保版本显示的是正确的 <code class="docutils literal notranslate"><span class="pre">Sep</span> <span class="pre">03</span></code> 日期。</p>
<p>然后检查 bootloader 配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vcgencmd</span> <span class="n">bootloader_config</span>
</pre></div>
</div>
<p>显示中有:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0xf41</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>只需要在第一台树莓派上完成firmware和bootloader更新，然后把这个TF卡放到其他没有升级过的树莓派上，只需要第一次启动，存储在TF卡中最新的firmware就会自动更新硬件，因为默认就配置了启动时自动更新firmwre，所以只要操作系统存储着最新的firmware就会在启动时更新。</p>
<p>所以，上述操作只需要做一次，其他树莓派只需要用这个TF卡插入开机重启一次就可以升级好。(树莓派每次启动都会检查本机最新的firmware进行升级)</p>
</div>
<section id="rpi-update">
<h3>rpi-update异常排查<a class="headerlink" href="#rpi-update" title="永久链接至标题">¶</a></h3>
<p>执行 <code class="docutils literal notranslate"><span class="pre">rpi-update</span></code> 遇到如下报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>*** Raspberry Pi firmware updater by Hexxeh, enhanced by AndrewS and Dom
*** Performing self-update
!!! Failed to download update for rpi-update!
!!! Make sure you have ca-certificates installed and that the time is set correctly
</pre></div>
</div>
<p>由于确定时间正确并且已经更新过系统，所以ca证书应该也正确安装。</p>
<p>参考 <a class="reference external" href="https://github.com/Hexxeh/rpi-update/issues/206">Failed to down update for rpi-update #206</a> ，我发现和issue不同的是，我能够解析DNS，并且能够正确执行 <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">--head</span> <span class="pre">https://github.com/</span></code> 。但是执行 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt</span> <span class="pre">rpi-update</span></code> 确实没有下载任何内容。</p>
<p>按照 <a class="reference external" href="https://github.com/Hexxeh/rpi-update/issues/206">Failed to down update for rpi-update #206</a> 进行排查，发现实际是因为电信DNS解析 <code class="docutils literal notranslate"><span class="pre">raw.githubusercontent.com</span></code> 这个域名异常:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -Lfs --output /tmp/rpi-update https://raw.githubusercontent.com/Hexxeh/rpi-update/master/rpi-update
$ ls -lh /tmp/rpi-update
ls: cannot access &#39;/tmp/rpi-update&#39;: No such file or directory
$ curl https://raw.githubusercontent.com/Hexxeh/rpi-update/master/rpi-update
curl: (7) Failed to connect to raw.githubusercontent.com port 443: Connection refused
$ host raw.githubusercontent.com
raw.githubusercontent.com has address 0.0.0.0
raw.githubusercontent.com has IPv6 address ::
raw.githubusercontent.com is an alias for github.map.fastly.net.
</pre></div>
</div>
<p>而在修改 <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> 配置使用公司内网DNS解析:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ host raw.githubusercontent.com
raw.githubusercontent.com is an alias for github.map.fastly.net.
github.map.fastly.net has address 151.101.228.133
</pre></div>
</div>
<p>通过 <code class="docutils literal notranslate"><span class="pre">dnsutils</span></code> 软件包中的dig命令可以看到，通过电信DNS解析是错误的，显示该域名已经被电信DNS污染:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ dig @202.96.209.133 raw.githubusercontent.com
...
;; ANSWER SECTION:
raw.githubusercontent.com. 300  IN    A    0.0.0.0
</pre></div>
</div>
</section>
</section>
<section id="ubuntu-server">
<h2>安装64位Ubuntu Server<a class="headerlink" href="#ubuntu-server" title="永久链接至标题">¶</a></h2>
<p>参考 <a class="reference internal" href="../startup/ubuntu64bit_pi.html#ubuntu64bit-pi"><span class="std std-ref">树莓派4b运行64位Ubuntu</span></a> 安装Ubuntu 64位树莓派服务器版本。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>现在我们已经不再需要树莓派官方提供的 Raspbian 运行TF卡了，请把该存储卡保存好，今后可能还会再次使用用来更新firmware。</p>
</div>
</section>
<section id="ssd">
<h2>复制系统到SSD存储<a class="headerlink" href="#ssd" title="永久链接至标题">¶</a></h2>
<section id="dd">
<h3>通过dd复制系统(可选)<a class="headerlink" href="#dd" title="永久链接至标题">¶</a></h3>
<ul>
<li><p>采用 <code class="docutils literal notranslate"><span class="pre">dd</span></code> 命令完整复制磁盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span> <span class="n">bs</span><span class="o">=</span><span class="mi">100</span><span class="n">M</span>
</pre></div>
</div>
</li>
<li><p>然后挂载SSD磁盘分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="tar">
<h3>通过tar复制系统(推荐)<a class="headerlink" href="#tar" title="永久链接至标题">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>采用tar包方式clone系统，可以灵活调整磁盘分区。</p>
</div>
<p>我的规划是使用SSD存储30G空间部署系统，启用空间划分给 <a class="reference internal" href="../../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a> 和 <a class="reference internal" href="../../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> ，以及构建本地 <a class="reference internal" href="../../../docker/index.html#docker"><span class="std std-ref">Docker Atlas</span></a> 运行存储。</p>
<ul class="simple">
<li><p>把 <a class="reference internal" href="wd_passport_ssd.html#wd-passport-ssd"><span class="std std-ref">西部数据Passport SSD移动硬盘</span></a> 插入树莓派4的USB接口(请使用蓝色的USB 3.0接口)，然后执行以下命令进行磁盘分区和文件系统格式化。划分方法统一采用分区方法，参考 <a class="reference internal" href="usb_boot_pi_3.html#usb-boot-pi-3"><span class="std std-ref">USB移动存储启动和运行树莓派3</span></a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span># parted -a optimal /dev/sda
<span class="linenos"> 2</span>GNU Parted 3.3
<span class="linenos"> 3</span>Using /dev/sda
<span class="linenos"> 4</span>Welcome to GNU Parted! Type &#39;help&#39; to view a list of commands.
<span class="linenos"> 5</span>(parted) mklabel msdos
<span class="linenos"> 6</span>Warning: The existing disk label on /dev/sda will be destroyed and all data on
<span class="linenos"> 7</span>this disk will be lost. Do you want to continue?
<span class="linenos"> 8</span>Yes/No? y
<span class="linenos"> 9</span>(parted) print
<span class="linenos">10</span>Model: WD My Passport 25F3 (scsi)
<span class="linenos">11</span>Disk /dev/sda: 1024GB
<span class="linenos">12</span>Sector size (logical/physical): 512B/4096B
<span class="linenos">13</span>Partition Table: msdos
<span class="linenos">14</span>Disk Flags:
<span class="linenos">15</span>
<span class="linenos">16</span>Number  Start  End  Size  Type  File system  Flags
<span class="linenos">17</span>
<span class="linenos">18</span>(parted) mkpart primary fat32 2048s 256M
<span class="linenos">19</span>(parted) align-check optimal 1
<span class="linenos">20</span>1 aligned
<span class="linenos">21</span>(parted) unit s
<span class="linenos">22</span>(parted) print
<span class="linenos">23</span>Model: WD My Passport 25F3 (scsi)
<span class="linenos">24</span>Disk /dev/sda: 2000343040s
<span class="linenos">25</span>Sector size (logical/physical): 512B/4096B
<span class="linenos">26</span>Partition Table: msdos
<span class="linenos">27</span>Disk Flags:
<span class="linenos">28</span>
<span class="linenos">29</span>Number  Start  End      Size     Type     File system  Flags
<span class="linenos">30</span> 1      2048s  499711s  497664s  primary  fat32        lba
<span class="linenos">31</span>
<span class="linenos">32</span>(parted) mkpart primary ext4 499712 30G
<span class="linenos">33</span>(parted) print
<span class="linenos">34</span>Model: WD My Passport 25F3 (scsi)
<span class="linenos">35</span>Disk /dev/sda: 2000343040s
<span class="linenos">36</span>Sector size (logical/physical): 512B/4096B
<span class="linenos">37</span>Partition Table: msdos
<span class="linenos">38</span>Disk Flags:
<span class="linenos">39</span>
<span class="linenos">40</span>Number  Start    End        Size       Type     File system  Flags
<span class="linenos">41</span> 1      2048s    499711s    497664s    primary  fat32        lba
<span class="linenos">42</span> 2      499712s  58593279s  58093568s  primary  ext4         lba
<span class="linenos">43</span>
<span class="linenos">44</span>(parted) align-check optimal 2
<span class="linenos">45</span>2 aligned
<span class="linenos">46</span>(parted) unit MB
<span class="linenos">47</span>(parted) set 1 boot on
<span class="linenos">48</span>(parted) print
<span class="linenos">49</span>Model: WD My Passport 25F3 (scsi)
<span class="linenos">50</span>Disk /dev/sda: 1024176MB
<span class="linenos">51</span>Sector size (logical/physical): 512B/4096B
<span class="linenos">52</span>Partition Table: msdos
<span class="linenos">53</span>Disk Flags:
<span class="linenos">54</span>
<span class="linenos">55</span>Number  Start   End      Size     Type     File system  Flags
<span class="linenos">56</span> 1      1.05MB  256MB    255MB    primary  fat32        boot, lba
<span class="linenos">57</span> 2      256MB   30000MB  29744MB  primary  ext4         lba
<span class="linenos">58</span>
<span class="linenos">59</span>(parted) q
<span class="linenos">60</span>Information: You may need to update /etc/fstab.
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>虽然根据网上信息，树莓派不支持GPT分区表启动，但是我实践下来发现GPT分区表是可行的，也就是可以非常容易支持超过2T的磁盘。</p>
</div>
<ul>
<li><p>格式化文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkfs</span><span class="o">.</span><span class="n">fat</span> <span class="o">-</span><span class="n">F32</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">ext4</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>如果你格式化磁盘加上了原先TF卡分区的label，就可以使得SSD磁盘标识和原先TF卡一致，这样就可以省去启动配置中有关磁盘PARTUUID的麻烦。所以，我推荐你采用格式化磁盘时加上label。详细见下文。</p>
</div>
<ul>
<li><p>Ubuntu for Raspberry Pi 分区挂载如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span>  <span class="mi">117</span><span class="n">G</span>  <span class="mf">4.1</span><span class="n">G</span>  <span class="mi">109</span><span class="n">G</span>   <span class="mi">4</span><span class="o">%</span> <span class="o">/</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p1</span>  <span class="mi">253</span><span class="n">M</span>   <span class="mi">97</span><span class="n">M</span>  <span class="mi">156</span><span class="n">M</span>  <span class="mi">39</span><span class="o">%</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
</ul>
<p>需要对应复制到新的SSD存储中，采用 <code class="docutils literal notranslate"><span class="pre">tar</span></code> 打包:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span>
<span class="c1">#tar打包系统不包含跨磁盘目录，所以/boot/firmware需要单独复制</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">cpzf</span> <span class="n">pi</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">--</span><span class="n">exclude</span><span class="o">=/</span><span class="n">pi</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">--</span><span class="n">one</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">system</span> <span class="o">/</span>

<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">sudo</span> <span class="n">tar</span> <span class="o">-</span><span class="n">xpzf</span> <span class="o">/</span><span class="n">pi</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">mnt</span> <span class="o">--</span><span class="n">numeric</span><span class="o">-</span><span class="n">owner</span>

<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
<span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">cf</span> <span class="o">-</span> <span class="o">.</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">xf</span> <span class="o">-</span><span class="p">)</span>
</pre></div>
</div>
<p>以上已经完整将原先在TF卡上运行的 <a class="reference internal" href="../startup/ubuntu64bit_pi.html#ubuntu64bit-pi"><span class="std std-ref">树莓派4b运行64位Ubuntu</span></a> 复制到了USB外接的SSD移动硬盘上。</p>
<ul>
<li><p>检查SSD磁盘的UUID，我们需要将PARTUUID配置到启动命令 <code class="docutils literal notranslate"><span class="pre">cmdline.txt</span></code> 配置文件以及 <code class="docutils literal notranslate"><span class="pre">fstab</span></code> 配置文件，正确反映磁盘挂载和启动分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># blkid /dev/sda</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span><span class="p">:</span> <span class="n">PTUUID</span><span class="o">=</span><span class="s2">&quot;b541639f&quot;</span> <span class="n">PTTYPE</span><span class="o">=</span><span class="s2">&quot;dos&quot;</span>
<span class="c1"># blkid /dev/sda1</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span><span class="p">:</span> <span class="n">UUID</span><span class="o">=</span><span class="s2">&quot;6E36-5E03&quot;</span> <span class="n">TYPE</span><span class="o">=</span><span class="s2">&quot;vfat&quot;</span> <span class="n">PARTUUID</span><span class="o">=</span><span class="s2">&quot;b541639f-01&quot;</span>
<span class="c1"># blkid /dev/sda2</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span><span class="p">:</span> <span class="n">UUID</span><span class="o">=</span><span class="s2">&quot;f4d2caed-9b2c-4645-99b4-8b406eb7d3f1&quot;</span> <span class="n">TYPE</span><span class="o">=</span><span class="s2">&quot;ext4&quot;</span> <span class="n">PARTUUID</span><span class="o">=</span><span class="s2">&quot;b541639f-02&quot;</span>
</pre></div>
</div>
</li>
</ul>
<p>这里的 <code class="docutils literal notranslate"><span class="pre">PARTUUID</span></code> 需要修改对应配置。</p>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/mnt/boot/firmware/cmdline.txt</span></code> 将:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">net</span><span class="o">.</span><span class="n">ifnames</span><span class="o">=</span><span class="mi">0</span> <span class="n">dwc_otg</span><span class="o">.</span><span class="n">lpm_enable</span><span class="o">=</span><span class="mi">0</span> <span class="n">console</span><span class="o">=</span><span class="n">serial0</span><span class="p">,</span><span class="mi">115200</span> <span class="n">console</span><span class="o">=</span><span class="n">tty1</span> <span class="n">root</span><span class="o">=</span><span class="n">LABEL</span><span class="o">=</span><span class="n">writable</span> <span class="n">rootfstype</span><span class="o">=</span><span class="n">ext4</span> <span class="n">elevator</span><span class="o">=</span><span class="n">deadline</span> <span class="n">rootwait</span> <span class="n">fixrtc</span>
</pre></div>
</div>
</li>
</ul>
<p>修改成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">net</span><span class="o">.</span><span class="n">ifnames</span><span class="o">=</span><span class="mi">0</span> <span class="n">dwc_otg</span><span class="o">.</span><span class="n">lpm_enable</span><span class="o">=</span><span class="mi">0</span> <span class="n">console</span><span class="o">=</span><span class="n">serial0</span><span class="p">,</span><span class="mi">115200</span> <span class="n">console</span><span class="o">=</span><span class="n">tty1</span> <span class="n">root</span><span class="o">=</span><span class="n">PARTUUID</span><span class="o">=</span><span class="s2">&quot;b541639f-02&quot;</span> <span class="n">rootfstype</span><span class="o">=</span><span class="n">ext4</span> <span class="n">elevator</span><span class="o">=</span><span class="n">deadline</span> <span class="n">rootwait</span> <span class="n">fixrtc</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这里 <code class="docutils literal notranslate"><span class="pre">PARTUUID=</span></code> 是USB外接SSD磁盘的分区2的PARTUUID。注意，是SSD磁盘，所以 <code class="docutils literal notranslate"><span class="pre">elevator=</span></code> 参数保持和原先TF卡配置一样，还是 <code class="docutils literal notranslate"><span class="pre">deadline</span></code> 。不过，如果你的外接磁盘是机械硬盘，则参数改为 <code class="docutils literal notranslate"><span class="pre">cfq</span></code> 。</p>
</div>
<ul>
<li><p>编辑 <code class="docutils literal notranslate"><span class="pre">/mnt/etc/fstab</span></code> ，将:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LABEL</span><span class="o">=</span><span class="n">writable</span>       <span class="o">/</span>        <span class="n">ext4</span>   <span class="n">defaults</span>        <span class="mi">0</span> <span class="mi">0</span>
<span class="n">LABEL</span><span class="o">=</span><span class="n">system</span><span class="o">-</span><span class="n">boot</span>       <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>  <span class="n">vfat</span>    <span class="n">defaults</span>        <span class="mi">0</span>       <span class="mi">1</span>
</pre></div>
</div>
</li>
</ul>
<p>修改成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PARTUUID</span><span class="o">=</span><span class="s2">&quot;b541639f-01&quot;</span>       <span class="o">/</span>        <span class="n">ext4</span>   <span class="n">defaults</span>        <span class="mi">0</span> <span class="mi">0</span>
<span class="n">PARTUUID</span><span class="o">=</span><span class="s2">&quot;b541639f-02&quot;</span>  <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>  <span class="n">vfat</span>    <span class="n">defaults</span>        <span class="mi">0</span>       <span class="mi">1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以上是通过tar方式复制系统，我在最初尝试时没有成功。我还以为是这个方法存在问题，后来才发现实际上是因为内核没有解压缩导致的。详见下文</p>
</div>
</section>
<section id="id2">
<h3>有关树莓派分区表<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>注意到SD卡使用的分区表是msdos，但是我在划分USB外接移动硬盘时候，使用了 <code class="docutils literal notranslate"><span class="pre">parted</span></code> 将磁盘的分区表构建成了GPT。参考 <a class="reference external" href="https://www.raspberrypi.org/forums/viewtopic.php?t=205418">booting from a GPT mass storage device</a> 了解到树莓派不支持GPT分区表的磁盘启动，而是要使用2TB以下磁盘，采用msdos分区表启动。有人尝试将MBR转换成GPT(使用 <code class="docutils literal notranslate"><span class="pre">gdisk</span></code> 工具的选项 <code class="docutils literal notranslate"><span class="pre">r-f-y-w</span></code> )，虽然GPT分区正确并且数据能够在Mac/Windows/Linux上读取，但是树莓派3不能从磁盘启动，始终看到的是彩虹屏幕。</p>
<p>我在树莓派4上最后测试验证GPT分区表是可以支持启动的，树莓派3后续有机会再测试。</p>
<p><a class="reference external" href="https://www.rodsbooks.com/gdisk/hybrid.html">Hybrid MBRs: The Good, the Bad, and the So Ugly You’ll Tear Your Eyes Out</a> 使用 <code class="docutils literal notranslate"><span class="pre">gdisk</span></code> 转换分区表来实现混合分区表(方法待参考):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># gdisk /dev/sda
GPT fdisk (gdisk) version 1.0.5

Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present

Found valid GPT with protective MBR; using GPT.

Command (? for help): r

Recovery/transformation command (? for help): p
Disk /dev/sda: 2000343040 sectors, 953.8 GiB
Model: My Passport 25F3
Sector size (logical/physical): 512/4096 bytes
Disk identifier (GUID): A0ACD939-81CF-4874-B5E3-45B51A11B1B5
Partition table holds up to 128 entries
Main partition table begins at sector 2 and ends at sector 33
First usable sector is 34, last usable sector is 2000343006
Partitions will be aligned on 2048-sector boundaries
Total free space is 1941751741 sectors (925.9 GiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048          499711   243.0 MiB   EF00  primary
   2          499712        58593279   27.7 GiB    8300  primary

Recovery/transformation command (? for help): h

WARNING! Hybrid MBRs are flaky and dangerous! If you decide not to use one,
just hit the Enter key at the below prompt and your MBR partition table will
be untouched.

Type from one to three GPT partition numbers, separated by spaces, to be
added to the hybrid MBR, in sequence: 1 2
Place EFI GPT (0xEE) partition first in MBR (good for GRUB)? (Y/N): y

Creating entry for GPT partition #1 (MBR partition #2)
Enter an MBR hex code (default EF):
Set the bootable flag? (Y/N): y

Creating entry for GPT partition #2 (MBR partition #3)
Enter an MBR hex code (default 83):
Set the bootable flag? (Y/N): n

Unused partition space(s) found. Use one to protect more partitions? (Y/N): n

Recovery/transformation command (? for help): o

Disk size is 2000343040 sectors (953.8 GiB)
MBR disk identifier: 0x16F2A91F
MBR partitions:

Number  Boot  Start Sector   End Sector   Status      Code
   1                     1         2047   primary     0xEE
   2      *           2048       499711   primary     0xEF
   3                499712     58593279   primary     0x83

Recovery/transformation command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sda.
The operation has completed successfully.
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>转换完成后，使用 <code class="docutils literal notranslate"><span class="pre">fdisk</span> <span class="pre">-l</span></code> 和 <code class="docutils literal notranslate"><span class="pre">parted</span> <span class="pre">/dev/sda</span></code> 检查，可以看到分区表依然是GPT(暂时没有探索明白)，后续我准备再采购新设备时重新实践一下。</p>
</div>
</section>
</section>
<section id="id3">
<h2>解压缩内核<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>每次Ubuntu更新内核都需要重复执行这个步骤。</p>
</div>
<p>当前不支持压缩版本的64位arm内核启动，所以我们需要将 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> 解压成 <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> 。</p>
<ul>
<li><p>找出镜像中gzip压缩的内容起点:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
<span class="n">od</span> <span class="o">-</span><span class="n">A</span> <span class="n">d</span> <span class="o">-</span><span class="n">t</span> <span class="n">x1</span> <span class="n">vmlinuz</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;1f 8b 08 00&#39;</span>
</pre></div>
</div>
</li>
</ul>
<p>输出类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0000000</span> <span class="mi">1</span><span class="n">f</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">08</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">02</span> <span class="mi">03</span> <span class="n">ec</span> <span class="mi">5</span><span class="n">c</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">74</span> <span class="mi">14</span> <span class="mi">55</span>
</pre></div>
</div>
<p>这里第一串数字 <code class="docutils literal notranslate"><span class="pre">0000000</span></code> 就是起点，也就是镜像的开始位置。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>注意 /boot 目录和 /boot/firmware 目录下都有一个 vmlinuz 文件，前者是软链接，指向 <code class="docutils literal notranslate"><span class="pre">/boot/vmlinuz-5.4.0-1021-raspi</span></code> ，后者是实际文件 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> 。一定要操作 <code class="docutils literal notranslate"><span class="pre">/boot/firmware</span></code> 目录下的 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> ，而不是 <code class="docutils literal notranslate"><span class="pre">/boot/vminuz</span></code> ，否则从USB移动硬盘启动会报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">sdhci_send_command</span><span class="p">:</span> <span class="n">MMC</span><span class="p">:</span> <span class="mi">1</span> <span class="n">busy</span> <span class="n">timeout</span><span class="o">.</span>
<span class="n">starting</span> <span class="n">USB</span><span class="o">...</span>
<span class="n">No</span> <span class="n">working</span> <span class="n">controllers</span> <span class="n">found</span>
<span class="n">USB</span> <span class="ow">is</span> <span class="n">stopped</span><span class="o">.</span> <span class="n">Please</span> <span class="n">issue</span> <span class="s1">&#39;usb start&#39;</span> <span class="n">first</span><span class="o">.</span>
<span class="n">starting</span> <span class="n">USB</span><span class="o">...</span>
<span class="n">No</span> <span class="n">working</span> <span class="n">controllers</span> <span class="n">found</span>
<span class="n">No</span> <span class="n">ethernet</span> <span class="n">found</span><span class="o">.</span>
<span class="n">missing</span> <span class="n">environment</span> <span class="n">variable</span><span class="p">:</span> <span class="n">pxeuuid</span>
<span class="n">missing</span> <span class="n">environment</span> <span class="n">variable</span><span class="p">:</span> <span class="n">bootfile</span>
<span class="n">Retrieving</span> <span class="n">file</span><span class="p">:</span> <span class="n">pxelinux</span><span class="o">.</span><span class="n">cfg</span><span class="o">/</span><span class="mi">00000000</span>
<span class="n">No</span> <span class="n">ethernet</span> <span class="n">found</span><span class="o">.</span>
<span class="o">...</span>
<span class="n">Config</span> <span class="n">file</span> <span class="ow">not</span> <span class="n">found</span>
<span class="n">starting</span> <span class="n">USB</span><span class="o">...</span>
<span class="n">No</span> <span class="n">working</span> <span class="n">controllers</span> <span class="n">found</span>
<span class="n">No</span> <span class="n">ethernet</span> <span class="n">found</span><span class="o">.</span>
<span class="n">No</span> <span class="n">ethernet</span> <span class="n">found</span><span class="o">.</span>
<span class="n">U</span><span class="o">-</span><span class="n">Boot</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>然后停止响应。</p>
</div>
<ul>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">dd</span></code> 命令展开数据然后用 <code class="docutils literal notranslate"><span class="pre">zcat</span></code> 解压缩到一个文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="n">vmlinuz</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0000000</span> <span class="o">|</span> <span class="n">zcat</span> <span class="o">&gt;</span> <span class="n">vmlinux</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="config-txt">
<h2>更新启动config.txt<a class="headerlink" href="#config-txt" title="永久链接至标题">¶</a></h2>
<ul>
<li><p>配置 <code class="docutils literal notranslate"><span class="pre">config.txt</span></code> 文件告知树莓派如何启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</li>
</ul>
<p>注释掉所有 <code class="docutils literal notranslate"><span class="pre">[pi*]</span></code> 段落，然后添加 <code class="docutils literal notranslate"><span class="pre">kernel=vmlinux</span></code> 和 <code class="docutils literal notranslate"><span class="pre">initramfs</span> <span class="pre">initrd.img</span> <span class="pre">followkernel</span></code> 到 <code class="docutils literal notranslate"><span class="pre">[all]</span></code> 段落:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#[pi4]</span>
<span class="c1">#kernel=uboot_rpi_4.bin</span>
<span class="c1">#max_framebuffers=2</span>

<span class="c1">#[pi2]</span>
<span class="c1">#kernel=uboot_rpi_2.bin</span>

<span class="c1">#[pi3]</span>
<span class="c1">#kernel=uboot_rpi_3.bin</span>

<span class="p">[</span><span class="nb">all</span><span class="p">]</span>
<span class="n">arm_64bit</span><span class="o">=</span><span class="mi">1</span>
<span class="n">device_tree_address</span><span class="o">=</span><span class="mh">0x03000000</span>
<span class="n">kernel</span><span class="o">=</span><span class="n">vmlinux</span>
<span class="n">initramfs</span> <span class="n">initrd</span><span class="o">.</span><span class="n">img</span> <span class="n">followkernel</span>
</pre></div>
</div>
</section>
<section id="dat-elf">
<span id="gitzip"></span><h2>更新 .dat 和 .elf 文件<a class="headerlink" href="#dat-elf" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>下载最新的raspberry pi的firmware，但是这个库非常巨大(10G+)，所以不建议直接clone，而是采用 <a class="reference external" href="https://gitzip.org/">chrome插件 GitZip</a> 来指定只下载部分文件。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>GitZip插件刚开始使用有点让我疑惑，实际上这个插件使用有两步：</p>
<ul class="simple">
<li><p>点击GitZip插件按钮，在弹出浮动窗口点 <code class="docutils literal notranslate"><span class="pre">Get</span> <span class="pre">Token:Normal/Private</span></code> 的 <code class="docutils literal notranslate"><span class="pre">Normal</span></code> 链接，转到GitHub授权页面给这个插件授权(即获得Github API Access Token)</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../_images/gitzip_token.png"><img alt="../../../_images/gitzip_token.png" src="../../../_images/gitzip_token.png" style="width: 600.0px; height: 218.25px;" /></a>
</figure>
<ul class="simple">
<li><p>然后在GitHub的文件中，选择文件或者目录，不要直接点文件或目录的url(这样还是转跳)而是在这一行中点空白处，并且连点2下。此时在这行的开头就会浮现一个勾选符号，并且页面右下角会浮现出下载按钮</p></li>
</ul>
</div>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../_images/gitzip_download.png"><img alt="../../../_images/gitzip_download.png" src="../../../_images/gitzip_download.png" style="width: 600.0px; height: 321.75px;" /></a>
</figure>
<ul>
<li><p>将下载的最新Raspberry pi firmware 的 <code class="docutils literal notranslate"><span class="pre">boot</span></code> 目录下 <code class="docutils literal notranslate"><span class="pre">.dat</span></code> 和 <code class="docutils literal notranslate"><span class="pre">.elf</span></code> 文件到Ubuntu的 <code class="docutils literal notranslate"><span class="pre">/boot</span></code> 分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">boot</span><span class="o">/*.</span><span class="n">dat</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">boot</span><span class="o">/*.</span><span class="n">elf</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="ubuntu-chroot">
<h2>废弃:更新Ubuntu操作系统(chroot方式)<a class="headerlink" href="#ubuntu-chroot" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这步跳过!!!</p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>我在使用chroot模式更新操作系统时候遇到一个错误，因为host主机的操作系统是 <a class="reference internal" href="../../../machine_learning/jetson/jetson_nano.html#jetson-nano"><span class="std std-ref">Jetson Nano</span></a> 的 L4T 定制版本Ubuntu 18.04 LTS，在内核上有差异，更新系统时候有一步需要更新 <code class="docutils literal notranslate"><span class="pre">initramfs-tools</span></code> 出现报错:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  ...
  Processing triggers for systemd (245.4-4ubuntu3.2) ...
  Running in chroot, ignoring request: daemon-reload
  Processing triggers for man-db (2.9.1-1) ...
  Processing triggers for ca-certificates (20201027ubuntu0.20.04.1) ...
  Updating certificates in /etc/ssl/certs...
  0 added, 0 removed; done.
  Running hooks in /etc/ca-certificates/update.d...
  done.
  Processing triggers for linux-image-5.4.0-1022-raspi (5.4.0-1022.25) ...
  /etc/kernel/postinst.d/initramfs-tools:
  update-initramfs: Generating /boot/initrd.img-5.4.0-1022-raspi
  W: mkconf: MD subsystem is not loaded, thus I cannot scan for arrays.
  W: mdadm: failed to auto-generate temporary mdadm.conf file.
  flash-kernel: deferring update (trigger activated)
  /etc/kernel/postinst.d/zz-flash-kernel:
  flash-kernel: deferring update (trigger activated)
  Processing triggers for initramfs-tools (0.136ubuntu6.3) ...
  update-initramfs: Generating /boot/initrd.img-5.4.0-1022-raspi
  W: mkconf: MD subsystem is not loaded, thus I cannot scan for arrays.
  W: mdadm: failed to auto-generate temporary mdadm.conf file.
  Unsupported platform.
  run-parts: /etc/initramfs/post-update.d//flash-kernel exited with return code 1
  dpkg: error processing package initramfs-tools (--configure):
   installed initramfs-tools package post-installation script subprocess returned error exit status 1
  Errors were encountered while processing:
   initramfs-tools
  E: Sub-process /usr/bin/dpkg returned an error code (1)

所以，我后续放弃直接在chroot中更新操作系统，改为在启动Ubuntu之后再做更新。
</pre></div>
</div>
</div>
<p>由于我们已经chroot到移动硬盘的Ubuntu系统中，所以我们可以非常方便更新移动硬盘的操作系统，这也方便后续对内核进行解压缩。</p>
<ul>
<li><p>升级Ubuntu系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span> <span class="n">update</span>
<span class="n">apt</span> <span class="n">upgrade</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id4">
<h2>启动<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>关机，将TF卡拔出，只连接USB外接的SSD移动硬盘，然后重启系统，观察Raspberry Pi从USB移动硬盘启动。</p>
<section id="id5">
<h3>启动报错<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>按照上述操作步骤，启动页面显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lba</span><span class="p">:</span> <span class="mi">2048</span> <span class="n">oem</span><span class="p">:</span> <span class="s1">&#39;mkfs.fat&#39;</span> <span class="n">volume</span><span class="p">:</span> <span class="s1">&#39; system-boot&#39;</span>
<span class="n">rsc</span> <span class="mi">32</span> <span class="n">fat</span><span class="o">-</span><span class="n">sectors</span> <span class="mi">4033</span> <span class="n">c</span><span class="o">-</span><span class="n">count</span> <span class="mi">516190</span> <span class="n">c</span><span class="o">-</span><span class="n">size</span> <span class="mi">1</span> <span class="n">r</span><span class="o">-</span><span class="nb">dir</span> <span class="mi">2</span> <span class="n">r</span><span class="o">-</span><span class="n">sec</span> <span class="mi">0</span>
<span class="n">Read</span> <span class="n">config</span><span class="o">.</span><span class="n">txt</span> <span class="nb">bytes</span>     <span class="mi">1173</span> <span class="n">hnd</span> <span class="mh">0x0001eb9c</span> <span class="nb">hash</span> <span class="s1">&#39;fafd37aa6348be46&#39;</span>
<span class="n">recovery4</span><span class="o">.</span><span class="n">elf</span> <span class="ow">not</span> <span class="n">found</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">recovery</span><span class="o">.</span><span class="n">elf</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p>然后就是彩虹页面</p>
<p>这个报错看起来和我之前在做tar备份恢复的报错相同。</p>
<p>我仔细核对了一下 <a class="reference external" href="https://eugenegrechko.com/blog/USB-Boot-Ubuntu-Server-20.04-on-Raspberry-Pi-4">USB Boot Ubuntu Server 20.04 on Raspberry Pi 4</a></p>
<p>我发现这个文档中就没有挂载过 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> ，只是挂载 <code class="docutils literal notranslate"><span class="pre">/dev/sda1</span></code> 到 <code class="docutils literal notranslate"><span class="pre">/mnt/ssdboot</span></code> 目录下，然后所有操作都是在 <code class="docutils literal notranslate"><span class="pre">/mnt/ssdboot</span></code> 下进行的。我最初以为文章中所指的 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> 是指 <code class="docutils literal notranslate"><span class="pre">/boot</span></code> 目录下的 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> ( <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> 磁盘中的 <code class="docutils literal notranslate"><span class="pre">/boot</span></code> 目录)，但是核对以后发现实际操作的是SSD磁盘 <code class="docutils literal notranslate"><span class="pre">/dev/sda1</span></code> 对应的 <code class="docutils literal notranslate"><span class="pre">/boot/firmware</span></code> 目录下的 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> 。</p>
<p>原因是Ubuntu for Raspberry实际上在 <code class="docutils literal notranslate"><span class="pre">/boot</span></code> 和 <code class="docutils literal notranslate"><span class="pre">/boot/firmware</span></code> 目录下各有一个 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> 文件。看来是我操作错误了。</p>
<p>重新回到 <code class="docutils literal notranslate"><span class="pre">/mnt/boot</span></code> 目录，将这个目录下的 <code class="docutils literal notranslate"><span class="pre">vmlinuz</span></code> 解压的 <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> 复制到子目录 <code class="docutils literal notranslate"><span class="pre">/mnt/boot/firmware</span></code> ，并相应复制 <code class="docutils literal notranslate"><span class="pre">initrd.img</span></code> 到 <code class="docutils literal notranslate"><span class="pre">/mnt/boot/firmware</span></code> 。再次重启系统，就能够正常启动了。</p>
</section>
<section id="pi-4-bootloader-configuration">
<h3>Pi 4 Bootloader Configuration<a class="headerlink" href="#pi-4-bootloader-configuration" title="永久链接至标题">¶</a></h3>
<p>参考 <a class="reference external" href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/booteeprom.md">Raspberry Pi 4 boot EEPROM</a> 指出 <a class="reference external" href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2711_bootloader_config.md">Pi 4 Bootloader Configuration</a> 需要通过树莓派的官方镜像中工具 <code class="docutils literal notranslate"><span class="pre">vcgencmd</span></code> 来检查 eeprom 中配置的bootloader。</p>
<p>使用树莓派官方镜像启动，然后执行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vcgencmd</span> <span class="n">bootloader_config</span>
</pre></div>
</div>
<p>可以看到输出信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">all</span><span class="p">]</span>
<span class="n">BOOT_UART</span><span class="o">=</span><span class="mi">0</span>
<span class="n">WAKE_ON_GPIO</span><span class="o">=</span><span class="mi">1</span>
<span class="n">POWER_OFF_ON_HALT</span><span class="o">=</span><span class="mi">0</span>
<span class="n">DHCP_TIMEOUT</span><span class="o">=</span><span class="mi">45000</span>
<span class="n">DHCP_REQ_TIMEOUT</span><span class="o">=</span><span class="mi">4000</span>
<span class="n">TFTP_FILE_TIMEOUT</span><span class="o">=</span><span class="mi">30000</span>
<span class="n">ENABLE_SELF_UPDATE</span><span class="o">=</span><span class="mi">1</span>
<span class="n">DISABLE_HDMI</span><span class="o">=</span><span class="mi">0</span>
<span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0xf41</span>
</pre></div>
</div>
<p>这里 <code class="docutils literal notranslate"><span class="pre">BOOT_ORDER=0xf41</span></code> 表示:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">0x1</span></code> - SD CARD</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">0x4</span></code> - USB mass storage boot (since 2020-09-03)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">0xf</span></code> - RESTART (loop) - start again with the first boot order field. (since 2020-09-03)</p></li>
</ul>
<p>这里的组合 <code class="docutils literal notranslate"><span class="pre">0xf41</span></code> 顺序是从右到左，也就是先SD卡，然后USB存储，不断循环。</p>
<p>看起来我使用最新的eeprom没有问题，启动顺序是正确的。</p>
<section id="eeprom">
<h4>修订eeprom<a class="headerlink" href="#eeprom" title="永久链接至标题">¶</a></h4>
<p>虽然最新的eeprom版本 (since 2020-09-03) 可以正确从USB外接存储启动(默认配置 <code class="docutils literal notranslate"><span class="pre">BOOT_ORDER=0xf41</span></code> )，但是我发现启动后树莓派4即使没有任何运行程序，也始终显示 Load Average 是1。使用 <code class="docutils literal notranslate"><span class="pre">top</span></code> 命令可以观察到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">top</span> <span class="o">-</span> <span class="mi">22</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">18</span> <span class="n">up</span> <span class="mi">1</span> <span class="n">day</span><span class="p">,</span>  <span class="mi">5</span><span class="p">:</span><span class="mi">02</span><span class="p">,</span>  <span class="mi">2</span> <span class="n">users</span><span class="p">,</span>  <span class="n">load</span> <span class="n">average</span><span class="p">:</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.00</span>
<span class="n">Tasks</span><span class="p">:</span> <span class="mi">129</span> <span class="n">total</span><span class="p">,</span>   <span class="mi">1</span> <span class="n">running</span><span class="p">,</span> <span class="mi">128</span> <span class="n">sleeping</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">stopped</span><span class="p">,</span>   <span class="mi">0</span> <span class="n">zombie</span>
<span class="o">%</span><span class="n">Cpu</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="mf">0.1</span> <span class="n">us</span><span class="p">,</span>  <span class="mf">0.1</span> <span class="n">sy</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">ni</span><span class="p">,</span> <span class="mf">99.8</span> <span class="nb">id</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">wa</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">hi</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">si</span><span class="p">,</span>  <span class="mf">0.0</span> <span class="n">st</span>
<span class="n">MiB</span> <span class="n">Mem</span> <span class="p">:</span>   <span class="mf">7810.3</span> <span class="n">total</span><span class="p">,</span>   <span class="mf">7246.5</span> <span class="n">free</span><span class="p">,</span>    <span class="mf">173.0</span> <span class="n">used</span><span class="p">,</span>    <span class="mf">390.8</span> <span class="n">buff</span><span class="o">/</span><span class="n">cache</span>
<span class="n">MiB</span> <span class="n">Swap</span><span class="p">:</span>      <span class="mf">0.0</span> <span class="n">total</span><span class="p">,</span>      <span class="mf">0.0</span> <span class="n">free</span><span class="p">,</span>      <span class="mf">0.0</span> <span class="n">used</span><span class="o">.</span>   <span class="mf">7522.3</span> <span class="n">avail</span> <span class="n">Mem</span>

    <span class="n">PID</span> <span class="n">USER</span>      <span class="n">PR</span>  <span class="n">NI</span>    <span class="n">VIRT</span>    <span class="n">RES</span>    <span class="n">SHR</span> <span class="n">S</span>  <span class="o">%</span><span class="n">CPU</span>  <span class="o">%</span><span class="n">MEM</span>     <span class="n">TIME</span><span class="o">+</span> <span class="n">COMMAND</span>
   <span class="mi">4079</span> <span class="n">ubuntu</span>    <span class="mi">20</span>   <span class="mi">0</span>   <span class="mi">10700</span>   <span class="mi">3176</span>   <span class="mi">2720</span> <span class="n">R</span>   <span class="mf">0.7</span>   <span class="mf">0.0</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.15</span> <span class="n">top</span>
   <span class="mi">3852</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">I</span>   <span class="mf">0.3</span>   <span class="mf">0.0</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.10</span> <span class="p">[</span><span class="n">kworker</span><span class="o">/</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="o">-</span><span class="n">events</span><span class="p">]</span>
      <span class="mi">1</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>  <span class="mi">167624</span>  <span class="mi">10796</span>   <span class="mi">7336</span> <span class="n">S</span>   <span class="mf">0.0</span>   <span class="mf">0.1</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">06.50</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">init</span> <span class="n">fixrtc</span>
      <span class="mi">2</span> <span class="n">root</span>      <span class="mi">20</span>   <span class="mi">0</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">S</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.06</span> <span class="p">[</span><span class="n">kthreadd</span><span class="p">]</span>
      <span class="mi">3</span> <span class="n">root</span>       <span class="mi">0</span> <span class="o">-</span><span class="mi">20</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">I</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.00</span> <span class="p">[</span><span class="n">rcu_gp</span><span class="p">]</span>
      <span class="mi">4</span> <span class="n">root</span>       <span class="mi">0</span> <span class="o">-</span><span class="mi">20</span>       <span class="mi">0</span>      <span class="mi">0</span>      <span class="mi">0</span> <span class="n">I</span>   <span class="mf">0.0</span>   <span class="mf">0.0</span>   <span class="mi">0</span><span class="p">:</span><span class="mf">00.00</span> <span class="p">[</span><span class="n">rcu_par_gp</span><span class="p">]</span>
</pre></div>
</div>
<p>为何系统没有任何运行进程，但是始终存在Laod Average = 1呢？</p>
<p>原因是系统始终有一个 <code class="docutils literal notranslate"><span class="pre">D</span></code> 住的进程(在等待IO)，通过以下命令可以检查系统所有 <code class="docutils literal notranslate"><span class="pre">R</span></code> 和 <code class="docutils literal notranslate"><span class="pre">D</span></code> 的进程:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="o">-</span><span class="n">e</span> <span class="n">v</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">E</span> <span class="s1">&#39; R | D &#39;</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">grep</span>
</pre></div>
</div>
<p>输出显示D住的系统进程:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>7195 ?        D      0:01      0     0     0     0  0.0 [kworker/2:1+events_freezable]
</pre></div>
</div>
<p>检查这个D住进程的堆栈，可以看到在等待 <code class="docutils literal notranslate"><span class="pre">mmc</span></code> 存储设备(也就是SD卡):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__switch_to</span><span class="o">+</span><span class="mh">0x104</span><span class="o">/</span><span class="mh">0x170</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">mmc_wait_for_req_done</span><span class="o">+</span><span class="mh">0x30</span><span class="o">/</span><span class="mh">0x170</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">mmc_wait_for_req</span><span class="o">+</span><span class="mh">0xb0</span><span class="o">/</span><span class="mh">0x108</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">mmc_wait_for_cmd</span><span class="o">+</span><span class="mh">0x7c</span><span class="o">/</span><span class="mh">0xb0</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">mmc_io_rw_direct_host</span><span class="o">+</span><span class="mh">0xa0</span><span class="o">/</span><span class="mh">0x138</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sdio_reset</span><span class="o">+</span><span class="mh">0x74</span><span class="o">/</span><span class="mh">0x98</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">mmc_rescan</span><span class="o">+</span><span class="mh">0x33c</span><span class="o">/</span><span class="mh">0x3b8</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">process_one_work</span><span class="o">+</span><span class="mh">0x1c0</span><span class="o">/</span><span class="mh">0x458</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">worker_thread</span><span class="o">+</span><span class="mh">0x50</span><span class="o">/</span><span class="mh">0x428</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0x104</span><span class="o">/</span><span class="mh">0x130</span>
<span class="p">[</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x10</span><span class="o">/</span><span class="mh">0x1c</span>
</pre></div>
</div>
<p>我反复重启了系统，情况相同，每次 <code class="docutils literal notranslate"><span class="pre">kworker</span></code> 系统进程都会D住。</p>
<p>联想到启动树莓派时，屏幕提示没有找到SD卡。所以怀疑虽然从USB存储启动，但是eeprom依然发起访问SD卡，由于SD卡缺失，导致IO等待。</p>
<p>解决的思路应该是尝试优先从USB存储启动，如果不行，再尝试只从USB存储启动(关闭从TF卡启动)。</p>
<p><strong>以下是我处理排查过程</strong></p>
<ul>
<li><p>读取当前eeprom配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vcgencmd</span> <span class="n">bootloader_config</span>
</pre></div>
</div>
</li>
</ul>
<p>输出内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">all</span><span class="p">]</span>
<span class="n">BOOT_UART</span><span class="o">=</span><span class="mi">0</span>
<span class="n">WAKE_ON_GPIO</span><span class="o">=</span><span class="mi">1</span>
<span class="n">POWER_OFF_ON_HALT</span><span class="o">=</span><span class="mi">0</span>
<span class="n">DHCP_TIMEOUT</span><span class="o">=</span><span class="mi">45000</span>
<span class="n">DHCP_REQ_TIMEOUT</span><span class="o">=</span><span class="mi">4000</span>
<span class="n">TFTP_FILE_TIMEOUT</span><span class="o">=</span><span class="mi">30000</span>
<span class="n">ENABLE_SELF_UPDATE</span><span class="o">=</span><span class="mi">1</span>
<span class="n">DISABLE_HDMI</span><span class="o">=</span><span class="mi">0</span>
<span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0xf41</span>
</pre></div>
</div>
<p>根据 <code class="docutils literal notranslate"><span class="pre">BOOT_ORDER</span></code> 配置，当前启动顺序是先SD卡然后USB存储，不断循环。</p>
<ul>
<li><p>检查版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vcgencmd</span> <span class="n">bootloader_version</span>
</pre></div>
</div>
</li>
</ul>
<p>输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sep</span>  <span class="mi">3</span> <span class="mi">2020</span> <span class="mi">13</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">43</span>
<span class="n">version</span> <span class="n">c305221a6d7e532693cc7ff57fddfc8649def167</span> <span class="p">(</span><span class="n">release</span><span class="p">)</span>
<span class="n">timestamp</span> <span class="mi">1599135103</span>
</pre></div>
</div>
<ul>
<li><p>修改启动顺序 - 参考 <a class="reference external" href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2711_bootloader_config.md">Pi 4 Bootloader Configuration</a></p></li>
<li><p>先将EEPROM镜像从 <code class="docutils literal notranslate"><span class="pre">/lib/firmware/raspberrypi/bootloader/</span></code> 目录下复制出来准备修改</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">firmware</span><span class="o">/</span><span class="n">raspberrypi</span><span class="o">/</span><span class="n">bootloader</span><span class="o">/</span><span class="n">stable</span><span class="o">/</span><span class="n">pieeprom</span><span class="o">-</span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mf">03.</span><span class="n">bin</span> <span class="o">./</span><span class="n">pieeprom</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
<li><p>导出配置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">config</span> <span class="n">pieeprom</span><span class="o">.</span><span class="n">bin</span> <span class="o">&gt;</span> <span class="n">bootconf</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</li>
<li><p>修改配置 <code class="docutils literal notranslate"><span class="pre">bootconf.txt</span></code> 将最后一行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0xf41</span>
</pre></div>
</div>
</li>
</ul>
<p>修改成(表示先外接USB存储再SD卡):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0xf14</span>
</pre></div>
</div>
<ul>
<li><p>将配置修改加入到EEPROM镜像文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">config</span> <span class="o">--</span><span class="n">out</span> <span class="n">pieeprom</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">bin</span> <span class="o">--</span><span class="n">config</span> <span class="n">bootconf</span><span class="o">.</span><span class="n">txt</span> <span class="n">pieeprom</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
<li><p>然后刷入bootloader EEPROM:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rpi</span><span class="o">-</span><span class="n">eeprom</span><span class="o">-</span><span class="n">update</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">f</span> <span class="o">./</span><span class="n">pieeprom</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
</li>
<li><p>拔掉SD卡，尝试从USB存储启动(优先)</p></li>
</ul>
<p>但是，启动以后，发现依然是存在 <code class="docutils literal notranslate"><span class="pre">[kworker/1:2+events_freezable]</span></code> 进程D住（是的，启动时终端还是显示mmc没有响应)</p>
<p>我尝试了以下组合:</p>
<ul class="simple">
<li><p>启动顺序 <code class="docutils literal notranslate"><span class="pre">0xf14</span></code> ，没有插入TF卡。测试结果：能够从USB存储启动，但是系统依然存在D住的 <code class="docutils literal notranslate"><span class="pre">kworker</span></code> 进程在等待 MMC卡返回，依然Load Average持续1。</p></li>
<li><p>将一块TF卡(可启动raspbian)插，但是我发现依然是优先从TF卡启动。这说明启动顺序 <code class="docutils literal notranslate"><span class="pre">0xf14</span></code> 没有效果，依然是 <code class="docutils literal notranslate"><span class="pre">0xf41</span></code> 优先从SD开启动。</p></li>
<li><p>修改成 <code class="docutils literal notranslate"><span class="pre">0x14</span></code> 也就是只做一次，先从USB存储启动，然后是TF卡，但不循环。问题依旧存在，然是存在 <code class="docutils literal notranslate"><span class="pre">[kworker/1:2+events_freezable]</span></code> 进程D住，Load Average持续1。</p></li>
<li><p>综上，只要启动顺序中有 <code class="docutils literal notranslate"><span class="pre">0x1</span></code> ，即启动顺序中有SD卡，即使从USB存储启动，只要SD卡不存在，就会导致系统进程 <code class="docutils literal notranslate"><span class="pre">kworker</span></code> D住等待 MMC 存储返回，系统始终存在 Load Average 1。</p></li>
</ul>
<p>最终，我一狠心，将启动顺序改成只从USB存储启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BOOT_ORDER</span><span class="o">=</span><span class="mh">0x4</span>
</pre></div>
</div>
<p>此时启动时发现，如果不插SD卡，启动自检不过，屏幕提示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Failed</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">device</span><span class="p">:</span> <span class="s1">&#39;sdcard&#39;</span> <span class="p">(</span><span class="n">cmd</span> <span class="mi">371</span><span class="n">a0010</span> <span class="n">status</span> <span class="mi">1</span><span class="n">fff0001</span><span class="p">)</span>
<span class="n">Insert</span> <span class="n">SD</span><span class="o">-</span><span class="n">CARD</span>
</pre></div>
</div>
<p>等待一会超时后， 则系统顺利从USB存储启动，而且系统中不再出现 <code class="docutils literal notranslate"><span class="pre">kworker</span></code> 进程 <code class="docutils literal notranslate"><span class="pre">D</span></code> 住现象。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>不过，我最近一次验证发现，如果不插入一张TF卡，虽然设置了 <code class="docutils literal notranslate"><span class="pre">0x4</span></code> 但是启动还是会尝试读取SD卡，直到超时才进入USB启动。这种不TF卡虽然能够工作，但是进程 <code class="docutils literal notranslate"><span class="pre">[kworker/0:1+events_freezable]</span></code> D住不能避免。</p>
<p>所以目前还是采用插入TF卡方式绕开这个问题。</p>
</div>
</section>
</section>
</section>
<section id="id8">
<h2>磁盘分区调整问题<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<p>后续我在使用过程中遇到一个异常问题，偶然发现服务器无法登陆，就断电重启了一次。但是发现重启后无法ssh登陆树莓派主机，接上显示器以后发现，启动没有找到根文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Begin: Loading essential drivers ... done.
Begin: Running /scripts/init-premount ... done.
Begin: Mounting root file system .. Begin: Running /script/local-top ... done
Begin: Running /scripts/local-premount ...
...
mdadm: No devices listed in conf file were found.
mdadm: No devices listed in conf file were found.
done.
Gave up waiting for root file system device. Common problems:
 - Boot args (cat /proc/cmdline)
   - Check rootdelay= (did the system wait long enough?)
 - Missing modules (cat /proc/modules; ls /dev)
ALERT! LABEL=writable does not exist.  Dropping to a shell!

BusyBox v1.30.1 (Ubuntu 1:1.30.1-4ubuntu6.2) built-in shell (ash)
Enter &#39;help&#39; for a list of built-in commands.

(initramfs)
</pre></div>
</div>
<p>从提示中可以看到，系统启动找不傲标记为 <code class="docutils literal notranslate"><span class="pre">LABEL=writalbe</span></code> 的根文件系统。我记得我在将Ubuntu操作系统从TF卡复制到USB外接SSD磁盘时，已经将文件系统中 <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> 以及启动 <code class="docutils literal notranslate"><span class="pre">cmdline.txt</span></code> 修订成使用 <code class="docutils literal notranslate"><span class="pre">PARTUUID</span></code> ，不应该出现查找上述标签的文件系统。实际上 <code class="docutils literal notranslate"><span class="pre">LABEL=writalbe</span></code> 是树莓派上安装Ubuntu默认的文件系统分区命名，我已经做过修订为何还会出现。</p>
<p>由于这个SSD磁盘是通过 <code class="docutils literal notranslate"><span class="pre">dd</span></code> 命令从TF卡完整复制的，所以分区的label和原先TF卡完全一致。例如，使用 <code class="docutils literal notranslate"><span class="pre">lsblk</span></code> 命令可以看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">lsblk</span> <span class="o">-</span><span class="n">o</span> <span class="n">name</span><span class="p">,</span><span class="n">mountpoint</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">uuid</span>
</pre></div>
</div>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>NAME        MOUNTPOINT     LABEL         SIZE UUID
sda                                    953.9G
├─sda1                     system-boot   256M B726-57E2
└─sda2                     writable    953.6G 483efb12-d682-4daf-9b34-6e2f774b56f7
mmcblk0                                119.1G
├─mmcblk0p1 /boot/firmware system-boot   256M B726-57E2
└─mmcblk0p2 /              writable    118.9G 483efb12-d682-4daf-9b34-6e2f774b56f7
</pre></div>
</div>
<p>我不知道为何文件系统 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> 文件系统从 128G 扩展到整个磁盘就导致启动时无法读取。</p>
<p>我想到的一个修复方式是重建文件系统，之前通过 <code class="docutils literal notranslate"><span class="pre">tar</span></code> 命令没能把系统成功启动，并不是操作系统不能通过 <code class="docutils literal notranslate"><span class="pre">tar</span></code> 命令备份和恢复，而是我最初实践时候尚未完全了解树莓派eeprom启动设置导致的。既然我已经通过了eeprom正确设置成功从USB启动，我相信再次通过tar方式完成系统重建也是可行的。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>这个重启后无法进入系统的问题，我后来回想了一下，应该是操作系统升级了内核，我没有注意到升级内核以后必须重新用 <code class="docutils literal notranslate"><span class="pre">zcat</span></code> 命令将压缩内核解压成 <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> 导致的，所以我再次挑战从tar包clone系统。`</p>
</div>
</section>
<section id="tarclone">
<h2>通过tar命令clone系统<a class="headerlink" href="#tarclone" title="永久链接至标题">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>操作步骤中有一步有所调整，就是我对磁盘分区的label设置了和默认配置相同的参数，这样，可以免去修改分区相关的配置。</p>
</div>
<ul>
<li><p>对USB外接移动SSD硬盘分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># parted -a optimal /dev/sda
GNU Parted 3.3
Using /dev/sda
Welcome to GNU Parted! Type &#39;help&#39; to view a list of commands.
(parted) mklabel gpt
Warning: The existing disk label on /dev/sda will be destroyed and all data on
this disk will be lost. Do you want to continue?
Yes/No? yes
(parted) print
Model: WD My Passport 25F3 (scsi)
Disk /dev/sda: 1024GB
Sector size (logical/physical): 512B/4096B
Partition Table: gpt
Disk Flags:

Number  Start  End  Size  File system  Name  Flags

(parted) mkpart primary fat32 2048s 256M
(parted) align-check optimal 1
1 aligned
(parted) unit s
(parted) print
Model: WD My Passport 25F3 (scsi)
Disk /dev/sda: 2000343040s
Sector size (logical/physical): 512B/4096B
Partition Table: gpt
Disk Flags:

Number  Start  End      Size     File system  Name     Flags
 1      2048s  499711s  497664s  fat32        primary

(parted) mkpart primary ext4 499712 30G
(parted) print
Model: WD My Passport 25F3 (scsi)
Disk /dev/sda: 2000343040s
Sector size (logical/physical): 512B/4096B
Partition Table: gpt
Disk Flags:

Number  Start    End        Size       File system  Name     Flags
 1      2048s    499711s    497664s    fat32        primary
 2      499712s  58593279s  58093568s  ext4         primary

(parted) align-check optimal 2
2 aligned
(parted) unit MB
(parted) set 1 boot on
(parted) print
Model: WD My Passport 25F3 (scsi)
Disk /dev/sda: 1024176MB
Sector size (logical/physical): 512B/4096B
Partition Table: gpt
Disk Flags:

Number  Start   End      Size     File system  Name     Flags
 1      1.05MB  256MB    255MB    fat32        primary  boot, esp
 2      256MB   30000MB  29744MB  ext4         primary

(parted) q
Information: You may need to update /etc/fstab.
</pre></div>
</div>
</li>
<li><p>格式化磁盘，注意，我这里格式化对分区进行了label，采用的label和原先树莓派默认的label完全一样，以便重建系统后不需要修订分区信息(不需要修改label或PARTUUID):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkfs</span><span class="o">.</span><span class="n">vfat</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span>
<span class="n">fatlabel</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="s2">&quot;system-boot&quot;</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">ext4</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">-</span><span class="n">L</span> <span class="s2">&quot;writable&quot;</span>
</pre></div>
</div>
</li>
<li><p>然后通过 <code class="docutils literal notranslate"><span class="pre">lsblk</span></code> 命令检查，确保label和TF卡(mmcblk0)完全一致:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">lsblk</span> <span class="o">-</span><span class="n">o</span> <span class="n">name</span><span class="p">,</span><span class="n">mountpoint</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">uuid</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>NAME        MOUNTPOINT     LABEL         SIZE UUID
sda                                    953.9G
├─sda1                     system-boot   243M 85F3-6F6C
└─sda2                     writable     27.7G 3991189f-1bda-4f0f-b81a-bf46fd05ddfa
mmcblk0                                119.1G
├─mmcblk0p1 /boot/firmware system-boot   256M B726-57E2
└─mmcblk0p2 /              writable    118.9G 483efb12-d682-4daf-9b34-6e2f774b56f7
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>由于SSD移动硬盘所有分区和原先TF卡的对应分区label完全一致，就避免了需要修订磁盘挂载和标识的麻烦。</p>
</div>
<ul>
<li><p>通过tar复制整个系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span>
<span class="c1">#tar打包系统不包含跨磁盘目录，所以/boot/firmware需要单独复制</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">cpzf</span> <span class="n">pi</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">--</span><span class="n">exclude</span><span class="o">=/</span><span class="n">pi</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">--</span><span class="n">one</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">system</span> <span class="o">/</span>

<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">sudo</span> <span class="n">tar</span> <span class="o">-</span><span class="n">xpzf</span> <span class="o">/</span><span class="n">pi</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">mnt</span> <span class="o">--</span><span class="n">numeric</span><span class="o">-</span><span class="n">owner</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
<span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">cf</span> <span class="o">-</span> <span class="o">.</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span> <span class="o">&amp;&amp;</span> <span class="n">tar</span> <span class="n">xf</span> <span class="o">-</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>解压缩内核:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
<span class="n">od</span> <span class="o">-</span><span class="n">A</span> <span class="n">d</span> <span class="o">-</span><span class="n">t</span> <span class="n">x1</span> <span class="n">vmlinuz</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;1f 8b 08 00&#39;</span>
</pre></div>
</div>
</li>
</ul>
<p>输出类似:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0000000</span> <span class="mi">1</span><span class="n">f</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">08</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">02</span> <span class="mi">03</span> <span class="n">ec</span> <span class="mi">5</span><span class="n">c</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">74</span> <span class="mi">14</span> <span class="n">d7</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">dd</span></code> 和 <code class="docutils literal notranslate"><span class="pre">zcat</span></code> 解压缩内核:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dd</span> <span class="k">if</span><span class="o">=</span><span class="n">vmlinuz</span> <span class="n">bs</span><span class="o">=</span><span class="mi">1</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0000000</span> <span class="o">|</span> <span class="n">zcat</span> <span class="o">&gt;</span> <span class="n">vmlinux</span>
</pre></div>
</div>
<ul>
<li><p>更新 <code class="docutils literal notranslate"><span class="pre">config.txt</span></code> 配置设置从解压后内核启动:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#[pi4]</span>
<span class="c1">#kernel=uboot_rpi_4.bin</span>
<span class="c1">#max_framebuffers=2</span>

<span class="c1">#[pi2]</span>
<span class="c1">#kernel=uboot_rpi_2.bin</span>

<span class="c1">#[pi3]</span>
<span class="c1">#kernel=uboot_rpi_3.bin</span>

<span class="p">[</span><span class="nb">all</span><span class="p">]</span>
<span class="n">arm_64bit</span><span class="o">=</span><span class="mi">1</span>
<span class="n">device_tree_address</span><span class="o">=</span><span class="mh">0x03000000</span>
<span class="n">kernel</span><span class="o">=</span><span class="n">vmlinux</span>
<span class="n">initramfs</span> <span class="n">initrd</span><span class="o">.</span><span class="n">img</span> <span class="n">followkernel</span>
</pre></div>
</div>
</li>
<li><p>下载最新raspberry pi的firmware，将 <code class="docutils literal notranslate"><span class="pre">boot</span></code> 目录下 <code class="docutils literal notranslate"><span class="pre">.dat</span></code> 和 <code class="docutils literal notranslate"><span class="pre">.elf</span></code> 文件复制到 <code class="docutils literal notranslate"><span class="pre">/boot/firmware</span></code> 对应目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">boot</span><span class="o">/*.</span><span class="n">dat</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">boot</span><span class="o">/*.</span><span class="n">elf</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">firmware</span>
</pre></div>
</div>
</li>
<li><p>将USB外接SSD移动硬盘连接到树莓派，启动系统，观察Raspberry Pi从USB移动硬盘启动。</p></li>
</ul>
<p><strong>成功</strong></p>
<p>验证成功:</p>
<ul class="simple">
<li><p>树莓派存储磁盘可以使用GPT分区表</p></li>
<li><p>不需要使用dd来复制磁盘，使用tar命令也可以复制系统，而且灵活调整磁盘分区大小</p></li>
</ul>
</section>
<section id="id9">
<h2>参考<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://eugenegrechko.com/blog/USB-Boot-Ubuntu-Server-20.04-on-Raspberry-Pi-4">USB Boot Ubuntu Server 20.04 on Raspberry Pi 4</a> - 这篇文章非常详尽解说了从外接USB存储启动Ubuntu Server for Raspberry Pi的方法，比通过工具无脑操作要更有技术性</p></li>
<li><p><a class="reference external" href="https://www.tomshardware.com/how-to/boot-raspberry-pi-4-usb">How to Boot Raspberry Pi 4 From a USB SSD or Flash Drive</a> 采用了 raspi-config 工具来设置Raspberry Pi OS，是树莓派官方解决方案，比较简单傻瓜化，不过只能用于树莓派官方操作系统</p></li>
<li><p>有关树莓派分区：</p>
<ul>
<li><p><a class="reference external" href="https://www.raspberrypi.org/forums/viewtopic.php?t=205418">booting from a GPT mass storage device</a></p></li>
<li><p><a class="reference external" href="https://www.raspberrypi.org/forums/viewtopic.php?t=241914">Does the Pi support booting from GPT drives?</a></p></li>
<li><p><a class="reference external" href="https://www.rodsbooks.com/gdisk/hybrid.html">Hybrid MBRs: The Good, the Bad, and the So Ugly You’ll Tear Your Eyes Out</a> - 详细的Hybrid MBR原理和操作</p></li>
<li><p><a class="reference external" href="https://wiki.gentoo.org/wiki/Hybrid_partition_table">Gentoo Hybrid partition table</a></p></li>
</ul>
</li>
<li><p>有关磁盘文件系统label参考:
- <cite>List partition labels from the command line &lt;https://unix.stackexchange.com/questions/14165/list-partition-labels-from-the-command-line&gt;</cite>
- <cite>How to change the volume name of a FAT32 filesystem? &lt;https://unix.stackexchange.com/questions/44095/how-to-change-the-volume-name-of-a-fat32-filesystem&gt;</cite>
- <a class="reference external" href="https://linuxconfig.org/how-to-name-label-a-partition-or-volume-on-linux">How to name/label a partition or volume on Linux</a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="usb_boot_pi_3.html" class="btn btn-neutral float-left" title="USB移动存储启动和运行树莓派3" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="usb_boot_ubuntu_pi_4.html" class="btn btn-neutral float-right" title="树莓派4 USB存储启动Ubuntu Server 20.04" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>