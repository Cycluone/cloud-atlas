<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>私有云架构 &mdash; Cloud Atlas 0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinxnotes-strike.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="copyright" title="版权所有" href="../../copyright.html" />
    <link rel="next" title="私有云NTP服务" href="priv_ntp.html" />
    <link rel="prev" title="私有云计算构建" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Cloud Atlas
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ansible/index.html">Ansible Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sqlite/index.html">SQLite Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pgsql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nosql/index.html">NoSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infra_search/index.html">Search Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../info_service/index.html">Info-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linux/index.html">Linux Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shell/index.html">Shell Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Real Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../real_think/index.html">真实世界的技术思考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prepare/index.html">真实云计算的构建准备</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">私有云计算构建</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">私有云架构</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">私有云拓扑架构图</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">虚拟化的层级部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kubernetes">Kubernetes私有云</a></li>
<li class="toctree-l4"><a class="reference internal" href="#openstack">OpenStack私有云</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="priv_ntp.html">私有云NTP服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_dnsmasq_ics.html">私有云DNS服务(dnsmasq)和共享因特网(ICS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_kvm.html">私有云KVM环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-dev.html">开发环境z-dev</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_ssh.html">私有云SSH访问</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_monitor.html">私有云监控</a></li>
<li class="toctree-l3"><a class="reference internal" href="zdata_ceph.html">私有云数据层 ZData Ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="zdata_ceph_rbd_libvirt.html">私有云基于 ZData Ceph 运行虚拟机</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_kvm_sr-iov.html">私有云KVM网络虚拟化sr-iov</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_cloud_infra_prometheus.html">私有云Prometheus部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s_env.html">构建Kubernetes云计算环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="z-k8s.html">部署Kubernetes集群(z-k8s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_docker.html">私有云docker环境</a></li>
<li class="toctree-l3"><a class="reference internal" href="priv_k8s_docker_centos.html">私有云Kubernetes和docker环境(CentOS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../edge_cloud/index.html">边缘云计算构建</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/index.html">真实荒漠</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mobile_work/index.html">移动工作</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Atlas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Real Atlas</a> &raquo;</li>
          <li><a href="index.html">私有云计算构建</a> &raquo;</li>
      <li>私有云架构</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/real/priv_cloud/priv_cloud_infra.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="priv-cloud-infra">
<span id="id1"></span><h1>私有云架构<a class="headerlink" href="#priv-cloud-infra" title="永久链接至标题">¶</a></h1>
<section id="id2">
<h2>私有云拓扑架构图<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>2021年10月，我购买了 <a class="reference internal" href="../../linux/server/hardware/hpe/hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 来实现完整的云计算模拟，规划是采用一台二手服务器:</p>
<ul class="simple">
<li><p>通过 <a class="reference internal" href="../../kvm/kvm_nested_virtual/index.html#kvm-nested-virtual"><span class="std std-ref">KVM嵌套虚拟化</span></a> 运行大量的一级KVM虚拟机，一级KVM虚拟机作为运行 <a class="reference internal" href="../../openstack/index.html#openstack"><span class="std std-ref">OpenStack Atlas</span></a> 的物理机，部署一个完整的OpenStack集群</p>
<ul>
<li><p>物理服务器运行 <a class="reference internal" href="../../linux/server/cockpit/index.html#cockpit"><span class="std std-ref">Cockpit服务器统一管理平台</span></a> 可以集成 <a class="reference internal" href="../../linux/storage/stratis/index.html#stratis"><span class="std std-ref">Stratis - Linux存储系统</span></a> 存储，以及 <a class="reference internal" href="../../ovirt/index.html#ovirt"><span class="std std-ref">oVirt Atlas</span></a> ，所以在第一层虚拟化上，可以不用自己手工部署 <a class="reference internal" href="../../kvm/index.html#kvm"><span class="std std-ref">KVM Atlas</span></a> ，而是集成到 oVirt</p></li>
<li><p>通过oVirt来管理第一层虚拟机，虚拟机开启嵌套虚拟化，这样可以同时学习oVirt的管理，体验不同于OpenStack的轻量级虚拟化管理平台</p>
<ul>
<li><p>oVirt支持 <a class="reference internal" href="../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a> 管理，可以方便在底层部署 GlusterFS</p></li>
</ul>
</li>
</ul>
</li>
<li><p>在一级虚拟机中运行 <a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 模拟裸机的K8S集群</p></li>
<li><p>在OpenStack中部署运行大量二级虚拟机，按需运行，模拟云计算的弹性以及计费和监控</p></li>
<li><p>OpenStack中的二级虚拟机内部再部署一个 <a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 集群，模拟云计算之上的K8S集群，结合 HashiCorp 的 Terraform 来实现全链路的自动化部署</p></li>
<li><p>附加：在DL360物理服务器上运行一个精简的Docker容器来做日常开发学习</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../_images/real_cloud.png"><img alt="../../_images/real_cloud.png" src="../../_images/real_cloud.png" style="width: 724.8000000000001px; height: 495.20000000000005px;" /></a>
</figure>
<section id="id3">
<h3>多层次虚拟化服务器分布<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<table class="colwidths-given docutils align-default" id="id10">
<caption><span class="caption-text">zcloud服务器部署多层虚拟化虚拟机分配</span><a class="headerlink" href="#id10" title="永久链接至表格">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>虚拟化层</p></th>
<th class="head"><p>主机IP</p></th>
<th class="head"><p>主机名</p></th>
<th class="head"><p>cpu</p></th>
<th class="head"><p>内存(G)</p></th>
<th class="head"><p>磁盘(G)</p></th>
<th class="head"><p>NUMA</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.51</p></td>
<td><p>z-o7k-m-1</p></td>
<td><p>4</p></td>
<td><p>8</p></td>
<td></td>
<td><p>0</p></td>
<td><p>OpenStack 管控 1</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.52</p></td>
<td><p>z-o7k-m-2</p></td>
<td><p>4</p></td>
<td><p>8</p></td>
<td></td>
<td><p>0</p></td>
<td><p>OpenStack 管控 2</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.53</p></td>
<td><p>z-o7k-m-3</p></td>
<td><p>4</p></td>
<td><p>8</p></td>
<td></td>
<td><p>0</p></td>
<td><p>OpenStack 管控 3</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.61</p></td>
<td><p>z-o7k-n-1</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 1</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.62</p></td>
<td><p>z-o7k-n-2</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 2</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.63</p></td>
<td><p>z-o7k-n-3</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 3</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.64</p></td>
<td><p>z-o7k-n-4</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 4</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.65</p></td>
<td><p>z-o7k-n-5</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 5</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.66</p></td>
<td><p>z-o7k-n-6</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 6</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.67</p></td>
<td><p>z-o7k-n-7</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 7</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.68</p></td>
<td><p>z-o7k-n-8</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 8</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.69</p></td>
<td><p>z-o7k-n-9</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 9</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.70</p></td>
<td><p>z-o7k-n-10</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>OpenStack Nova 10</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.101</p></td>
<td><p>z-k8s-m-1</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>0</p></td>
<td><p>K8s 管控 1</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.102</p></td>
<td><p>z-k8s-m-2</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>0</p></td>
<td><p>K8s 管控 2</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.103</p></td>
<td><p>z-k8s-m-3</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>0</p></td>
<td><p>K8s 管控 3</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.111</p></td>
<td><p>z-k8s-n-1</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 1</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.112</p></td>
<td><p>z-k8s-n-2</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 2</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.113</p></td>
<td><p>z-k8s-n-3</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 3</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.114</p></td>
<td><p>z-k8s-n-4</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 4</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.115</p></td>
<td><p>z-k8s-n-5</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 5</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.116</p></td>
<td><p>z-k8s-n-6</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 6</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.117</p></td>
<td><p>z-k8s-n-7</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 7</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.118</p></td>
<td><p>z-k8s-n-8</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 8</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.119</p></td>
<td><p>z-k8s-n-9</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 9</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.120</p></td>
<td><p>z-k8s-n-10</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td><p>1</p></td>
<td><p>K8s node 10</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>192.168.6.200</p></td>
<td><p>zcloud</p></td>
<td><p>48</p></td>
<td><p>64</p></td>
<td><p>512SSD</p></td>
<td></td>
<td><p>HP DL360 Gen9</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>192.168.6.200</p></td>
<td><p>wpad</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>WPAD服务</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>192.168.6.200</p></td>
<td><p>proxy</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>Proxy服务</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.201</p></td>
<td><p>z-b-store-1</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>512HDD</p></td>
<td><p>0(0 1)</p></td>
<td><p>virtio-blk直接访问HDD(存储备份基础服务)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.202</p></td>
<td><p>z-b-store-2</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>512HDD</p></td>
<td><p>0(2 3)</p></td>
<td><p>virtio-blk直接访问HDD(存储备份基础服务)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.203</p></td>
<td><p>z-b-store-3</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>512HDD</p></td>
<td><p>0(4 5)</p></td>
<td><p>virtio-blk直接访问HDD(存储备份基础服务)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.204</p></td>
<td><p>z-b-data-1</p></td>
<td><p>4</p></td>
<td><p>16</p></td>
<td><p>1024NVMe</p></td>
<td><p>0(24 25 26 27)</p></td>
<td><p>iommu NVMe(数据基础服务)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.205</p></td>
<td><p>z-b-data-2</p></td>
<td><p>4</p></td>
<td><p>16</p></td>
<td><p>1024NVMe</p></td>
<td><p>0(28 29 30 31)</p></td>
<td><p>iommu NVMe(数据基础服务)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.206</p></td>
<td><p>z-b-data-3</p></td>
<td><p>4</p></td>
<td><p>16</p></td>
<td><p>1024NVMe</p></td>
<td><p>0(32 33 34 35)</p></td>
<td><p>iommu NVMe(数据基础服务)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.211</p></td>
<td><p>z-b-cache-1</p></td>
<td><p>2</p></td>
<td><p>8</p></td>
<td></td>
<td><p>0(6 7)</p></td>
<td><p>近端访问 z-data(缓存基础服务)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.212</p></td>
<td><p>z-b-cache-2</p></td>
<td><p>2</p></td>
<td><p>8</p></td>
<td></td>
<td><p>0(8 9)</p></td>
<td><p>近端访问 z-data(缓存基础服务)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.213</p></td>
<td><p>z-b-cache-3</p></td>
<td><p>2</p></td>
<td><p>8</p></td>
<td></td>
<td><p>0(10 11)</p></td>
<td><p>近端访问 z-data(缓存基础服务)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.221</p></td>
<td><p>z-b-mon-1</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td></td>
<td><p>基础监控</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.222</p></td>
<td><p>z-b-mon-2</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td></td>
<td></td>
<td><p>基础监控</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.231</p></td>
<td><p>z-numa</p></td>
<td><p>4</p></td>
<td><p>4</p></td>
<td><p>6</p></td>
<td><p>0 1</p></td>
<td><p>测试功能-numa</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.232</p></td>
<td><p>z-iommu</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>6</p></td>
<td><p>1</p></td>
<td><p>测试功能-iommu(fedora35)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.233</p></td>
<td><p>z-vgpu</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td><p>1</p></td>
<td><p>测试功能-vgpu(fedora35)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.234</p></td>
<td><p>z-udev</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td><p>1</p></td>
<td><p>编译(ubuntu20)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.241</p></td>
<td><p>z-centos6</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td></td>
<td><p>模版</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.242</p></td>
<td><p>z-centos7</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td></td>
<td><p>模版</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.243</p></td>
<td><p>z-centos8</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td></td>
<td><p>模版</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.244</p></td>
<td><p>z-fedora35</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td></td>
<td><p>模版</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.245</p></td>
<td><p>z-ubuntu18</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td></td>
<td><p>模版</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.246</p></td>
<td><p>z-ubuntu20</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>6</p></td>
<td></td>
<td><p>模版(ubuntu 20.04)</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.247</p></td>
<td><p>z-ubuntu20-rbd</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
<td></td>
<td><p>模版(ubuntu 20.04)Ceph存储</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.249</p></td>
<td><p>z-centos9-rbd</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
<td></td>
<td><p>模版(CentOS 9 Stream)Ceph存储</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.250</p></td>
<td><p>z-centos8-rbd</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
<td></td>
<td><p>模版(CentOS 8)Ceph存储</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.251</p></td>
<td><p>z-centos7-rbd</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>7</p></td>
<td></td>
<td><p>模版(CentOS 7)Ceph存储</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>192.168.6.252</p></td>
<td><p>z-vdev</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>6</p></td>
<td><p>1</p></td>
<td><p>fedora35(vgpu 8G)</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>192.168.6.253</p></td>
<td><p>z-dev</p></td>
<td><p>2</p></td>
<td><p>4</p></td>
<td><p>6</p></td>
<td><p>0</p></td>
<td><p>fedora35</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>192.168.6.254</p></td>
<td><p>dl360-ilo</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>HP DL360 Gen9带外管理</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>保留 <code class="docutils literal notranslate"><span class="pre">192.168.6.21</span> <span class="pre">~</span> <span class="pre">192.168.6.50</span></code> 作为DHCP段IP，用于验证PXE以及无线网络段动态IP地址分配</p>
</div>
<section id="id4">
<h4>主机命名规则<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<ul class="simple">
<li><p>物理主机: 单字段命名</p></li>
<li><p>物理主机集群(树莓派): 主机名分为 3 段，以 <code class="docutils literal notranslate"><span class="pre">-</span></code> 作为分隔符</p>
<ul>
<li><p>第一个字段 表示服务器层次</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">pi</span></code> 树莓派</p></li>
</ul>
</li>
<li><p>第二字段 表示服务器节点身份</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">master</span></code> 管控服务器</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">worker</span></code> 工作节点服务器</p></li>
</ul>
</li>
<li><p>第三字段 表示节点序号数字</p></li>
</ul>
</li>
<li><p>单用途虚拟机: 主机名分为 2 段，以 <code class="docutils literal notranslate"><span class="pre">-</span></code> 作为分隔符</p>
<ul>
<li><p>第一个字段 表示服务器层次(见下文)，目前只有 <code class="docutils literal notranslate"><span class="pre">z</span></code></p></li>
<li><p>第二个字段 表示用途 ，如 <code class="docutils literal notranslate"><span class="pre">dev</span></code> <code class="docutils literal notranslate"><span class="pre">numa</span></code> 等</p></li>
</ul>
</li>
<li><p>虚拟集群: 主机名分为 4 段，以 <code class="docutils literal notranslate"><span class="pre">-</span></code> 作为分隔符</p>
<ul>
<li><p>第一个字段 表示服务器层次， <code class="docutils literal notranslate"><span class="pre">z</span></code> 表示在 <a class="reference internal" href="../../linux/server/hardware/hpe/hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 物理服务器( <code class="docutils literal notranslate"><span class="pre">zcloud</span></code> )上部署的第一层虚拟化; <code class="docutils literal notranslate"><span class="pre">a</span></code> 表示 <code class="docutils literal notranslate"><span class="pre">第二层</span></code> 虚拟化，主要是在OpenStack之上运行虚拟机，模拟大规模 <a class="reference internal" href="../../openstack/index.html#openstack"><span class="std std-ref">OpenStack Atlas</span></a> 集群 (你也可以将这个字段理解为数据中心，今后部署多地冗灾体系)</p></li>
<li><p>第二字段 表示集群 ，目前主要在第一层虚拟化部署集群:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">b</span></code> : base 基础服务</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">o7k</span></code> : OpenStack (模仿Kubernetes缩略方法，将中间7个字母简写为 <code class="docutils literal notranslate"><span class="pre">7</span></code> ，所以 OpenStack 缩写成 <code class="docutils literal notranslate"><span class="pre">o7k</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">k8s</span></code> : Kubernetes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">o7t</span></code> : OpenShift</p></li>
</ul>
</li>
<li><p>第三字段 表示节点身份:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">m</span></code> : 集群管控节点 (manager)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n</span></code> : 集群工作节点 (node)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">store</span></code> : 基础服务存储</p>
<ul>
<li><p><a class="reference internal" href="../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> : 基础服务数据服务:</p>
<ul>
<li><p><a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a></p></li>
<li><p><a class="reference internal" href="../../redis/index.html#redis"><span class="std std-ref">Redis Atlas</span></a></p></li>
<li><p><a class="reference internal" href="../../kubernetes/administer/etcd/index.html#etcd"><span class="std std-ref">etcd - 分布式kv存储</span></a></p></li>
<li><p><a class="reference internal" href="../../big_data/message_queue/kafka/index.html#kafka"><span class="std std-ref">Kafka消息队列系统</span></a></p></li>
<li><p><a class="reference internal" href="../../big_data/message_queue/rabbitmq/index.html#rabbitmq"><span class="std std-ref">RabbitMQ消息队列系统</span></a></p></li>
<li><p><a class="reference internal" href="../../mysql/index.html#mysql"><span class="std std-ref">MySQL Atlas</span></a></p></li>
<li><p><a class="reference internal" href="../../pgsql/index.html#pgsql"><span class="std std-ref">PostgreSQL Atlas</span></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p>第四字段 表示节点序号数字</p></li>
</ul>
</li>
</ul>
</section>
<section id="id5">
<h4>网络规划<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>我所使用的 <a class="reference internal" href="../../linux/server/hardware/hpe/hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 有2个4口网卡:</p>
<ul class="simple">
<li><p>服务器主板板载 <code class="docutils literal notranslate"><span class="pre">4口</span></code> Broadcom BCM5719千兆网卡</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FlexibleLOM</span> <span class="pre">Bay</span></code> <code class="docutils literal notranslate"><span class="pre">4口</span></code> Intel I350千兆网卡 - 支持 <a class="reference internal" href="../../kvm/sr-iov/index.html#sr-iov"><span class="std std-ref">SR-IOV</span></a></p></li>
</ul>
<p>由于独立的 <code class="docutils literal notranslate"><span class="pre">4口</span></code> Intel I350千兆网卡 支持 SR-IOV ，所以我规划:</p>
<ul class="simple">
<li><p>每个Intel I350 ( <code class="docutils literal notranslate"><span class="pre">igb</span></code> ) 支持 <code class="docutils literal notranslate"><span class="pre">7个</span></code> SR-IOV 的 VF，共计可以实现 <code class="docutils literal notranslate"><span class="pre">32</span> <span class="pre">个</span></code> 网卡 ( <code class="docutils literal notranslate"><span class="pre">4x8</span></code> ) ，分配到 <a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 和 <a class="reference internal" href="../../openstack/index.html#openstack"><span class="std std-ref">OpenStack Atlas</span></a> :</p>
<ul>
<li><p>2块 Intel I350 ( <code class="docutils literal notranslate"><span class="pre">igb</span></code>  ) 用于 <code class="docutils literal notranslate"><span class="pre">z-k8s</span></code> 集群(Kubernetes): k8s运行节点(VM) <code class="docutils literal notranslate"><span class="pre">z-k8s-n-1</span></code> 到 <code class="docutils literal notranslate"><span class="pre">z-k8s-n-4</span></code> ，每个node分配4个 sr-iov cni ，其余节点 <code class="docutils literal notranslate"><span class="pre">z-k8s-n-5</span></code> 到 <code class="docutils literal notranslate"><span class="pre">z-k8s-n-10</span></code> 则使用常规 <code class="docutils literal notranslate"><span class="pre">virtio-net</span></code> ； 通过标签区别节点能力 (此外 <a class="reference internal" href="../../kvm/vgpu/index.html#vgpu"><span class="std std-ref">NVIDIA vGPU</span></a> 也只分配2个node，以验证k8s调度)</p></li>
<li><p>2块 Intel I350 ( <code class="docutils literal notranslate"><span class="pre">igb</span></code>   ) 用于 <code class="docutils literal notranslate"><span class="pre">z-o7k</span></code> 集群(OpenStack): 同样也分配4个node</p></li>
</ul>
</li>
</ul>
<p>绝大多数虚拟机的网络都连接在 <code class="docutils literal notranslate"><span class="pre">br0</span></code> 上，通过内部交换机实现互联 ( 后续学习 Open vSwitch (OVS) )，以内核虚拟交换机实现高速互联:</p>
<ul class="simple">
<li><p>所有虚拟机都通过 <code class="docutils literal notranslate"><span class="pre">br0</span></code> 访问 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> 基础数据层，数据通路走内核，不经过外部交换机</p></li>
<li><p>少量外部物理硬件(如 <a class="reference internal" href="../../arm/raspberry_pi/pi_cluster/index.html#pi-cluster"><span class="std std-ref">Raspberry Pi Cluster</span></a> 以及我用笔记本模拟都KVM节点)，通过 <a class="reference internal" href="../../network/cisco/index.html#cisco"><span class="std std-ref">Cisco 网络</span></a> 交换机访问 <code class="docutils literal notranslate"><span class="pre">br0</span></code> 连接的虚拟机，如 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> 虚拟化集群</p></li>
</ul>
</section>
<section id="id6">
<h4>私有云域名规划<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h4>
<p>私有云是我在一台 <a class="reference internal" href="../../linux/server/hardware/hpe/hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 物理服务器( <code class="docutils literal notranslate"><span class="pre">zcloud</span></code> ) 上部署的云计算环境，我将这个环境作为 <code class="docutils literal notranslate"><span class="pre">staging</span></code> 环境来运行，所以域名设置为 <code class="docutils literal notranslate"><span class="pre">staging.huatai.me</span></code> ：</p>
<ul class="simple">
<li><p>在最初部署环境中，为了快速完成整体架构，我采用 <a class="reference internal" href="../../infra_service/dns/dnsmasq/index.html#dnsmasq"><span class="std std-ref">DNSmasq</span></a> 和 <a class="reference internal" href="../../linux/network/iptables/iptables_ics.html#iptables-ics"><span class="std std-ref">iptables配置因特网共享连接(ICS)</span></a> 来实现 <a class="reference internal" href="priv_dnsmasq_ics.html#priv-dnsmasq-ics"><span class="std std-ref">私有云DNS服务(dnsmasq)和共享因特网(ICS)</span></a></p></li>
<li><p>后续不断完善迭代，我将会升级采用 <a class="reference internal" href="../../infra_service/dns/bind/index.html#bind"><span class="std std-ref">BIND</span></a> 重构整个DNS系统</p></li>
</ul>
</section>
</section>
</section>
<section id="id7">
<h2>虚拟化的层级部署<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<section id="data">
<h3>数据存储层(data)<a class="headerlink" href="#data" title="永久链接至标题">¶</a></h3>
<p>在 <code class="docutils literal notranslate"><span class="pre">zcloud</span></code> 底层虚拟化上，我采用完全手工方式构建最基础的存储数据的虚拟机:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">z-b-data-1</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-data-2</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-data-3</span></code> 是通过 <a class="reference internal" href="../../kvm/iommu/ovmf.html#ovmf"><span class="std std-ref">Open Virtual Machine Firmware(OMVF)</span></a> 虚拟机pass-through读写 <a class="reference internal" href="../../linux/storage/nvme/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a> 的高性能存储虚拟机</p>
<ul>
<li><p>所有依赖高速存储的基础服务，如 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> / <a class="reference internal" href="../../mysql/index.html#mysql"><span class="std std-ref">MySQL Atlas</span></a> / <a class="reference internal" href="../../redis/index.html#redis"><span class="std std-ref">Redis Atlas</span></a> 等都部署在这3个虚拟机内部</p></li>
<li><p>这3个虚拟机只依赖 <a class="reference internal" href="../../kvm/index.html#kvm"><span class="std std-ref">KVM Atlas</span></a> 和 <a class="reference internal" href="../../kvm/libvirt/index.html#libvirt"><span class="std std-ref">Libvirt虚拟机管理器</span></a> ，并且在物理主机启动时自动启动运行，提供基础数据服务</p></li>
<li><p><a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> 是最关键的存储服务: 除了 <code class="docutils literal notranslate"><span class="pre">数据存储层</span></code> 这3台虚拟机直接存储数据之外，其他虚拟机(包括第一层虚拟化和第二层虚拟化)的磁盘镜像全部存储在 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> 之中</p>
<ul>
<li><p>你可以将这个数据存储层 Ceph 看成类似于阿里云的 <code class="docutils literal notranslate"><span class="pre">盘古</span></code> 分布式存储，开天劈地: 这样所有其他虚拟机都不需要占用本地磁盘(事实上作为 <code class="docutils literal notranslate"><span class="pre">zcloud</span></code> 主机的系统盘 <code class="docutils literal notranslate"><span class="pre">ssd</span></code> 空间非常狭小)</p></li>
<li><p>分布式存储提供了网络共享访问，同时提供了数据镜像容灾，这样运行的虚拟机可以在网络上不同的计算节点迁移: 例如，我可以在网络中加入我的笔记本或者台式机来模拟一个物理节点，共享访问Ceph存储，实现把虚拟机热迁移过去，从而减轻服务器的压力</p></li>
</ul>
</li>
<li><p>在磁盘上构建 <a class="reference internal" href="../../linux/storage/lvm/index.html#linux-lvm"><span class="std std-ref">Linux LVM逻辑卷管理</span></a> LVM 卷用于存储数据 - <code class="docutils literal notranslate"><span class="pre">vg-data</span></code> (300G)</p>
<ul>
<li><p><a class="reference internal" href="../../kubernetes/administer/etcd/index.html#etcd"><span class="std std-ref">etcd - 分布式kv存储</span></a> 存储在 <code class="docutils literal notranslate"><span class="pre">vg-data/lv-etcd</span></code></p>
<ul>
<li><p><a class="reference internal" href="../../kubernetes/administer/coredns/index.html#coredns"><span class="std std-ref">CoreDNS</span></a> 采用 <a class="reference internal" href="../../kubernetes/administer/etcd/index.html#etcd"><span class="std std-ref">etcd - 分布式kv存储</span></a> 存储数据</p></li>
<li><p><a class="reference internal" href="../../kubernetes/storage/rook/index.html#rook"><span class="std std-ref">Rook - 云原生存储调度器</span></a> 采用 <a class="reference internal" href="../../kubernetes/administer/etcd/index.html#etcd"><span class="std std-ref">etcd - 分布式kv存储</span></a> 存储配置，在 <code class="docutils literal notranslate"><span class="pre">z-k8s</span></code> 中实现微型 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> / <a class="reference internal" href="../../nosql/cassandra/index.html#cassandra"><span class="std std-ref">Cassandra</span></a> / <a class="reference internal" href="../../infra_service/nfs/index.html#nfs"><span class="std std-ref">nfs服务</span></a></p></li>
<li><p><a class="reference internal" href="../../kubernetes/monitor/m3/index.html#m3"><span class="std std-ref">M3 - 分布式时序数据库</span></a> 采用 <a class="reference internal" href="../../kubernetes/administer/etcd/index.html#etcd"><span class="std std-ref">etcd - 分布式kv存储</span></a> 存储数据，构建分布式 <a class="reference internal" href="../../kubernetes/monitor/prometheus/index.html#prometheus"><span class="std std-ref">Prometheus监控</span></a> metrics 存储</p></li>
<li><p><a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 采用 <a class="reference internal" href="../../kubernetes/administer/etcd/index.html#etcd"><span class="std std-ref">etcd - 分布式kv存储</span></a> 存储数据</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">z-b-store-1</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-store-2</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-store-3</span></code> 是直接访问服务器上3块 2.5” SSD，基于 <a class="reference internal" href="../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a> 的 <a class="reference internal" href="../../linux/storage/stratis/index.html#stratis"><span class="std std-ref">Stratis - Linux存储系统</span></a> 存储，运行 <a class="reference internal" href="../../ovirt/index.html#ovirt"><span class="std std-ref">oVirt Atlas</span></a> 同时提供 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> 的 geo-replication</p>
<ul>
<li><p>数据备份和恢复</p></li>
<li><p>近线数据存储，后续考虑实现一个容灾系统模拟</p></li>
<li><p>使用 <span class="sphinxnotes-strike">企业级SSD</span> 较好的消费级大容量SSD(2T)</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">z-b-arch-1</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-arch-2</span></code> / <code class="docutils literal notranslate"><span class="pre">z-b-arch-3</span></code> 是直接访问服务器上3块 2.5” 机械硬盘，提供 <a class="reference internal" href="../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a> 存储服务以及自动化归档备份 - 方案待定</p>
<ul>
<li><p>采用大容量机械硬盘(叠瓦盘)(8T)，存储为主，较少修改，作为归档数据</p></li>
<li><p>双副本，实现基于磁盘的数据归档方案(磁带机维护成本高)</p></li>
<li><p>采用 <a class="reference internal" href="../../linux/storage/bcache/index.html#linux-bcache"><span class="std std-ref">Linux Bcache(块缓存)</span></a> 来加速(利用SSD的部分容量)</p></li>
</ul>
</li>
</ul>
</section>
<section id="id8">
<h3>第一层虚拟化<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">z-o7k</span></code> 系列构建 <a class="reference internal" href="../../openstack/index.html#openstack"><span class="std std-ref">OpenStack Atlas</span></a> 集群</p>
<ul>
<li><p>采用 <a class="reference internal" href="../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 20.04 部署</p></li>
<li><p>启用 <a class="reference internal" href="../../kvm/kvm_nested_virtual/index.html#kvm-nested-virtual"><span class="std std-ref">KVM嵌套虚拟化</span></a> 实现第二层虚拟化</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">z-o3t</span></code> 系列构建 <a class="reference internal" href="../../ovirt/index.html#ovirt"><span class="std std-ref">oVirt Atlas</span></a> 集群</p>
<ul>
<li><p>采用 <a class="reference internal" href="../../linux/redhat_linux/centos/index.html#centos"><span class="std std-ref">CentOS</span></a> 8 部署</p></li>
<li><p>启用 <a class="reference internal" href="../../kvm/kvm_nested_virtual/index.html#kvm-nested-virtual"><span class="std std-ref">KVM嵌套虚拟化</span></a> 实现第二层虚拟化</p></li>
<li><p>实现 <a class="reference internal" href="../../linux/storage/stratis/index.html#stratis"><span class="std std-ref">Stratis - Linux存储系统</span></a> 存储</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">z-k8s</span></code> 系列构建 <a class="reference internal" href="../../kubernetes/index.html#kubernetes"><span class="std std-ref">Kubernetes Atlas</span></a> 集群</p>
<ul>
<li><p>采用 <a class="reference internal" href="../../linux/ubuntu_linux/index.html#ubuntu-linux"><span class="std std-ref">Ubuntu Linux</span></a> 20.04 部署</p></li>
<li><p>采用 <a class="reference internal" href="../../kvm/vgpu/index.html#vgpu"><span class="std std-ref">NVIDIA vGPU</span></a> 将 <a class="reference internal" href="../../machine_learning/hardware/tesla_p10.html#tesla-p10"><span class="std std-ref">Nvidia Tesla P10 GPU运算卡</span></a> 输出到多个工作节点虚拟机，实现分布式 <a class="reference internal" href="../../machine_learning/index.html#machine-learning"><span class="std std-ref">Machine Learning Atlas</span></a></p></li>
<li><p>采用 <a class="reference internal" href="../../kubernetes/storage/rook/index.html#rook"><span class="std std-ref">Rook - 云原生存储调度器</span></a> 来部署一个集成到Kubernetes的 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> 集群</p></li>
</ul>
</li>
</ul>
<p>第一层虚拟化的虚拟机也采用手工方式部署，部署用于构建集群的虚拟机都采用 <code class="docutils literal notranslate"><span class="pre">数据存储层</span></code> 的 <a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a> <code class="docutils literal notranslate"><span class="pre">RBD</span></code> ，不使用任何本地磁盘: 虚拟机计算节点可以任意迁移。</p>
</section>
<section id="id9">
<h3>第二层虚拟化<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p>基于第一层虚拟化部署的 <a class="reference internal" href="../../openstack/index.html#openstack"><span class="std std-ref">OpenStack Atlas</span></a> 和 <a class="reference internal" href="../../ovirt/index.html#ovirt"><span class="std std-ref">oVirt Atlas</span></a> 实现自动化部署</p></li>
</ul>
</section>
</section>
<section id="kubernetes">
<h2>Kubernetes私有云<a class="headerlink" href="#kubernetes" title="永久链接至标题">¶</a></h2>
<p>从集群稳定性和扩展性来说，推荐采用 <a class="reference internal" href="../../kubernetes/deployment/bootstrap_kubernetes_ha/ha_k8s_external.html#ha-k8s-external"><span class="std std-ref">扩展etcd节点高可用集群</span></a> 部署模式：</p>
<ul class="simple">
<li><p>kubernetes的管控组件和etcd分别部署在不同服务器，单节点故障影响从1/3降低到1/6</p></li>
<li><p>运维管理简化，拓扑清晰</p></li>
<li><p>etcd和apiserver都是管控平面非常消耗资源的组件，通过分离etcd部署提升了管控平面整体性能</p></li>
</ul>
<p>但是，我的私有云由于资源限制，只有3台物理服务器，所以我采用了一种混合虚拟化和容器的部署架构：</p>
<ul class="simple">
<li><p>管控平面服务器(kubernetes master)运行在KVM虚拟机(每个物理服务器上运行一个虚拟机)</p>
<ul>
<li><p>共计3台KVM虚拟机，对外提供apiserver服务(直接通过 <a class="reference internal" href="../../kvm/libvirt/index.html#libvirt"><span class="std std-ref">Libvirt虚拟机管理器</span></a> 运行KVM虚拟机，简单清晰)</p></li>
<li><p>物理网络连接Kubernetes worker节点，管理运行在物理节点上的worker nodes</p></li>
<li><p>可以节约服务器占用，同时KVM虚拟机可以平滑迁移</p></li>
</ul>
</li>
<li><p>etcd服务器运行在物理主机上</p>
<ul>
<li><p>etcd是整个kubernetes集群的数据存储，不仅需要保障数据安全性，而且要保证读写性能</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>最初我考虑采用OpenStack来运行Kubernetes管控服务器，但是OpenStack构建和运行复杂，Kubernetes依赖OpenStack则过于沉重，一旦出现OpenStack异常会导致整个Kubernetes不可用。</p>
<p>基础服务部署着重于稳定和简洁，依赖越少越好：并不是所有基础设施都适合云化(OpenStack)或者云原生(Kubernetes)，特别是BootStrap的基础服务，使用物理裸机来运行反而更稳定更不容易出错。</p>
</div>
<ul class="simple">
<li><p>Kubernetes的worker nodes直接部署在3台物理服务器上</p>
<ul>
<li><p>裸物理服务器运行Docker容器，可以充分发挥物理硬件性能</p></li>
<li><p>Ceph (<a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a>) 直接运行在物理服务器，提供OpenStack对象存储和Kubernetes卷存储，最大化存储性能</p></li>
<li><p>Gluster (<a class="reference internal" href="../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a>)直接运行在物理服务器，提供oVirt(<a class="reference internal" href="../../ovirt/index.html#ovirt"><span class="std std-ref">oVirt Atlas</span></a>)的虚拟化存储以及虚拟机和Kubernetes的NFS文件存储、数据归档</p></li>
<li><p>网络直通，最大化网络性能</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>整个似有网络仅使用 <code class="docutils literal notranslate"><span class="pre">3台物理服务器</span></code> 。如果你缺少服务器资源，也可以采用KVM虚拟机来实践部署，即采用完全的OpenStack集群(单机或多机都可以)，在OpenStack之上运行Kubernetes。</p>
</div>
</section>
<section id="openstack">
<h2>OpenStack私有云<a class="headerlink" href="#openstack" title="永久链接至标题">¶</a></h2>
<p>OpenStack和Kubernetes共同部署在3台物理服务器上，底层的基础服务是共享的：</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../kubernetes/administer/etcd/index.html#etcd"><span class="std std-ref">etcd - 分布式kv存储</span></a></p></li>
<li><p><a class="reference internal" href="../../mysql/vitess/index.html#vitess"><span class="std std-ref">Vitess MySQL数据库集群</span></a></p></li>
<li><p><a class="reference internal" href="../../big_data/message_queue/rabbitmq/index.html#rabbitmq"><span class="std std-ref">RabbitMQ消息队列系统</span></a></p></li>
<li><p><a class="reference internal" href="../../big_data/message_queue/kafka/index.html#kafka"><span class="std std-ref">Kafka消息队列系统</span></a></p></li>
<li><p><a class="reference internal" href="../../ceph/index.html#ceph"><span class="std std-ref">Ceph Atlas</span></a></p></li>
<li><p><a class="reference internal" href="../../gluster/index.html#gluster"><span class="std std-ref">Gluster Atlas</span></a></p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="私有云计算构建" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="priv_ntp.html" class="btn btn-neutral float-right" title="私有云NTP服务" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; <a href="../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>