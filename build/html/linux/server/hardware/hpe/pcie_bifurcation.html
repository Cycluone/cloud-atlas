

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>PCIe bifurcation选项 &mdash; Cloud Atlas 0.1 文档</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../../copyright.html" />
    <link rel="next" title="HPE DL360 Gen9设置BIOS激活NUMA" href="dl360_bios_numa.html" />
    <link rel="prev" title="HPE DL360 BIOS升级" href="dl360_bios_upgrade.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ansible/index.html">Ansible Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../postgresql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Linux Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../best_linux.html">最佳Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../redhat_linux/index.html">RedHat Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../arch_linux/index.html">Arch Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../gentoo_linux/index.html">Gentoo Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../lfs_linux/index.html">LFS(Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ubuntu_linux/index.html">Ubuntu Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../suse_linux/index.html">SUSE Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../kali_linux/index.html">Kali Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tails_linux/index.html">Tails Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../postmarketos/index.html">postmarketOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../container_os/index.html">容器化操作系统(Container OS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../fedora_coreos/index.html">Fedora CoreOS容器操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../chromium_os/index.html">Chromium OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../alpine_linux/index.html">Alpine Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../subgraph_os/index.html">Subgraph OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../kaios/index.html">KaiOS - 世界第三手机操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../compute/index.html">Linux计算</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../storage/index.html">Linux存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../network/index.html">Linux网络</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Linux服务器</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">服务器硬件</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../edac.html">EDAC 诊断系统硬件故障</a></li>
<li class="toctree-l4"><a class="reference internal" href="../lm_sensor.html">lm_sensors(Linux监控传感器)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../check_server_temp.html">服务器温度检测</a></li>
<li class="toctree-l4"><a class="reference internal" href="../lackpack.html">LackPack</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dell/index.html">Dell服务器</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">HPE服务器</a></li>
<li class="toctree-l4"><a class="reference internal" href="../chipset/index.html">服务器主板芯片</a></li>
<li class="toctree-l4"><a class="reference internal" href="../storage/index.html">服务器存储</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../ipmi/index.html">IPMI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cockpit/index.html">Cockpit服务器统一管理平台</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../collectd/index.html">collectd - 系统信息采集服务</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../security/index.html">Linux安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../desktop/index.html">Linux桌面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../linux_tablet/index.html">Linux平板</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../performance/index.html">Performance Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Linux Atlas</a> &raquo;</li>
        
          <li><a href="../../index.html">Linux服务器</a> &raquo;</li>
        
          <li><a href="../index.html">服务器硬件</a> &raquo;</li>
        
          <li><a href="index.html">HPE服务器</a> &raquo;</li>
        
      <li>PCIe bifurcation选项</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../_sources/linux/server/hardware/hpe/pcie_bifurcation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="pcie-bifurcation">
<span id="id1"></span><h1>PCIe bifurcation选项<a class="headerlink" href="#pcie-bifurcation" title="永久链接至标题">¶</a></h1>
<p><a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 支持PCIe直接使用NVMe存储，这样可以在服务器上实现高性能存储集群。(原厂的 U.2 接口NVMe SSD存储升级套件实在成本太高)</p>
<p>在淘宝上可以购买到 PCIe X16 四盘NVMe扩展卡:</p>
<figure class="align-default">
<img alt="../../../../_images/pcie_nvme_extendcard.png" src="../../../../_images/pcie_nvme_extendcard.png" />
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_nvme_extendcard-1.png"><img alt="../../../../_images/pcie_nvme_extendcard-1.png" src="../../../../_images/pcie_nvme_extendcard-1.png" style="width: 879.6px; height: 633.6px;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_nvme_extendcard-2.png"><img alt="../../../../_images/pcie_nvme_extendcard-2.png" src="../../../../_images/pcie_nvme_extendcard-2.png" style="width: 779.0px; height: 808.0px;" /></a>
</figure>
<section id="id2">
<h2>PCIe bifurcation<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>需要注意，扩展卡是 PCIe x16 规格的，为了能够支持4个NVMe m.2 存储，需要将这个 X16 分成4个 X4 才能支持4个NVMe盘。需要主板支持一种称为 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> 技术，这样在主板BIOS中可以将 PCIe X16 改成 <code class="docutils literal notranslate"><span class="pre">x4x4x4x4</span></code></p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/pcie_bifurcation-1.png"><img alt="../../../../_images/pcie_bifurcation-1.png" src="../../../../_images/pcie_bifurcation-1.png" style="width: 766.0px; height: 810.0px;" /></a>
</figure>
<p>参考HP官方文档，DL360 gen10 是支持 PCIe Bifurcation 的:</p>
<p><code class="docutils literal notranslate"><span class="pre">System</span> <span class="pre">Configuration</span> <span class="pre">&gt;</span> <span class="pre">BIOS/Platform</span> <span class="pre">Configuration</span> <span class="pre">(RBSU)</span> <span class="pre">&gt;</span> <span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span> <span class="pre">&gt;</span> <span class="pre">PCIe</span> <span class="pre">Bifurcation</span> <span class="pre">Options</span></code></p>
<p>对于 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 我尝试完成 <a class="reference internal" href="dl360_bios_upgrade.html#dl360-bios-upgrade"><span class="std std-ref">HPE DL360 BIOS升级</span></a> 再做BIOS配置验证</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>目前尚未实践，等完成 <a class="reference internal" href="dl360_bios_upgrade.html#dl360-bios-upgrade"><span class="std std-ref">HPE DL360 BIOS升级</span></a> 之后看能否实现分成4个X4，如果只支持对半分，则购买2块双盘NVMe扩展卡，安装到 PCIe 3.0 Slot 1 和 Slot 2上，也能实现相同效果 - 因为HP DL360的Slot 1和Slot 2都连接在CPU 1上，和在一个Slot 1上切分4个X4一样。</p>
</div>
</section>
<section id="pciebifuration">
<h2>PCIe设备和bifuration<a class="headerlink" href="#pciebifuration" title="永久链接至标题">¶</a></h2>
<p>参考 <a class="reference external" href="https://community.hpe.com/t5/Servers-General/HPE-Proliant-dl160-gen9-bifurcation/td-p/7133232#.YXdM-y8RppQ">HPE Proliant dl160 gen9 bifurcation</a> 提到:</p>
<ul>
<li><p>有人提出 DL360和DL380更新到最新的Bios 2.90也没有出现 <code class="docutils literal notranslate"><span class="pre">pcie</span> <span class="pre">options</span></code> 选项，不过， <code class="docutils literal notranslate"><span class="pre">dual</span> <span class="pre">bifuration</span></code> 支持是从 2016 年开始的，在 <a class="reference external" href="https://support.hpe.com/hpesc/public/docDisplay?docLocale=en_US&amp;docId=c05060771">HPE UEFI System Utilities and Shell Release Notes for HPE ProLiant Gen9 Servers</a> 文档第5页(2016年文档)有说明:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Addedsupportto</span> <span class="n">configurethe</span> <span class="n">systemto</span> <span class="n">bifurcatePCIe</span> <span class="n">Slot</span> <span class="mi">1</span> <span class="n">on</span> <span class="n">the</span> <span class="n">DL360Gen9</span> <span class="ow">or</span> <span class="n">PCIeSlot</span> <span class="mi">2</span> <span class="n">on</span> <span class="n">the</span> <span class="n">DL380Gen9</span>
</pre></div>
</div>
</li>
</ul>
<p>也就是说对于 DL360 Gen9 是支持Slot 1的 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> ，对于 DL380 Gen9 则支持 Slot 2的 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bitfurcaton</span></code></p>
<ul class="simple">
<li><p>HP的人说DL360和DL380 Gen9是支持，但是需要PCIe扩展卡厂商的部件适配bifurcate，部件需要和firmware和驱动适配正确的速率才能实现 x8 / x4 。所以，这可能是没有插入PCIe扩展卡就看不到 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuratio</span></code> 选项的原因？</p></li>
</ul>
<p>参考 <a class="reference external" href="https://linustechtips.com/topic/1279595-hpe-gen9-with-asus-hyper-m2-x16-card-v2/">HPE Gen9 with asus hyper m.2 x16 card v2</a> 提到有人购买了 Asus hyper m.2 x16 card v2 以及 4块 Samsung 970 plus:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> 需要CPU和主板同时支持，Intel E5 v3处理器支持 <code class="docutils literal notranslate"><span class="pre">40个</span></code> PCIe 路径(lanes)</p></li>
</ul>
<p>参考 <a class="reference external" href="https://www.manualslib.com/manual/1391841/Hpe-Proliant-Gen10.html?page=120">Setting Gpu Configurations; Selecting Pcie Bifurcation Options; Configuring Specific Pcie Devices - HPE ProLiant Gen10 User Manual</a> 说明了对于GPU设备:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">System</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">BIOS</span><span class="o">/</span><span class="n">Platform</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">RBSU</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PCIe</span> <span class="n">Device</span> <span class="n">Configuration</span> <span class="o">&gt;</span> <span class="n">GPU</span> <span class="n">CFG</span>
</pre></div>
</div>
<p>有2个选项:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>4:1—Maps 4 PCIe slots to each installed processor
8:1—Maps all slots to a single processor
</pre></div>
</div>
<section id="id3">
<h3>综合<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> 需要PCIe设备和主板firmware/driver配合进行协商，所以如果系统没有安装PCIe设备(GPU或NVMe卡)则看不到 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span></code> 配置选项</p></li>
<li><p>HPE gen9服务器更新到最新的BIOS是支持 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code> 的，但是有可能需要扩展卡能够适配才能正确设置，但是没有看到 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span></code> 配置入口:</p></li>
</ul>
</section>
</section>
<section id="id4">
<h2>我的选择<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<section id="id5">
<h3>直通扩展卡(失败)<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>我购买了 3个 <a class="reference internal" href="../storage/samsung_pm9a1.html#samsung-pm9a1"><span class="std std-ref">三星PM9A1 NVMe存储</span></a> 以及 佳翼M2X16四盘NVMe扩展卡( 宣传称 <code class="docutils literal notranslate"><span class="pre">支持PCIE</span> <span class="pre">4.0</span> <span class="pre">GEN4，</span> <span class="pre">向下兼容PCIE3.0</span> <span class="pre">GEN3</span></code> )。我比较担心能否配合DL 360 Gen9实现 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">bifurcation</span></code></p>
<ul class="simple">
<li><p>我最初尝试将 NVMe扩展卡 安装在 Slot 3上(因为我想能在 Slot 1上安装显卡，然后可以还留出空间在Slot 2上安装第二个NVMe扩展卡)，但是确实启动以后没有找到PCIe配置选项</p></li>
<li><p>将 NVMe 扩展卡 改到安装到 Slot 1，重新启动系统，检查 <code class="docutils literal notranslate"><span class="pre">BIOS/Platform</span> <span class="pre">Configuration(RBSU)</span></code> 配置选项，依然没有看到 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span></code> 配置入口(只看到 <code class="docutils literal notranslate"><span class="pre">PCI</span> <span class="pre">Device</span> <span class="pre">Enable/Disable</span></code> 激活关闭设置):</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/rbsu_no_pcie_config.png"><img alt="../../../../_images/rbsu_no_pcie_config.png" src="../../../../_images/rbsu_no_pcie_config.png" style="width: 1260.8000000000002px; height: 640.0px;" /></a>
</figure>
<p><a class="reference external" href="https://community.hpe.com/t5/Servers-General/HPE-Proliant-dl160-gen9-bifurcation/td-p/7133232#.YXdM-y8RppQ">HPE Proliant dl160 gen9 bifurcation</a> 中答复中也提到了，这个功能需要扩展卡厂商支持firmware，有人换了6个扩展卡都没有看到BIOS能够显示出 <code class="docutils literal notranslate"><span class="pre">PCIe</span> <span class="pre">Device</span> <span class="pre">Configuration</span></code> 配置项。看起来我购买的 <code class="docutils literal notranslate"><span class="pre">佳翼M2X16四盘NVMe扩展卡</span></code> 也同样没有适配成功。</p>
<p>真是让人非常沮丧，折腾这么久，查询很多资料都没有明确的 HPE Gen9 解决 PCIe bifurction 的解释和适配方法，虽然2016年 <a class="reference external" href="https://support.hpe.com/hpesc/public/docDisplay?docLocale=en_US&amp;docId=c05060771">HPE UEFI System Utilities and Shell Release Notes for HPE ProLiant Gen9 Servers</a> 提到了支持，但是该文档最新2021年版本已经找不到这项说明了。</p>
</section>
<section id="plx">
<h3>PLX主控扩展卡<a class="headerlink" href="#plx" title="永久链接至标题">¶</a></h3>
<p>根据网上搜索到到信息了解到，HP gent9 的服务器可以使用PLX主控芯片扩展卡( PLX 是PCIe交换和桥接芯片供应商 )，从淘宝上搜索无需主板支持 <code class="docutils literal notranslate"><span class="pre">bifurcation</span></code> 的扩展卡有两种芯片:</p>
<ul class="simple">
<li><p>ASM2824</p></li>
<li><p>PLX2847 ( <a class="reference external" href="https://www.broadcom.com/products/pcie-switches-bridges/pcie-switches/pex8747">Broadcom PEX8747</a> 就是收购PLX的产品线的PLX8747)</p></li>
</ul>
<p>最终，我还是重新购买了 <code class="docutils literal notranslate"><span class="pre">M.2</span> <span class="pre">NVMe</span> <span class="pre">SSD扩展卡</span> <span class="pre">PCIe3.0</span> <span class="pre">X8X16扩2口4口M2</span> <span class="pre">PLX8747</span></code> ：</p>
<ul class="simple">
<li><p>目前google到的英文资料基本都是采用PLX芯片成功的</p></li>
<li><p>PLX是专注于PCIe连接的厂商，被很多NVMe Extend Card采用</p>
<ul>
<li><p><a class="reference external" href="http://www.sunweit.com/product/251-en.html">SUNWEIT PCI-E 3.0 X16 PEX8747 4-M.2 NVMe Extend Card</a></p></li>
<li><p><a class="reference external" href="http://www.asrock.com/news/index.cn.asp?id=2565">华擎X99 WS-E/10G</a> (华擎是从华硕分出的主板制造厂商，售价较低但做工还比较扎实，比不上华硕但是同价位质量较优 <a class="reference external" href="https://www.zhihu.com/question/354822608">感觉华擎的东西做工用料都很扎实呀，为什么都说是二线？</a> ) ，在HP论坛中有信息显示华擎ASrocck的NVMe PLX芯片扩展卡可以在HP gen9服务器上正确工作</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>PLX是半导体行业巨头新博通(Broadcom)旗下企业，原先是安华高公司于2014年收购PLX，2016年安华高公司收购Broadcom后改名Broadcom Limited(新博通)。( <a class="reference external" href="https://zhuanlan.zhihu.com/p/70074321">博通又准备收购芯片公司？|半导体行业观察</a> )</p>
</div>
<ul class="simple">
<li><p>需要注意，接口应该是 PCIe3.0 X16 ，这样拆分4个以后才是 x4x4x4x4 ，可以满足较高速的 NVMe 读写。</p></li>
</ul>
</section>
</section>
<section id="pcie-switches">
<h2>PCIe switches性能<a class="headerlink" href="#pcie-switches" title="永久链接至标题">¶</a></h2>
<p>Intel的北桥集成在CPU里面，所以原生PCIe通道的数量由CPU决定，主板可以根据需要对这些通道进行重新组合(比方x16 = 1x16 或 1x8+1x8 或 1x8+1x4+1x4)以满足多个pci的需要。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>我所使用的二手服务器 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 使用的处理器是 <a class="reference internal" href="../../../../kernel/cpu/intel/xeon_e5-2670_v3.html#xeon-e5-2670-v3"><span class="std std-ref">Intel Xeon E5-2670 v3处理器</span></a> ，每个处理器提供了 40 个PCIe Lanes</p>
</div>
<p>PCIE Switch (pcie扩充器/转换器/桥) 提供了通道数扩充以及拆分功能，例如 PLX 8747 就可以将一组x16扩充成两组x16，也可以拆分成 x8x8 或者 x4x4x4x4。网上资料显示两路扩展(两组x16)性能可能有损失。</p>
<p>注意配置的拓扑 <a class="reference external" href="https://link.zhihu.com/?target=http%3A//www.cirrascale.com/blog/index.php/exploring-the-pcie-bus-routes/">Exploring the PCIe Bus Routes</a> :</p>
<ul class="simple">
<li><p>如果主板使用PLX芯片，则应该将需要通讯的两个GPU位于同一个PLX芯片下面</p></li>
<li><p>如果两个gpu位于不同的PLX芯片下, 但位于同一个cpu下, 性能次之: 有7%的带宽损失(9.8 vs 10.6 gb/s) 和 7.9 vs 7.7微妙的延迟</p></li>
<li><p>两个gpu位于不同cpu下(自然也不同plx下)性能最次: 有62%的带宽损失和316%的延迟增加 (4 vs 10.6 gb/s, 32.1 vs 7.7)</p></li>
</ul>
<p>我的连接构思:</p>
<ul class="simple">
<li><p>由于 Slot1 和 Slot2 是连接在CPU 1上的PCIe，所以如果考虑多个GPU，可以在Slot1和Slot2上安装2块PGU卡，在Slot 3上安装NVMe存储卡，这样确保GPU之间通讯快速。</p></li>
<li><p>如果使用1个GPU卡 <a class="reference internal" href="../../../../machine_learning/hardware/tesla_p10.html#tesla-p10"><span class="std std-ref">Nvidia Tesla P10 GPU运算卡</span></a> ，则安装在 Slot 1上， Slot2 空出来安装一个双盘位NVMe存储扩展卡(x4x4)</p></li>
</ul>
</section>
<section id="pcienvme">
<h2>神奇PCIe拆分NVMe存储<a class="headerlink" href="#pcienvme" title="永久链接至标题">¶</a></h2>
<p>在服务器领域，例如 <a class="reference internal" href="hpe_dl360_gen9.html#hpe-dl360-gen9"><span class="std std-ref">HPE ProLiant DL360 Gen9服务器</span></a> 提供了SFF安装模式 <code class="docutils literal notranslate"><span class="pre">4</span> <span class="pre">SAS/SATA</span> <span class="pre">(Drive</span> <span class="pre">1-4)+6</span> <span class="pre">NVMe</span> <span class="pre">(Drive</span> <span class="pre">5-10)</span></code> ，可以将主机最后6个盘位替换成U.2接口的NVMe SSD磁盘。在 <a class="reference external" href="https://mp.weixin.qq.com/s?__biz=MzAwODExNjI3NA==&amp;mid=2649776369&amp;idx=1&amp;sn=6d90101ad858822ee1ce42db2560edea&amp;chksm=837701acb40088ba205a9d1f29c19ae62dea57bccd1c60e5b36ba67b02181e953827bb290ed8&amp;token=511876318&amp;lang=zh_CN&amp;scene=21#wechat_redirect">Dell PowerEdge R640：NVMe直连、NDC网卡、PERC10一览</a> 可以看到Dell服务器也是通过将 Xeon 处理器内置的 PCIe lanes 分出一部分专用于连接 NVMe SSD。这种模式节约了宝贵的PCIe插槽，同时又提供了满足大量NVMe存储分别连接不同的PCIe lanes的需求，可以实现直通连接，在 <a class="reference internal" href="../../../../kvm/iommu/iommu_infra.html#iommu-infra"><span class="std std-ref">IOMMU架构</span></a> 实现pass-through给虚拟机，实现高性能虚拟化存储。</p>
<p><a class="reference internal" href="../chipset/pcie.html#pcie"><span class="std std-ref">PCIe</span></a> :</p>
<ul class="simple">
<li><p>3.0 的单通道性能是传输速率 984.6MB/s ，使用 ×4 规格已经达到 3.938GB/s ，可以满足 PCIe 3.0 NVMe 的带宽需求</p></li>
<li><p>4.0 的单通道性能是传输速率 1.969GB/s ，使用 ×4 规格达到 7.877GB/s ，可以满足最快的PCIe 4.0 NVMe:ref:<cite>samsung_pm9a1</cite> 以及对应企业级 980 Pro的带宽</p></li>
</ul>
<p>传统的RAID技术，在不断推陈出新的NVMe存储技术发展下，也出现了NVMe RAID卡，通过NVMe switch可以实现更多的NVMe设备直连。如果HBA卡没有提供内置的RAID功能，可以采用 <a class="reference internal" href="../../../../kernel/cpu/intel/intel_vroc/index.html#intel-vroc"><span class="std std-ref">Intel Virtual RAID on CPU (Intel VROC)</span></a> 技术，实现全速率的NVMe组件RAID。在使用PEX88048主控芯片的NVMe Switch Adapter (Broadcom P411W-32P)，默认将PCIe 4.0 x16拆分成 4个x8 SFF-8654接口:</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../../../../_images/p411w-32p_8sff.png"><img alt="../../../../_images/p411w-32p_8sff.png" src="../../../../_images/p411w-32p_8sff.png" style="width: 560.0px; height: 430.5px;" /></a>
</figure>
<p>在不集联下一级PCIe Switch情况下，Broadcom P411W-32最多可拆分为32个PCIex1来连接SSD(牺牲了单盘带宽)，可以想象一下使用32个NVMe组建的阵列。</p>
</section>
<section id="id10">
<h2>参考<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://zhuanlan.zhihu.com/p/219831641">PCIe Switch Adapter：不只是NVMe HBA？</a></p></li>
<li><p><a class="reference external" href="https://zhuanlan.zhihu.com/p/103929939">硬件杂谈：关于pcie拆分与plx芯片</a></p></li>
<li><p><a class="reference external" href="https://www.zhihu.com/question/50238393/answer/120399606">请问pcie x16/x8以及sli/cfx对运算卡性能的影响?</a></p></li>
<li><p><a class="reference external" href="https://mp.weixin.qq.com/s?__biz=MzAwODExNjI3NA==&amp;mid=2649780116&amp;idx=1&amp;sn=a833bb9ffcb9b95b1b081321412e50f0&amp;chksm=83770ec9b40087dfa2f3ac411bd66698e73580df088f5b40e9a6a25c814e41264bf2b7dd9133&amp;token=934250801&amp;lang=zh_CN&amp;scene=21#wechat_redirect">PCIe 4.0 SAS+NVMe RAID/HBA卡：最高读IOPS 300万、写24万</a></p></li>
</ul>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="dl360_bios_numa.html" class="btn btn-neutral float-right" title="HPE DL360 Gen9设置BIOS激活NUMA" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dl360_bios_upgrade.html" class="btn btn-neutral float-left" title="HPE DL360 BIOS升级" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; <a href="../../../../copyright.html"> 版权所有</a> 2018 - now, Huatai Huang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>