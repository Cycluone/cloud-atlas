

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>调整ext4根文件系统大小 &mdash; Cloud Atlas 0.1 文档</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="copyright" title="版权所有" href="../../../copyright.html" />
    <link rel="next" title="Linux文件系统Disk Quota" href="quota/index.html" />
    <link rel="prev" title="Ext4文件系统上Dropbox疑问" href="dropbox_ext4.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Cloud Atlas
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../studio/index.html">Studio Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infrastructure/index.html">Infrastructure Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devops/index.html">DevOps Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvm/index.html">KVM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph/index.html">Ceph Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gluster/index.html">Gluster Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ovirt/index.html">oVirt Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openstack/index.html">OpenStack Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker/index.html">Docker Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kubernetes/index.html">Kubernetes Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openshift/index.html">OpenShift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sql/index.html">SQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mysql/index.html">MySQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../postgresql/index.html">PostgreSQL Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redis/index.html">Redis Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/index.html">Network Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infra_service/index.html">Infra-Service Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../web/index.html">Web Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../big_data/index.html">Big Data Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../machine_learning/index.html">Machine Learning Atlas</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Linux Atlas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../best_linux.html">最佳Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../redhat_linux/index.html">RedHat Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../arch_linux/index.html">Arch Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gentoo_linux/index.html">Gentoo Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../lfs_linux/index.html">LFS(Linux from scratch)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ubuntu_linux/index.html">Ubuntu Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../suse_linux/index.html">SUSE Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../kali_linux/index.html">Kali Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tails_linux/index.html">Tails Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../postmarketos/index.html">postmarketOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../container_os/index.html">容器化操作系统(Container OS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fedora_coreos/index.html">Fedora CoreOS容器操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chromium_os/index.html">Chromium OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../alpine_linux/index.html">Alpine Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subgraph_os/index.html">Subgraph OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../kaios/index.html">KaiOS - 世界第三手机操作系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../compute/index.html">Linux计算</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Linux存储</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../disk/index.html">Linux磁盘</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Linux文件系统</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="choice_linux_filesystem.html">Linux文件系统选择</a></li>
<li class="toctree-l4"><a class="reference internal" href="mount_ext4_on_macos.html">在macOS中挂载Ext4文件系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="xfs.html">XFS文件系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="lvm_xfs_in_studio.html">Studio环境的LVM+XFS存储</a></li>
<li class="toctree-l4"><a class="reference internal" href="xfs_tunning.html">XFS性能优化</a></li>
<li class="toctree-l4"><a class="reference internal" href="dropbox_ext4.html">Ext4文件系统上Dropbox疑问</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">调整ext4根文件系统大小</a></li>
<li class="toctree-l4"><a class="reference internal" href="quota/index.html">Linux文件系统Disk Quota</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../zfs/index.html">ZFS - Linux存储系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../btrfs/index.html">Btrfs - Linux存储系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stratis/index.html">Stratis - Linux存储系统</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../network/index.html">Linux网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../server/index.html">Linux服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/index.html">Linux安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../desktop/index.html">Linux桌面</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../linux_tablet/index.html">Linux平板</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel/index.html">Kernel Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_system/index.html">Distributed System Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Python Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../django/index.html">Django Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../javascript/index.html">JavaScript Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nodejs/index.html">Node.js Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../golang/index.html">Go Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../swift/index.html">Swift Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rust/index.html">Rust Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../android/index.html">Android Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bsd/index.html">BSD Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apple/index.html">Apple Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../windows/index.html">Windows Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../real/index.html">Real Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../management/index.html">Management Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../life/index.html">Life Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutme.html">关于作者</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donate.html">捐助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../thanks.html">感谢</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../roadmap.html">Roadmap</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Cloud Atlas</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Linux Atlas</a> &raquo;</li>
        
          <li><a href="../index.html">Linux存储</a> &raquo;</li>
        
          <li><a href="index.html">Linux文件系统</a> &raquo;</li>
        
      <li>调整ext4根文件系统大小</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/linux/storage/filesystem/resize_ext4_rootfs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="ext4">
<span id="resize-ext4-rootfs"></span><h1>调整ext4根文件系统大小<a class="headerlink" href="#ext4" title="永久链接至标题">¶</a></h1>
<ul class="simple">
<li><p>Linux支持在线扩展Ext4文件系统，但是不能在线缩小Ext4</p></li>
<li><p>Xen和KVM虚拟机都支持虚拟机运行时调整虚拟机块设备大小，但是如果启动虚拟磁盘设备的分区在使用中，就不能在线修改</p></li>
<li><p>只能调整分区的结束位置，但是不能调整分区的开始位置(会导致数据丢失)。并且这种操作是高风险操作，建议做好数据备份之后再操作。</p></li>
<li><p>建议在文件系统之下使用LVM卷管理，这样对卷进行扩展，实际上只是添加新的PV，不会修改现有的PV，风险相对较低。</p></li>
</ul>
<section id="rootfs">
<h2>在线扩展rootfs<a class="headerlink" href="#rootfs" title="永久链接至标题">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>通过 <code class="docutils literal notranslate"><span class="pre">fdisk</span></code> 修改磁盘分区大小，必须确保分区起始扇区和原先一致，且扩展后的扇区范围没有覆盖其他分区，否则会导致数据丢失。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>以下在线扩展根分区操作是我的一次实践记录，当时环境中分区 <code class="docutils literal notranslate"><span class="pre">/dev/vda3</span></code> 没有占满整个磁盘，并且 <code class="docutils literal notranslate"><span class="pre">/dev/vda3</span></code> 之后的磁盘空间是空白(没有 <code class="docutils literal notranslate"><span class="pre">/dev/vda4</span></code> )，所以才能通过fdisk调整分区 <code class="docutils literal notranslate"><span class="pre">/dev/vda3</span></code> 的结束位置而不影响现有数据。</p>
</div>
<p>对于具有海量数据的服务器，通过备份，格式化磁盘，然后再恢复数据方式来静态扩展文件系统分区不仅非常麻烦，有时候还因为必须持续在线或者海量小文件存储而无法实现。如果能够在线扩展文件系统，对于业务场景会非常有帮助。</p>
<ul>
<li><p>本案例能够直接不卸载根文件系统，直接通过fdisk命令修改 <code class="docutils literal notranslate"><span class="pre">/dev/vda3</span></code> 分区大小，然后 <code class="docutils literal notranslate"><span class="pre">resize2fs</span></code> 修改EXT4文件系统大小，原因是因为该磁盘恰好只分配了 <code class="docutils literal notranslate"><span class="pre">/dev/sda3</span></code> ，磁盘后续都是连续空白。</p></li>
<li><p>检查磁盘分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#fdisk -l /dev/vda

Disk /dev/vda: 128.8 GB, 128849018880 bytes, 251658240 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x000cb9dd

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048     2099199     1048576   83  Linux
/dev/vda2         2099200     6293503     2097152   82  Linux swap / Solaris
/dev/vda3         6293504   125829119    59767808   83  Linux  &lt;= 注意：这里vda3没有完全分配完磁盘空间，并且没有后续的vda4，所以才能通过fdisk修改分区大小
</pre></div>
</div>
</li>
<li><p>首先删除 <code class="docutils literal notranslate"><span class="pre">vda3</span></code> 对应分区，然后重新添加 <code class="docutils literal notranslate"><span class="pre">vda3</span></code> 分区，注意 <strong>分区起始扇区和原先相同，结束扇区则增大</strong> ，以便能够使用更多磁盘空间:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#fdisk /dev/vda
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): p   &lt;= 打印当前磁盘分区

Disk /dev/vda: 128.8 GB, 128849018880 bytes, 251658240 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x000cb9dd

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048     2099199     1048576   83  Linux
/dev/vda2         2099200     6293503     2097152   82  Linux swap / Solaris
/dev/vda3         6293504   125829119    59767808   83  Linux   &lt;= 这个是需要扩展的分区3

Command (m for help): d   &lt;= 删除分区
Partition number (1-3, default 3): 3   &lt;= 选择分区3，即删除
Partition 3 is deleted

Command (m for help): p   &lt;= 再次打印当前磁盘分区

Disk /dev/vda: 128.8 GB, 128849018880 bytes, 251658240 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x000cb9dd

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048     2099199     1048576   83  Linux
/dev/vda2         2099200     6293503     2097152   82  Linux swap / Solaris  &lt;= 可以看到分区3已经消失

Command (m for help): n     &lt;= 添加新分析，也就是再次添加分区3
Partition type:
   p   primary (2 primary, 0 extended, 2 free)
   e   extended
Select (default p): p     &lt;= 设置新增加的分区是主分区
Partition number (3,4, default 3): 3     &lt;= 分区3
First sector (6293504-251658239, default 6293504): 6293504  &lt;= 关键点：重建的分区3起始扇区必需和原先删除的分区3完全一致
Last sector, +sectors or +size{K,M,G} (6293504-251658239, default 251658239):  &lt;= 关键点：重建的分区3的结束扇区值扩大了，完整占据磁盘剩余空间
Using default value 251658239
Partition 3 of type Linux and of size 117 GiB is set

Command (m for help): p   &lt;= 再次打印当前磁盘分区

Disk /dev/vda: 128.8 GB, 128849018880 bytes, 251658240 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x000cb9dd

   Device Boot      Start         End      Blocks   Id  System
/dev/vda1   *        2048     2099199     1048576   83  Linux
/dev/vda2         2099200     6293503     2097152   82  Linux swap / Solaris
/dev/vda3         6293504   251658239   122682368   83  Linux   &lt;= 确认重建的分区3正确

Command (m for help): w   &lt;= 将分区表信息写回磁盘保存
The partition table has been altered!

Calling ioctl() to re-read partition table.

WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
</pre></div>
</div>
</li>
<li><p>刷新内核对磁盘分区的识别</p></li>
</ul>
<p>注意，由于是修改正挂载的磁盘分区，所以需要通过 <code class="docutils literal notranslate"><span class="pre">partprobe</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">kpartx</span></code> 来通知重新识别。</p>
<p>不过， <code class="docutils literal notranslate"><span class="pre">partprobe</span></code> 方式并不能使得内核识别正在使用的根磁盘分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#partprobe</span>
<span class="n">Error</span><span class="p">:</span> <span class="n">Partition</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="mi">3</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda</span> <span class="n">have</span> <span class="n">been</span> <span class="n">written</span><span class="p">,</span> <span class="n">but</span> <span class="n">we</span> <span class="n">have</span> <span class="n">been</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">inform</span> <span class="n">the</span> <span class="n">kernel</span> <span class="n">of</span> <span class="n">the</span> <span class="n">change</span><span class="p">,</span> <span class="n">probably</span> <span class="n">because</span> <span class="n">it</span><span class="o">/</span><span class="n">they</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">use</span><span class="o">.</span>  <span class="n">As</span> <span class="n">a</span> <span class="n">result</span><span class="p">,</span> <span class="n">the</span> <span class="n">old</span> <span class="n">partition</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">will</span> <span class="n">remain</span> <span class="ow">in</span> <span class="n">use</span><span class="o">.</span>  <span class="n">You</span> <span class="n">should</span> <span class="n">reboot</span> <span class="n">now</span> <span class="n">before</span> <span class="n">making</span> <span class="n">further</span> <span class="n">changes</span><span class="o">.</span>
</pre></div>
</div>
<p>这里可以通过检查磁盘分区在内核中信息验证没有生效:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">partitions</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">vd</span>
</pre></div>
</div>
<p>显示如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">253</span>        <span class="mi">0</span>  <span class="mi">125829120</span> <span class="n">vda</span>
<span class="mi">253</span>        <span class="mi">1</span>    <span class="mi">1048576</span> <span class="n">vda1</span>
<span class="mi">253</span>        <span class="mi">2</span>    <span class="mi">2097152</span> <span class="n">vda2</span>
<span class="mi">253</span>        <span class="mi">3</span>   <span class="mi">59767808</span> <span class="n">vda3</span>
</pre></div>
</div>
<p>参考 <a class="reference external" href="https://access.redhat.com/solutions/199573">Does RHEL 7 support online resize of disk partitions?</a> 使用 <code class="docutils literal notranslate"><span class="pre">partx</span></code> 的 <code class="docutils literal notranslate"><span class="pre">-u</span></code> 参数可以更新:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">partx</span> <span class="o">-</span><span class="n">u</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda</span>
</pre></div>
</div>
<p>此时没有任何输出信息，实际已经更新完成。</p>
<p>再次检查分区大小信息，可以看到已经更新:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cat /proc/partitions | grep vd</span>
 <span class="mi">253</span>        <span class="mi">0</span>  <span class="mi">125829120</span> <span class="n">vda</span>
 <span class="mi">253</span>        <span class="mi">1</span>    <span class="mi">1048576</span> <span class="n">vda1</span>
 <span class="mi">253</span>        <span class="mi">2</span>    <span class="mi">2097152</span> <span class="n">vda2</span>
 <span class="mi">253</span>        <span class="mi">3</span>  <span class="mi">122682368</span> <span class="n">vda3</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<ul class="simple">
<li><p>RHEL7内核包含了从 <a class="reference external" href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=c83f6bf98dc1f1a194118b3830706cebbebda8c4">block: add partition resize function to blkpg ioctl</a> 的BLKPG ioctl的修改来支持 <code class="docutils literal notranslate"><span class="pre">BLKPG_RESIZE_PARTITION</span></code> 操作。</p></li>
<li><p>当前RHEL7的 <code class="docutils literal notranslate"><span class="pre">util-linux</span></code> 工具包包含的 <code class="docutils literal notranslate"><span class="pre">partx</span></code> 和 <code class="docutils literal notranslate"><span class="pre">resizepart</span></code> 程序是唯一支持 <code class="docutils literal notranslate"><span class="pre">BLKPG_RESIZE_PARTITION</span></code> 的BLKPG ioctl操作的用户端命令。</p></li>
</ul>
</div>
<ul>
<li><p>检查磁盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tune2fs</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span>
</pre></div>
</div>
</li>
<li><p>扩展EXT4文件系统</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">resize2fs</span></code> 命令支持ext2/ext3/ext4文件系统重定义大小。如果文件系统是umount状态，则可以通过 <code class="docutils literal notranslate"><span class="pre">resize2fs</span></code> 工具扩展或收缩文件系统。如果文件系统是mount状态，则只支持扩展文件系统。注意：要在线扩展文件系统，需要内核和文件系统都支持on-line resize。（现代Linux发行版使用的内核 2.6 可以支持在线resize挂载状态的ext3和ext4；其中，ext3文件系统需要使用 <code class="docutils literal notranslate"><span class="pre">resize_inode</span></code> 特性)</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esize2fs</span> <span class="p">[</span> <span class="o">-</span><span class="n">fFpPMbs</span> <span class="p">]</span> <span class="p">[</span> <span class="o">-</span><span class="n">d</span> <span class="n">debug</span><span class="o">-</span><span class="n">flags</span> <span class="p">]</span> <span class="p">[</span> <span class="o">-</span><span class="n">S</span> <span class="n">RAID</span><span class="o">-</span><span class="n">stride</span> <span class="p">]</span> <span class="p">[</span> <span class="o">-</span><span class="n">z</span> <span class="n">undo_file</span> <span class="p">]</span> <span class="n">device</span> <span class="p">[</span> <span class="n">size</span> <span class="p">]</span>
</pre></div>
</div>
<ul>
<li><p>现在我们检查一下当前挂载的 <code class="docutils literal notranslate"><span class="pre">/dev/vda3</span></code> 磁盘文件系统，挂载为 <code class="docutils literal notranslate"><span class="pre">/</span></code> 分区，当前大小是 <code class="docutils literal notranslate"><span class="pre">56G</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#df -h</span>
<span class="n">Filesystem</span>      <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span>        <span class="mi">56</span><span class="n">G</span>  <span class="mf">2.4</span><span class="n">G</span>   <span class="mi">51</span><span class="n">G</span>   <span class="mi">5</span><span class="o">%</span> <span class="o">/</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
<li><p>执行以下命令扩展文件系统(默认扩展成分区大小，也可以指定文件系统大小):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="mf">1.43.5</span> <span class="p">(</span><span class="mi">04</span><span class="o">-</span><span class="n">Aug</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span>
<span class="n">Filesystem</span> <span class="n">at</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span> <span class="ow">is</span> <span class="n">mounted</span> <span class="n">on</span> <span class="o">/</span><span class="p">;</span> <span class="n">on</span><span class="o">-</span><span class="n">line</span> <span class="n">resizing</span> <span class="n">required</span>
<span class="n">old_desc_blocks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">new_desc_blocks</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">The</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span> <span class="ow">is</span> <span class="n">now</span> <span class="mi">30670592</span> <span class="p">(</span><span class="mi">4</span><span class="n">k</span><span class="p">)</span> <span class="n">blocks</span> <span class="n">long</span><span class="o">.</span>
</pre></div>
</div>
<ul>
<li><p>再次检查挂载的 <code class="docutils literal notranslate"><span class="pre">/</span></code> 分区，可以看到空间已经扩展到 <code class="docutils literal notranslate"><span class="pre">116G</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#df -h</span>
<span class="n">Filesystem</span>      <span class="n">Size</span>  <span class="n">Used</span> <span class="n">Avail</span> <span class="n">Use</span><span class="o">%</span> <span class="n">Mounted</span> <span class="n">on</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span>       <span class="mi">116</span><span class="n">G</span>  <span class="mf">2.4</span><span class="n">G</span>  <span class="mi">108</span><span class="n">G</span>   <span class="mi">3</span><span class="o">%</span> <span class="o">/</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
<p>现在就可以毫无障碍地使用扩展过的根文件系统</p>
<ul class="simple">
<li><p>强制系统重启进行fsck</p></li>
</ul>
<p>RHEL 6等早期使用SysVinit和Debian使用Upstart早期版本，都支持在根分区的文件系统上 <code class="docutils literal notranslate"><span class="pre">/forcefsck</span></code> 文件来激活强制对根文件系统进行fsck，这是通过 <code class="docutils literal notranslate"><span class="pre">/etc/rc.sysinit</span></code> 脚本来实现的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="o">/</span><span class="n">forcefsck</span>
</pre></div>
</div>
<p>这样系统重启会强制进行fack。</p>
<p>不过，在systemd系统中，需要通过 <code class="docutils literal notranslate"><span class="pre">systemd-fsck</span></code> 服务来设置 <a class="reference external" href="https://www.freedesktop.org/software/systemd/man/systemd-fsck&#64;.service.html">systemd-fsck&#64;.service</a> 。</p>
<p>参考 <a class="reference external" href="https://wiki.archlinux.org/index.php/fsck">archliux - fsck</a> 使用以下命令检查分区设置的fsck检查频率（默认是每30次启动会做一次fsck，不过，当前文件系统设置了 <code class="docutils literal notranslate"><span class="pre">-1</span></code> 强制不检查，或者设置 <code class="docutils literal notranslate"><span class="pre">0</span></code> 也是不检查）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#dumpe2fs -h /dev/vda3 | grep -i &quot;mount count&quot;</span>
<span class="n">dumpe2fs</span> <span class="mf">1.43.5</span> <span class="p">(</span><span class="mi">04</span><span class="o">-</span><span class="n">Aug</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span>
<span class="n">Mount</span> <span class="n">count</span><span class="p">:</span>              <span class="mi">6</span>
<span class="n">Maximum</span> <span class="n">mount</span> <span class="n">count</span><span class="p">:</span>      <span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>修改检查 <code class="docutils literal notranslate"><span class="pre">/dev/vda3</span></code> 频率，设置成 <code class="docutils literal notranslate"><span class="pre">1</span></code> ，则每次重启都会检查:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tune2fs</span> <span class="o">-</span><span class="n">c</span> <span class="mi">1</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span>
</pre></div>
</div>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tune2fs</span> <span class="mf">1.43.5</span> <span class="p">(</span><span class="mi">04</span><span class="o">-</span><span class="n">Aug</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span>
<span class="n">Setting</span> <span class="n">maximal</span> <span class="n">mount</span> <span class="n">count</span> <span class="n">to</span> <span class="mi">1</span>
</pre></div>
</div>
<p>现在我们重启操作系统，从VNC终端检查虚拟机可以看到虚拟机启动时进行了文件系统fsck。</p>
<ul>
<li><p>既然已经做过fsck了，我们现在恢复原先默认关闭fsck的设置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tune2fs</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">vda3</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="id1">
<h2>离线收缩rootfs<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>收缩文件系统风险很大，至少我的实践是失败的(在线扩容则每次都能够成功)。所以我强烈建议你在尝试收缩文件系统之前做好数据备份，随时做好从备份中恢复的准备。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Ext4文件系统只支持离线收缩，不能在线挂载情况下收缩文件系统，所以限制比较多。对于数据量较少的情况，我觉得还是通过备份恢复方式更简便(既然已经离线了，用备份恢复方式和收缩文件系统差别不大了)。</p>
</div>
<p>在 <a class="reference internal" href="../../../arm/raspberry_pi/startup/ubuntu64bit_pi.html#ubuntu64bit-pi"><span class="std std-ref">树莓派4b运行64位Ubuntu</span></a> 会发现首次启动操作系统，就会自动扩展根文件系统占据整个磁盘的剩余空间。对于部署服务器来说，合理的分区方式是根文件系统只占用较少空间，将主要存储空间保留给LVM卷管理，或者 <a class="reference internal" href="../btrfs/index.html#btrfs"><span class="std std-ref">Btrfs - Linux存储系统</span></a> / <a class="reference internal" href="../zfs/index.html#zfs"><span class="std std-ref">ZFS - Linux存储系统</span></a> 实现动态存储分配管理。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在通过resize2fs缩小文件系统时，我特意先选择比目标磁盘空间小1G的大小，这样可以确保fdisk调整文件系统分区时不会出现冲突。等fdisk调整到目标磁盘空间后，再次执行resize2fs，让EXT4文件系统恰好扩展到完整的分区大小。</p>
<p>我先后做过两次磁盘ext4 resizefs，第一次是直接对 <a class="reference internal" href="../../../arm/raspberry_pi/startup/ubuntu64bit_pi.html#ubuntu64bit-pi"><span class="std std-ref">树莓派4b运行64位Ubuntu</span></a> 的安装后磁盘分区进行调整，此时文件系统分区表是树莓派默认的dos分区; 第二次是我实现 <a class="reference internal" href="../../../arm/raspberry_pi/storage/usb_boot_ubuntu_pi_4.html#usb-boot-ubuntu-pi-4"><span class="std std-ref">树莓派4 USB存储启动Ubuntu Server 20.04</span></a> 采用最近安装的Ubuntu for Raspberry Pi，此时文件系统分区表是GPT。所以两者在分区的扇区上有细微的差别。</p>
</div>
<ul>
<li><p>检查当前磁盘分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fdisk</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span>
</pre></div>
</div>
</li>
</ul>
<p>显示输出当前整个 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> 大约占用了 <code class="docutils literal notranslate"><span class="pre">953.6G</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span><span class="p">:</span> <span class="mf">953.9</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024175636480</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000343040</span> <span class="n">sectors</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">4096</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">4096</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">1048576</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="n">F727B1EE</span><span class="o">-</span><span class="n">B292</span><span class="o">-</span><span class="mi">40</span><span class="n">DF</span><span class="o">-</span><span class="n">ACB0</span><span class="o">-</span><span class="n">AAAD6A763492</span>

<span class="n">Device</span>      <span class="n">Start</span>        <span class="n">End</span>    <span class="n">Sectors</span>   <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span>    <span class="mi">2048</span>     <span class="mi">499711</span>     <span class="mi">497664</span>   <span class="mi">243</span><span class="n">M</span> <span class="n">EFI</span> <span class="n">System</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>  <span class="mi">499712</span> <span class="mi">2000343006</span> <span class="mi">1999843295</span> <span class="mf">953.6</span><span class="n">G</span> <span class="n">Linux</span> <span class="n">filesystem</span>
</pre></div>
</div>
<ul>
<li><p>检查当前磁盘空间:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">df</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
</li>
</ul>
<p>显示外接SSD移动硬盘占用空间仅 2.5G</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>       <span class="mi">940</span><span class="n">G</span>  <span class="mf">2.5</span><span class="n">G</span>  <span class="mi">899</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
<ul>
<li><p>我计划将根目录收缩到30G左右，所以先卸载挂载磁盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
</li>
<li><p>在卸载到文件系统上执行 fsck</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e2fsck</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
</pre></div>
</div>
</li>
</ul>
<p>输出显示文件系统是干净的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e2fsck</span> <span class="mf">1.44.1</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">writable</span><span class="p">:</span> <span class="n">clean</span><span class="p">,</span> <span class="mi">142569</span><span class="o">/</span><span class="mi">62496768</span> <span class="n">files</span><span class="p">,</span> <span class="mi">5140329</span><span class="o">/</span><span class="mi">249980411</span> <span class="n">blocks</span>
</pre></div>
</div>
<ul>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">resize2fs</span></code> 命令收缩文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="mi">32</span><span class="n">G</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="mf">1.45.5</span> <span class="p">(</span><span class="mi">07</span><span class="o">-</span><span class="n">Jan</span><span class="o">-</span><span class="mi">2020</span><span class="p">)</span>
<span class="n">Please</span> <span class="n">run</span> <span class="s1">&#39;e2fsck -f /dev/sda2&#39;</span> <span class="n">first</span><span class="o">.</span>
</pre></div>
</div>
<ul>
<li><p>按照提示再次执行 <code class="docutils literal notranslate"><span class="pre">e2fsck</span> <span class="pre">-f</span> <span class="pre">/dev/sda2</span></code> 显示输出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="mf">1.44.1</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">Please</span> <span class="n">run</span> <span class="s1">&#39;e2fsck -f /dev/sda2&#39;</span> <span class="n">first</span><span class="o">.</span>

<span class="n">root</span><span class="nd">@jetson</span><span class="p">:</span><span class="o">/</span><span class="c1"># e2fsck -f /dev/sda2</span>
<span class="n">e2fsck</span> <span class="mf">1.44.1</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">Pass</span> <span class="mi">1</span><span class="p">:</span> <span class="n">Checking</span> <span class="n">inodes</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="ow">and</span> <span class="n">sizes</span>
<span class="n">Pass</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Checking</span> <span class="n">directory</span> <span class="n">structure</span>
<span class="n">Pass</span> <span class="mi">3</span><span class="p">:</span> <span class="n">Checking</span> <span class="n">directory</span> <span class="n">connectivity</span>
<span class="n">Pass</span> <span class="mi">4</span><span class="p">:</span> <span class="n">Checking</span> <span class="n">reference</span> <span class="n">counts</span>
<span class="n">Pass</span> <span class="mi">5</span><span class="p">:</span> <span class="n">Checking</span> <span class="n">group</span> <span class="n">summary</span> <span class="n">information</span>
<span class="n">writable</span><span class="p">:</span> <span class="mi">142569</span><span class="o">/</span><span class="mi">62496768</span> <span class="n">files</span> <span class="p">(</span><span class="mf">0.2</span><span class="o">%</span> <span class="n">non</span><span class="o">-</span><span class="n">contiguous</span><span class="p">),</span> <span class="mi">5140329</span><span class="o">/</span><span class="mi">249980411</span> <span class="n">blocks</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>实际上只要 <code class="docutils literal notranslate"><span class="pre">mount</span></code> 过一次文件系统，如果要执行 <code class="docutils literal notranslate"><span class="pre">resize2fs</span></code> 就必须先执行一次 <code class="docutils literal notranslate"><span class="pre">e2fsck</span> <span class="pre">-f</span></code> 。</p>
</div>
<ul>
<li><p>再次收缩文件系统:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="mi">32</span><span class="n">G</span>
</pre></div>
</div>
</li>
</ul>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resize2fs</span> <span class="mf">1.44.1</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">Resizing</span> <span class="n">the</span> <span class="n">filesystem</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="n">to</span> <span class="mi">8388608</span> <span class="p">(</span><span class="mi">4</span><span class="n">k</span><span class="p">)</span> <span class="n">blocks</span><span class="o">.</span>
<span class="n">resize2fs</span><span class="p">:</span> <span class="n">A</span> <span class="n">block</span> <span class="n">group</span> <span class="ow">is</span> <span class="n">missing</span> <span class="n">an</span> <span class="n">inode</span> <span class="n">table</span> <span class="k">while</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">resize</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
<span class="n">Please</span> <span class="n">run</span> <span class="s1">&#39;e2fsck -fy /dev/sda2&#39;</span> <span class="n">to</span> <span class="n">fix</span> <span class="n">the</span> <span class="n">filesystem</span>
<span class="n">after</span> <span class="n">the</span> <span class="n">aborted</span> <span class="n">resize</span> <span class="n">operation</span><span class="o">.</span>
</pre></div>
</div>
<p>看似有些问题，这次resize2fs有问题，需要fack了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e2fsck</span> <span class="o">-</span><span class="n">fy</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
</pre></div>
</div>
<p>提示信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e2fsck</span> <span class="mf">1.44.1</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">ext2fs_check_desc</span><span class="p">:</span> <span class="n">Corrupt</span> <span class="n">group</span> <span class="n">descriptor</span><span class="p">:</span> <span class="n">bad</span> <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="n">bitmap</span>
<span class="n">e2fsck</span><span class="p">:</span> <span class="n">Group</span> <span class="n">descriptors</span> <span class="n">look</span> <span class="n">bad</span><span class="o">...</span> <span class="n">trying</span> <span class="n">backup</span> <span class="n">blocks</span><span class="o">...</span>
<span class="n">writable</span><span class="p">:</span> <span class="n">recovering</span> <span class="n">journal</span>
<span class="n">e2fsck</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">superblock</span> <span class="n">flags</span> <span class="n">on</span> <span class="n">writable</span>


<span class="n">writable</span><span class="p">:</span> <span class="o">*****</span> <span class="n">FILE</span> <span class="n">SYSTEM</span> <span class="n">WAS</span> <span class="n">MODIFIED</span> <span class="o">*****</span>

<span class="n">writable</span><span class="p">:</span> <span class="o">**********</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">Filesystem</span> <span class="n">still</span> <span class="n">has</span> <span class="n">errors</span> <span class="o">**********</span>
</pre></div>
</div>
<ul>
<li><p>我再次尝试 fsck</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e2fsck</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
</pre></div>
</div>
</li>
</ul>
<p>提示文件系统是干净的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e2fsck</span> <span class="mf">1.44.1</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">Setting</span> <span class="n">free</span> <span class="n">inodes</span> <span class="n">count</span> <span class="n">to</span> <span class="mi">62473043</span> <span class="p">(</span><span class="n">was</span> <span class="mi">62386733</span><span class="p">)</span>
<span class="n">Setting</span> <span class="n">free</span> <span class="n">blocks</span> <span class="n">count</span> <span class="n">to</span> <span class="mi">245963688</span> <span class="p">(</span><span class="n">was</span> <span class="mi">244930381</span><span class="p">)</span>
<span class="n">writable</span><span class="p">:</span> <span class="n">clean</span><span class="p">,</span> <span class="mi">23725</span><span class="o">/</span><span class="mi">62496768</span> <span class="n">files</span><span class="p">,</span> <span class="mi">4016723</span><span class="o">/</span><span class="mi">249980411</span> <span class="n">blocks</span>
</pre></div>
</div>
<ul>
<li><p>但是确实比较奇怪，此时我尝试挂在分区显示文件系统只有236M:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">df</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
</li>
</ul>
<p>显示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>       <span class="mi">939</span><span class="n">G</span>  <span class="mi">236</span><span class="n">M</span>  <span class="mi">900</span><span class="n">G</span>   <span class="mi">1</span><span class="o">%</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
<p>OMG，难道数据丢失了？</p>
<p>不过，进入 <code class="docutils literal notranslate"><span class="pre">/mnt</span></code> 目录下使用 <code class="docutils literal notranslate"><span class="pre">du</span> <span class="pre">-sh</span></code> 看到数据还存在:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">du</span> <span class="o">-</span><span class="n">sh</span>
</pre></div>
</div>
<p>输出还是之前的 4.5G ，看似数据没有丢失，只是当前收缩以后 <code class="docutils literal notranslate"><span class="pre">df</span></code> 显示不正确。</p>
<ul>
<li><p>再次卸载文件系统，然后fsck以后，看看是否正确:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span>
<span class="n">fsck</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
</pre></div>
</div>
</li>
</ul>
<p>显示还是clean:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fsck</span> <span class="kn">from</span> <span class="nn">util</span><span class="o">-</span><span class="n">linux</span> <span class="mf">2.31.1</span>
<span class="n">e2fsck</span> <span class="mf">1.44.1</span> <span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">Mar</span><span class="o">-</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">writable</span><span class="p">:</span> <span class="n">clean</span><span class="p">,</span> <span class="mi">23725</span><span class="o">/</span><span class="mi">62496768</span> <span class="n">files</span><span class="p">,</span> <span class="mi">4016723</span><span class="o">/</span><span class="mi">249980411</span> <span class="n">blocks</span>
</pre></div>
</div>
<ul>
<li><p>现在尝试使用 fdisk 命令重建分区 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">fdisk</span> <span class="p">(</span><span class="n">util</span><span class="o">-</span><span class="n">linux</span> <span class="mf">2.31.1</span><span class="p">)</span><span class="o">.</span>
<span class="n">Changes</span> <span class="n">will</span> <span class="n">remain</span> <span class="ow">in</span> <span class="n">memory</span> <span class="n">only</span><span class="p">,</span> <span class="n">until</span> <span class="n">you</span> <span class="n">decide</span> <span class="n">to</span> <span class="n">write</span> <span class="n">them</span><span class="o">.</span>
<span class="n">Be</span> <span class="n">careful</span> <span class="n">before</span> <span class="n">using</span> <span class="n">the</span> <span class="n">write</span> <span class="n">command</span><span class="o">.</span>


<span class="n">Command</span> <span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">help</span><span class="p">):</span> <span class="n">p</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span><span class="p">:</span> <span class="mf">953.9</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024175636480</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000343040</span> <span class="n">sectors</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">4096</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">4096</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">1048576</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="n">F727B1EE</span><span class="o">-</span><span class="n">B292</span><span class="o">-</span><span class="mi">40</span><span class="n">DF</span><span class="o">-</span><span class="n">ACB0</span><span class="o">-</span><span class="n">AAAD6A763492</span>

<span class="n">Device</span>      <span class="n">Start</span>        <span class="n">End</span>    <span class="n">Sectors</span>   <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span>    <span class="mi">2048</span>     <span class="mi">499711</span>     <span class="mi">497664</span>   <span class="mi">243</span><span class="n">M</span> <span class="n">EFI</span> <span class="n">System</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>  <span class="mi">499712</span> <span class="mi">2000343006</span> <span class="mi">1999843295</span> <span class="mf">953.6</span><span class="n">G</span> <span class="n">Linux</span> <span class="n">filesystem</span>
</pre></div>
</div>
</li>
<li><p>现在先删除 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> 然后再把它加回来，只不过加回来时候分区结束位置提前(缩小)</p></li>
</ul>
<p>先删除分区:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Command</span> <span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">help</span><span class="p">):</span> <span class="n">d</span>
<span class="n">Partition</span> <span class="n">number</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span> <span class="mi">2</span><span class="p">):</span>

<span class="n">Partition</span> <span class="mi">2</span> <span class="n">has</span> <span class="n">been</span> <span class="n">deleted</span><span class="o">.</span>
</pre></div>
</div>
<p>然后再加回来，加回来时候分区只设置32G:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Command (m for help): n
Partition number (2-128, default 2):
First sector (499712-2000343006, default 499712):
Last sector, +sectors or +size{K,M,G,T,P} (499712-2000343006, default 2000343006): +32G

Created a new partition 2 of type &#39;Linux filesystem&#39; and of size 32 GiB.
Partition #2 contains a ext4 signature.

Do you want to remove the signature? [Y]es/[N]o: n
</pre></div>
</div>
<ul>
<li><p>再次检查分区信息是否正确:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Command</span> <span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">help</span><span class="p">):</span> <span class="n">p</span>

<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span><span class="p">:</span> <span class="mf">953.9</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">1024175636480</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">2000343040</span> <span class="n">sectors</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">4096</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">4096</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">1048576</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="n">F727B1EE</span><span class="o">-</span><span class="n">B292</span><span class="o">-</span><span class="mi">40</span><span class="n">DF</span><span class="o">-</span><span class="n">ACB0</span><span class="o">-</span><span class="n">AAAD6A763492</span>

<span class="n">Device</span>      <span class="n">Start</span>      <span class="n">End</span>  <span class="n">Sectors</span>  <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda1</span>    <span class="mi">2048</span>   <span class="mi">499711</span>   <span class="mi">497664</span>  <span class="mi">243</span><span class="n">M</span> <span class="n">EFI</span> <span class="n">System</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>  <span class="mi">499712</span> <span class="mi">67608575</span> <span class="mi">67108864</span>   <span class="mi">32</span><span class="n">G</span> <span class="n">Linux</span> <span class="n">filesystem</span>
</pre></div>
</div>
</li>
</ul>
<p>和之前对比，只是 <code class="docutils literal notranslate"><span class="pre">/dev/sda2</span></code> 空间缩小了，其他一致，所以我们保存退出:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Command</span> <span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">help</span><span class="p">):</span> <span class="n">w</span>
<span class="n">The</span> <span class="n">partition</span> <span class="n">table</span> <span class="n">has</span> <span class="n">been</span> <span class="n">altered</span><span class="o">.</span>
<span class="n">Calling</span> <span class="n">ioctl</span><span class="p">()</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">partition</span> <span class="n">table</span><span class="o">.</span>
<span class="n">Re</span><span class="o">-</span><span class="n">reading</span> <span class="n">the</span> <span class="n">partition</span> <span class="n">table</span> <span class="n">failed</span><span class="o">.</span><span class="p">:</span> <span class="n">Device</span> <span class="ow">or</span> <span class="n">resource</span> <span class="n">busy</span>

<span class="n">The</span> <span class="n">kernel</span> <span class="n">still</span> <span class="n">uses</span> <span class="n">the</span> <span class="n">old</span> <span class="n">table</span><span class="o">.</span> <span class="n">The</span> <span class="n">new</span> <span class="n">table</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">at</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">reboot</span> <span class="ow">or</span> <span class="n">after</span> <span class="n">you</span> <span class="n">run</span> <span class="n">partprobe</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kpartx</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<ul>
<li><p>按照提示刷新内核中sda分区表信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">partprobe</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda</span>
</pre></div>
</div>
</li>
<li><p>尝试挂载磁盘:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
</li>
</ul>
<p>很不幸失败了:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span><span class="p">:</span> <span class="o">/</span><span class="n">mnt</span><span class="p">:</span> <span class="n">wrong</span> <span class="n">fs</span> <span class="nb">type</span><span class="p">,</span> <span class="n">bad</span> <span class="n">option</span><span class="p">,</span> <span class="n">bad</span> <span class="n">superblock</span> <span class="n">on</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span><span class="p">,</span> <span class="n">missing</span> <span class="n">codepage</span> <span class="ow">or</span> <span class="n">helper</span> <span class="n">program</span><span class="p">,</span> <span class="ow">or</span> <span class="n">other</span> <span class="n">error</span><span class="o">.</span>
</pre></div>
</div>
<ul>
<li><p>fsck:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e2fsck</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sda2</span>
</pre></div>
</div>
</li>
</ul>
<p>提示superblock记录和实际设备记录块不一致:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>e2fsck 1.44.1 (24-Mar-2018)
The filesystem size (according to the superblock) is 249980411 blocks
The physical size of the device is 8388608 blocks
Either the superblock or the partition table is likely to be corrupt!
Abort&lt;y&gt;?
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>最终我没有shrink成功，很遗憾，后续再看有没有机会实践了。</p>
</div>
</section>
<section id="id2">
<h2>参考<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://access.redhat.com/solutions/199573">Does RHEL 7 support online resize of disk partitions?</a></p></li>
<li><p><a class="reference external" href="https://devops.profitbricks.com/tutorials/increase-the-size-of-a-linux-root-partition-without-rebooting/">Resize a Linux Root Partition Without Rebooting</a></p></li>
<li><p><a class="reference external" href="https://linuxconfig.org/how-to-resize-ext4-root-partition-live-without-umount">How to resize ext4 root partition live without umount on Linux</a></p></li>
<li><p><a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/storage_administration_guide/ext4grow">6.3. RESIZING AN EXT4 FILE SYSTEM</a></p></li>
<li><p><a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/ext4grow">5.3. RESIZING AN EXT4 FILE SYSTEM</a></p></li>
<li><p><a class="reference external" href="https://www.teimouri.net/reload-partition-table-without-reboot-linux/#.XEbJLy2B3RY">Reload Partition Table Without Reboot In Linux</a></p></li>
<li><p><a class="reference external" href="https://access.redhat.com/articles/1196333">How to Shrink an ext2/3/4 File system with resize2fs</a></p></li>
<li><p><a class="reference external" href="https://serverfault.com/questions/528075/is-it-possible-to-on-line-shrink-a-ext4-volume-with-lvm">Is it possible to on-line shrink a EXT4 volume with LVM?</a> - 提供了一个通过initramfs在服务器启动时自动shrink文件系统的方法，比较巧妙，值得借鉴</p></li>
</ul>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="quota/index.html" class="btn btn-neutral float-right" title="Linux文件系统Disk Quota" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dropbox_ext4.html" class="btn btn-neutral float-left" title="Ext4文件系统上Dropbox疑问" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; <a href="../../../copyright.html"> 版权所有</a> 2021, Huatai Huang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <!-- your html code here -->
    <br>
    <p><a href="https://github.com/huataihuang/cloud-atlas/issues">留言和讨论</a>|<a href="https://github.com/huataihuang/cloud-atlas/blob/master/source/donate.rst">请我喝一杯咖啡</a></p>
     


</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>